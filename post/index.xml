<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on cvvz&#39;s Blog</title>
		<link>https://cvvz.fun/post/</link>
		<description>Recent content in Posts on cvvz&#39;s Blog</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>zh-hans</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Thu, 17 Aug 2023 15:13:22 +0800</lastBuildDate>
		<atom:link href="https://cvvz.fun/post/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>k8s storage ç”Ÿå‘½å‘¨æœŸå…¨æµç¨‹</title>
			<link>https://cvvz.fun/post/volume-lifecycle/</link>
			<pubDate>Thu, 17 Aug 2023 15:13:22 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/volume-lifecycle/</guid>
			<description>æœ¬ç¯‡ä¸æ¶‰åŠä»£ç ç»†èŠ‚ï¼Œä½†æ˜¯å…¨æ˜¯å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚ã€‚è¿™ç¯‡ç¬”è®°å¯ä»¥ä½œä¸ºk8s storageçš„è¿ç»´æ‰‹å†Œï¼Œå¿˜è®°äº†ç»†èŠ‚çš„æ—¶å€™å†æ‹¿å‡ºæ¥é‡æ–°è¿‡ä¸€éã€‚ ä»Pe</description>
			<content type="html"><![CDATA[<blockquote>
<p>æœ¬ç¯‡ä¸æ¶‰åŠä»£ç ç»†èŠ‚ï¼Œä½†æ˜¯å…¨æ˜¯å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚ã€‚è¿™ç¯‡ç¬”è®°å¯ä»¥ä½œä¸ºk8s storageçš„è¿ç»´æ‰‹å†Œï¼Œå¿˜è®°äº†ç»†èŠ‚çš„æ—¶å€™å†æ‹¿å‡ºæ¥é‡æ–°è¿‡ä¸€éã€‚</p>
</blockquote>
<h2 id="ä»pending-åˆ°containercreating">ä»Pending åˆ°ContainerCreating</h2>
<h3 id="è°ƒåº¦">è°ƒåº¦</h3>
<p>Podè¢«åˆ›å»ºå‡ºæ¥åï¼Œè°ƒåº¦å™¨å¼€å§‹è¿›è¡Œè°ƒåº¦ï¼Œè°ƒåº¦æ—¶éœ€è¦åˆ¤æ–­Podä½¿ç”¨çš„PVCçš„çŠ¶æ€ï¼ŒPVCå¯¹åº”çš„storage classçš„<code>VolumeBindingMode</code> å­—æ®µï¼Œå’ŒPVCçš„<code>VolumeName</code>å­—æ®µï¼š</p>
<ol>
<li>
<p>å¦‚æœPodå¯¹åº”çš„PVCå·²ç»å’ŒæŸä¸ªPV boundå¥½äº†ï¼Œé‚£ä¹ˆè°ƒåº¦æ—¶ï¼ŒNodeé™¤äº†éœ€è¦æ»¡è¶³Podçš„topoè¦æ±‚ï¼Œè¿˜éœ€è¦æ»¡è¶³bound PVçš„affinityè¦æ±‚ã€‚è¿™ç§æƒ…å†µåç»­ä¸å†è®¨è®ºã€‚</p>
</li>
<li>
<p>å¦‚æœ<code>VolumeBindingMode==Immediate</code>ï¼Œæˆ–è€…PVCçš„<code>VolumeName</code>å·²ç»è®¾ç½®ï¼ˆstatic provisionï¼‰é‚£ä¹ˆå°±å¿…é¡»ç­‰å¾…PVCå’ŒPVå®ŒæˆåŒå‘ç»‘å®šæ‰èƒ½è¿›è¡ŒPodçš„è°ƒåº¦ã€‚</p>
</li>
<li>
<p>å¦‚æœä¸º<code>VolumeBindingMode == WaitForFirstConsumer</code> ï¼Œä¸”PVCçš„<code>VolumeName</code>æ²¡æœ‰è®¾ç½®ï¼Œé‚£ä¹ˆè°ƒåº¦å™¨ä¼šä¸ºè¿™ä¸ªPodå®Œæ•´çš„èµ°ä¸€éè°ƒåº¦æµç¨‹ï¼š</p>
<ol>
<li>å¦‚æœé›†ç¾¤é‡Œå·²ç»æœ‰åˆ›å»ºå¥½çš„æˆ–è€…æ®‹ç•™çš„PVæ»¡è¶³PVCçš„è¦æ±‚ï¼Œè°ƒåº¦å™¨ä¼šè®¾ç½®æ»¡è¶³è¦æ±‚çš„PVçš„<code>claimRef</code>å­—æ®µï¼Œç›¸å½“äºå®ŒæˆPV â†’ PVCçš„ç»‘å®š</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œè°ƒåº¦å™¨åˆ™ä¼šæ‰¾åˆ°åˆé€‚çš„Nodeè®¾ç½®pvc annotation<code>&quot;volume.kubernetes.io/selected-node&quot;</code></li>
</ol>
<p><strong>æ³¨æ„ï¼Œæ­¤æ—¶Podä»ç„¶å¤„äºPendingçŠ¶æ€ï¼Œç­‰å¾…PVCå’ŒPVå®ŒæˆåŒå‘ç»‘å®šã€‚</strong></p>
</li>
</ol>
<h3 id="åŒå‘ç»‘å®š">åŒå‘ç»‘å®š</h3>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>å¦‚æœé›†ç¾¤é‡Œå·²ç»æœ‰åˆ›å»ºå¥½çš„æˆ–è€…æ®‹ç•™çš„PVæ»¡è¶³PVCçš„è¦æ±‚ï¼š</p>
<ol>
<li>å¦‚æœ<code>VolumeBindingMode==Immediate</code> ï¼Œ æˆ–è€…PVCçš„VolumeNameå·²ç»è®¾ç½®ï¼Œé‚£ä¹ˆpersistentvolumecontroller ä¼šæ‰¾åˆ°æ»¡è¶³è¦æ±‚çš„é‚£ä¸ªPVå®ŒæˆåŒå‘ç»‘å®šï¼Œå®ŒæˆåPVCå’ŒPVçš„statuså‡ä¸ºBoundã€‚è°ƒåº¦å™¨åˆ™ä¼šç»§ç»­è°ƒåº¦ï¼Œæ­¤æ—¶è°ƒåº¦æ—¶ä¼šå°†PVçš„affinityè€ƒè™‘åœ¨å†…ã€‚</li>
<li>å¦‚æœä¸º<code>VolumeBindingMode == WaitForFirstConsumer</code> ï¼Œä¸”PVCçš„<code>VolumeName</code>æ²¡æœ‰è®¾ç½®ï¼Œåœ¨è°ƒåº¦é˜¶æ®µï¼Œè°ƒåº¦å™¨ä¼šè®¾ç½®æ»¡è¶³è¦æ±‚çš„PVçš„<code>claimRef</code>å­—æ®µï¼Œpersistentvolumecontrolleråªå¯èƒ½æ‰¾åˆ°åœ¨è°ƒåº¦é˜¶æ®µè®¾ç½®äº†PV <code>claimRef</code>å­—æ®µä¸”ç­‰äºPVCçš„ï¼Œè®¾ç½®PVCçš„<code>volumeName</code>å­—æ®µå’Œ<code>pv.kubernetes.io/bind-completed: &quot;yes&quot;</code> annotationã€‚ä¹Ÿå°±æ˜¯è¯´è¿™ç§æƒ…å†µä¸‹åŒå‘ç»‘å®šæ˜¯ç”±è°ƒåº¦å™¨å’Œpersistentvolumecontrolleré…åˆå®Œæˆã€‚</li>
</ol>
<p>å‡å¦‚é›†ç¾¤é‡Œæ²¡æœ‰ä»»ä½•ç°æˆçš„PVå¯ä»¥æ»¡è¶³PVCçš„è¦æ±‚ï¼š</p>
<ol>
<li>å¦‚æœPVCçš„<code>VolumeName</code>å·²ç»è®¾ç½®ï¼Œpersistentvolumecontroller åˆ™ä»€ä¹ˆéƒ½ä¸ä¼šåšã€‚æ­¤æ—¶PVCä¼šä¸€ç›´<code>Pending</code>ï¼ŒPodä¹Ÿ<code>Pending</code>ï¼Œæ— äº‹å‘ç”Ÿï¼Œç›´åˆ°æœ‰äººæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå’Œ<code>VolumeName</code>åŒåçš„PVä¸ºæ­¢ã€‚</li>
<li>å¦‚æœ<code>VolumeBindingMode==Immediate</code> ï¼Œpersistentvolumecontroller ä¼šè®¾ç½®PVCçš„<code>volume.kubernetes.io/storage-provisioner</code> annotation</li>
<li>å¦‚æœä¸º<code>VolumeBindingMode == WaitForFirstConsumer</code> ï¼Œä¹Ÿä¼šè®¾ç½®PVCçš„<code>volume.kubernetes.io/storage-provisioner</code> annotationã€‚</li>
</ol>
<h3 id="provision">Provision</h3>
<p>external-provisioner å‘ç°PVCé‡Œæœ‰äº†<code>volume.kubernetes.io/storage-provisioner</code> è¿™ä¸ªannotationï¼Œå¹¶ä¸”å’Œè‡ªå·±nameä¸€è‡´ï¼Œæ‰å¯èƒ½å¼€å§‹Provision volumeã€‚</p>
<ol>
<li>å¦‚æœ<code>VolumeBindingMode==Immediate</code> ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è°ƒç”¨csiè¿›è¡Œprovision</li>
<li>å¦‚æœ<code>VolumeBindingMode == WaitForFirstConsumer</code> ï¼Œé‚£ä¹ˆè¿˜éœ€è¦æœ‰<code>&quot;volume.kubernetes.io/selected-node&quot;</code> annotationæ‰èƒ½provisionï¼Œè¿™ä¸ªæ˜¯å‰é¢è°ƒåº¦å™¨è®¾ç½®çš„ã€‚<code>WaitForFirstConsumer</code> æ˜¯ç”¨æ¥æ”¯æŒvolume topology ç‰¹æ€§çš„ï¼Œè¿™é‡Œè®¾ç½®çš„nodeçš„topoä¿¡æ¯ï¼Œåç»­ä¼šä½œä¸ºå‚æ•°ä¼ ç»™csiï¼Œcsiåœ¨åˆ›å»ºvolumeæ—¶å°†ä¼šæ»¡è¶³è¿™ä¸ªnodeçš„topoè¦æ±‚ï¼Œé¿å…å‡ºç°è·¨azçš„æƒ…å†µã€‚å¦å¤–å¦‚æœåˆ›å»ºvolumeå¤±è´¥ï¼Œexternal provisionerè¿˜å¯èƒ½åˆ é™¤è¿™ä¸ªannotationï¼Œè§¦å‘è°ƒåº¦å™¨é‡æ–°è°ƒåº¦ã€‚</li>
</ol>
<p>provisionæˆåŠŸï¼ˆæˆ–è€…æœ‰ç°æˆçš„PVå¯ç”¨ï¼‰å¹¶ä¸”åŒå‘ç»‘å®šä¹Ÿåšå®Œï¼ŒPodå°±æ­£å¼è¢«è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šï¼Œ<strong>æ­¤æ—¶Podä»<code>Pending</code>çŠ¶æ€å˜æˆäº†<code>ContainerCreating</code>çŠ¶æ€</strong>ã€‚</p>
<p>kubelet watchåˆ°podäº‹ä»¶ï¼Œç¼“å­˜åˆ°podä¿¡æ¯åˆ°podmanagerï¼Œvolumemanageræ ¹æ®æ”¶åˆ°çš„podä¿¡æ¯æ„é€ å‡ºDSWï¼Œç„¶åå¼€å§‹è¿›è¡Œreconcileã€‚</p>
<h2 id="ä»containercreatingåˆ°running">ä»ContainerCreatingåˆ°Running</h2>
<h3 id="attach">attach</h3>
<p>reconcileæµç¨‹é¦–å…ˆä¼š<code>waitForVolumeAttach</code> ã€‚é»˜è®¤attach/detachæ“ä½œæ˜¯ç”±attachdetach controlleråšçš„ï¼Œé™¤éæ˜¾å¼çš„è®¾ç½®kubeletå‚æ•°<code>enable-controller-attach-detach=false</code> ï¼ˆkubeletå¯åŠ¨æ—¶ä¼šé»˜è®¤è®¾ç½®ä¸ºtrueï¼‰ã€‚å½“<code>enable-controller-attach-detach=true</code> æ—¶ï¼Œkubeletä¼šè®¾ç½®ä¸€ä¸ªannotationï¼š</p>
<p><code>volumes.kubernetes.io/controller-managed-attach-detach: &quot;true&quot;</code> ï¼Œattachdetach controller å‘ç°æœ‰è¿™ä¸ªannotationæ—¶å°±çŸ¥é“è‡ªå·±åº”è¯¥è´Ÿè´£è¯¥nodeä¸Šçš„volumeçš„attach/detachæ“ä½œã€‚</p>
<p>å¦‚æœvolume pluginæ˜¯attachableçš„ï¼Œå¹¶ä¸”<code>enable-controller-attach-detach=false</code>ï¼Œé‚£ä¹ˆå°±æ˜¯ç”±kubeletè¿›è¡Œattach volumeï¼š</p>
<ul>
<li>é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ”¯æŒmulti attachï¼ˆåªæœ‰access modeæ˜¯<code>ReadWriteMany</code>æˆ–è€…<code>ReadOnlyMany</code>æ‰æ”¯æŒåŒæ—¶attachåˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œå¦åˆ™åªå…è®¸attachåˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼‰ï¼Œå¦‚æœä¸æ”¯æŒï¼Œé‚£ä¹ˆåŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªattachæ“ä½œã€‚</li>
<li>å¯¹äºcsi pluginï¼Œattachæ“ä½œå°±æ˜¯åˆ›å»º<code>volumeattachment</code>ï¼Œç„¶åä¸€ç›´å¡ç€ç­‰åˆ°<code>volumeattachment</code>çš„statuså˜ä¸º<code>attached: true</code>æ‰ç®—attachæˆåŠŸï¼ŒæˆåŠŸåï¼Œæ‰ä¼šæ›´æ–°åˆ°ASWä¸­ã€‚</li>
</ul>
<p><strong>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œattach/detachè¿˜æœ‰åé¢çš„mount/unmountæ“ä½œï¼Œéƒ½æ˜¯ç”¨çš„operationexecutoræ¡†æ¶ï¼Œå®ç°ä¸Šæ˜¯å•ç‹¬èµ·ä¸€ä¸ªgoroutineå¼‚æ­¥å¤„ç†çš„ï¼Œä¸ä¼šå¡ä½ä»»ä½•reconcileæµç¨‹ã€‚</strong></p>
<p>å¦‚æœvolume pluginä¸æ˜¯attachableçš„æˆ–è€…<code>enable-controller-attach-detach=true</code> ï¼Œä¹Ÿå°±æ˜¯ç”±attachdetach controllerè´Ÿè´£attachæ“ä½œï¼Œé‚£ä¹ˆä¼šèµ°åˆ°<code>VerifyControllerAttachedVolume</code>æµç¨‹ä¸­ã€‚åœ¨è¿™ä¸ªæµç¨‹é‡Œï¼š</p>
<ul>
<li>é¦–å…ˆå¦‚æœvolumeä¸æ˜¯attachableçš„ï¼Œé‚£ä¹ˆç›´æ¥æ›´æ–°ASWï¼Œç›¸å½“äºç›´æ¥è®¤ä¸ºattachæˆåŠŸï¼›</li>
<li>å¦‚æœæ˜¯attachableçš„ï¼Œå…ˆåˆ¤æ–­volumeæ˜¯å¦<code>ReportedInUse</code>ï¼Œå¦‚æœä¸æ˜¯å°±ç›´æ¥è¿”å›ï¼›</li>
<li>è·å–èŠ‚ç‚¹çš„<code>status.VolumesAttached</code>å­—æ®µï¼Œå¦‚æœvolumeåœ¨è¿™ä¸ªå­—æ®µä¸­ï¼Œå°±è¯´æ˜attachdetach  controllerçš„attachæ“ä½œå·²ç»æˆåŠŸäº†ï¼Œå°±å¯ä»¥æ›´æ–°åˆ°ASWä¸­ã€‚</li>
</ul>
<p>å½“ç”±attachdetach controllerè´Ÿè´£attachæ“ä½œæ—¶ï¼š</p>
<ul>
<li>é¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦å·²ç»attachäº†ï¼Œå› ä¸ºcontrolleræœ¬èº«æœ‰ç¼“å­˜ï¼Œæ‰€ä»¥æ˜¯æŸ¥çœ‹ASWè€Œä¸æ˜¯åƒkubeleté‚£æ ·æŸ¥çœ‹node statusï¼›</li>
<li>æ¥ç€å¦‚æœä¸æ”¯æŒmultiattachï¼Œä¼šä»ASWé‡ŒæŸ¥è¯¢æ˜¯å¦æœ‰åˆ«çš„èŠ‚ç‚¹attachedäº†è¿™ä¸ªvolumeï¼Œå¦‚æœæ˜¯åˆ™ä¸å…è®¸å†attachï¼ŒæŠ¥é”™è¿”å›</li>
<li>æ¥ç€æ‰§è¡Œattach volumeï¼Œattach volumeæ“ä½œæœ¬èº«å’Œkubeletæ˜¯ä½¿ç”¨çš„åŒä¸€ä¸ªpackageï¼ˆå†…éƒ¨æœ‰äº›æ¥å£å®ç°æœ‰äº›ä¸åŒï¼Œä½†æ˜¯å¤§éƒ¨åˆ†ä¸€æ ·ï¼‰ï¼Œä¸Šé¢å·²ç»æœ‰ä»‹ç»ã€‚</li>
<li>attach/detachæˆåŠŸåcontrollerä¼šæ›´æ–°node statusé‡Œçš„<code>VolumesAttached</code>å­—æ®µï¼Œè¿™æ ·volumemanagerå°±å¯ä»¥é€šè¿‡èŠ‚ç‚¹ä¸Šçš„è¿™ä¸ªå­—æ®µæ¥åˆ¤æ–­æŸä¸ªvolumeæ˜¯å¦å·²ç»attachæˆåŠŸã€‚</li>
</ul>
<p>åˆ›å»º<code>volumeattachment</code>ä¹‹åï¼Œè¢«external-attacher watchåˆ°åä¼šè°ƒç”¨csiè¿›è¡Œattachï¼ŒæˆåŠŸåä¼šæ›´æ–°<code>volumeattachment</code>çš„statusä¸º<code>attached: true</code> ï¼Œå¦‚æœå¤±è´¥äº†ä¹Ÿä¼šåœ¨statusé‡Œæ›´æ–°é”™è¯¯åŸå› ã€‚</p>
<p>å‰é¢æåˆ°çš„<code>ReportedInUse</code>æ˜¯è¿™æ ·æ¥çš„ï¼š<strong>kubeletä¼šå‘¨æœŸæ€§çš„è°ƒç”¨volume managerçš„<code>GetVolumesInUse</code> æ–¹æ³•æ¥è·å–æ‰€æœ‰attachableçš„å¹¶ä¸”åº”è¯¥è¢«attachåˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„volumeï¼ˆåªè¦volumeåœ¨DSWï¼Œå°±åº”è¯¥attachã€‚å¿…é¡»ç­‰åˆ°volumeæ—¢ä¸åœ¨DSWä¹Ÿä¸åœ¨ASWå°±ä¼šè¢«ä»node statusé‡Œåˆ æ‰ã€‚</strong>ï¼‰ï¼Œæ›´æ–°åˆ°node statusçš„<code>VolumesInUse</code>å­—æ®µã€‚æ›´æ–°å®Œäº†ä¹‹åï¼Œåˆä¼šè°ƒç”¨volume managerçš„<code>MarkVolumesAsReportedInUse</code> æ–¹æ³•ï¼Œåœ¨DSWä¸­è¿›è¡Œæ ‡æ³¨ï¼Œè®¾ç½®<code>reportedInUse = true</code>ï¼Œè¡¨ç¤ºvolumeå·²ç»æ›´æ–°åˆ° node status çš„<code>VolumesInUse</code>å­—æ®µé‡Œå»äº†ã€‚</p>
<p><code>ReportedInUse</code> æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ol>
<li>volumemanageråœ¨æ‰§è¡Œ<code>VerifyControllerAttachedVolume</code>é‡Œè¦å…ˆåˆ¤æ–­æ˜¯å¦å·²ç»è®¾ç½®äº†<code>ReportedInUse</code> æ‰ä¼šå»å†³å®šæ˜¯å¦åº”è¯¥è®¾ç½®volumeä¸ºattachedã€‚</li>
<li>attachdetach controllerä¾èµ–node statusé‡Œçš„ <code>ReportedInUse</code>æ¥åˆ¤æ–­volumeæ˜¯ä¸æ˜¯å·²ç»è¢«kubeletæ„ŸçŸ¥åˆ°åœ¨è¿›è¡Œmountæ“ä½œäº†ï¼Œè¿™å†³å®šäº†controlleræ˜¯å¦å¯ä»¥å®‰å…¨çš„detach volumeï¼Œåç»­ä¹Ÿæœ‰æåˆ°è¿™ä¸€ç‚¹ã€‚</li>
</ol>
<h3 id="mount-device-å’Œmount-volume">mount device å’Œmount volume</h3>
<p>kubeletç­‰å¾…attachæˆåŠŸï¼Œå¹¶å°†volumeä¿¡æ¯æ›´æ–°åˆ°ASWä¸­åï¼Œæ¥ç€è¿›è¡Œmountã€‚å…ˆmount deviceï¼Œå³global mount pointï¼Œç„¶åmount volumeï¼Œå³å°†Pod volume bind mountåˆ°global mount pointã€‚kubeletç­‰å¾…volume mountæˆåŠŸä»¥åä¼šæ›´æ–°<strong>PodçŠ¶æ€ä»<code>ContainerCreating</code>åˆ°<code>Running</code></strong>ã€‚</p>
<h2 id="ä»terminatingåˆ°podè¢«å½»åº•åˆ é™¤">ä»Terminatingåˆ°Podè¢«å½»åº•åˆ é™¤</h2>
<p>åˆ é™¤podæ—¶ï¼Œpodè¿›å…¥<code>Terminating</code>çŠ¶æ€ï¼Œkubeletå¼€å§‹æ€æ‰æ‰€æœ‰çš„å®¹å™¨ã€‚å¿…é¡»è¦ç¡®ä¿æ‰€æœ‰å®¹å™¨éƒ½å·²ç»è¢«æ€æ­»ï¼ŒDSWPæ‰ä¼šä»DSWä¸­åˆ é™¤podå’Œvolumeä¿¡æ¯ï¼Œè¿™æ ·å°±è§¦å‘reconcileæµç¨‹è¿›è¡Œunmount/unattachã€‚<strong>æ³¨æ„è¿™æ—¶Podä»ç„¶å¤„äºTerminatingçŠ¶æ€ã€‚</strong></p>
<h3 id="unmount-volume">unmount volume</h3>
<p>ç¬¬ä¸€æ­¥æ˜¯unmount pod volumeï¼Œå¹¶åˆ é™¤vol.dataæ–‡ä»¶ã€‚unmountæˆåŠŸåï¼Œpodçš„volumeç›®å½•å°±æ˜¯ç©ºçš„äº†ï¼Œpodå°±å¯ä»¥å½»åº•çš„ä»etcdä¸­åˆ é™¤äº†ï¼Œè¿™ä¸ªæ—¶å€™é›†ç¾¤é‡Œå°±æŸ¥è¯¢ä¸åˆ°è¿™ä¸ªpodäº†ã€‚å¦‚æœpodä¸€ç›´å¡åœ¨<code>Terminaing</code>çŠ¶æ€ï¼Œè¦ä¹ˆæ˜¯å®¹å™¨åˆ é™¤ä¸æ‰ï¼Œè¦ä¹ˆæ˜¯unmountä¸€ç›´æ²¡æœ‰æˆåŠŸï¼Œå¾ˆå¯èƒ½æ˜¯kernelå‡ºbugäº†ã€‚</p>
<p><strong>podè¢«å½»åº•åˆ é™¤ä»¥åï¼Œåªä»£è¡¨unmount volumeæˆåŠŸäº†ã€‚unmount deviceå’Œdetach volumeè¿˜ä¼šåœ¨åå°ç»§ç»­è¿›è¡Œã€‚</strong></p>
<h2 id="podè¢«å½»åº•åˆ é™¤ä»¥å">Podè¢«å½»åº•åˆ é™¤ä»¥å</h2>
<h3 id="unmount-device">unmount device</h3>
<p>unmount deviceä»¥åï¼ŒèŠ‚ç‚¹ä¸Šå°±å®Œå…¨ä¸å­˜åœ¨ä»»ä½•mount pointäº†ã€‚</p>
<h3 id="detach-volume">detach volume</h3>
<p>å¦‚æœä¸éœ€è¦unmount deviceï¼Œæˆ–è€…unmount device æˆåŠŸä¹‹åï¼Œvolumemanagerå¼€å§‹è¿›è¡Œdetach volumeã€‚</p>
<p>å¦‚æœpluginä¸æ˜¯attachableçš„ï¼Œæˆ–è€…æ˜¯ç”±controllerè´Ÿè´£attach/detachï¼Œå°±ç›´æ¥æŠŠvolumeä¿¡æ¯ä»ASWé‡Œåˆ æ‰äº†ã€‚<strong>æ³¨æ„è¿™ä¸€æ­¥ä¼šè§¦å‘kubeletæ›´æ–°node statusä¸­çš„<code>ReportedInUse</code> ï¼Œå°†volumeä»<code>ReportedInUse</code> ä¸­åˆ é™¤æ‰ã€‚è¿™æ„å‘³ç€ä»ç°åœ¨å¼€å§‹attachdetach controllerå¯ä»¥å¼€å§‹å®‰å…¨çš„æ‰§è¡Œdetachæ“ä½œäº†ã€‚</strong></p>
<p>å¦‚æœæ˜¯ç”±kubeletè´Ÿè´£attach/detachï¼Œkubeletå°±æ‰§è¡Œdetach volumeæ“ä½œã€‚å¯¹äºcsiï¼Œdetachå°±æ˜¯åˆ é™¤<code>volumeattachment</code>ï¼Œç„¶åç­‰å¾…<code>volumeattachment</code>è¢«å½»åº•ä»etcdä¸­åˆ é™¤æ‰ï¼Œæ‰ç®—detachæˆåŠŸã€‚ç”±äº<code>volumeattachment</code>ä¸­å®šä¹‰äº†finalizerï¼Œæ‰€ä»¥ä¸ä¼šç›´æ¥è¢«åˆ é™¤ï¼Œéœ€è¦ç­‰åˆ°external-attacherè°ƒç”¨csiæ‰§è¡Œdetachå¹¶æˆåŠŸï¼Œæ‰ä¼šè¢«å½»åº•ä»é›†ç¾¤ä¸­åˆ é™¤ï¼Œ<code>volumeattachment</code>è¢«å½»åº•åˆ é™¤äº†ï¼Œæ‰ç®—æ˜¯detachæˆåŠŸã€‚</p>
<p>å¦‚æœæ˜¯controllerè´Ÿè´£attach/detachï¼Œcontrollerè¿›è¡Œdetach çš„å‰ææœ‰ä¸¤ä¸ªï¼š</p>
<ol>
<li>æ˜¯volumeåœ¨ASWä¸­å­˜åœ¨è€Œåœ¨DSWä¸­ä¸å­˜åœ¨ï¼ˆè¿™é‡Œæåˆ°çš„ASWå’ŒDSWæŒ‡çš„æ˜¯atachdetach controllerçš„ï¼Œä¸æ˜¯kubletçš„ï¼‰ï¼Œåªæœ‰<strong>å½“Podåœ¨é›†ç¾¤ä¸­è¢«å½»åº•åˆ æ‰äº†ï¼ŒDSWPæ‰ä¼šå°†volumeä»DSWä¸­åˆ é™¤ï¼Œcontrolleræ‰èƒ½å¼€å§‹reconcileï¼›</strong></li>
<li><strong>detachå‰è¿˜éœ€è¦ç¡®ä¿volumeå·²ç»è¢«ä»èŠ‚ç‚¹unmountedäº†æ‰èƒ½è¿›è¡Œ</strong>ã€‚controlleræ€ä¹ˆçŸ¥é“volumeå·²ç»è¢«unmountedæˆåŠŸäº†å‘¢ï¼Ÿå½“èŠ‚ç‚¹ä¸Šçš„<code>ReportedInUse</code> å­—æ®µè¢«å¢åŠ æˆ–è€…åˆ é™¤æ—¶ï¼Œcontrollerå°±ä¼šç›¸åº”çš„è®¾ç½®ASWä¸­volumeçš„<code>MountedByNode</code>å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå°±ä»£è¡¨ç€controlleræ˜¯å¦å¯ä»¥å®‰å…¨detachã€‚åˆå¦‚å‰é¢æè¿°çš„ï¼Œåªæœ‰å½“kubelet unmountå·²ç»æˆåŠŸï¼Œå½»åº•ä»volumemanagerçš„ASWä¸­åˆ é™¤åï¼Œæ‰ä¼šè§¦å‘æ›´æ–°node statusï¼Œå°†volumeä»èŠ‚ç‚¹çš„<code>ReportedInUse</code> é‡Œåˆ é™¤æ‰ã€‚</li>
</ol>
<p>detachçš„æµç¨‹æ˜¯ï¼š</p>
<ul>
<li>é¦–å…ˆä»ASWä¸­åˆ é™¤è¯¥volumeï¼›</li>
<li>ç„¶åæ›´æ–°node status çš„<code>VolumesAttached</code>ï¼Œå°†volumeä»ä¸­å»æ‰ï¼›</li>
<li>ç„¶åæ‰§è¡Œdetach volumeï¼Œcsi çš„ detach volumeå®ç°å’Œä¸Šé¢kubeletæ˜¯åŒä¸€ä¸ªï¼Œå·²ç»è¯´è¿‡äº†ã€‚</li>
<li>å¦‚æœdetachå¤±è´¥äº†ï¼Œä¼šé‡æ–°æŠŠvolumeåŠ å›åˆ°ASWä¸­ã€‚</li>
<li>æ¥ä¸‹æ¥çš„<code>UpdateNodeStatuese</code> å‡½æ•°åˆä¼šæŠŠvolumeä¹Ÿé‡æ–°åŠ å›åˆ°node statusçš„<code>VolumesAttached</code> ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œé™¤äº†unmountæˆåŠŸåcontrollerä¼šdetach volumeä»¥å¤–ï¼Œè¿˜æœ‰ä¸€äº›æƒ…å†µï¼Œå³ä½¿<code>ReportedInUse</code>ä»ç„¶å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´volumeæ²¡æœ‰å®Œæˆunmountä¹Ÿä¼šè¿›è¡Œdetach volumeï¼ˆä½†æ˜¯ä»ç„¶è¦ä¿è¯Podå·²ç»è¢«å½»åº•åˆ é™¤æ‰äº†ï¼‰ï¼š</p>
<ol>
<li>èŠ‚ç‚¹çŠ¶æ€ä¸å¥åº·ï¼Œå¹¶ä¸”å·²ç»ç­‰å¾…äº†ä¸€ä¸ªè¶…æ—¶æ—¶é—´<code>maxWaitForUnmountDuration</code>ã€‚</li>
<li>èŠ‚ç‚¹è¢«æ‰“ä¸Šäº†<code>node.kubernetes.io/out-of-service</code>æ±¡ç‚¹ï¼ˆ<strong>èŠ‚ç‚¹è¢«æ‰“ä¸Š</strong><code>node.kubernetes.io/out-of-service</code><strong>æ±¡ç‚¹åï¼Œä¼šforce deleteæ‰é‚£ä¸ªèŠ‚ç‚¹ä¸Šä¸èƒ½å®¹å¿è¯¥æ±¡ç‚¹çš„pod</strong>ï¼‰</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>ç§‘å­¦ä¸Šç½‘--k8sç‰ˆ</title>
			<link>https://cvvz.fun/post/kexueshangwang/</link>
			<pubDate>Fri, 28 Apr 2023 23:14:10 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/kexueshangwang/</guid>
			<description>æ˜¨å¤©æŠ˜è…¾äº†ä¸€ä¸‹ï¼Œåœ¨è‡ªå»ºçš„aksé›†ç¾¤ä¸Šæ­å¥½äº†å‡ºå›½çš„æœºåœºï¼Œç”¨cert-managerè‡ªåŠ¨ç­¾å‘å’Œç»­æœŸè¯ä¹¦ã€åŸŸååŠ¨æ€çš„è§£æåˆ°service public ipï¼Œå³</description>
			<content type="html"><![CDATA[<blockquote>
<p>æ˜¨å¤©æŠ˜è…¾äº†ä¸€ä¸‹ï¼Œåœ¨è‡ªå»ºçš„aksé›†ç¾¤ä¸Šæ­å¥½äº†å‡ºå›½çš„æœºåœºï¼Œç”¨cert-managerè‡ªåŠ¨ç­¾å‘å’Œç»­æœŸè¯ä¹¦ã€åŸŸååŠ¨æ€çš„è§£æåˆ°service public ipï¼Œå³ä½¿ipè¢«å°ç¦äº†ä¹Ÿæ— æ‰€è°“ï¼Œæ¯•ç«Ÿäº‘åŸç”ŸğŸ¤£ã€‚ã€‚</p>
<p>åŸæ–‡åœ°å€ï¼š<a href="https://github.com/cvvz/k8s-playground/tree/master/gost#%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91-k8s%E7%89%88">https://github.com/cvvz/k8s-playground/tree/master/gost#ç§‘å­¦ä¸Šç½‘-k8sç‰ˆ</a></p>
</blockquote>
<h2 id="pre-requisite">pre-requisite</h2>
<ol>
<li>è´­ä¹°åŸŸå</li>
<li>å‡†å¤‡å¥½ä»¥ä¸‹å‘½ä»¤è¡Œå·¥å…·: <code>envsubst</code>, <code>cmctl</code>, <code>kubectl</code>, <code>az</code>, <code>helm</code></li>
</ol>
<h2 id="step-1-é…ç½®dns">step 1: é…ç½®DNS</h2>
<h3 id="step-11-åˆ›å»º-azure-dns-zone">step 1.1: åˆ›å»º azure dns zone</h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="nb">export</span> <span class="nv">AZURE_DEFAULTS_GROUP</span><span class="o">=</span>your-resource-group
<span class="ln">2</span><span class="nb">export</span> <span class="nv">DOMAIN_NAME</span><span class="o">=</span>your-domain-name 
<span class="ln">3</span>az network dns zone create --name <span class="nv">$DOMAIN_NAME</span>
</code></pre></div><h3 id="step-12-åœ¨åŸŸåæä¾›å•†çš„æ§åˆ¶å°ä¸­è®¾ç½®åŸŸådnsçš„ns-recordsä¸ºazure-authoritative-dns-servers">step 1.2: åœ¨åŸŸåæä¾›å•†çš„æ§åˆ¶å°ä¸­è®¾ç½®åŸŸåDNSçš„<code>NS records</code>ä¸º<code>Azure authoritative DNS servers</code></h3>
<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è·å– azure authoritative DNS servers åˆ—è¡¨ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>az network dns zone show --name <span class="nv">$DOMAIN_NAME</span> --query nameServers -o tsv
</code></pre></div><h3 id="step-13-ç­‰å¾…ns-record-ä¼ æ’­å®Œæˆå¯èƒ½éœ€è¦å‡ ä¸ªå°æ—¶">step 1.3: ç­‰å¾…ns record ä¼ æ’­å®Œæˆï¼Œå¯èƒ½éœ€è¦å‡ ä¸ªå°æ—¶ã€‚</h3>
<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤éªŒè¯æ˜¯å¦èƒ½æˆåŠŸè§£æåˆ°ns recordï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dig <span class="nv">$DOMAIN_NAME</span> ns +trace +nodnssec
</code></pre></div><h2 id="step-2-enable-workload-identity-feature">step 2: Enable workload identity feature</h2>
<blockquote>
<p>cert-manager éœ€è¦è°ƒç”¨azure apiï¼Œä½¿ç”¨<a href="https://learn.microsoft.com/en-us/azure/aks/workload-identity-overview">workload identity</a>è¿›è¡Œé‰´æƒ</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>az extension add --name aks-preview
<span class="ln">2</span>
<span class="ln">3</span>az feature register --namespace <span class="s2">&#34;Microsoft.ContainerService&#34;</span> --name <span class="s2">&#34;EnableWorkloadIdentityPreview&#34;</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="c1"># æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç›´åˆ°çŠ¶æ€å˜ä¸º Registeredï¼š</span>
<span class="ln">6</span>az feature list -o table --query <span class="s2">&#34;[?contains(name, &#39;Microsoft.ContainerService/EnableWorkloadIdentityPreview&#39;)].{Name:name,State:properties.state}&#34;</span>
<span class="ln">7</span>
<span class="ln">8</span>az provider register --namespace Microsoft.ContainerService
</code></pre></div><h2 id="step-3-åˆ›å»ºaksé›†ç¾¤">step 3ï¼š åˆ›å»ºaksé›†ç¾¤</h2>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span><span class="nb">export</span> <span class="nv">CLUSTER</span><span class="o">=</span>your-aks-cluster-name
<span class="ln"> 2</span><span class="c1"># regionå»ºè®®é€‰æ‹©east asiaï¼Œé¦™æ¸¯æœºæˆ¿ï¼Œç½‘ç»œå»¶è¿Ÿç›¸å¯¹æ›´å°</span>
<span class="ln"> 3</span><span class="nb">export</span> <span class="nv">AZURE_DEFAULTS_LOCATION</span><span class="o">=</span>eastasia
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c1"># åˆ›å»ºé›†ç¾¤</span>
<span class="ln"> 6</span>az aks create -n <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span> <span class="se">\
</span><span class="ln"> 7</span><span class="se"></span>--enable-oidc-issuer <span class="se">\
</span><span class="ln"> 8</span><span class="se"></span>--enable-workload-identity 
<span class="ln"> 9</span>
<span class="ln">10</span>az aks get-credentials -n <span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span>
</code></pre></div><h2 id="step-4-éƒ¨ç½²cert-manager">step 4: éƒ¨ç½²cert-manager</h2>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>cat <span class="s">&lt;&lt;EOF &gt; /tmp/values.yaml
</span><span class="ln"> 2</span><span class="s">podLabels:
</span><span class="ln"> 3</span><span class="s">  azure.workload.identity/use: &#34;true&#34;
</span><span class="ln"> 4</span><span class="s">serviceAccount:
</span><span class="ln"> 5</span><span class="s">  labels:
</span><span class="ln"> 6</span><span class="s">    azure.workload.identity/use: &#34;true&#34;
</span><span class="ln"> 7</span><span class="s">EOF</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span>helm repo add jetstack https://charts.jetstack.io
<span class="ln">10</span>helm repo update
<span class="ln">11</span>helm upgrade cert-manager jetstack/cert-manager <span class="se">\
</span><span class="ln">12</span><span class="se"></span>    --install <span class="se">\
</span><span class="ln">13</span><span class="se"></span>    --create-namespace <span class="se">\
</span><span class="ln">14</span><span class="se"></span>    --wait <span class="se">\
</span><span class="ln">15</span><span class="se"></span>    --namespace cert-manager <span class="se">\
</span><span class="ln">16</span><span class="se"></span>    --set <span class="nv">installCRDs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="ln">17</span><span class="se"></span>    --reuse-values <span class="se">\
</span><span class="ln">18</span><span class="se"></span>    --values /tmp/values.yaml
</code></pre></div><h2 id="step-5-ä¸ºcert-manageré…ç½®federated-workload-identity">step 5: ä¸ºcert-manageré…ç½®federated workload identity</h2>
<blockquote>
<p>eastasia regionä¸æ”¯æŒ workload identityï¼Œå‚è€ƒï¼š<a href="https://learn.microsoft.com/en-us/azure/active-directory/workload-identities/workload-identity-federation-considerations#unsupported-regions-user-assigned-managed-identities">https://learn.microsoft.com/en-us/azure/active-directory/workload-identities/workload-identity-federation-considerations#unsupported-regions-user-assigned-managed-identities</a></p>
<p>é€‰æ‹©ä¸€ä¸ªæ”¯æŒçš„regionï¼ˆæ¯”å¦‚japaneastï¼‰ä¸­åˆ›å»ºworkload identity</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span><span class="nb">export</span> <span class="nv">USER_ASSIGNED_IDENTITY_NAME</span><span class="o">=</span>your-cert-manager-identity-name
<span class="ln"> 2</span><span class="nb">export</span> <span class="nv">IDENTITY_RG</span><span class="o">=</span>your-identity-group
<span class="ln"> 3</span><span class="nb">export</span> <span class="nv">IDENTITY_RG_LOCATION</span><span class="o">=</span>your-identity-group-location
<span class="ln"> 4</span>
<span class="ln"> 5</span>az group create -n <span class="si">${</span><span class="nv">IDENTITY_RG</span><span class="si">}</span> -l <span class="si">${</span><span class="nv">IDENTITY_RG_LOCATION</span><span class="si">}</span>
<span class="ln"> 6</span>az identity create --name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER_ASSIGNED_IDENTITY_NAME</span><span class="si">}</span><span class="s2">&#34;</span> -g <span class="si">${</span><span class="nv">IDENTITY_RG</span><span class="si">}</span> -l <span class="si">${</span><span class="nv">IDENTITY_RG_LOCATION</span><span class="si">}</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="nb">export</span> <span class="nv">USER_ASSIGNED_IDENTITY_CLIENT_ID</span><span class="o">=</span><span class="k">$(</span>az identity show --name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER_ASSIGNED_IDENTITY_NAME</span><span class="si">}</span><span class="s2">&#34;</span> --query <span class="s1">&#39;clientId&#39;</span> -o tsv -g <span class="si">${</span><span class="nv">IDENTITY_RG</span><span class="si">}</span><span class="k">)</span>
<span class="ln"> 9</span>az role assignment create <span class="se">\
</span><span class="ln">10</span><span class="se"></span>    --role <span class="s2">&#34;DNS Zone Contributor&#34;</span> <span class="se">\
</span><span class="ln">11</span><span class="se"></span>    --assignee <span class="nv">$USER_ASSIGNED_IDENTITY_CLIENT_ID</span> <span class="se">\
</span><span class="ln">12</span><span class="se"></span>    --scope <span class="k">$(</span>az network dns zone show --name <span class="nv">$DOMAIN_NAME</span> -o tsv --query id<span class="k">)</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="c1"># cert-managerçš„service accountå’Œnamespace</span>
<span class="ln">15</span><span class="nb">export</span> <span class="nv">SERVICE_ACCOUNT_NAME</span><span class="o">=</span>cert-manager 
<span class="ln">16</span><span class="nb">export</span> <span class="nv">SERVICE_ACCOUNT_NAMESPACE</span><span class="o">=</span>cert-manager 
<span class="ln">17</span>
<span class="ln">18</span><span class="nb">export</span> <span class="nv">SERVICE_ACCOUNT_ISSUER</span><span class="o">=</span><span class="k">$(</span>az aks show --name <span class="nv">$CLUSTER</span> --query <span class="s2">&#34;oidcIssuerProfile.issuerUrl&#34;</span> -o tsv<span class="k">)</span>
<span class="ln">19</span>az identity federated-credential create <span class="se">\
</span><span class="ln">20</span><span class="se"></span>  --name <span class="s2">&#34;cert-manager&#34;</span> <span class="se">\
</span><span class="ln">21</span><span class="se"></span>  --identity-name <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER_ASSIGNED_IDENTITY_NAME</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="ln">22</span><span class="se"></span>  --issuer <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SERVICE_ACCOUNT_ISSUER</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="ln">23</span><span class="se"></span>  --subject <span class="s2">&#34;system:serviceaccount:</span><span class="si">${</span><span class="nv">SERVICE_ACCOUNT_NAMESPACE</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">SERVICE_ACCOUNT_NAME</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="ln">24</span><span class="se"></span>  -g <span class="si">${</span><span class="nv">IDENTITY_RG</span><span class="si">}</span>
</code></pre></div><h2 id="step-6-ç”Ÿæˆè¯ä¹¦">step 6: ç”Ÿæˆè¯ä¹¦</h2>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span><span class="nb">export</span> <span class="nv">GOST_NS</span><span class="o">=</span>gost
<span class="ln"> 2</span>kubectl create ns <span class="nv">$GOST_NS</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c1"># åˆ›å»ºissuer</span>
<span class="ln"> 5</span><span class="nb">export</span> <span class="nv">EMAIL_ADDRESS</span><span class="o">=</span>&lt;email-address&gt; 
<span class="ln"> 6</span><span class="nb">export</span> <span class="nv">AZURE_SUBSCRIPTION_ID</span><span class="o">=</span>&lt;your-subscription-id&gt;  
<span class="ln"> 7</span>wget https://raw.githubusercontent.com/cvvz/k8s-playground/master/gost/clusterissuer-lets-encrypt.yaml 
<span class="ln"> 8</span>envsubst &lt; clusterissuer-lets-encrypt.yaml <span class="p">|</span> kubectl apply -f  -
<span class="ln"> 9</span>kubectl describe clusterissuer letsencrypt-production
<span class="ln">10</span>
<span class="ln">11</span><span class="c1"># åˆ›å»ºCertificate</span>
<span class="ln">12</span>wget https://raw.githubusercontent.com/cvvz/k8s-playground/master/gost/certificate.yaml 
<span class="ln">13</span>envsubst &lt; certificate.yaml <span class="p">|</span> kubectl apply -f -
<span class="ln">14</span>
<span class="ln">15</span><span class="c1"># éªŒè¯è¯ä¹¦çŠ¶æ€</span>
<span class="ln">16</span>cmctl status certificate www -n <span class="nv">$GOST_NS</span>
<span class="ln">17</span>cmctl inspect secret www-tls -n <span class="nv">$GOST_NS</span>
</code></pre></div><h2 id="step-7-éƒ¨ç½²gostæœåŠ¡">step 7: éƒ¨ç½²gostæœåŠ¡</h2>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span><span class="nb">export</span> <span class="nv">AZURE_LOADBALANCER_DNS_LABEL_NAME</span><span class="o">=</span>lb-<span class="k">$(</span>uuidgen<span class="k">)</span> 
<span class="ln"> 2</span><span class="nb">export</span> <span class="nv">USER</span><span class="o">=</span>your-user-name
<span class="ln"> 3</span><span class="nb">export</span> <span class="nv">PASSWORD</span><span class="o">=</span>your-password
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c1"># deployment</span>
<span class="ln"> 6</span>wget https://raw.githubusercontent.com/cvvz/k8s-playground/master/gost/deployment.yaml
<span class="ln"> 7</span>envsubst &lt; deployment.yaml <span class="p">|</span> kubectl apply -f -
<span class="ln"> 8</span><span class="c1"># service</span>
<span class="ln"> 9</span>wget https://raw.githubusercontent.com/cvvz/k8s-playground/master/gost/service.yaml
<span class="ln">10</span>envsubst &lt; service.yaml <span class="p">|</span> kubectl apply -f -
</code></pre></div><h2 id="step-8-è®¾ç½®dns-record">step 8: è®¾ç½®dns record</h2>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="c1"># è®¾ç½®www A record</span>
<span class="ln">2</span>az network dns record-set cname set-record <span class="se">\
</span><span class="ln">3</span><span class="se"></span>    --zone-name <span class="nv">$DOMAIN_NAME</span> <span class="se">\
</span><span class="ln">4</span><span class="se"></span>    --cname <span class="nv">$AZURE_LOADBALANCER_DNS_LABEL_NAME</span>.<span class="nv">$AZURE_DEFAULTS_LOCATION</span>.cloudapp.azure.com <span class="se">\
</span><span class="ln">5</span><span class="se"></span>    --record-set-name www
<span class="ln">6</span>
<span class="ln">7</span><span class="c1"># éªŒè¯å¯ä»¥è§£æåˆ°service external ip</span>
<span class="ln">8</span>dig www.<span class="nv">$DOMAIN_NAME</span> A
</code></pre></div><blockquote>
<p>ä¸ç®¡podå’Œservice ipæ€ä¹ˆå˜åŒ–ï¼Œåªè¦<code>$AZURE_LOADBALANCER_DNS_LABEL_NAME</code>ä¸å˜ï¼ŒåŸŸåå§‹ç»ˆä¼šè§£æåˆ°serviceçš„public ipã€‚</p>
<p>æ‰€ä»¥å°±ç®—ipè¢«å°ç¦ï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªserviceç”Ÿæˆæ–°çš„public ipå°±è¡Œäº†ã€‚</p>
</blockquote>
<h2 id="step-9éªŒè¯">step 9ï¼šéªŒè¯</h2>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>curl -v <span class="s2">&#34;https://www.google.com&#34;</span> --proxy <span class="s2">&#34;https://www.</span><span class="nv">$DOMAIN_NAME</span><span class="s2">&#34;</span> --proxy-user <span class="nv">$USER</span>:<span class="nv">$PASSWORD</span>
</code></pre></div>]]></content>
		</item>
		
		<item>
			<title>Ginkgoæºç åˆ†æ</title>
			<link>https://cvvz.fun/post/ginkgo/</link>
			<pubDate>Wed, 05 Apr 2023 08:56:03 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/ginkgo/</guid>
			<description>ginkgo cmd æ‰§è¡Œginkgo cmdé»˜è®¤è¿è¡Œçš„æ˜¯ginkgo run å…¥å£å‡½æ•° 1func (r *SpecRunner) RunSpecs(args []string, additionalArgs []string) { ä¸»è¦åšä¸¤ä»¶äº‹ï¼Œç¼–è¯‘å’Œè¿è¡Œsuite ç¼–è¯‘ ä½¿ç”¨ go test -c -o å¾—åˆ°.test</description>
			<content type="html"><![CDATA[<h1 id="ginkgo-cmd">ginkgo cmd</h1>
<p>æ‰§è¡Œginkgo cmdé»˜è®¤è¿è¡Œçš„æ˜¯ginkgo run</p>
<figure>
    <img src="/ginkgo/Untitled.png" width="700px"/> 
</figure>

<p>å…¥å£å‡½æ•°</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">SpecRunner</span><span class="p">)</span> <span class="nf">RunSpecs</span><span class="p">(</span><span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">additionalArgs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p>ä¸»è¦åšä¸¤ä»¶äº‹ï¼Œç¼–è¯‘å’Œè¿è¡Œsuite</p>
<h2 id="ç¼–è¯‘">ç¼–è¯‘</h2>
<figure>
    <img src="/ginkgo/Untitled%201.png" width="700px"/> 
</figure>

<p>ä½¿ç”¨ <code>go test -c -o</code> å¾—åˆ°<code>.test</code>å¯æ‰§è¡Œæ–‡ä»¶</p>
<figure>
    <img src="/ginkgo/gotest.png" width="700px"/> 
</figure>

<p>è¦ç†è§£.testæ–‡ä»¶ä¸­çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆspecï¼‰æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Œå°±è¦ç†è§£ginkgoæ˜¯æ€ä¹ˆæ„é€ specs treeçš„</p>
<h3 id="æ„é€ specs-tree">æ„é€ specs tree</h3>
<p><code>Describe</code>ç­‰æ˜¯container Nodeï¼Œ<code>BeforeXXX</code>å’Œ<code>AfterXXX</code>ç­‰æ˜¯setup Nodeï¼Œ<code>It</code>æ˜¯subject Nodeã€‚<code>Describe</code>é€šè¿‡<code>var _ = Describe</code>çš„æ–¹å¼å®ç°åœ¨golangæºæ–‡ä»¶é¡¶å±‚æ‰§è¡Œå‡½æ•°ï¼Œè¿™ä¼šä½¿å¾—åœ¨ç¼–è¯‘æ—¶æœ€å…ˆæ‰§è¡ŒDescribeã€‚</p>
<p>ä»–ä»¬åº•å±‚éƒ½æ˜¯é€šè¿‡<code>pushNode</code>ï¼Œä»å¤–å‘å†…ä¸€å±‚ä¸€å±‚çš„push Nodeï¼Œç„¶ååœ¨<code>RunSpecs</code>å…¥å£ä¸­çš„<code>BuildTree</code>æ„é€ å‡ºå¦‚ä¸‹çš„specs treeæ•°æ®ç»“æ„ï¼š</p>
<figure>
    <img src="/ginkgo/image3.png" width="1000px"/> 
</figure>

<h2 id="è¿è¡Œ">è¿è¡Œ</h2>
<h3 id="ginkgo">ginkgo</h3>
<p>åœ¨SUITE_LOOPä¸­å¾ªç¯è¿è¡Œæ¯ä¸€ä¸ªç¼–è¯‘å‡ºæ¥çš„<code>.test</code>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="nx">suites</span><span class="p">[</span><span class="nx">suiteIdx</span><span class="p">]</span> <span class="p">=</span> <span class="nx">internal</span><span class="p">.</span><span class="nf">RunCompiledSuite</span><span class="p">(</span><span class="nx">suites</span><span class="p">[</span><span class="nx">suiteIdx</span><span class="p">],</span> <span class="nx">r</span><span class="p">.</span><span class="nx">suiteConfig</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">reporterConfig</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">cliConfig</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">goFlagsConfig</span><span class="p">,</span> <span class="nx">additionalArgs</span><span class="p">)</span>
</code></pre></div><p>æ¯ä¸ªsuiteéƒ½ä¼šç¼–è¯‘æˆä¸€ä¸ª<code>.test</code>ï¼Œå¦‚æœæœ‰å¤šä¸ªtest suiteï¼Œä¸€ä¸ªä¸€ä¸ªçš„ç¼–è¯‘è¿è¡Œ</p>
<p>å¦‚æœä»¥parallelçš„æ¨¡å¼è¿è¡Œï¼Œåˆ™å¯åŠ¨server</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">parallel_support</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">numProcs</span><span class="p">,</span> <span class="nx">reporters</span><span class="p">.</span><span class="nf">NewDefaultReporter</span><span class="p">(</span><span class="nx">reporterConfig</span><span class="p">,</span> <span class="nx">formatter</span><span class="p">.</span><span class="nx">ColorableStdOut</span><span class="p">))</span>
</code></pre></div><p>ç”Ÿæˆgo test flagï¼Œå¦‚æœè¿è¡Œåœ¨parallelæ¨¡å¼ï¼Œå¯åŠ¨å¤šä¸ª.testè¿›ç¨‹å¹¶å‘æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚ginkgoä¼šæ ¹æ®æœºå™¨çš„æ ¸å¿ƒæ•°å†³å®šå¯åŠ¨å¤šå°‘ä¸ªtestè¿›ç¨‹ï¼Œæ¯ä¸ªtestè¿›ç¨‹è¿è¡Œçš„éƒ½æ˜¯åŒä¸€ç»„specsï¼Œä½†æ˜¯testå…·ä½“è¿è¡Œå“ªä¸€ä¸ªspecç”±ginkgo serverå†³å®šã€‚</p>
<figure>
    <img src="/ginkgo/Untitled%202.png" width="1000px"/> 
</figure>

<p>å¯åŠ¨goroutineç­‰å¾…å­è¿›ç¨‹é€€å‡ºå¹¶å¡ä½ç­‰å¾…ç»“æœ</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 2</span>	<span class="nx">cmd</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
<span class="ln"> 3</span>	<span class="nx">exitStatus</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">ProcessState</span><span class="p">.</span><span class="nf">Sys</span><span class="p">().(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">WaitStatus</span><span class="p">).</span><span class="nf">ExitStatus</span><span class="p">()</span>
<span class="ln"> 4</span>	<span class="nx">procResults</span> <span class="o">&lt;-</span> <span class="nx">procResult</span><span class="p">{</span>
<span class="ln"> 5</span>		<span class="nx">passed</span><span class="p">:</span>               <span class="p">(</span><span class="nx">exitStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">exitStatus</span> <span class="o">==</span> <span class="nx">types</span><span class="p">.</span><span class="nx">GINKGO_FOCUS_EXIT_CODE</span><span class="p">),</span>
<span class="ln"> 6</span>		<span class="nx">hasProgrammaticFocus</span><span class="p">:</span> <span class="nx">exitStatus</span> <span class="o">==</span> <span class="nx">types</span><span class="p">.</span><span class="nx">GINKGO_FOCUS_EXIT_CODE</span><span class="p">,</span>
<span class="ln"> 7</span>	<span class="p">}</span>
<span class="ln"> 8</span><span class="p">}()</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="c1">// ç„¶åå¡ä½ç­‰å¾…å­è¿›ç¨‹ç»“æœ
</span><span class="ln">11</span><span class="c1"></span><span class="nx">passed</span> <span class="o">:=</span> <span class="kc">true</span>
<span class="ln">12</span><span class="k">for</span> <span class="nx">proc</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">proc</span> <span class="o">&lt;=</span> <span class="nx">cliConfig</span><span class="p">.</span><span class="nf">ComputedProcs</span><span class="p">();</span> <span class="nx">proc</span><span class="o">++</span> <span class="p">{</span>
<span class="ln">13</span>	<span class="nx">result</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">procResults</span>
<span class="ln">14</span>	<span class="nx">passed</span> <span class="p">=</span> <span class="nx">passed</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">passed</span>
<span class="ln">15</span>	<span class="nx">suite</span><span class="p">.</span><span class="nx">HasProgrammaticFocus</span> <span class="p">=</span> <span class="nx">suite</span><span class="p">.</span><span class="nx">HasProgrammaticFocus</span> <span class="o">||</span> <span class="nx">result</span><span class="p">.</span><span class="nx">hasProgrammaticFocus</span>
<span class="ln">16</span><span class="p">}</span>
</code></pre></div><h3 id="test">.test</h3>
<p>.testæ–‡ä»¶çš„å…¥å£ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="kd">func</span> <span class="nf">TestE2E</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">2</span>	<span class="nx">gomega</span><span class="p">.</span><span class="nf">RegisterFailHandler</span><span class="p">(</span><span class="nx">ginkgo</span><span class="p">.</span><span class="nx">Fail</span><span class="p">)</span>
<span class="ln">3</span>	<span class="nx">ginkgo</span><span class="p">.</span><span class="nf">RunSpecs</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s">&#34;Sample Suite&#34;</span><span class="p">)</span>
<span class="ln">4</span><span class="p">}</span>
</code></pre></div><p>å¦‚æœè¿è¡Œåœ¨parallelæ¨¡å¼ï¼Œåˆ™å¯åŠ¨clientå¹¶è¿æ¥server</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="nx">client</span> <span class="p">=</span> <span class="nx">parallel_support</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">suiteConfig</span><span class="p">.</span><span class="nx">ParallelHost</span><span class="p">)</span>
<span class="ln">2</span><span class="k">if</span> <span class="p">!</span><span class="nx">client</span><span class="p">.</span><span class="nf">Connect</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">3</span>	<span class="nx">client</span> <span class="p">=</span> <span class="kc">nil</span>
<span class="ln">4</span>	<span class="nf">exitIfErr</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">GinkgoErrors</span><span class="p">.</span><span class="nf">UnreachableParallelHost</span><span class="p">(</span><span class="nx">suiteConfig</span><span class="p">.</span><span class="nx">ParallelHost</span><span class="p">))</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p>Build specs tree</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="nx">err</span> <span class="o">:=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Suite</span><span class="p">.</span><span class="nf">BuildTree</span><span class="p">()</span>
</code></pre></div><p>Run Suite</p>
<ol>
<li>
<p>æŠŠspecséšæœºæ‰“æ•£åˆ†ç»„</p>
<blockquote>
<p>ordered specsåˆ†åœ¨ä¸€ç»„ï¼Œæ™®é€šçš„specå•ç‹¬ä¸€ä¸ªæ˜¯ä¸€ç»„ï¼Œserial specsåˆ†ä¸ºä¸€ç»„</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="nx">groupedSpecIndices</span><span class="p">,</span> <span class="nx">serialGroupedSpecIndices</span> <span class="o">:=</span> <span class="nf">OrderSpecs</span><span class="p">(</span><span class="nx">specs</span><span class="p">,</span> <span class="nx">suite</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span>
</code></pre></div></li>
<li>
<p>ä»¥groupä¸ºå•ä½runSpecsã€‚å…·ä½“ä¸‹ä¸€æ­¥è¿è¡Œå“ªä¸€ç»„ä»serverè·å¾—ä¸‹æ ‡</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="nx">nextIndex</span> <span class="p">=</span> <span class="nx">suite</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">FetchNextCounter</span>
</code></pre></div></li>
<li>
<p>å¦‚æœæ˜¯serial groupï¼Œé‚£ä¹ˆå¿…é¡»å½“å‰æ˜¯#1 processï¼Œè€Œä¸”è¦ç­‰åˆ°å…¶ä»–processéƒ½é€€å‡ºã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="k">if</span> <span class="nx">suite</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ParallelProcess</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">serialGroupedSpecIndices</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
<span class="ln">2</span>    <span class="nx">groupedSpecIndices</span><span class="p">,</span> <span class="nx">serialGroupedSpecIndices</span><span class="p">,</span> <span class="nx">nextIndex</span> <span class="p">=</span> <span class="nx">serialGroupedSpecIndices</span><span class="p">,</span> <span class="nx">GroupedSpecIndices</span><span class="p">{},</span> <span class="nf">MakeIncrementingIndexCounter</span><span class="p">()</span>
<span class="ln">3</span>    <span class="nx">suite</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">BlockUntilNonprimaryProcsHaveFinished</span><span class="p">()</span>
<span class="ln">4</span>    <span class="k">continue</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div></li>
<li>
<p>å¼€å§‹Run group specs</p>
<p>æ¯ä¸€ç»„é‡Œå¯èƒ½å¤šä¸ªspecsï¼Œä¸€ä¸ªspecä¸€ä¸ªspcçš„æ‰§è¡Œ</p>
<p>runSpec</p>
<ol>
<li>
<p>åˆ¤æ–­interruptStatusï¼Œæ¥å†³å®šè¦ä¸è¦skip è¿™ä¸ªspec</p>
</li>
<li>
<p>æ ¹æ®attempt derocatorçš„å®šä¹‰ï¼Œå°è¯•attemptsæ¬¡</p>
</li>
<li>
<p>specä¸­çš„nodesåˆ†ä¸ºä¸¤æ‰¹æ‰§è¡Œï¼Œå…ˆæŠŠspecä¸­çš„setup Nodeå’Œsubject Nodeï¼ˆItï¼‰ç»„æˆä¸ºä¸€æ‰¹nodesä¾æ¬¡è¿è¡Œ</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="nx">nodes</span> <span class="o">:=</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nf">WithType</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeTypeBeforeAll</span><span class="p">)</span>
<span class="ln">2</span><span class="nx">nodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nf">WithType</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeTypeBeforeEach</span><span class="p">)</span><span class="o">...</span><span class="p">).</span><span class="nf">SortedByAscendingNestingLevel</span><span class="p">()</span>
<span class="ln">3</span><span class="nx">nodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nf">WithType</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeTypeJustBeforeEach</span><span class="p">).</span><span class="nf">SortedByAscendingNestingLevel</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
<span class="ln">4</span><span class="nx">nodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nf">FirstNodeWithType</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeTypeIt</span><span class="p">))</span>
</code></pre></div></li>
<li>
<p>å†æŠŠcleanup Nodeç»„æˆä¸€æ‰¹Nodesä¾æ¬¡è¿è¡Œã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="nx">nodes</span> <span class="o">:=</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nf">WithType</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeTypeAfterEach</span><span class="p">)</span>
<span class="ln">2</span><span class="nx">nodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nf">WithType</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeTypeAfterAll</span><span class="p">)</span><span class="o">...</span><span class="p">).</span><span class="nf">SortedByDescendingNestingLevel</span><span class="p">()</span>
<span class="ln">3</span><span class="nx">nodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nf">WithType</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">NodeTypeJustAfterEach</span><span class="p">).</span><span class="nf">SortedByDescendingNestingLevel</span><span class="p">(),</span> <span class="nx">nodes</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></li>
<li>
<p>nodesä¸­çš„Nodeä¸€ä¸ªä¸€ä¸ªçš„æ‰§è¡Œï¼ŒrunNode</p>
<p>runNode</p>
<ol>
<li>
<p>åˆ¤æ–­interruptStatusï¼Œæ¥å†³å®šNodeè¦ä¸è¦è·³è¿‡ï¼Œä½†æ˜¯cleanupã€reportçš„Nodeå¿…é¡»è¦æ”¶åˆ°å¤šæ¬¡ä¿¡å·æ‰ä¼šçœŸæ­£è·³è¿‡ã€‚</p>
</li>
<li>
<p>Itä¸­ç”¨æˆ·å®šä¹‰çš„closureåœ¨åº•å±‚å°±æ˜¯é€šè¿‡goroutineæ‰§è¡Œï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="nx">finished</span> <span class="o">:=</span> <span class="kc">false</span>
<span class="ln"> 3</span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 4</span>        <span class="k">if</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="p">!</span><span class="nx">finished</span> <span class="p">{</span>
<span class="ln"> 5</span>            <span class="nx">suite</span><span class="p">.</span><span class="nx">failer</span><span class="p">.</span><span class="nf">Panic</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nf">NewCodeLocationWithStackTrace</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">e</span><span class="p">)</span>
<span class="ln"> 6</span>        <span class="p">}</span>
<span class="ln"> 7</span>           
<span class="ln"> 8</span>        <span class="nx">outcomeFromRun</span><span class="p">,</span> <span class="nx">failureFromRun</span> <span class="o">:=</span> <span class="nx">suite</span><span class="p">.</span><span class="nx">failer</span><span class="p">.</span><span class="nf">Drain</span><span class="p">()</span>
<span class="ln"> 9</span>        <span class="nx">failureFromRun</span><span class="p">.</span><span class="nx">TimelineLocation</span> <span class="p">=</span> <span class="nx">suite</span><span class="p">.</span><span class="nf">generateTimelineLocation</span><span class="p">()</span>
<span class="ln">10</span>        <span class="nx">outcomeC</span> <span class="o">&lt;-</span> <span class="nx">outcomeFromRun</span>
<span class="ln">11</span>        <span class="nx">failureC</span> <span class="o">&lt;-</span> <span class="nx">failureFromRun</span>
<span class="ln">12</span>    <span class="p">}()</span>
<span class="ln">13</span>           
<span class="ln">14</span>    <span class="c1">// It ä¸­å®šä¹‰çš„closure
</span><span class="ln">15</span><span class="c1"></span>    <span class="nx">node</span><span class="p">.</span><span class="nf">Body</span><span class="p">(</span><span class="nx">sc</span><span class="p">)</span>
<span class="ln">16</span>    <span class="nx">finished</span> <span class="p">=</span> <span class="kc">true</span>
<span class="ln">17</span><span class="p">}()</span>
</code></pre></div></li>
<li>
<p>è¿™ä¸ªgoroutineæœ‰å‡ ä¸ªé€€å‡ºæ¡ä»¶ï¼š</p>
<figure>
    <img src="/ginkgo/Untitled%203.png" width="800px"/> 
</figure>

<p>è¶…æ—¶å’Œinterruptçš„æƒ…å†µä¸‹éƒ½ä¼šå†ç­‰å¾…gracePeriodï¼Œä½†æ˜¯å¦‚æœNodeæ²¡å®šä¹‰contextï¼Œåˆ™gracePeriodä¸º0</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="k">if</span> <span class="p">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">HasContext</span> <span class="p">{</span>
<span class="ln">2</span>    <span class="nx">gracePeriod</span> <span class="p">=</span> <span class="mi">0</span>
<span class="ln">3</span><span class="p">}</span>
</code></pre></div><p>å¦‚æœgracePeriodæ—¶é—´åˆ°äº†Nodeè¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œé‚£å°±leak Nodeï¼Œä¹Ÿå°±æ˜¯leak goroutineï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ— æ³•é¢„æµ‹çš„è¡Œä¸ºã€‚</p>
<p><strong>interruptæœºåˆ¶ï¼š</strong></p>
<p>è¿™ä¸ªchannelæ˜¯ä»interrupt handlerå¤åˆ¶è¿‡æ¥çš„ï¼Œæœ‰å‡ ç§interruptçš„æƒ…å†µ</p>
<ul>
<li>
<p>interrupt handleræ¯éš”500mså»æœåŠ¡ç«¯è½®è¯¢æ˜¯å¦å¯ä»¥Abortã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™å¯ä»¥Abortå‘¢ï¼šå¦‚æœè¿è¡Œåœ¨paralleæ¨¡å¼ï¼Œå¹¶ä¸”å¼€å¯äº†fail-fastï¼Œè¿™æ ·æœ‰ä»»ä½•ä¸€ä¸ªprocesså¤±è´¥ï¼Œéƒ½ä¼šé€šçŸ¥æœåŠ¡ç«¯ç°åœ¨å¯ä»¥å¼€å§‹Abortäº†</p>
<figure>
    <img src="/ginkgo/Untitled%204.png" width="800px"/> 
</figure>

<p>å¦‚æœå¯ä»¥é‚£ä¹ˆå°±ä¼šè§¦å‘è¿™ä¸ªinterrupt channel closeã€‚</p>
<blockquote>
<p>è¿™ä¸ªåœ°æ–¹çš„å®ç°æ˜¯é€šè¿‡è½®è¯¢æ¥å®ç°çš„ï¼ŒçŠ¶æ€æ›´æ–°ä¼šæœ‰500msçš„å»¶è¿Ÿã€‚å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>åœ¨è¿è¡ŒSerialçš„Nodeæˆ–è€…cleanup Nodeæ—¶ï¼Œä¼šå…ˆæ£€æŸ¥ä¸€ä¸‹çŠ¶æ€ï¼Œå†å†³å®šæ˜¯å¦è¿è¡Œã€‚ä½†æ˜¯å¯èƒ½å½“æ—¶serverç«¯å·²ç»è®¾ç½®ä¸ºéœ€è¦abortäº†ï¼Œå¯æ˜¯è¿˜éœ€è¦ç­‰500msæ‰èƒ½æ‹¿åˆ°å®é™…çŠ¶æ€ã€‚è¿™ä¸ªæ—¶å€™ä¼šå»è¿è¡ŒNodeï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯åº”è¯¥skipçš„ã€‚</li>
<li>cleanup Nodeåº”è¯¥ç›´æ¥å¿½ç•¥Abortçš„channelã€‚</li>
</ol>
<p>æˆ‘æäº¤äº†ä¸€ä¸ªPR <a href="https://github.com/onsi/ginkgo/pull/1178">https://github.com/onsi/ginkgo/pull/1178</a> è§£å†³äº†è¿™ä¸ªé—®é¢˜</p>
</blockquote>
</li>
<li>
<p>æ”¶åˆ°SIGINTå’ŒSIGTERMä¿¡å·</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="kd">func</span> <span class="nf">NewInterruptHandler</span><span class="p">(</span><span class="nx">client</span> <span class="nx">parallel_support</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">signals</span> <span class="o">...</span><span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">)</span> <span class="o">*</span><span class="nx">InterruptHandler</span> <span class="p">{</span>
<span class="ln">2</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">signals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
<span class="ln">3</span>        <span class="nx">signals</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">{</span><span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">}</span>
<span class="ln">4</span>    <span class="p">}</span>
</code></pre></div></li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>è¿è¡ŒAfterSuiteCleanup Node</p>
]]></content>
		</item>
		
		<item>
			<title>go-daemon åŸç†è§£æ</title>
			<link>https://cvvz.fun/post/go-daemon/</link>
			<pubDate>Sun, 19 Mar 2023 09:38:40 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/go-daemon/</guid>
			<description>go-daemonæ˜¯golangçš„forké—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œåœ¨è§£å†³blobfuse2 mounté—®é¢˜æ—¶çœ‹äº†ä¸€égo-daemonæºç ï¼Œåœ¨è¿™é‡Œ</description>
			<content type="html"><![CDATA[<blockquote>
<p><a href="https://github.com/sevlyar/go-daemon">go-daemon</a>æ˜¯golangçš„<a href="https://github.com/golang/go/issues/227">forké—®é¢˜</a>çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œåœ¨è§£å†³<a href="https://cvvz.github.io/post/blobfuse2/">blobfuse2 mounté—®é¢˜</a>æ—¶çœ‹äº†ä¸€égo-daemonæºç ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚</p>
</blockquote>
<p>go-daemoné€šè¿‡<a href="https://github.com/sevlyar/go-daemon/blob/master/daemon.go#L30">Reborn</a>å‡½æ•°æ¥æ¨¡æ‹Ÿfork</p>
<figure>
    <img src="/go-daemon/reborn.png" width="500px"/> 
</figure>

<p>è¿”å›å€¼childä¸ºnilæ—¶æ‰§è¡Œå­è¿›ç¨‹çš„ä»£ç ï¼Œä¸ä¸ºnilæ—¶æ‰§è¡Œçˆ¶è¿›ç¨‹çš„ä»£ç ï¼š</p>
<figure>
    <img src="/go-daemon/child.jpeg" width="600px"/> 
</figure>

<p>çˆ¶å­è¿›ç¨‹è¿è¡Œçš„æ˜¯åŒä¸€å¥—ä»£ç ï¼Œåœ¨åº•å±‚æ˜¯é€šè¿‡envæ¥åŒºåˆ†å½“å‰æ‰§è¡Œçˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹çš„ä»£ç å—ã€‚ä¹Ÿå°±æ˜¯è¯´çˆ¶è¿›ç¨‹åœ¨å¯åŠ¨å­è¿›ç¨‹çš„æ—¶å€™ä¼šè®¾ç½®ä¸€ä¸ªç‰¹æ®Šçš„envï¼Œç„¶åé€šè¿‡<code>os.StartProcess</code>ä¼ å…¥envå¹¶å¯åŠ¨å­è¿›ç¨‹æ‰§è¡Œå½“å‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<figure>
    <img src="/go-daemon/startchild.png" width="550px"/> 
</figure>

<p><code>os.StartProcess</code>åº•å±‚è°ƒç”¨çš„æ˜¯<code>forkExec</code>ï¼Œå³fork + execï¼Œç”¨æ–°è¿›ç¨‹è¦†ç›–forkå‡ºæ¥çš„å­è¿›ç¨‹ã€‚å› æ­¤çˆ¶å­è¿›ç¨‹é™¤äº†æ‰§è¡ŒåŒä¸€ä»½ä»£ç ä»¥å¤–ï¼Œä¸å…±äº«ä»»ä½•èµ„æºï¼Œåªèƒ½é€šè¿‡åœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶ä¸»åŠ¨è®¾ç½®ä¸€äº›attributesæ¥å®ç°éƒ¨åˆ†èµ„æºå…±äº«ã€‚</p>
<p>æ¯”å¦‚go-daemonå°±æ˜¯åœ¨çˆ¶è¿›ç¨‹ä¸­æ‰“å¼€PIPEï¼Œç„¶åè®¾ç½®å­è¿›ç¨‹çš„stdinä¸ºPIPEçš„readç«¯fd</p>
<figure>
    <img src="/go-daemon/file.png" width="400px"/> 
</figure>

<p>çˆ¶è¿›ç¨‹å‘PIPEçš„writeç«¯å†™å…¥æ•°æ®ï¼š</p>
<figure>
    <img src="/go-daemon/write.png" width="400px"/> 
</figure>

<p>å­è¿›ç¨‹å¯åŠ¨æ—¶ä»stdinè¯»å–æ•°æ®å¹¶è§£æ</p>
<figure>
    <img src="/go-daemon/read.png" width="400px"/> 
</figure>

<p>ä¹‹åæŠŠfd 3ï¼ˆåœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶è®¾ç½®ä¸ºäº†<code>/dev/null</code>ï¼‰dupåˆ°stdinï¼Œç›¸å½“äºå…³é—­äº†stdin</p>
<figure>
    <img src="/go-daemon/dup.png" width="400px"/> 
</figure>

]]></content>
		</item>
		
		<item>
			<title>è®°ä¸€æ¬¡background fuse mounté—®é¢˜çš„è§£å†³è¿‡ç¨‹</title>
			<link>https://cvvz.fun/post/blobfuse2/</link>
			<pubDate>Sat, 18 Mar 2023 14:27:04 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/blobfuse2/</guid>
			<description>blobfuse2 æ˜¯å¾®è½¯å¼€æºçš„ä½¿ç”¨ golang + libfuse å®ç°çš„fuse æ–‡ä»¶ç³»ç»Ÿã€‚blob csi driver æ˜¯å…¶å¯¹åº”çš„csi driverå®ç°ã€‚æˆ‘ä»¬æœ€è¿‘ç¢°åˆ°äº†ä¸¤ä¸ªbackground fuse mou</description>
			<content type="html"><![CDATA[<blockquote>
<p><a href="https://github.com/Azure/azure-storage-fuse#blobfuse2---a-microsoft-supported-azure-storage-fuse-driver">blobfuse2</a> æ˜¯å¾®è½¯å¼€æºçš„ä½¿ç”¨ golang + libfuse å®ç°çš„fuse æ–‡ä»¶ç³»ç»Ÿã€‚<a href="https://github.com/kubernetes-sigs/blob-csi-driver">blob csi driver</a> æ˜¯å…¶å¯¹åº”çš„csi driverå®ç°ã€‚æˆ‘ä»¬æœ€è¿‘ç¢°åˆ°äº†ä¸¤ä¸ªbackground fuse mountå¼•å‘çš„é—®é¢˜ï¼Œæœ€åå®šä½åˆ°äº†æ˜¯ç›¸åŒæ ¹å› å¹¶è§£å†³ï¼šåœ¨PR<a href="https://github.com/Azure/azure-storage-fuse/pull/1088">#1088</a>é‡Œåˆ†æäº†é—®é¢˜åŸå› å’Œè§£å†³åŠæ³•ï¼Œè¿™é‡Œä¹Ÿè®°å½•ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ã€‚</p>
</blockquote>
<h2 id="é—®é¢˜ç°è±¡">é—®é¢˜ç°è±¡</h2>
<p>æˆ‘ä»¬å…ˆåç¢°åˆ°äº†ä¸¤ä¸ªé—®é¢˜ï¼Œé—®é¢˜ç°è±¡ä¸åŒï¼Œä½†æ˜¯æ˜¯ç”±åŒä¸€ä¸ªæ ¹å› é€ æˆçš„ï¼š</p>
<ul>
<li>
<p>é—®é¢˜ä¸€ï¼š æ‰§è¡Œ<code>blobfuse2 mount</code>æŒ‚è½½å®é™…å¤±è´¥ï¼Œä½†æ²¡æœ‰åœ¨ç»ˆç«¯æˆ–è€…æ—¥å¿—é‡Œæç¤ºä»»ä½•é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸”errnoè¿”å›ä¸º0ï¼š <a href="https://github.com/Azure/azure-storage-fuse/issues/1081">#1081</a>ã€‚è¿™å¯¼è‡´blob csi driverå°†Podç›®å½•æŒ‚è½½åˆ°äº†æœ¬åœ°ç›˜ã€‚</p>
</li>
<li>
<p>é—®é¢˜äºŒï¼šåˆ é™¤ä½¿ç”¨äº†blobfuse2ä½œä¸ºæŒ‚è½½ç‚¹çš„Podåï¼Œæ–°åˆ›å»ºå‡ºæ¥çš„Podæ•°æ®ä¸¢å¤±ï¼š<a href="https://github.com/Azure/azure-storage-fuse/issues/1079#issuecomment-1462302216">#1079</a>ã€‚</p>
<ol>
<li>
<p>è¿™ä¸ªé—®é¢˜é¦–å…ˆæŸ¥åˆ°çš„åŸå› æ˜¯ï¼šåœ¨åˆ é™¤è€Podæ—¶ï¼Œæ‰§è¡Œ<code>NodeUnPublishVolume</code>é˜¶æ®µï¼Œunmount bind mountpointæ—¶ï¼Œä¼šå°†source mountpointï¼Œä¹Ÿå°±æ˜¯blobfuse2çš„mount pointä¹Ÿä¸€å¹¶unmountæ‰ã€‚è¿™æ ·å°±ä¼šå¯¼è‡´åœ¨æ–°Podåˆ›å»ºæ—¶ï¼Œæ‰§è¡Œ<code>NodePublishVolume</code>é˜¶æ®µï¼Œbind mountçš„source mountpointå…¶å®æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚</p>
</li>
<li>
<p>è¿›ä¸€æ­¥åˆ†ææ—¶ï¼Œåœ¨åˆ›å»ºè€Podé˜¶æ®µï¼Œè¿›è¡Œ<code>NodePublishVolume</code>æ—¶ï¼Œç›®å½•å…¶å®è¢«åŒæ—¶bind mountåˆ°äº†fuseå’Œext4ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿé‡Œï¼š</p>
<figure>
    <img src="/blobfuse2/1.jpeg" width="1000px"/> 
</figure>

</li>
<li>
<p>è€Œunmountè¿™ç§mountpointæ—¶å°±ä¼šå¯¼è‡´source mountpointä¹Ÿè¢«unmountæ‰ã€‚è™½ç„¶ä¸çŸ¥é“è¿™ä¸ªè¡Œä¸ºèƒŒåçš„åŸå› æ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯é—®é¢˜çš„æ ¹å› è¿˜æ˜¯åœ¨äºbind mountæ—¶ä¸åº”è¯¥åŒæ—¶mountåˆ°ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ã€‚</p>
</li>
</ol>
</li>
</ul>
<h2 id="é—®é¢˜åŸå› ">é—®é¢˜åŸå› </h2>
<p>libfuseæä¾›äº†<a href="https://github.com/libfuse/libfuse/blob/master/lib/helper.c#L135">-få‚æ•°</a>æ¥å†³å®šæ˜¯å¦è¦è®©ç”¨æˆ·æ€çš„fuseè¿›ç¨‹è¿è¡Œåœ¨foregroundã€‚é»˜è®¤æ˜¯ä»¥backgroundæ¨¡å¼è¿è¡Œ â€”â€” å³çˆ¶è¿›ç¨‹forkå‡ºå­è¿›ç¨‹ç„¶åé€€å‡ºï¼Œå­è¿›ç¨‹è¢«1å·è¿›ç¨‹æ¥ç®¡ã€‚</p>
<p>blobfuse2æ˜¯åŸºäºgolangå®ç°çš„ï¼Œé€šè¿‡cgoè°ƒç”¨libfuseåº“å‡½æ•°ï¼Œä½†æ˜¯<a href="https://github.com/golang/go/issues/227">golangæ²¡æ³•å¾ˆå¥½çš„æ”¯æŒfork</a>ï¼Œå®é™…æµ‹è¯•æ—¶å‘ç°å¦‚æœblobfuse2ç›´æ¥ä¾èµ–libfuseåº“ä¸­çš„forkæ¥å¯åŠ¨å­è¿›ç¨‹ï¼Œä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™å‘½ä»¤éƒ½ä¼šè¢«å¡ä½ä¸”æ— æ³•é€€å‡ºã€‚blobfuse2å€ŸåŠ©äº†å¼€æºé¡¹ç›®<a href="https://github.com/sevlyar/go-daemon">go-daemon</a>æ¥å®ç°åœ¨golangä¸­forkã€‚æˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡<a href="https://cvvz.github.io/post/go-daemon/">åšå®¢</a>ä¸­åˆ†æä¸€ä¸‹go-daemonçš„æºç ã€‚</p>
<p>å…·ä½“çš„åšæ³•(<a href="https://github.com/Azure/azure-storage-fuse/blob/5e06d431845e46a2df4bca187a863b71f6e7cb0b/cmd/mount.go#L405-L421">ä»£ç åœ¨è¿™</a>)æ˜¯åœ¨start fuseä¹‹å‰ï¼Œé€šè¿‡go-daemonçš„<code>Reborn()</code>å‡½æ•°forkå‡ºå­è¿›ç¨‹ï¼Œç„¶åå­è¿›ç¨‹<a href="https://github.com/Azure/azure-storage-fuse/blob/8f655cf9e1b501c574b1a217bdb57a9e717bb712/component/libfuse/libfuse2_handler.go#L212-L218">ä»¥foregroundæ–¹å¼start fuse</a>ï¼š</p>
<figure>
    <img src="/blobfuse2/f.png" width="800px"/> 
</figure>

<p>å¹¶ä¸”çˆ¶è¿›ç¨‹é€€å‡ºï¼š</p>
<figure>
    <img src="/blobfuse2/fork1.png" width="700px"/> 
</figure>

<p>è¿™æ ·åšä¼šå¯¼è‡´é—®é¢˜çš„åŸå› æ˜¯ï¼Œå…¶å®<a href="https://github.com/libfuse/libfuse/blob/master/lib/helper.c#L351-L359">libfuseåœ¨daemonize forkä¹‹å‰è¿˜æœ‰å¾ˆå¤šé€»è¾‘ï¼Œå…¶ä¸­å°±åŒ…æ‹¬fuse mount</a>ï¼š</p>
<figure>
    <img src="/blobfuse2/fusemount.png" width="600px"/> 
</figure>

<p>ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œdaemonizeä¹‹å‰å¾ˆå¯èƒ½å‘ç”Ÿå…¶ä»–é”™è¯¯å¯¼è‡´fuse mountç›´æ¥æŠ¥é”™é€€å‡ºã€‚</p>
<figure>
    <img src="/blobfuse2/beforemount.png" width="600px"/> 
</figure>

<p>ä½†æ˜¯ç°åœ¨blobfuse2çš„forkå‘ç”Ÿåœ¨libfuseçš„å…¥å£ç‚¹<a href="https://github.com/libfuse/libfuse/blob/master/lib/helper.c#L307">fuse_main</a>ä¹‹å‰äº†ï¼Œè€Œä¸”çˆ¶è¿›ç¨‹è¿‡æ—©çš„ç›´æ¥é€€å‡ºäº†ï¼Œè¿™å°±å¯¼è‡´fuse daemonizeä¹‹å‰å‘ç”Ÿçš„é”™è¯¯éƒ½æ— æ³•è¢«çˆ¶è¿›ç¨‹æ•æ‰åˆ°ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæ‰§è¡Œ<code>blobfuse2 mount</code>æ“ä½œå³ä½¿mountå¤±è´¥äº†ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ã€‚</p>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜çš„åŸå› å·²ç»æ¸…æ¥šäº†ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜çš„åŸå› ä¹Ÿæ˜¯å¼‚æ­¥mountå¯¼è‡´çš„ï¼šåˆ›å»ºPodæ—¶ï¼Œåœ¨<code>NodeStageVolume</code>é˜¶æ®µï¼Œblob csi driverä¼šè°ƒç”¨<code>blobfuse2 mount</code>æ‰§è¡Œfuse mountæ“ä½œã€‚<code>blobfuse2 mount</code>è™½ç„¶è¿”å›æˆåŠŸäº†ï¼Œä½†æ˜¯å®é™…ä¸Šmountæ“ä½œè¿˜åœ¨å­è¿›ç¨‹ä¸­å¼‚æ­¥çš„æ‰§è¡Œã€‚</p>
<p>è€Œcsi driverè®¤ä¸º<code>blobfuse2 mount</code>è¿”å›æˆåŠŸäº†å°±ä»£è¡¨fuse mountæˆåŠŸäº†ï¼Œå› æ­¤ä¹Ÿè¿”å›æ‰§è¡ŒæˆåŠŸçš„responseã€‚æ¥ç€kubeletä¼šè°ƒç”¨<code>NodePublishVolume</code>æ‰§è¡Œbind mountï¼Œä½†åœ¨bind mountæ—¶ï¼Œå…¶å®fuse mountä»åœ¨è¿›è¡Œä¸­ï¼Œå› æ­¤é¦–å…ˆbind mountåˆ°äº†è¿˜æœªfuse mountæˆåŠŸçš„ext4æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œç­‰åˆ°fuse mountæˆåŠŸï¼Œç›®å½•è¢«åˆå§‹åŒ–ä¸ºfuseæ–‡ä»¶ç³»ç»Ÿï¼Œåˆbind mountåˆ°äº†fuseæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼šåŒæ—¶bind mountåˆ°ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šã€‚</p>
<h2 id="è°ƒç ”">è°ƒç ”</h2>
<p>å› ä¸ºgolangçš„forkçš„é™åˆ¶ï¼Œä¸Šè¿°é—®é¢˜åªä¼šåœ¨ä½¿ç”¨golangçš„fuseé¡¹ç›®ä¸­å‡ºç°ã€‚</p>
<p><a href="https://github.com/winfsp/cgofuse">cgofuse</a>ä¹Ÿæ˜¯ä¸€ä¸ªé€šè¿‡cgo+libfuseå®ç°çš„fuseé¡¹ç›®ï¼Œ<a href="https://github.com/winfsp/cgofuse/blob/master/fuse/host.go#L648-L652">åªæ”¯æŒforeground fuse mount</a>:</p>
<figure>
    <img src="/blobfuse2/cgofuse.png" width="700px"/> 
</figure>

<p>blobfuse v1å’Œ<a href="https://github.com/s3fs-fuse/s3fs-fuse">s3fs-fuse</a>éƒ½æ˜¯ç”¨c++å†™çš„ï¼Œ<a href="https://github.com/s3fs-fuse/s3fs-fuse/blob/master/src/s3fs.cpp#L5574">ç›´æ¥è°ƒç”¨libfuseçš„fuse_main</a>ï¼Œæ²¡æœ‰é—®é¢˜ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>ææ¸…æ¥šäº†libfuseåº•å±‚åŸç†ï¼Œè§£å†³æ–¹æ¡ˆä¼¼ä¹å¾ˆå®¹æ˜“æƒ³åˆ°äº†ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªçˆ¶å­è¿›ç¨‹é—´IPCçš„åœºæ™¯ï¼Œä½†æ˜¯å®é™…ä¸Šè¦å®Œå…¨è§£å†³è¿˜æ˜¯è¦æƒ³ä¸€äº›åŠæ³•çš„ã€‚</p>
<p>ç¬¬ä¸€ä¸ªè¦è§£å†³çš„é—®é¢˜æ˜¯çˆ¶è¿›ç¨‹å¦‚ä½•çŸ¥é“å­è¿›ç¨‹mountå¤±è´¥ã€‚å­è¿›ç¨‹mountå¤±è´¥æ—¶æ˜¯ä¼šå¯¼è‡´è¿›ç¨‹é€€å‡ºçš„ï¼Œå› æ­¤åªè¦èƒ½æ•è·å­è¿›ç¨‹é€€å‡ºäº‹ä»¶å³å¯ã€‚ç›´æ¥åœ¨çˆ¶è¿›ç¨‹ä¸­ä½¿ç”¨<code>wait</code>æˆ–è€…ç›‘å¬<code>SIGCHLD</code>ä¿¡å·éƒ½å¯ä»¥ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œå­è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶ï¼Œçˆ¶è¿›ç¨‹æ²¡æœ‰åœ¨ç»ˆç«¯å’Œæ—¥å¿—é‡Œæ‰“å°é”™è¯¯ä¿¡æ¯ã€‚<a href="https://github.com/libfuse/libfuse/blob/master/lib/fuse_log.c#L16-L21">libfuseé»˜è®¤æ˜¯ç›´æ¥å°†é”™è¯¯æ—¥å¿—è¾“å‡ºåˆ°stderr</a>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å­è¿›ç¨‹çš„stderré‡å®šå‘è¾“å‡ºåˆ°çˆ¶è¿›ç¨‹å³å¯ã€‚å¦‚æœæ˜¯é€šè¿‡ç›´æ¥forkäº§ç”Ÿçš„å­è¿›ç¨‹ï¼Œå› ä¸ºçˆ¶å­è¿›ç¨‹å…±äº«open fdï¼Œå› æ­¤åªéœ€è¦åœ¨çˆ¶è¿›ç¨‹ä¸­åˆ›å»ºPIPEï¼Œç„¶ååœ¨å­è¿›ç¨‹ä¸­æŠŠstderré‡å®šå‘åˆ°PIPEçš„write fdï¼Œå¹¶åœ¨çˆ¶è¿›ç¨‹ä»PIPE read fdè¯»å°±å¯ä»¥äº†ã€‚å¯æ˜¯go-daemonå…¶å®æ˜¯å…ˆforkï¼Œç„¶åexecè¦†ç›–å­è¿›ç¨‹ï¼Œçˆ¶å­è¿›ç¨‹å¹¶ä¸å…±äº«open fdï¼Œæ‰€ä»¥å­è¿›ç¨‹åˆ›å»ºå‡ºæ¥åæ˜¯æ‹¿ä¸åˆ°çˆ¶è¿›ç¨‹åˆ›å»ºå‡ºçš„PIPE fdçš„ã€‚æ‰€ä»¥å¾—ç»•ä¸€ä¸‹ï¼Œæœ€åæƒ³åˆ°çš„åŠæ³•æ˜¯ï¼Œå…ˆåœ¨çˆ¶è¿›ç¨‹åˆ›å»ºPIPEï¼Œç„¶ååœ¨åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ç›´æ¥è®¾ç½®å­è¿›ç¨‹attributeï¼Œå°†ä»–çš„stdout/stderrè®¾ç½®ä¸ºPIPE write fdã€‚è¿™ä¸ªåŠŸèƒ½go-daemonè¿˜ä¸æ”¯æŒï¼Œé¡ºæ‰‹åšäº†ä¸€ä¸‹ï¼š<a href="https://github.com/sevlyar/go-daemon/pull/90">https://github.com/sevlyar/go-daemon/pull/90</a>ã€‚</p>
<p>ç°åœ¨çˆ¶è¿›ç¨‹èƒ½æ„ŸçŸ¥åˆ°å­è¿›ç¨‹mountå¤±è´¥çš„äº‹ä»¶äº†ï¼Œä½†æ˜¯çˆ¶è¿›ç¨‹è¿˜éœ€è¦èƒ½æ„ŸçŸ¥å­è¿›ç¨‹mountæˆåŠŸçš„äº‹ä»¶æ‰è¡Œï¼Œè¿™æ ·çˆ¶è¿›ç¨‹æ‰å¯ä»¥å®‰å…¨çš„é€€å‡ºã€‚ä½†æ˜¯fuse mountæˆåŠŸåæ˜¯ä¸ä¼šä»¥ä»»ä½•å½¢å¼é€šçŸ¥çˆ¶è¿›ç¨‹çš„ï¼Œé™¤éä¿®æ”¹libfuseä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œç¢°åˆ°äº†ä¸€äº›å›°éš¾ã€‚åœ¨çœ‹äº†libfuseçš„ä»£ç ä¹‹åï¼Œæœ€åæƒ³åˆ°äº†å¦‚ä¸‹çš„è§£å†³åŠæ³•ï¼š</p>
<p>libfuseæä¾›äº†å¾ˆå¤š<a href="https://github.com/libfuse/libfuse/blob/master/include/fuse.h#L324-L828">callback</a>é’©å­å‡½æ•°ï¼Œæ¶µç›–äº†æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç”¨æˆ·åœ¨æ‰§è¡Œ<code>cd</code>,<code>ls</code>,<code>rm</code>, <code>mkdir</code>ç­‰æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤æ—¶ï¼Œkernelä¼šè°ƒç”¨ç›¸åº”çš„callbackä¸ç”¨æˆ·æ€fuseè¿›ç¨‹é€šä¿¡ï¼Œ<a href="https://github.com/Azure/azure-storage-fuse/blob/7d86acbc95871a4e513b0087bdb7b68f23b7d5db/component/libfuse/libfuse_wrapper.h#L60-L119">blobfuse2ä¹Ÿæ³¨å†Œäº†å¾ˆå¤šå¯¹åº”çš„callback</a>ã€‚libfuseåœ¨mountæˆåŠŸåkernelè‡ªåŠ¨æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªcallbackæ˜¯<a href="https://github.com/libfuse/libfuse/blob/master/include/fuse.h#L608-L617">init</a>ï¼Œç”¨äºåˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿã€‚æ‰€ä»¥æœ€åæƒ³åˆ°çš„è§£å†³åŠæ³•å°±æ˜¯å½“ç”¨æˆ·æ€çš„fuseè¿›ç¨‹åœ¨æ‰§è¡Œ<code>init</code> callbackæ—¶ï¼Œç»™çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ª<code>SIGUSR1</code>çš„ä¿¡å·ï¼Œå½“çˆ¶è¿›ç¨‹æ”¶åˆ°è¿™ä¸ªä¿¡å·ï¼Œå°±çŸ¥é“fuse mounté˜¶æ®µè‚¯å®šæˆåŠŸäº†ï¼Œå¯ä»¥æˆåŠŸé€€å‡ºäº†ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>Prometheusè¯•ç©</title>
			<link>https://cvvz.fun/post/prometheus/</link>
			<pubDate>Mon, 20 Feb 2023 09:26:59 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/prometheus/</guid>
			<description>Mental Model å¾ˆå–œæ¬¢å¿ƒæ™ºæ¨¡å‹è¿™ä¸ªè¯ï¼Œæ„æ€æ˜¯å¯¹ä¸€ä¸ªäº‹ç‰©å»ºç«‹ä¸€ä¸ªæ•´ä½“çš„æ¡†æ¶æ€§çš„ç†è§£ã€‚ Prometheusçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œscrape_config éƒ¨åˆ†å®šä¹‰çš„</description>
			<content type="html"><![CDATA[<h2 id="mental-model">Mental Model</h2>
<blockquote>
<p>å¾ˆå–œæ¬¢å¿ƒæ™ºæ¨¡å‹è¿™ä¸ªè¯ï¼Œæ„æ€æ˜¯å¯¹ä¸€ä¸ªäº‹ç‰©å»ºç«‹ä¸€ä¸ªæ•´ä½“çš„æ¡†æ¶æ€§çš„ç†è§£ã€‚</p>
</blockquote>
<ol>
<li>
<p>Prometheusçš„<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">é…ç½®æ–‡ä»¶</a>ä¸­ï¼Œ<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config">scrape_config</a> éƒ¨åˆ†å®šä¹‰çš„æ˜¯<a href="https://prometheus.io/docs/concepts/jobs_instances/#jobs-and-instances">job</a> â€”â€” ä¹Ÿå°±æ˜¯å»å“ªä¸ªtarget <a href="https://prometheus.io/docs/concepts/jobs_instances/#jobs-and-instances">instance</a> scrape metrics â€”â€” ä½†æ˜¯<strong>é…ç½®æ–‡ä»¶é‡Œä¸å…³å¿ƒä¹Ÿæ²¡æ³•å…³å¿ƒå…·ä½“æŠ“å“ªäº›æŒ‡æ ‡</strong>ã€‚</p>
</li>
<li>
<p>å…·ä½“æœ‰å“ªäº›æŒ‡æ ‡å¯ä»¥æŠ“ï¼Œä¹Ÿå°±æ˜¯ <strong><a href="https://prometheus.io/docs/concepts/data_model/#metric-names-and-labels">metrics name + label</a> å’Œ <a href="https://prometheus.io/docs/concepts/metric_types/">metrics type</a>ï¼Œéƒ½åœ¨å®¢æˆ·ç«¯æºä»£ç ä¸­å®šä¹‰</strong>ã€‚</p>
</li>
</ol>
<blockquote>
<p>å¦‚æœconfigurationæ²¡æœ‰é…ç½®å¯¹ï¼Œç›¸å½“äºæ‰¾ä¸åˆ°æŠ“çš„åœ°æ–¹ã€‚</p>
<p>å¦‚æœclientä»£ç ä¸æ­£ç¡®ï¼Œç›¸å½“äºæŠ“çš„åœ°æ–¹å¯¹äº†ï¼Œä½†æ˜¯ä»€ä¹ˆä¸œè¥¿éƒ½æŠ“ä¸åˆ°ã€‚</p>
</blockquote>
<ol start="3">
<li>æŠ“åˆ°metricsä»¥åï¼Œå°±å¯ä»¥å®šä¹‰rules â€”â€” é€šè¿‡<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">promQLæŸ¥è¯¢</a>ï¼Œç„¶åå¤„ç†æŸ¥è¯¢ç»“æœ â€”â€” <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/">alerting</a>æˆ–æ˜¯<a href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/">recording</a></li>
</ol>
<blockquote>
<p>æŠ¥è­¦æ— æ³•è§¦å‘çš„åŸå› æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>clientæˆ–configurationæ²¡å†™å¯¹</li>
<li>promQLæ²¡å†™å¯¹ï¼Œå¯ä»¥ä½¿ç”¨utæµ‹è¯•rulesè§„åˆ™æ˜¯å¦æ­£ç¡®ã€‚</li>
</ul>
</blockquote>
<h2 id="configuration">configuration</h2>
<p>é™¤äº†ç›´æ¥é…ç½®target instanceä¹‹å¤–ï¼Œscrape_configè¿˜æ”¯æŒå¤šç§æœåŠ¡å‘ç°æœºåˆ¶ï¼Œ<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">kubernetes_sd_config</a>æ˜¯k8sçš„æœåŠ¡å‘ç°é…ç½®</p>
<p>æœåŠ¡å‘ç°æœºåˆ¶ä¼šç»™metricsé¢å¤–è®¾ç½®ä¸€äº›<code>__meta__</code>å¼€å¤´çš„labelï¼Œå¯ä»¥é€šè¿‡<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config">relabel_config</a>æ¥è¿‡æ»¤å‡ºå…·ä½“çš„instanceï¼Œæ¯”å¦‚ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="ln"> 1</span><span class="nt">relabel_configs</span><span class="p">:</span><span class="w">
</span><span class="ln"> 2</span><span class="w">  </span>- <span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">__address__</span><span class="w">
</span><span class="ln"> 3</span><span class="w">    </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="l">$(FQDN):443</span><span class="w">
</span><span class="ln"> 4</span><span class="w">  </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__meta_kubernetes_namespace, __meta_kubernetes_pod_label_component,     __meta_kubernetes_pod_container_name]</span><span class="w">
</span><span class="ln"> 5</span><span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">keep</span><span class="w">
</span><span class="ln"> 6</span><span class="w">    </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system;kube-proxy;kube-proxy</span><span class="w">
</span><span class="ln"> 7</span><span class="w">  </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__meta_kubernetes_namespace, __meta_kubernetes_pod_name]</span><span class="w">
</span><span class="ln"> 8</span><span class="w">    </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">(.+);(.+)</span><span class="w">
</span><span class="ln"> 9</span><span class="w">    </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">__metrics_path__</span><span class="w">
</span><span class="ln">10</span><span class="w">    </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="l">/api/v1/namespaces/${1}/pods/${2}:10249/proxy/metrics</span><span class="w">
</span><span class="ln">11</span><span class="w">  </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__meta_kubernetes_pod_name]</span><span class="w">
</span><span class="ln">12</span><span class="w">    </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">(.*)</span><span class="w">
</span><span class="ln">13</span><span class="w">    </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">pod</span><span class="w">
</span><span class="ln">14</span><span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">replace</span><span class="w">
</span><span class="ln">15</span><span class="w">  </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__meta_kubernetes_namespace]</span><span class="w">
</span><span class="ln">16</span><span class="w">    </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">(.*)</span><span class="w">
</span><span class="ln">17</span><span class="w">    </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">namespace</span><span class="w">
</span><span class="ln">18</span><span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">replace</span><span class="w">
</span></code></pre></div><p>prometheusä¼šæŠ“å– <code>kube-system/kube-proxy</code>çš„metricsï¼Œtarget instanceæ˜¯<code>$(FQDN):443</code>ï¼Œmetrics api pathæ˜¯<code>/api/v1/namespaces/kube-system/pods/kube-proxy:10249/proxy/metrics</code></p>
<blockquote>
<p>è¯´æ˜kube-proxyçš„metricså¹¶ä¸æ˜¯ç›´æ¥ä»podçš„/metricsæ¥å£è·å–çš„ï¼Œè€Œæ˜¯é€šè¿‡<a href="https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster-services/#manually-constructing-apiserver-proxy-urls">apiserverçš„proxy api</a>)</p>
</blockquote>
<p>å¹¶ä¸”ç»™metricsåŠ ä¸Š<code>namespace</code>å’Œ<code>pod</code>è¿™ä¸¤ä¸ªlabelï¼Œæ¯”å¦‚ï¼š</p>
<figure>
    <img src="/prometheus/kubeproxy.png" width="1000px"/> 
</figure>

<h2 id="promql">promQL</h2>
<p>promQLä¸­æœ‰ä¸¤ä¸ªéå¸¸å¸¸è§ï¼Œä½†åˆç›¸å¯¹å¤æ‚çš„queryï¼Œä¸€ä¸ªæ˜¯è®¡ç®—å æ¯”ï¼ˆratioï¼‰ï¼Œä¸€ä¸ªæ˜¯è®¡ç®—ç™¾åˆ†ä½ï¼ˆquantileï¼‰</p>
<h3 id="è®¡ç®—ratio">è®¡ç®—ratio</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="ln">1</span><span class="c"># ratio of api server requests over 5m</span><span class="w">
</span><span class="ln">2</span><span class="w"></span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">job_verb_code_instance:apiserver_request:ratio_rate5m</span><span class="w">
</span><span class="ln">3</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="ln">4</span><span class="sd">    sum by(job, verb, instance) (rate(apiserver_request_total[5m]))
</span><span class="ln">5</span><span class="sd">        / ignoring (verb) group_left()
</span><span class="ln">6</span><span class="sd">    sum by(job, instance) (rate(apiserver_request_total[5m]))</span><span class="w">    
</span></code></pre></div><p>é¦–å…ˆé€šè¿‡<code>apiserver_request_total[5m]</code>å¾—åˆ°5må†…çš„å…¨éƒ¨é‡‡æ ·ç‚¹ï¼Œå³<code>range vector</code>ï¼Œç„¶åç”¨rateè®¡ç®—æ¯ç§’å¢é•¿é€Ÿç‡ï¼Œæœ€åç”¨sumèšåˆï¼Œä¸¤è¾¹åšé™¤æ³•å°±å¾—åˆ°æ¯”ä¾‹å…³ç³»ã€‚</p>
<p>å¦‚æœåªæ‰§è¡Œå·¦è¾¹ï¼š
<figure>
    <img src="/prometheus/1.png" width="1000px"/> 
</figure>
</p>
<p>å¦‚æœåªæ‰§è¡Œå³è¾¹ï¼š
<figure>
    <img src="/prometheus/2.png" width="1000px"/> 
</figure>
</p>
<p>å¯ä»¥çœ‹åˆ°å› ä¸ºå·¦è¾¹çš„queryå¸¦ä¸Šäº†æ›´å¤šçš„labelï¼Œå› æ­¤å¯ä»¥æŸ¥åˆ°æ›´å¤šçš„æ•°æ®ã€‚</p>
<p>æˆ‘ä»¬æƒ³è®¡ç®—æ¯ä¸€ç§verbåœ¨æ‰€æœ‰è¯·æ±‚ä¸­çš„å æ¯”ï¼Œå…ˆä½¿ç”¨ <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching-keywords">ignoring</a> å¿½ç•¥æ‰<code>verb</code>labelï¼Œè¿™æ ·ä¸¤è¾¹labelä¸€è‡´æ‰èƒ½åšé™¤æ³•ï¼›</p>
<p>å› ä¸ºå·¦è¾¹çš„æ•°æ®å¤š(many)ï¼Œå³è¾¹çš„æ•°æ®åªæœ‰ä¸€æ¡(one)ï¼Œè¿™å±äº<a href="https://prometheus.io/docs/prometheus/latest/querying/operators/#many-to-one-and-one-to-many-vector-matches">Many-to-one matches</a>ï¼Œæ‰€ä»¥æ¥ç€ç”¨<code>group_left()</code>è®©å·¦è¾¹çš„æ¯ä¸€æ¡æ•°æ®ä¾æ¬¡é™¤ä»¥å³è¾¹ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœï¼š</p>
<figure>
    <img src="/prometheus/3.png" width="1000px"/> 
</figure>

<h3 id="è®¡ç®—quantile">è®¡ç®—quantile</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="ln">1</span><span class="c"># 99th percentile latency</span><span class="w">
</span><span class="ln">2</span><span class="w"></span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">job:apiserver_request_latency:99pctlrate5m</span><span class="w">
</span><span class="ln">3</span><span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="ln">4</span><span class="sd">    </span><span class="w">    </span><span class="l">histogram_quantile(0.99, sum by (le, job)(rate(apiserver_request_duration_seconds_bucket{verb=~&#34;GET|POST|DELETE|PATCH&#34;}[5m]))) * 1000 &gt; 0</span><span class="w">
</span></code></pre></div><p>é¦–å…ˆ<code>apiserver_request_duration_seconds_bucket</code>æ˜¯ä¸€ä¸ªbucketï¼Œé€šè¿‡<code>[5m]</code>å¾—åˆ°æ¯ä¸€ä¸ªbucketåœ¨5må†…çš„é‡‡æ ·å€¼ï¼Œç„¶åè®¡ç®—æ¯ä¸€ä¸ªbucketä¸­çš„å¢é•¿rateï¼Œå†æŒ‰ç…§le(less equalï¼Œå³æ¡¶çš„ä¸Šè¾¹ç•Œ)è¿›è¡Œsumèšåˆã€‚æœ€åé€šè¿‡<a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#histogram_quantile">histogram_quantile</a>å‡½æ•°è®¡ç®—ç™¾åˆ†ä½ã€‚</p>
<blockquote>
<p><strong>âš ï¸æ³¨æ„ï¼Œhistogramä¸ä¼šè®°å½•çœŸå®æ•°æ®ï¼Œåªè®°å½•æ¯ä¸ª bucket ä¸‹çš„ count å’Œ sumï¼Œç„¶åå‡å®šæ•°æ®åœ¨æ¡¶ä¸­æ˜¯å‡åŒ€åˆ†å¸ƒçš„æ¥è®¡ç®—ç™¾åˆ†ä½ã€‚å¦‚æœ bucket è®¾ç½®çš„ä¸åˆç†ï¼Œä¼šäº§ç”Ÿä¸ç¬¦åˆé¢„æœŸçš„ quantile ç»“æœ:</strong></p>
<p>æ¯”å¦‚bucket æ˜¯ 100ms ~ 1000msï¼Œè€Œå¤§éƒ¨åˆ†è®°å½•éƒ½åœ¨ 100ms ~ 200ms ä¹‹é—´ï¼Œä½†æ˜¯ç”±äºprometheuså‡å®šæ•°æ®æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼Œå› æ­¤è®¡ç®— P99 æ—¶ä¼šå¾—åˆ°æ¥è¿‘äº 1000ms çš„å€¼ã€‚<a href="https://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation">å®˜æ–¹æ–‡æ¡£</a>é‡Œæè¿°äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
</blockquote>
<h2 id="å‡ ç§æ—¶é—´çš„ç†è§£">å‡ ç§æ—¶é—´çš„ç†è§£</h2>
<p>Prometheusé‡Œè¿˜æ¶‰åŠåˆ°å‡ ç§æ—¶é—´æ¦‚å¿µï¼Œå¿…é¡»ææ¸…æ¥šæ‰èƒ½çŸ¥é“æ€ä¹ˆæ ·è®¾ç½®ruleæ‰èƒ½æ­£ç¡®è§¦å‘å‘Šè­¦</p>
<h3 id="evaluation_interval-scrape_intervalå’Œalerting-rulesä¸­çš„for">evaluation_interval, scrape_intervalå’Œalerting rulesä¸­çš„for</h3>
<ul>
<li><strong>evaluation_interval</strong>ï¼šåªæœ‰å½“å®ƒ &gt;= scrape_intervalæ—¶ï¼Œæ‰èƒ½ç¡®ä¿æ¯æ¬¡evaluationæ—¶ï¼ŒpromQLæŸ¥è¯¢åˆ°çš„éƒ½æ˜¯æ–°æ•°æ®ã€‚</li>
<li><strong>alerting ruleä¸­çš„for</strong>ï¼šå’Œä¸Šé¢åŒç†ï¼Œåªæœ‰å½“å®ƒ &gt;= scrape_intervalæ—¶ï¼Œæ‰èƒ½ç¡®ä¿å‘Šè­¦å‘å‡ºæ—¶è‡³å°‘è¦†ç›–äº†ä¸¤æ¬¡sampleã€‚</li>
</ul>
<blockquote>
<ol>
<li>
<p>å½“for &lt; evaluation_interval æ—¶ï¼Œå¿…é¡»è¦Pendingåˆ°ç¬¬äºŒæ¬¡evaluationå‘ç”Ÿæ—¶æ‰èƒ½åˆ¤æ–­æ˜¯å¦çœŸçš„è¦fire alert</p>
</li>
<li>
<p>evaluation_intervalå’Œforï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ª &gt;= scrape_intervalï¼Œå°±å¯ä»¥ä¿è¯å‘Šè­¦å‘å‡ºæ—¶è‡³å°‘è¦†ç›–äº†ä¸¤æ¬¡sampleï¼Œä¸ä¼šæœ‰false alertã€‚</p>
</li>
</ol>
</blockquote>
<h3 id="range-vectorä¸­çš„time-duration">range vectorä¸­çš„[time duration]</h3>
<p>ä»¥<code>[10m]</code>ä¸ºä¾‹ï¼Œæ„æ€æ˜¯ä»æŸ¥è¯¢æ—¶åˆ»ç®—èµ·ï¼Œå¾€å‰æ¨10mï¼Œæ—¶åºæ•°æ®åº“é‡Œå­˜äº†å¤šå°‘æ•°æ®å°±æŸ¥å¤šå°‘æ•°æ®å‡ºæ¥ï¼Œæ„å‘³ç€ï¼š</p>
<ul>
<li><strong>if scrape_interval == 10m</strong>ï¼Œé‚£ä¹ˆåŸºæœ¬ä¸Šå¯ä»¥ä¿è¯ä½ åˆšå¥½åªèƒ½æŸ¥å‡ºæ¥ä¸€æ¡æ•°æ®ï¼›</li>
<li><strong>if scrape_interval &gt; 10m</strong>ï¼Œé‚£ä¹ˆä½ æœ‰å¯èƒ½æŸ¥ä¸å‡ºæ¥ä»»ä½•æ•°æ®ï¼›</li>
<li><strong>if scrape_interval &lt; 10m</strong>ï¼Œä½ å¯èƒ½å¯ä»¥æŸ¥å‡ºæ¥å¤šæ¡æ•°æ®ã€‚é‡‡æ ·é—´éš”å°äº5mï¼Œä½ è‚¯å®šå¯ä»¥æŸ¥å‡ºæ¥2æ¡æ•°æ®ï¼Œä¾æ¬¡ç±»æ¨</li>
</ul>
<blockquote>
<p>åœ¨å†™prometheusçš„utæ—¶ï¼Œå¦‚æœpromQLè®¡ç®—çš„æ˜¯range vectorçš„æ•°æ®ç±»å‹ï¼Œæœ€å¥½é¿å…evaluation_intervalå’Œinput_seriesçš„intervalï¼ˆå³scrape_intervalï¼‰æˆ<strong>å€æ•°å…³ç³»</strong>ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºåœ¨utä¸­ï¼Œevaluation_intervalå’Œscrape_intervalçš„å¼€å§‹æ—¶é—´éƒ½æ˜¯0ï¼Œå¦‚æœè¿™ä¸¤ä¸ªintervalæ˜¯å€æ•°å…³ç³»ï¼Œé‚£ä¹ˆåœ¨evaluationçš„æ—¶å€™ï¼Œæ€»æ˜¯ä¼šæœ‰æ—¶åˆ»ï¼Œevaluationæ—¶åˆšå¥½äº§ç”Ÿä¸€ä¸ªinputï¼Œè®¡ç®—æ—¶ä¼šæŠŠè¿™ä¸ªinputä¹Ÿå¸¦è¿›å»ï¼Œè¿™å¯èƒ½ä¼šäº§ç”Ÿè®©äººå›°æƒ‘çš„utç»“æœã€‚è¿™ç§æƒ…å†µåœ¨çœŸå®åœºæ™¯ä¸­å¾ˆéš¾å‘ç”Ÿã€‚</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>è®°ä¸€æ¬¡é€šè¿‡read-aheadä¼˜åŒ–NFSæ€§èƒ½çš„è¿‡ç¨‹</title>
			<link>https://cvvz.fun/post/nfs-read-ahead/</link>
			<pubDate>Sun, 16 Oct 2022 22:58:42 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/nfs-read-ahead/</guid>
			<description>é—®é¢˜ agent nodeæ“ä½œç³»ç»Ÿç‰ˆæœ¬Ubuntu 18.04ï¼Œå®¢æˆ·ä½¿ç”¨blob csi driverï¼Œä½¿ç”¨NFSåè®®è¿›è¡ŒæŒ‚è½½ï¼Œå¯¹ä¸€ä¸ª25GBçš„æ–‡ä»¶æ‰§è¡Œsha25</description>
			<content type="html"><![CDATA[<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>agent nodeæ“ä½œç³»ç»Ÿç‰ˆæœ¬Ubuntu 18.04ï¼Œå®¢æˆ·ä½¿ç”¨<a href="https://github.com/kubernetes-sigs/blob-csi-driver">blob csi driver</a>ï¼Œä½¿ç”¨NFSåè®®è¿›è¡ŒæŒ‚è½½ï¼Œå¯¹ä¸€ä¸ª25GBçš„æ–‡ä»¶æ‰§è¡Œsha256sumè€—æ—¶20å¤šåˆ†é’Ÿï¼Œæ€§èƒ½è¿œä½äºä½¿ç”¨æœ¬åœ°ç£ç›˜ã€‚</p>
<h2 id="åˆ†æ">åˆ†æ</h2>
<p>é€šè¿‡NFSåè®®æŒ‚è½½å’Œç›´æ¥æŒ‚è½½æœ¬åœ°ç£ç›˜çš„åŒºåˆ«æ˜¯ä¸‹å±‚çš„æ–‡ä»¶ç³»ç»ŸIOå˜æˆäº†ç½‘ç»œIOã€‚</p>
<p>æŸ¥çœ‹sha256sumæ‰§è¡Œè¿‡ç¨‹ä¸­çš„cpuåˆ©ç”¨ç‡ï¼Œå‘ç°IO waitåé«˜ï¼Œä¹Ÿå°±æ˜¯è¯´é€ æˆè€—æ—¶çš„ä¸»è¦åŸå› æ˜¯å› ä¸ºæ‰§è¡Œäº†è¿‡å¤šçš„ç½‘ç»œIOã€‚</p>
<p>åœ¨æ’é™¤äº†ç½‘ç»œå»¶è¿Ÿçš„å¯¹è¿™ä¸ªé—®é¢˜çš„å½±å“åï¼Œä¼˜åŒ–é‡ç‚¹æ”¾åœ¨èƒ½å¦å‡å°‘ç½‘ç»œIOæ¬¡æ•°ä¸Šï¼Œè¿™å’Œå‡å°‘æœ¬åœ°æ–‡ä»¶ç³»ç»ŸIOçš„ä¼˜åŒ–æ€è·¯æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚sha256sumæ˜¯å…¸å‹çš„é¡ºåºè¯»åœºæ™¯ï¼ˆé€šè¿‡straceå¯ä»¥çœ‹åˆ°å®ƒåœ¨ä¸åœçš„æ‰§è¡Œç³»ç»Ÿè°ƒç”¨<code>read</code>ï¼Œæ¯æ¬¡è¯»å–32KBæ•°æ®è¿›è¡Œå¤„ç†ï¼‰ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å¢åŠ é¢„è¯»ï¼ˆread-aheadï¼‰çš„æ•°æ®é‡æ¥å¢åŠ æ¯æ¬¡IOé¢å¤–é¡ºåºè¯»å–çš„æ•°æ®å¹¶ç¼“å­˜ï¼Œä»è€Œå¢åŠ ç³»ç»Ÿè°ƒç”¨è¯»page cacheçš„æ¬¡æ•°ï¼Œå¹¶å‡å°‘ç£ç›˜IOçš„æ¬¡æ•°ã€‚</p>
<p>æ‰§è¡Œ <code>echo 16384 &gt; /sys/class/bdi/$(mountpoint -d  $MOUNT_POINT)/read_ahead_kb</code>è®¾ç½®é¢„è¯»å‚æ•°ä¸º16384ï¼ˆé»˜è®¤ä¸º128ï¼‰åï¼Œsha256sumçš„æ‰§è¡Œæ—¶é—´æé«˜åˆ°3åˆ†é’Ÿã€‚</p>
<p>ä¸‹é¢å¯¹æ¯”ä¸€ä¸‹ä¼˜åŒ–å‰å’Œä¼˜åŒ–åçš„å„é¡¹æŒ‡æ ‡ã€‚</p>
<h3 id="cpuåˆ©ç”¨ç‡">cpuåˆ©ç”¨ç‡</h3>
<h4 id="before">before</h4>
<figure>
    <img src="/nfs-read-ahead/cpu-utilization-0.png" width="700px"/> 
</figure>

<h4 id="after">after</h4>
<figure>
    <img src="/nfs-read-ahead/cpu-utilization-1.png" width="700px"/> 
</figure>

<p>ä¼˜åŒ–åcpuåˆ©ç”¨ç‡æå‡ï¼ŒIO waitæ—¶é—´å‡å°‘ã€‚</p>
<h3 id="cacheå‘½ä¸­ç‡">cacheå‘½ä¸­ç‡</h3>
<p>æµ‹è¯•å·¥å…·<a href="https://github.com/iovisor/bcc/blob/master/tools/cachetop.py">cachetop</a></p>
<h4 id="before-1">before</h4>
<figure>
    <img src="/nfs-read-ahead/cache-hit-0.png" width="700px"/> 
</figure>

<h4 id="after-1">after</h4>
<figure>
    <img src="/nfs-read-ahead/cache-hit-1.png" width="700px"/> 
</figure>

<p>ä¼˜åŒ–åå‘½ä¸­ç‡å·®ä¸å¤šï¼Œä½†æ¯ä¸€ç§’hit/missçš„æ¬¡æ•°æ›´å¤šï¼Œä¹Ÿå°±æ„å‘³ç€å•ä½æ—¶é—´å†…readæ‰§è¡Œçš„æ¬¡æ•°æ›´å¤šï¼Œé€šè¿‡cacheè¯»å–çš„æ•°æ®ä¹Ÿæ›´å¤šã€‚ï¼ˆæ¯æ¬¡å‘½ä¸­cacheè¯»å–ä¸€ä¸ªpageï¼Œ4KBå¤§å°ï¼‰</p>
<h3 id="vfs_readå‡½æ•°æ‰§è¡Œæ—¶é—´">vfs_readå‡½æ•°æ‰§è¡Œæ—¶é—´</h3>
<p>æµ‹è¯•å·¥å…·<a href="https://github.com/iovisor/bcc/blob/master/tools/funcinterval.py">funcinterval</a></p>
<h4 id="before-2">before</h4>
<figure>
    <img src="/nfs-read-ahead/vfs-read-0.png" width="700px"/> 
</figure>

<h4 id="after-2">after</h4>
<figure>
    <img src="/nfs-read-ahead/vfs-read-1.png" width="700px"/> 
</figure>

<p>è€—æ—¶é•¿ï¼ˆéœ€è¦è¿›è¡ŒIOï¼‰çš„vfs_readæ¬¡æ•°å‡å°‘äº†ï¼Œè€—æ—¶çŸ­ï¼ˆè¯»ç¼“å­˜ï¼‰çš„vfs_readæ¬¡æ•°å¢åŠ äº†</p>
<h2 id="åœ¨blobfuseä¸Šçš„å‘ç°">åœ¨blobfuseä¸Šçš„å‘ç°</h2>
<p>å®éªŒæ—¶è¿˜å‘ç°ä½¿ç”¨<a href="https://github.com/Azure/azure-storage-fuse">blobfuse</a>æŒ‚è½½æ—¶ï¼Œå³ä½¿ä¸è®¾ç½®<code>read-ahead</code>å‚æ•°ï¼Œæ€§èƒ½ä¹Ÿä¸é”™ï¼Œsha256sumçš„æ‰§è¡Œæ—¶é—´å¤§çº¦åœ¨5åˆ†é’Ÿå·¦å³ã€‚</p>
<p>é€šè¿‡straceè§‚å¯Ÿsha256sumç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæƒ…å†µï¼Œå‘ç°åœ¨æ‰§è¡Œ<code>openat</code>æ—¶èŠ±äº†å¾ˆé•¿æ—¶é—´ï¼Œè¿™æœŸé—´blobfuse cpuåˆ©ç”¨ç‡å¾ˆé«˜ï¼ˆä¸»è¦æ—¶é—´èŠ±åœ¨ç”¨æˆ·æ€ã€ç³»ç»Ÿæ€å’Œå¤„ç†è½¯ä¸­æ–­ï¼‰ï¼Œio waitä¹Ÿå¾ˆé«˜ï¼Œ<strong>å¯ä»¥æ¨æµ‹sha256sumåœ¨æ‰§è¡Œ<code>openat</code>çš„æ—¶å€™ï¼Œblobfuseå°±å·²ç»åœ¨è¯»å–æ•°æ®äº†</strong>ã€‚</p>
<figure>
    <img src="/nfs-read-ahead/blobfuse-0.png" width="700px"/> 
</figure>

<p>ç­‰åˆ°æ‰§è¡Œreadçš„æ—¶å€™ï¼Œio waitä¸æ˜¯å¾ˆé«˜ï¼Œsha256sumçš„cpuåˆ©ç”¨ç‡å¾ˆé«˜ï¼Œè¯´æ˜è¯»å–æ•°æ®å¹¶æ²¡æœ‰ç»è¿‡IOï¼Œåº”è¯¥æ˜¯ç›´æ¥è¯»çš„page cacheã€‚</p>
<figure>
    <img src="/nfs-read-ahead/blobfuse-1.png" width="700px"/> 
</figure>

]]></content>
		</item>
		
		<item>
			<title>VolumeBindingMode</title>
			<link>https://cvvz.fun/post/volumebindingmode/</link>
			<pubDate>Sun, 16 Oct 2022 21:02:59 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/volumebindingmode/</guid>
			<description>VolumeBindingModeæ˜¯storageclassçš„ä¸€ä¸ªå­—æ®µï¼Œè¿™ä¸ªå­—æ®µå¯ä»¥è®¾ç½®ä¸ºä¸¤ä¸ªå€¼ï¼šImmediate æˆ–è€… WaitForFir</description>
			<content type="html"><![CDATA[<p><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#volume-binding-mode">VolumeBindingMode</a>æ˜¯storageclassçš„ä¸€ä¸ªå­—æ®µï¼Œè¿™ä¸ªå­—æ®µå¯ä»¥è®¾ç½®ä¸ºä¸¤ä¸ªå€¼ï¼š<code>Immediate</code> æˆ–è€… <code>WaitForFirstConsumer</code>ï¼Œ<code>WaitForFirstConsumer</code>çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>static bindingæ—¶ï¼Œèµ·åˆ°å»¶è¿Ÿç»‘å®šPVCå’ŒPVçš„ä½œç”¨</li>
<li>dynamically provisionæ—¶ï¼Œèµ·åˆ°å»¶è¿Ÿåˆ›å»ºPVçš„ä½œç”¨</li>
</ul>
<p>å…·ä½“å•¥æ„æ€ï¼Œåˆæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿé€šè¿‡èµ°è¯»ä»£ç æ¥åŠ æ·±ç†è§£ã€‚ä»¥ä¸‹æ¶‰åŠåˆ°schedulerã€persistentvolume controllerå’Œexternal provisionerä¸‰ä¸ªç»„ä»¶çš„äº¤äº’ï¼Œå…¨éƒ¨éƒ½æ˜¯ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥ç†è§£èµ·æ¥æ¯”è¾ƒç›´ç™½ï¼Œä¸ç”¨ç»•å¼¯å­ï¼Œä¸»è¦ä»»åŠ¡æ˜¯æŠŠè¿™äº›ä¸šåŠ¡é€»è¾‘walk throughä¸€éã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨é›†ç¾¤ä¸­åˆ›å»ºäº†Podå’ŒPVCã€‚Podä¼šè§¦å‘è°ƒåº¦å™¨çš„è°ƒåº¦æµç¨‹ï¼ŒPVCä¼šè§¦å‘pv controllerçš„bindingæµç¨‹ä»¥åŠexternal provisionerçš„provisionæµç¨‹ã€‚ä¸‹é¢ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ã€‚</p>
<h2 id="scheduler">scheduler</h2>
<p>å…ˆä»è°ƒåº¦å™¨è¯´èµ·ï¼Œé‡ç‚¹åœ¨<a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/scheduler/framework/plugins/volumebinding/volume_binding.go">volumebindingæ’ä»¶</a>ä¸­ã€‚</p>
<h3 id="prefilter">Prefilter</h3>
<p>åœ¨Prefilteré˜¶æ®µï¼Œå¦‚æœæœ‰<code>Immediate</code>çš„PVCå­˜åœ¨ï¼Œå°±å¿…é¡»å…ˆä¸PVç»‘å®šå®Œæˆä¹‹åï¼Œæ‰å…è®¸è¿›è¡Œè°ƒåº¦ã€‚è¿™ä¸€ç‚¹å¾ˆå…³é”®ã€‚</p>
<figure>
    <img src="/VolumeBindingMode/prefilter.png" width="1000px"/> 
</figure>

<h3 id="filter">Filter</h3>
<p>åœ¨Filteré˜¶æ®µï¼Œå¯¹äºå·²ç»boundçš„PVCï¼Œå°±å¿…é¡»è¦Nodeæ»¡è¶³PVçš„affinityè¦æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´æ—¢è¦æ»¡è¶³Podä¸­å®šä¹‰çš„topologyï¼Œåˆè¦æ»¡è¶³PVçš„topologyã€‚</p>
<figure>
    <img src="/VolumeBindingMode/filter-0.png" width="1000px"/> 
</figure>

<p>å¯¹äºunboundçš„PVCï¼Œå…ˆçœ‹è¿™ä¸ªPVCæœ‰æ²¡æœ‰<code>volume.kubernetes.io/selected-node</code> annotationï¼Œæœ‰çš„è¯ï¼Œåªèƒ½é€‰æ‹©annotationæŒ‡å®šçš„nodeã€‚</p>
<figure>
    <img src="/VolumeBindingMode/filter-1.png" width="1000px"/> 
</figure>

<p>å¦åˆ™åœ¨é›†ç¾¤ä¸­å¯»æ‰¾æå‰åˆ›å»ºçš„ä¸”æ»¡è¶³PVCè¦æ±‚çš„PVï¼ŒåŒæ—¶Nodeä¹Ÿè¦æ»¡è¶³PVçš„affinityè¦æ±‚ï¼Œè¿›è¡ŒPV-&gt;PVCçš„ç»‘å®šï¼ˆè¿™å±äºstatic bindingï¼‰ï¼Œå¦åˆ™è¿™ä¸ªPVCéœ€è¦è¿›è¡Œdynamic provisionã€‚</p>
<figure>
    <img src="/VolumeBindingMode/filter-2.png" width="1000px"/> 
</figure>

<p>å¦‚æœå­˜åœ¨éœ€è¦è¿›è¡Œdynamic provisionçš„PVCï¼Œå°±å†è¿›è¡Œå¦‚ä¸‹è¿‡æ»¤ï¼Œä¸»è¦æ˜¯åˆ¤æ–­ï¼š1. åˆ¤æ–­Nodeæ˜¯å¦èƒ½æ»¡è¶³scé‡Œå®šä¹‰çš„topology 2. CSIStorageCapacityè¿™ä¸ªfeatureå¼€å¯äº†çš„è¯ï¼Œéœ€è¦åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æœ‰è¶³å¤Ÿçš„volumeå®¹é‡</p>
<figure>
    <img src="/VolumeBindingMode/filter-3.png" width="1000px"/> 
</figure>

<h3 id="score">Score</h3>
<p>åœ¨ä¼˜é€‰(Score)é˜¶æ®µï¼Œåªéœ€è¦æ ¹æ®static bindingçš„æƒ…å†µæ¥è¿›è¡Œæ‰“åˆ†ï¼šåŸºäºvolume capacityçš„æƒ…å†µæ¥å¯¹èŠ‚ç‚¹è¿›è¡Œä¼˜é€‰</p>
<figure>
    <img src="/VolumeBindingMode/score.png" width="1000px"/> 
</figure>

<h3 id="reserve">Reserve</h3>
<p>åœ¨é¢„å (Reserve)é˜¶æ®µï¼Œå¯¹äºstatic binding çš„PVï¼Œåœ¨è¿™é‡ŒåšPV -&gt; PVCçš„ç»‘å®šï¼Œå³æ›´æ–°PVçš„ClaimRefå­—æ®µã€‚</p>
<figure>
    <img src="/VolumeBindingMode/reserve.png" width="1000px"/> 
</figure>

<p>å¯¹äºdynamic provisionçš„PVCï¼Œåˆ™è®¾ç½®<code>volume.kubernetes.io/selected-node</code> annotation</p>
<figure>
    <img src="/VolumeBindingMode/reserve-2.png" width="1000px"/> 
</figure>

<h3 id="prebind">PreBind</h3>
<p>åœ¨PreBindé˜¶æ®µï¼Œå…ˆå‘API Serveræ›´æ–°PVCå’ŒPVã€‚å‰é¢åœ¨Reserveè¿™ä¸ªæ­¥éª¤ä¸­å·²ç»æ›´æ–°äº†æœ¬åœ°ç¼“å­˜ï¼Œç°åœ¨æ˜¯æ›´æ–°åˆ°API Serverä¸­ã€‚å³å¯¹äºstatic bindçš„PVCï¼Œè®¾ç½®PVçš„ClaimRefï¼Œå¯¹äºdynamic provisionçš„PVCï¼Œè®¾ç½®äº†<code>volume.kubernetes.io/selected-node</code> annotationã€‚</p>
<p>ç„¶åç­‰å¾…PV controllerå®ŒæˆPVC -&gt; PVçš„ç»‘å®šï¼Œå®Œæˆçš„æ ‡å¿—æ˜¯<code>pvc.Spec.VolumeName</code>å’Œ<code>pv.kubernetes.io/bind-completed</code> annotationè¢«è®¾ç½®</p>
<figure>
    <img src="/VolumeBindingMode/prebind.png" width="1000px"/> 
</figure>

<h2 id="persistentvolume-controller">persistentvolume controller</h2>
<p>è¿™éƒ¨åˆ†çš„ä»£ç ä½äº<a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/volume/persistentvolume/pv_controller.go">pv_controller.go</a>ä¸­ã€‚</p>
<p>pv controllerå°è¯•ä¸ºPVCå¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„volumeï¼Œä½†æ˜¯å¦‚æœæ˜¯<code>WaitForFirstConsumer</code>çš„PVCï¼Œæ ¹æ®ä¸Šé¢è°ƒåº¦å™¨çš„åˆ†æï¼Œè°ƒåº¦å™¨ä¼šé€‰æ‹©åˆé€‚çš„PVå¹¶è¿›è¡ŒPV-&gt;PVCçš„ç»‘å®šï¼Œè€Œpv controlleråˆ™ä¸ä¼šåšè¿™ä»¶äº‹ã€‚</p>
<figure>
    <img src="/VolumeBindingMode/volumecontroller.png" width="1000px"/> 
</figure>

<p>è€Œæœ‰äº†PV -&gt; PVCçš„ç»‘å®šï¼Œpv controlleråªéœ€è¦å®ŒæˆPVC -&gt; PVçš„ç»‘å®šå¹¶è®¾ç½®<code>pv.kubernetes.io/bind-completed</code> annotation å³å¯ã€‚</p>
<p>ä½†æ˜¯å¦‚æœæ˜¯<code>Immediate</code>çš„PVCï¼Œæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œå¦‚æœä¸boundï¼Œè°ƒåº¦å™¨å‹æ ¹å°±ä¸ä¼šè°ƒåº¦Podã€‚æ‰€ä»¥æ˜¯é controlleræ¥æ‰¾åˆé€‚çš„PVï¼Œå¹¶ä¸”å®ŒæˆPVå’ŒPVCçš„ç»‘å®šã€‚</p>
<p>ä½†æ˜¯å¦‚æœé›†ç¾¤é‡Œæ²¡æœ‰åˆé€‚çš„é¢„å…ˆåˆ›å»ºå¥½çš„PVå¯ä¾›PVCè¿›è¡Œstatic bindingï¼Œé‚£ä¹ˆå°±è¦å…ˆè§¦å‘external provisionerè¿›è¡Œdynamic provision pvã€‚è§¦å‘çš„æ–¹å¼å°±æ˜¯è®¾ç½®<code>volume.kubernetes.io/storage-provisioner</code>è¿™ä¸ªannotationçš„å€¼ä¸ºæŒ‡å®šçš„provisioner nameã€‚</p>
<h2 id="external-provisioner">external provisioner</h2>
<p><a href="https://github.com/kubernetes-csi/external-provisioner">external provisioner</a>ä¸­çš„ProvisionControllerè´Ÿè´£æ ¹æ®watchåˆ°çš„PVCäº‹ä»¶æ¥å†³å®šè¦ä¸è¦ä¸ºå®ƒprovision volumeå¹¶åˆ›å»ºPVã€‚</p>
<figure>
    <img src="/VolumeBindingMode/provisioner-1.png" width="1000px"/> 
</figure>

<p>åœ¨<code>shouldProvision</code>ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­<code>volume.kubernetes.io/storage-provisioner</code> annotationè®¾ç½®çš„provisioner nameæ˜¯ä¸æ˜¯è‡ªå·±ï¼›å¦‚æœæ˜¯<code>WaitForFirstConsumer</code>çš„PVCï¼Œè¿˜å¿…é¡»è¦æ±‚<code>volume.kubernetes.io/selected-node</code>è¿™ä¸ªannotationå­˜åœ¨ï¼Œæ‰èƒ½è¿›è¡Œprovisionã€‚</p>
<p>æ³¨é‡Šä¸­è¿˜æåˆ°ï¼Œprovisionerä¼šé€šè¿‡remove <code>volume.kubernetes.io/selected-node</code> è¿™ä¸ªannotationæ¥è§¦å‘è°ƒåº¦å™¨æ¥è¿›è¡Œrescheduleã€‚å› ä¸ºæœ‰çš„æ—¶å€™åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šè¿›è¡Œdynamic provisionæ—¶ï¼Œè¿˜å¯èƒ½å› ä¸ºèµ„æºç­‰é—®é¢˜è€Œå¤±è´¥ï¼Œè¿™åœ¨è°ƒåº¦é˜¶æ®µå¹¶ä¸èƒ½æ„ŸçŸ¥ï¼Œæ‰€ä»¥å°±æœ‰é‡è°ƒåº¦çš„éœ€æ±‚ã€‚</p>
<figure>
    <img src="/VolumeBindingMode/provisioner-2.png" width="1000px"/> 
</figure>

]]></content>
		</item>
		
		<item>
			<title>åœ¨WSLä¸­ä½¿ç”¨VPNç¢°åˆ°çš„ç½‘ç»œé—®é¢˜</title>
			<link>https://cvvz.fun/post/wsl-vpn-issue/</link>
			<pubDate>Mon, 22 Aug 2022 09:23:12 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/wsl-vpn-issue/</guid>
			<description>æœ€è¿‘ç”±äºå·¥ä½œåŸå› ï¼Œä¸å¾—ä¸å°†å·¥ä½œæœºåˆ‡æ¢åˆ°Windowsç³»ç»Ÿï¼Œå‡†å¤‡è£…ä¸ªWSLä½œä¸ºoverlayçš„å·¥ä½œç¯å¢ƒã€‚å®‰è£…ã€é…ç½®éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å‘ç°ä¸»æœºæ¥</description>
			<content type="html"><![CDATA[<p>æœ€è¿‘ç”±äºå·¥ä½œåŸå› ï¼Œä¸å¾—ä¸å°†å·¥ä½œæœºåˆ‡æ¢åˆ°Windowsç³»ç»Ÿï¼Œå‡†å¤‡è£…ä¸ªWSLä½œä¸ºoverlayçš„å·¥ä½œç¯å¢ƒã€‚å®‰è£…ã€é…ç½®éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å‘ç°ä¸»æœºæ¥äº†VPNä»¥åï¼Œè™šæ‹Ÿæœºæ²¡æ³•ç§‘å­¦ä¸Šç½‘äº†ã€‚åˆ©ç”¨å‘¨æœ«æ—¶é—´æŠ˜è…¾äº†ä¸€ä¸‹ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹è°ƒæŸ¥å’Œè§£å†³é—®é¢˜çš„è¿‡ç¨‹ã€‚</p>
<h2 id="åŸºæœ¬ä¿¡æ¯">åŸºæœ¬ä¿¡æ¯</h2>
<p>ä¸»æœºï¼šWindows10, OS build: 19044.1889</p>
<p>wslï¼šUbuntu 20.04</p>
<p>WSLæœ‰1å’Œ2ä¸¤ä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸¤ä¸ªç‰ˆæœ¬çš„<a href="https://learn.microsoft.com/en-us/windows/wsl/compare-versions#:~:text=WSL%202%20is%20running,will%20change%20on%20restart.">åŒºåˆ«</a>æ˜¯wsl1ä»¥æ¡¥æ¥æ–¹å¼åŠ å…¥ä¸»æœºç½‘ç»œï¼Œç±»ä¼¼äºdockerçš„hostç½‘ç»œæ¨¡å¼ï¼Œå’Œå®¿ä¸»æœºå…±ç”¨åŒä¸€ä¸ªnetwork namespaceï¼›wsl2åˆ™æœ‰ç‹¬ç«‹çš„è™šæ‹Ÿä»¥å¤ªç½‘å¡å’Œipåœ°å€ï¼Œé€šè¿‡NATçš„æ–¹å¼è®¿é—®Internetã€‚ä¸»æœºVPNå¯¼è‡´çš„ç½‘ç»œé—®é¢˜åœ¨wsl1å’Œwsl2ä¸Šéƒ½å­˜åœ¨ï¼Œä½†æ˜¯é—®é¢˜åŸå› ä¸ä¸€æ ·ï¼Œè¿™é‡Œåˆ†å¼€è®¨è®ºã€‚</p>
<h2 id="wsl1">WSL1</h2>
<h3 id="æ•´ä½“ç½‘ç»œç¯å¢ƒ">æ•´ä½“ç½‘ç»œç¯å¢ƒ</h3>
<figure>
    <img src="/wsl-vpn/wsl1-network.drawio.svg" width="700px"/> 
</figure>

<h3 id="ä¸»æœºç¯å¢ƒ">ä¸»æœºç¯å¢ƒ</h3>
<p><strong>ç½‘ç»œè®¾å¤‡</strong></p>
<figure>
    <img src="/wsl-vpn/wsl1-host-devices.png" width="1000px"/> 
</figure>

<p>å›¾ä¸­Ethernetæ˜¯æˆ‘çš„ç‰©ç†ç½‘å¡ï¼ˆ192.168.31.8ï¼‰ï¼Œè¿æ¥å°ç±³è·¯ç”±å™¨ï¼ˆ192.168.31.1ï¼‰ï¼ŒMSFTVPNæ˜¯VPè™šæ‹Ÿå‡ºæ¥çš„ä¸€å—è™šæ‹Ÿç½‘å¡ï¼ˆ100.64.16.6ï¼‰ã€‚</p>
<p><strong>è·¯ç”±è¡¨</strong></p>
<figure>
    <img src="/wsl-vpn/wsl1-host-route.png" width="700px"/> 
</figure>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯è·¯ç”±è¡¨å¼€å¤´æœ‰ä¸¤æ¡é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œå†…æ ¸ä¼šé€‰æ‹©metricè¾ƒå°çš„é‚£ä¸ªä½œä¸ºé«˜ä¼˜å…ˆçº§çš„ç½‘ç»œæ¥å£ã€‚(æ•°æ®æµå’Œmetricçš„å…³ç³»å°±å¥½åƒç”µæµå’Œç”µé˜»çš„å…³ç³»:) )è¿™è¯´æ˜ä¸»æœºæµé‡ä¼šå¼ºåˆ¶é€šè¿‡VPNè™šæ‹Ÿç½‘å¡ï¼Œæ— è®ºæ˜¯è®¿é—®å¢™å†…è¿˜æ˜¯å¢™å¤–ç½‘ç«™ã€‚è¿™ä¸€ç‚¹åœ¨<a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/vpn/vpn-routing#force-tunnel-configuration">å®˜æ–¹æ–‡æ¡£</a>ä¸­æœ‰è§£é‡Šã€‚</p>
<h3 id="wslç¯å¢ƒ">wslç¯å¢ƒ</h3>
<p>åœ¨wslå†…çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡å’Œè·¯ç”±è¡¨å’Œä¸»æœºå‡ ä¹ç›¸åŒã€‚è¯´æ˜wsl1å’Œwindowså®¿ä¸»æœºä¸¤è€…å…±å¤„åœ¨åŒä¸€ä¸ªnetwork namespaceä¸­ã€‚</p>
<figure>
    <img src="/wsl-vpn/wsl1-vm-devices.png" width="700px"/> 
</figure>

<h3 id="é—®é¢˜å’Œæ’æŸ¥è¿‡ç¨‹">é—®é¢˜å’Œæ’æŸ¥è¿‡ç¨‹</h3>
<p>é—®é¢˜ï¼šæ‰§è¡Œ <code>/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot;</code> è¯•å›¾å®‰è£…brewå‘ç°æ— å“åº”ã€‚</p>
<p>ç»è¿‡æ’æŸ¥å‘ç°æ˜¯è™šæ‹Ÿæœºä¸­åŸŸåè§£æå‡ºäº†é—®é¢˜</p>
<figure>
    <img src="/wsl-vpn/wsl1-vm-dns.png" width="700px"/> 
</figure>

<p>ä½†æ˜¯åœ¨ä¸»æœºä¸­åŸŸåè§£ææ˜¯OKçš„ã€‚</p>
<figure>
    <img src="/wsl-vpn/wsl1-host-dns.png" width="800px"/> 
</figure>

<p>ä¿®æ”¹è™šæ‹Ÿæœºçš„<code>/etc/hosts</code>æ–‡ä»¶ï¼Œæ·»åŠ  <code>185.199.108.133 raw.githubusercontent.com</code> å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†è¿™åªæ˜¯ä¸€ç§workaroudï¼Œç»•è¿‡äº†åŸŸåè§£æï¼Œç›´æ¥ä½¿ç”¨IPåœ°å€ï¼ŒçœŸæ­£çš„é—®é¢˜æ˜¯dnsè§£æå¤±è´¥å¹¶æ²¡æœ‰è§£å†³ï¼Œè®¿é—®å…¶ä»–ç½‘ç«™ä»ç„¶å¯èƒ½å‡ºé”™ã€‚ä¸è¿‡è¿™è‡³å°‘è¯´æ˜äº†è™šæ‹Ÿæœºå†…éƒ¨æ˜¯èƒ½å¤Ÿé€šè¿‡VPNè®¿é—®åˆ°Internetçš„ï¼Œåªè¦è§£å†³äº†åŸŸåçš„é—®é¢˜ï¼Œå°±èƒ½è§£å†³curlä¸é€šçš„é—®é¢˜äº†ã€‚</p>
<p>é‚£ä¹ˆdnsä¸ºä»€ä¹ˆä¼šè§£æå¤±è´¥ï¼ŸæŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼Œå‘ç°è¿™ä¸ªwslè‡ªåŠ¨ç”Ÿæˆçš„dnsé…ç½®æ–‡ä»¶è®¾ç½®çš„dns serveræ˜¯å°ç±³è·¯ç”±å™¨ç½‘å…³çš„ipåœ°å€192.168.31.1
<figure>
    <img src="/wsl-vpn/dns-config.png" width="900px"/> 
</figure>
</p>
<p>æƒ³åˆ°åœ¨ä¸»æœºä¸Šè§£æåŸŸåæ˜¯æˆåŠŸçš„ï¼ŒçŒœæµ‹ä¸»æœºä½¿ç”¨çš„dnsæœåŠ¡å™¨åº”è¯¥ä¸æ˜¯è·¯ç”±å™¨ç½‘å…³ã€‚ç”±äºåœ¨ä¸»æœºé…ç½®ä¸­æ²¡æœ‰æ‰¾åˆ°å…¶ä»–dns serverï¼Œæ‰€ä»¥æƒ³æŠ“åŒ…çœ‹çœ‹è™šæ‹Ÿæœºçš„åŸŸåè§£æå’Œä¸»æœºæœ‰å•¥åŒºåˆ«ï¼Œç»“æœå‘ç°ä¸»æœºä¸Šæ‰€æœ‰ä¸VPN Serveré€šä¿¡çš„æ•°æ®å…¨éƒ¨è¢«åŠ å¯†å¤„ç†äº†ï¼š
<figure>
    <img src="/wsl-vpn/data-capture-host.png" width="900px"/> 
</figure>
</p>
<p>ä½†æ˜¯è¿›ä¸€æ­¥è¯å®äº†è™šæ‹Ÿæœºä¸­åŸŸåè§£æçš„æŠ¥æ–‡çš„ç¡®æ˜¯ç›´æ¥å‘ç»™äº†ç½‘å…³ï¼š
<figure>
    <img src="/wsl-vpn/data-capture-vm.png" width="1000px"/> 
</figure>
</p>
<p>åæ¥åˆæƒ³èƒ½ä¸èƒ½ç›´æ¥æŠ“VPNçš„è¿™å—è™šæ‹Ÿç½‘å¡å‘¢ï¼Œè¿™æ ·ä¸å°±æ‹¿åˆ°æ˜æ–‡æ•°æ®äº†å—ï¼Ÿç»“æœå‘ç°windowsä¸Šwiresharkçœ‹ä¸åˆ°è¿™å—è®¾å¤‡ï¼Œè€Œwsl1é‡Œç³»ç»Ÿè°ƒç”¨æ”¯æŒä¸å…¨ï¼ŒæŠ“åŒ…å¤±è´¥ã€‚ã€‚</p>
<p>ä½†æ˜¯æ‰¾åˆ°äº†æ­£ç¡®çš„æ–¹å‘è§£å†³èµ·æ¥å°±å¾ˆå¿«äº†ï¼Œåœ¨ç½‘ä¸ŠæŸ¥æ‰¾VPNåŸŸåè§£æç›¸å…³çš„å†…å®¹æ—¶æ‰¾åˆ°äº†è¿™ç¯‡<a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/vpn/vpn-name-resolution">æ–‡æ¡£</a>ï¼Œä»‹ç»äº†Windows VPNè¿›è¡ŒåŸŸåè§£ææ—¶ï¼Œä¼šå…ˆå»æŸ¥è¯¢<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee649207(v=ws.10)">NRPT</a>è¡¨ï¼Œæˆ‘åœ¨ä¸»æœºä¸Šæ‰¾åˆ°äº†è¿™å¼ è¡¨ï¼Œå…¶ä¸­å®šä¹‰äº†DNS Serverï¼š</p>
<figure>
    <img src="/wsl-vpn/nrpt.png" width="800px"/> 
</figure>

<p>æ‰‹åŠ¨ä¿®æ”¹è™šæ‹ŸæœºDNSé…ç½®æ–‡ä»¶ï¼Œé—®é¢˜è§£å†³ã€‚</p>
<h2 id="wsl2">WSL2</h2>
<p>WSL1å‡çº§åˆ°WSL2ä¹‹åï¼Œè¿™ä¸ªç½‘ç»œé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯åŸå› ä¸åŒã€‚fyiï¼Œè¿™ä¸ªé—®é¢˜æˆ‘è¿˜æ²¡æ‰¾åˆ°æ ¹å› ï¼Œæš‚æ—¶è¿˜æ˜¯ç»§ç»­ç”¨WSL1ã€‚ã€‚</p>
<h3 id="æ•´ä½“ç½‘ç»œç¯å¢ƒ-1">æ•´ä½“ç½‘ç»œç¯å¢ƒ</h3>
<figure>
    <img src="/wsl-vpn/wsl2-network.drawio.svg" width="700px"/> 
</figure>

<h3 id="ä¸»æœºç¯å¢ƒ-1">ä¸»æœºç¯å¢ƒ</h3>
<p>WSL2ä¸­çš„è™šæ‹Ÿæœºå’Œä¸»æœºä¸åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œè™šæ‹Ÿæœºé€šè¿‡NATï¼Œè½¬æ¢ä¸ºä¸»æœºçš„ipè®¿é—®å¤–ç½‘ï¼ˆä½¿ç”¨VPNæ—¶ï¼Œåˆ™æ˜¯è½¬æ¢ä¸ºVPNçš„client ipè®¿é—®VPN serverå†è®¿é—®å¤–ç½‘ï¼Œå½“ç„¶å®é™…æµé‡ä¹Ÿæ˜¯æ­è½½åœ¨çœŸå®ç‰©ç†ç½‘ç»œä¹‹ä¸Šï¼‰ã€‚å‡çº§WSL2åï¼Œåœ¨ä¸»æœºä¸Šå‡ºç°äº†ä¸€å—åä¸ºWSLçš„è™šæ‹Ÿç½‘å¡172.20.176.1ï¼š</p>
<figure>
    <img src="/wsl-vpn/wsl2-host-devices.png" width="1000px"/> 
</figure>

<h3 id="wslç¯å¢ƒ-1">wslç¯å¢ƒ</h3>
<figure>
    <img src="/wsl-vpn/wsl2-vm-devices.png" width="900px"/> 
</figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œwsl2æœ‰è‡ªå·±çš„ç½‘ç»œè®¾å¤‡å’Œè·¯ç”±è§„åˆ™ã€‚ä¸å†åƒwsl1é‚£æ ·ä¸å®¿ä¸»æœºå…±ç”¨ç½‘ç»œè®¾å¤‡å’Œè·¯ç”±è¡¨ã€‚åœ¨è™šæ‹Ÿæœºä¸­æœ‰ä¸€å—ç½‘å¡eth0ï¼Œipåœ°å€ä¸º172.20.179.153/20ï¼Œé»˜è®¤è·¯ç”±é€šè¿‡è¿™ä¸ªç½‘å¡å‘åˆ°å®¿ä¸»æœºä¸Šçš„è™šæ‹Ÿç½‘å¡172.20.176.1ã€‚</p>
<h3 id="é—®é¢˜æ’æŸ¥è¿‡ç¨‹">é—®é¢˜æ’æŸ¥è¿‡ç¨‹</h3>
<p>é¦–å…ˆdnsè§£ææ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œpingå¤–ç½‘ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œè¯´æ˜æ•´ä¸ªç½‘ç»œé“¾è·¯æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
<p>é‚£ä¹ˆå…ˆçœ‹çœ‹curlå‘½ä»¤å…·ä½“å¡åœ¨å“ªä¸€æ­¥ï¼š</p>
<figure>
    <img src="/wsl-vpn/curl.png" width="900px"/> 
</figure>

<p>æ˜¯å¡åœ¨tlsæ¡æ‰‹æµç¨‹ï¼Œæ²¡æœ‰æ”¶åˆ°serverç«¯çš„å“åº”ã€‚</p>
<p>æ¥ç€åœ¨è™šæ‹Ÿæœºé‡ŒæŠ“åŒ…ï¼Œä½†æ˜¯ä¹Ÿåªæ˜¯åŒæ ·å‘ç°clientä¸€ç›´æ²¡æœ‰æ”¶åˆ°server helloçš„å“åº”ï¼š</p>
<figure>
    <img src="/wsl-vpn/hello.png" width="900px"/> 
</figure>

<p>ç‰©ç†æœºä¸ŠæŠ“åŒ…åªèƒ½çœ‹åˆ°ä¸€å †åŠ å¯†åçš„æ•°æ®åŒ…ï¼Œæ²¡æœ‰ä»»ä½•æœ‰å¸®åŠ©çš„ä¿¡æ¯ã€‚</p>
<p>åæ¥åˆè¿›ä¸€æ­¥å‘ç°curlå¤§éƒ¨åˆ†httpsç«™ç‚¹æœ‰é—®é¢˜ï¼Œæœ‰ä¸€äº›æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯è¿™ä¹Ÿæ²¡æœ‰ç»™æˆ‘å¸¦æ¥ä»€ä¹ˆå®è´¨æ€§çš„å¯å‘ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜æˆ‘æœ€ç»ˆæ²¡æœ‰æ‰¾åˆ°æ ¹å› ï¼Œä¹Ÿè¿˜æ²¡æœ‰è§£å†³ã€‚githubä¸Šæœ‰ç±»ä¼¼çš„<a href="https://github.com/microsoft/WSL/issues/5068">issue</a>ï¼Œä½†æ˜¯è¿™é‡Œæåˆ°çš„workaroundçš„æ–¹æ³•å¯¹æˆ‘éƒ½ä¸èµ·ä½œç”¨ã€‚</p>
<p>æœ€åå¦‚æœç»§ç»­æ’æŸ¥è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘è§‰å¾—éœ€è¦å€ŸåŠ©ä¸€äº›å†…æ ¸å·¥å…·ï¼Œæ²¿ç€æ•°æ®è¿”å›çš„é“¾è·¯ä¾æ¬¡è°ƒæŸ¥ï¼šå®¿ä¸»æœºç‰©ç†ç½‘å¡-&gt;å®¿ä¸»æœºå†…æ ¸åè®®æ ˆ-&gt;è§£å¯†æ•°æ®-&gt;VPNè™šæ‹Ÿç½‘å¡-&gt;å®¿ä¸»æœºå†…æ ¸åè®®æ ˆ-&gt;DNATå¹¶è·¯ç”±-&gt;wslçš„è™šæ‹Ÿç½‘å¡-&gt;è¿›å…¥linuxå†…æ ¸åè®®æ ˆã€‚</p>
<hr>
<p>æœ€è¿‘åœ¨æŸ¥<code>apiserver TLS handshake timeout</code>çš„é—®é¢˜çš„æ—¶å€™ï¼Œæ‰¾åˆ°äº†è¿™ä¸ªé—®é¢˜çš„<a href="https://stackoverflow.com/a/71723695">è§£å†³åŠæ³•</a>ï¼Œå°±æ˜¯<strong>æŠŠWLS2çš„eth0çš„MTUè°ƒæ•´ä¸ºå’ŒVPNè™šæ‹Ÿç½‘å¡çš„MTUä¸€è‡´</strong>ï¼Œè¿™æ ·æ•°æ®å¸§æ‰èƒ½æ­£ç¡®çš„encode/decodeï¼Œæ¯”å¦‚ï¼š<code>sudo ip link set dev eth0 mtu 1350</code>ã€‚è¿™ä¸ªæ–¹æ³•åœ¨è¿™ä¸ª<a href="https://github.com/microsoft/WSL/issues/4698#issuecomment-628682785">issue</a>é‡Œä¹Ÿæœ‰æåˆ°ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>k8så­˜å‚¨æ¼”è¿›è¿‡ç¨‹</title>
			<link>https://cvvz.fun/post/kubernetes-storage-history/</link>
			<pubDate>Wed, 15 Jun 2022 13:22:45 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/kubernetes-storage-history/</guid>
			<description>æœ€è¿‘åœ¨åšä¸€äº›CSIç›¸å…³çš„å·¥ä½œï¼Œé‡æ–°çœ‹äº†ä¸€ä¸‹ä¹‹å‰çš„ç¬”è®°å’Œèµ„æ–™ï¼Œå‘ç°kubernetesä»æœ€åˆç®€å•çš„Volumeåˆ°ç°åœ¨å¤æ‚çš„CSIçš„è®¾è®¡ï¼Œæœ‰ä¸€ä¸ª</description>
			<content type="html"><![CDATA[<p>æœ€è¿‘åœ¨åšä¸€äº›CSIç›¸å…³çš„å·¥ä½œï¼Œé‡æ–°çœ‹äº†ä¸€ä¸‹ä¹‹å‰çš„ç¬”è®°å’Œèµ„æ–™ï¼Œå‘ç°kubernetesä»æœ€åˆç®€å•çš„Volumeåˆ°ç°åœ¨å¤æ‚çš„CSIçš„è®¾è®¡ï¼Œæœ‰ä¸€ä¸ªé€æ­¥æ¼”è¿›çš„è¿‡ç¨‹ï¼Œææ¸…æ¥šä¸€ä¸ªæŠ€æœ¯çš„å†å²å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£å’ŒæŒæ¡å®ƒã€‚</p>
<h2 id="volume">Volume</h2>
<p>è¦åœ¨ä¸€ä¸ª Pod é‡Œå£°æ˜ Volumeï¼Œåªè¦åœ¨ Pod é‡ŒåŠ ä¸Š <code>spec.volumes</code> å­—æ®µå³å¯ã€‚ç„¶åï¼Œä½ å°±å¯ä»¥åœ¨è¿™ä¸ªå­—æ®µé‡Œå®šä¹‰ä¸€ä¸ªå…·ä½“ç±»å‹çš„ Volume äº†ï¼Œæ¯”å¦‚ï¼šhostPathï¼ŒemptyDirç­‰ã€‚ç°åœ¨é€šå¸¸ç›´æ¥ç”¨Volumeçš„æƒ…å†µå±€é™åœ¨ä½¿ç”¨å®¿ä¸»æœºçš„æœ¬åœ°å­˜å‚¨ï¼Œä¸ºä»€ä¹ˆä¸æ¨èé€šè¿‡Volumeä½¿ç”¨æŸä¸ªå…·ä½“çš„ç½‘ç»œå­˜å‚¨å‘¢ï¼Ÿå¯ä»¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="ln"> 1</span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="ln"> 2</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="ln"> 3</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="ln"> 4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rbd</span><span class="w">
</span><span class="ln"> 5</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="ln"> 6</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="ln"> 7</span><span class="w">    </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes/pause</span><span class="w">
</span><span class="ln"> 8</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rbd-rw</span><span class="w">
</span><span class="ln"> 9</span><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="ln">10</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rbdpd</span><span class="w">
</span><span class="ln">11</span><span class="w">        </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/rbd</span><span class="w">
</span><span class="ln">12</span><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="ln">13</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rbdpd</span><span class="w">
</span><span class="ln">14</span><span class="w">      </span><span class="nt">rbd</span><span class="p">:</span><span class="w">
</span><span class="ln">15</span><span class="w">        </span><span class="nt">monitors</span><span class="p">:</span><span class="w">
</span><span class="ln">16</span><span class="w">          </span>- <span class="s1">&#39;10.16.154.78:6789&#39;</span><span class="w">
</span><span class="ln">17</span><span class="w">        </span><span class="nt">pool</span><span class="p">:</span><span class="w"> </span><span class="l">kube</span><span class="w">
</span><span class="ln">18</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span><span class="ln">19</span><span class="w">        </span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span><span class="ln">20</span><span class="w">        </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="ln">21</span><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span><span class="ln">22</span><span class="w">        </span><span class="nt">keyring</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/ceph/keyring</span><span class="w">
</span><span class="ln">23</span><span class="w">        </span><span class="nt">imageformat</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span><span class="ln">24</span><span class="w">        </span><span class="nt">imagefeatures</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;layering&#34;</span><span class="w">
</span></code></pre></div><p>å¯ä»¥å‘ç°ï¼Œç›´æ¥é€šè¿‡Volumeä½¿ç”¨ç½‘ç»œå­˜å‚¨æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å¼€å‘è€…éœ€è¦ç†Ÿæ‚‰æ‰€ä½¿ç”¨çš„å­˜å‚¨çš„å„ç§é…ç½®å‚æ•°</li>
<li>æš´éœ²äº†å­˜å‚¨æœåŠ¡apiã€ç”¨æˆ·åã€æˆæƒæ–‡ä»¶ç­‰æ•æ„Ÿä¿¡æ¯</li>
</ol>
<h2 id="pvcpv">PVC/PV</h2>
<p>ä¸ºäº†è§£å†³ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ï¼Œk8sé¡¹ç›®å¼•å…¥äº†PVC/PVã€‚</p>
<p>PVCé¢å‘å¼€å‘äººå‘˜ï¼Œå¼€å‘äººå‘˜ä¸ç”¨å†çŸ¥é“å¤§é‡çš„å­˜å‚¨å®ç°ç»†èŠ‚ï¼Œåªéœ€è¦å£°æ˜éœ€è¦çš„å­˜å‚¨å®¹é‡å’Œè¯»å†™æƒé™ç­‰ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-yml" data-lang="yml"><span class="ln"> 1</span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span><span class="ln"> 2</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="ln"> 3</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="ln"> 4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv-claim</span><span class="w">
</span><span class="ln"> 5</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="ln"> 6</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="ln"> 7</span><span class="w">  </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="ln"> 8</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="ln"> 9</span><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="ln">10</span><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></code></pre></div><p>è€ŒPVé¢å‘å­˜å‚¨ç®¡ç†äººå‘˜ï¼Œä»–ä»¬ç†ŸçŸ¥å­˜å‚¨ä½¿ç”¨ç»†èŠ‚ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-yml" data-lang="yml"><span class="ln"> 1</span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span><span class="ln"> 2</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="ln"> 3</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="ln"> 4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv-volume</span><span class="w">
</span><span class="ln"> 5</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="ln"> 6</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span><span class="ln"> 7</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="ln"> 8</span><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span><span class="ln"> 9</span><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w">
</span><span class="ln">10</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="ln">11</span><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="ln">12</span><span class="w">  </span><span class="nt">rbd</span><span class="p">:</span><span class="w">
</span><span class="ln">13</span><span class="w">    </span><span class="nt">monitors</span><span class="p">:</span><span class="w">
</span><span class="ln">14</span><span class="w">    </span>- <span class="s1">&#39;10.16.154.78:6789&#39;</span><span class="w">
</span><span class="ln">15</span><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w"> </span><span class="l">kube</span><span class="w">
</span><span class="ln">16</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span><span class="ln">17</span><span class="w">    </span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span><span class="ln">18</span><span class="w">    </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="ln">19</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span><span class="ln">20</span><span class="w">    </span><span class="nt">keyring</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/ceph/keyring</span><span class="w">
</span></code></pre></div><p>é€šè¿‡PVC/PVè§£å†³äº†å¼€å‘è€…ä½¿ç”¨å­˜å‚¨çš„å›°éš¾ï¼Œä½†æ˜¯æ²¡æœ‰è§£å†³è¿ç»´äººå‘˜ç®¡ç†å­˜å‚¨çš„å›°éš¾ã€‚k8sè™½ç„¶æŠŠç½‘ç»œå­˜å‚¨<strong>attach</strong>ã€<strong>mount</strong>åˆ°å®¿ä¸»æœºå’Œmountåˆ°å®¹å™¨çš„æµç¨‹è‡ªåŠ¨åŒ–äº†ï¼ˆå‚è€ƒ<a href="https://cvvz.github.io/post/kubernetes-storage-history/#volume%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">æœ€åä¸€èŠ‚</a>ï¼‰ï¼Œä½†æ˜¯åˆ›å»ºï¼ˆ<strong>provision</strong>ï¼‰ç½‘ç»œå­˜å‚¨çš„å·¥ä½œè¿˜æ²¡æœ‰è‡ªåŠ¨åŒ–ï¼Œè¿ç»´äººå‘˜è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨åˆ›å»ºç½‘ç»œå­˜å‚¨å’ŒPVã€‚</p>
<h2 id="storageclass">StorageClass</h2>
<p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¼•å…¥äº†StorageClassï¼Œå€ŸåŠ©storageclasså’Œ<a href="https://github.com/kubernetes-retired/external-storage">external-storageåº“</a>ï¼Œå¯ä»¥ä½¿å¾—å­˜å‚¨çš„provisionå˜å¾—è‡ªåŠ¨åŒ–ï¼ˆå³è‡ªåŠ¨çš„åˆ›å»ºç½‘ç»œå­˜å‚¨å’ŒPVï¼‰ã€‚æ¯”å¦‚å£°æ˜ä¸‹é¢è¿™ä¸ªscï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-yml" data-lang="yml"><span class="ln">1</span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span><span class="ln">2</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span><span class="ln">3</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="ln">4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">block-service</span><span class="w">
</span><span class="ln">5</span><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/gce-pd</span><span class="w">
</span><span class="ln">6</span><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="ln">7</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pd-ssd</span><span class="w">
</span></code></pre></div><p>åˆ™å¯ä»¥å€ŸåŠ©<code> kubernetes.io/gce-pd</code>å­˜å‚¨æ’ä»¶ï¼ˆåŸºäº<a href="https://github.com/kubernetes-retired/external-storage">external-storageåº“</a>å¼€å‘ï¼‰è‡ªåŠ¨åˆ›å»ºç½‘ç»œå­˜å‚¨å’ŒPVã€‚</p>
<h2 id="flexvolume">FlexVolume</h2>
<p>ç°åœ¨çœ‹èµ·æ¥ä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜äº†ã€‚ä½†è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œéšç€å„ç§äº‘å­˜å‚¨å±‚å‡ºä¸ç©·ï¼Œè¶Šæ¥è¶Šå¤šçš„å­˜å‚¨å‚å•†æƒ³è¦æŠŠè‡ªå·±çš„å­˜å‚¨æ’ä»¶å¡åˆ°k8sçš„ä¸»å¹²ä»£ç ï¼ˆin-treeï¼‰ä¸­ï¼ˆpkg/volumeï¼‰ã€‚æ‰€ä»¥k8sæƒ³æä¾›ä¸€ç§æŠ½è±¡å±‚ï¼Œä½¿å¾—æ–°å¢çš„å­˜å‚¨æ’ä»¶ä¸å¿…å’Œk8sä¸»å¹²ä¸€èµ·æ¼”è¿›å’Œæµ‹è¯•ã€‚éšåå°±å¼•å…¥äº†FlexVolumeè¿™ç§Volumeç±»å‹ã€‚</p>
<p>å¯¹äº<code>attach</code>å’Œ<code>Mount</code>è¿™ä¸¤ä¸ªæ“ä½œï¼Œcontrollerå®é™…ä¸Šæ˜¯æ ¹æ®ä¸åŒçš„å­˜å‚¨ç±»å‹ï¼Œè°ƒç”¨pkg/volumeç›®å½•ä¸‹çš„å­˜å‚¨æ’ä»¶(Volume Plugin)ä»£ç ï¼Œè€Œå¯¹äºFlexVolumeè¿™ä¸ªVolumeç±»å‹ï¼Œå°±æ˜¯å¯¹åº” pkg/volume/flexvolume è¿™ä¸ªç›®å½•é‡Œçš„ä»£ç ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªç›®å½•å’Œå…¶ä»–å­˜å‚¨æ’ä»¶ä¸ä¸€æ ·ï¼Œå®ƒåªå……å½“æ’ä»¶çš„å…¥å£ï¼Œè€Œæ²¡æœ‰å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™ä¸ªç›®å½•é‡Œçš„ä»£ç éå¸¸ç®€å•ï¼Œæ¯”å¦‚mountæ“ä½œï¼Œå°±æ˜¯å»è°ƒç”¨å®¿ä¸»æœºä¸Šçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰€ä»¥å½“ä½ ç¼–å†™å®Œäº† FlexVolume çš„å®ç°ä¹‹åï¼Œä¸€å®šè¦æŠŠå®ƒçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ¯”å¦‚ blobfuseï¼‰æ”¾åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„æ’ä»¶ç›®å½•ä¸‹ï¼ˆ<code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec</code>ï¼‰ã€‚</p>
<h2 id="csi">CSI</h2>
<p>FlexVolumeæ˜¯ä¸€ç§out-of-treeçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¾ç„¶ä¸å¤Ÿå®Œç¾ã€‚ä¸»è¦ä½“ç°åœ¨å®ƒéœ€è¦å®¿ä¸»æœºçš„æƒé™å¹¶åœ¨å®¿ä¸»æœºä¸Šå®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆmountæ“ä½œéœ€è¦åœ¨worker nodeä¸Šå®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œattachæ“ä½œéœ€è¦åœ¨master nodeä¸Šå®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰</p>
<p>æ­¤å¤–ï¼Œåœ¨StorageClassè¿™ä¸€èŠ‚æåˆ°æˆ‘ä»¬å¯ä»¥å€ŸåŠ©<a href="https://github.com/kubernetes-retired/external-storage">external-storageåº“</a>æ¥ç¼–å†™å­˜å‚¨æ’ä»¶ï¼Œå®ç°dynamic provisionçš„èƒ½åŠ›ï¼Œä½†æ˜¯è¦ä¸“é—¨å»å†™ä¸€ä¸ªè¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ˆä»¥åŠå…¶ä»–ç±»ä¼¼é—®é¢˜ï¼‰ï¼Œç¤¾åŒºåˆæå‡ºäº†CSIæ–¹æ¡ˆï¼Œå½»åº•æŠŠå­˜å‚¨æ’ä»¶çš„ç®¡ç†é€»è¾‘å’Œk8sä¸»å¹²ä»£ç è§£è€¦å¼€æ¥ï¼š</p>
<ol>
<li>ä¸éœ€è¦èŠ‚ç‚¹æƒé™ï¼Œä¸éœ€è¦åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…å¯æ‰§è¡Œæ–‡ä»¶</li>
<li>æŠŠå…¬å…±èƒ½åŠ›ï¼ˆåŠ¨æ€provisionã€attachç­‰ï¼‰ä»k8sä¸»å¹²åˆ†æ”¯ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œæ”¾åœ¨<a href="https://github.com/kubernetes-csi">kubernetes-csi</a>è¿™ä¸ªé¡¹ç›®ä¸­</li>
</ol>
<p>æ­¤å¤–å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š<code>The Container Storage Interface (CSI) is a standard for exposing arbitrary block and file storage systems to containerized workloads on Container Orchestration Systems (COs) like Kubernetes.</code>ä¹Ÿå°±æ˜¯è¯´CSIæ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œé™¤äº†k8sä»¥å¤–è¿˜å¯ä»¥å…¼å®¹å…¶ä»–å®¹å™¨ç¼–æ’å¹³å°ï¼Œåªè¦æŒ‰ç…§è¿™ä¸ªæ ‡å‡†è¿›è¡Œå®ç°å³å¯ï¼Œå‚è€ƒ<a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI spec</a>ã€‚</p>
<p>CSIæœ¬èº«çš„è¿è¡Œæœºåˆ¶ä¸æ˜¯æœ¬ç¯‡çš„é‡ç‚¹ï¼Œå¯ä»¥å‚è€ƒ<a href="https://kubernetes-csi.github.io/docs/introduction.html">kubernetes CSIå®˜æ–¹æ–‡æ¡£</a>å’Œ<a href="https://github.com/kubernetes/design-proposals-archive/blob/main/storage/container-storage-interface.md">è®¾è®¡æ–‡æ¡£</a>ã€‚æ¯”å¦‚åœ¨è®¾è®¡æ–‡æ¡£é‡Œå·²ç»æŠŠCSI Driverå„ä¸ªç»„ä»¶çš„äº¤äº’è¿‡ç¨‹å†™çš„éå¸¸æ¸…æ¥šäº†ï¼š<a href="https://github.com/kubernetes/design-proposals-archive/blob/main/storage/container-storage-interface.md#example-walkthrough">Example Walkthrough
</a>ï¼Œæ— éœ€èµ˜è¿°ã€‚</p>
<h2 id="volumeçš„å®ç°åŸç†">Volumeçš„å®ç°åŸç†</h2>
<p>è¿™ä¸ªä¸»é¢˜å…¶å®å’Œæœ¬æ–‡æ²¡ä»€ä¹ˆå…³ç³»ï¼Œæ”¾åœ¨æœ€åä½œå‚è€ƒç”¨ã€‚</p>
<h3 id="æœ¬åœ°å­˜å‚¨">æœ¬åœ°å­˜å‚¨</h3>
<ul>
<li>
<p>emptyDirï¼šç›´æ¥ç”¨ <code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code> ç›®å½•ï¼Œæ‰€ä»¥emptyDir Volumeçš„å­˜å‚¨ä»‹è´¨ï¼ˆæ¯”å¦‚Diskè¿˜æ˜¯SSDï¼‰ç”±kubeletæ ¹ç›®å½•ï¼ˆä¸€èˆ¬æ˜¯/var/lib/kubeletï¼‰æ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿå†³å®š</p>
</li>
<li>
<p>hostPathï¼šé€šè¿‡bind mountçš„æ–¹å¼æŠŠnodeä¸Šçš„æŸä¸ªè·¯å¾„mountåˆ°<code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code></p>
</li>
</ul>
<h3 id="ç½‘ç»œå­˜å‚¨">ç½‘ç»œå­˜å‚¨</h3>
<p>é™¤äº†NFSåªéœ€è¦mountæ“ä½œï¼š<code>mount -t nfs &lt;NFSæœåŠ¡å™¨åœ°å€&gt;:/ /var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt; </code> ä»¥å¤–ï¼Œå…¶ä»–å­˜å‚¨ï¼ˆå—ã€å¯¹è±¡ï¼‰éƒ½éœ€è¦ä¸¤æ­¥ï¼š</p>
<ul>
<li>
<p><strong>attach</strong>: æŠŠè¿œç¨‹ç£ç›˜attachåˆ°å®¿ä¸»æœºï¼Œæˆä¸ºå®¿ä¸»æœºçš„ä¸€ä¸ªå—è®¾å¤‡ï¼Œæ¯”å¦‚<code>gcloud compute instances attach-disk &lt;è™šæ‹Ÿæœºåå­—&gt; --disk &lt;è¿œç¨‹ç£ç›˜åå­—&gt;</code></p>
</li>
<li>
<p><strong>mount</strong>: æŠŠå—è®¾å¤‡æ ¼å¼åŒ–æˆæ–‡ä»¶ç³»ç»Ÿï¼ˆNFSä¸éœ€è¦ï¼‰ï¼Œå¹¶mountåˆ°å®¿ä¸»æœºä¸Šï¼Œæ¯”å¦‚ï¼š<code>mount -t nfs &lt;NFSæœåŠ¡å™¨åœ°å€&gt;:/ /var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt; </code></p>
</li>
</ul>
<p>kubelet åœ¨å‘ Docker å‘èµ· CRI è¯·æ±‚æ—¶ï¼Œè¦å…ˆå‡†å¤‡å¥½å®¿ä¸»æœºä¸Šçš„<code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code>è¿™ä¸ªç›®å½•ï¼Œæ¥ç€é€šè¿‡<code>docker run -v /var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;:/&lt;å®¹å™¨å†…çš„ç›®æ ‡ç›®å½•&gt; æˆ‘çš„é•œåƒ â€¦</code> å°±æŠŠVolumeæŒ‚è½½è¿›äº†å®¹å™¨ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>è°ˆè°ˆkubernetesä¸­çš„etcd</title>
			<link>https://cvvz.fun/post/etcd-and-kubernetes/</link>
			<pubDate>Thu, 10 Feb 2022 08:19:53 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/etcd-and-kubernetes/</guid>
			<description>revision revisionæ˜¯etcdä¸­èµ„æºçš„å…¨å±€ç‰ˆæœ¬å·ï¼Œå¯ä»¥çœ‹ä½œä¸€ä¸ªå…¨å±€é€»è¾‘æ—¶é’Ÿã€‚etcd å¯åŠ¨çš„æ—¶å€™é»˜è®¤revisionæ˜¯ 1ï¼Œå¯¹ä»»ä½•ä¸€ä¸ªkeyçš„å¢ã€</description>
			<content type="html"><![CDATA[<h2 id="revision">revision</h2>
<p>revisionæ˜¯etcdä¸­èµ„æºçš„å…¨å±€ç‰ˆæœ¬å·ï¼Œå¯ä»¥çœ‹ä½œä¸€ä¸ªå…¨å±€é€»è¾‘æ—¶é’Ÿã€‚etcd å¯åŠ¨çš„æ—¶å€™é»˜è®¤revisionæ˜¯ 1ï¼Œå¯¹<strong>ä»»ä½•ä¸€ä¸ªkey</strong>çš„å¢ã€åˆ ã€æ›´æ–°æ“ä½œæ—¶éƒ½ä¼šå¯¼è‡´å…¶<strong>å…¨å±€å•è°ƒé€’å¢</strong>ã€‚</p>
<p>etcdä¸­æ¯ä¸ªkvéƒ½å¯¹åº”äº†ä¸¤ç§revisionï¼Œcreate_revisionå’Œmod_revisionï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span><span class="c1"># etcdctl get hello -w=json | jq</span>
<span class="ln"> 2</span><span class="o">{</span>
<span class="ln"> 3</span>  <span class="s2">&#34;header&#34;</span>: <span class="o">{</span>
<span class="ln"> 4</span>    <span class="s2">&#34;cluster_id&#34;</span>: 12938807918314689000,
<span class="ln"> 5</span>    <span class="s2">&#34;member_id&#34;</span>: 15640011255034253000,
<span class="ln"> 6</span>    <span class="s2">&#34;revision&#34;</span>: 234503652,
<span class="ln"> 7</span>    <span class="s2">&#34;raft_term&#34;</span>: <span class="m">42</span>
<span class="ln"> 8</span>  <span class="o">}</span>,
<span class="ln"> 9</span>  <span class="s2">&#34;kvs&#34;</span>: <span class="o">[</span>
<span class="ln">10</span>    <span class="o">{</span>
<span class="ln">11</span>      <span class="s2">&#34;key&#34;</span>: <span class="s2">&#34;aGVsbG8=&#34;</span>,
<span class="ln">12</span>      <span class="s2">&#34;create_revision&#34;</span>: 165796223,
<span class="ln">13</span>      <span class="s2">&#34;mod_revision&#34;</span>: 165796223,
<span class="ln">14</span>      <span class="s2">&#34;version&#34;</span>: 1,
<span class="ln">15</span>      <span class="s2">&#34;value&#34;</span>: <span class="s2">&#34;d29ybGQ=&#34;</span>
<span class="ln">16</span>    <span class="o">}</span>
<span class="ln">17</span>  <span class="o">]</span>,
<span class="ln">18</span>  <span class="s2">&#34;count&#34;</span>: <span class="m">1</span>
<span class="ln">19</span><span class="o">}</span>
</code></pre></div><p>åˆ›å»ºä¸€ä¸ªkvæ—¶ï¼Œcreate_revisionä¸ºå½“å‰çš„å…¨å±€revisionï¼›æ¯å½“æ›´æ–°æˆ–è€…åˆ é™¤è¿™ä¸ªkeyæ—¶ï¼Œmod_revisionä¼šè¢«æ›´æ–°ä¸ºå½“å‰çš„å…¨å±€revisionï¼›è¯»å–æ—¶ï¼Œä¸æŒ‡å®šrevisionï¼Œåˆ™é»˜è®¤è¯»å–æœ€æ–°çš„æ•°æ®ï¼Œå¦åˆ™è¯»å–è¯¥kvåœ¨æŸä¸ªç‰ˆæœ¬å·ä¸‹çš„å¿«ç…§ã€‚</p>
<h3 id="mvccå’Œä¹è§‚é”">MVCCå’Œä¹è§‚é”</h3>
<p>æ•°æ®åº“å¯ä»¥é€šè¿‡æ‚²è§‚é”æˆ–ä¹è§‚é”ï¼ˆMVCCï¼‰æ¥å®ç°äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚MVCCæœºåˆ¶çš„æ ¸å¿ƒæ€æƒ³æ˜¯ä¿å­˜kvæ•°æ®çš„å¤šä¸ªå†å²ç‰ˆæœ¬ï¼ˆrevisionï¼‰ï¼Œetcdä¸­çš„äº‹åŠ¡ä¹Ÿæ˜¯åŸºäºä¹è§‚é”æœºåˆ¶å®ç°ã€‚</p>
<p><strong>kubernetesèµ„æºçš„resourceVersionå¯¹åº”çš„æ˜¯etcdä¸­kvçš„mod_revision</strong>ã€‚</p>
<p>åœ¨controllerçš„reconcileæ§åˆ¶å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ›´æ–°workloadçš„specæˆ–è€…statuså­—æ®µï¼Œè€Œå¦‚æœåœ¨åŒä¸€æ¬¡reconcileä¸­å¯¹åŒä¸€ä¸ªèµ„æºå¯¹è±¡è¿›è¡Œäº†ä¸¤æ¬¡æ›´æ–°æ“ä½œï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡æ›´æ–°ä¼šæŠ¥é”™ï¼š<code>the object has been modified; please apply your changes to the latest version and try again</code>ï¼ŒåŸå› å°±æ˜¯ç¬¬ä¸€æ¬¡æ›´æ–°è¿‡åï¼Œèµ„æºå¯¹è±¡çš„resourceVersionè¢«æ›´æ–°ä¸ºäº†æ–°çš„ç‰ˆæœ¬ï¼Œåœ¨ç¬¬äºŒæ¬¡æ›´æ–°æ—¶ï¼Œç”±äºç‰ˆæœ¬è¿‡æ—¶å¯¼è‡´æ›´æ–°æ“ä½œè¿”å›å¤±è´¥ã€‚è¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¹è§‚å¹¶å‘åœºæ™¯ï¼Œéœ€è¦ä¸Šå±‚ä¸šåŠ¡é€»è¾‘è‡ªè¡Œé‡è¯•æˆ–è€…é¿å…å†™å†²çªçš„å‘ç”Ÿã€‚</p>
<h3 id="å¯é çš„watchæœºåˆ¶">å¯é çš„watchæœºåˆ¶</h3>
<p>kuberneteså€ŸåŠ©resourceVersionå®ç°äº†å¯é çš„watchæœºåˆ¶ã€‚clientç«¯åˆæ¬¡è¿›è¡Œlist &amp; watchæ—¶ï¼Œlistå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„http getè¯·æ±‚ï¼›ç¬¬äºŒæ­¥å‘é€ä¸€ä¸ªå¸¦æœ‰ <code>resourceVersion=0</code> å’Œ <code>watch=true</code> query stringçš„http getè¯·æ±‚å»ºç«‹watchè¿æ¥ã€‚</p>
<p>æ­¤å¤„watchè¯·æ±‚ä¸­resourceVersion=0çš„å«ä¹‰å°±æ˜¯æŒ‡clientç«¯åˆæ¬¡ä¸apiserverå»ºç«‹watchè¿æ¥ï¼Œapi-serverä¼šè¿”å›cacheä¸­çš„æœ€æ–°æ•°æ®ï¼Œå¹¶æ¨é€äº‹ä»¶ã€‚</p>
<p>å½“clientä¸serverä¹‹é—´çš„è¿æ¥ç”±äºç½‘ç»œåŸå› çŸ­æš‚ä¸­æ–­æ—¶ï¼Œclientä¼šä¸æ–­çš„å‘é€watchè¯·æ±‚ï¼Œå¹¶æŒ‡å®šresourceVersionï¼Œè¿æ¥æ¢å¤æ—¶ï¼Œå¦‚æœresourceVersionæ¯”apiserverä¸­ç¼“å­˜çš„èµ„æºæœ€å°ç‰ˆæœ¬å¤§ï¼Œé‚£ä¹ˆapiserverä¼šå°†ç”±äºç½‘ç»œè¿æ¥ä¸­æ–­è€Œé—æ¼çš„äº‹ä»¶å’Œèµ„æºå¯¹è±¡å‘é€ç»™å®¢æˆ·ç«¯ï¼›ä½†æ˜¯å¦‚æœç½‘ç»œä¸­æ–­æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´resourceVersionå¤ªè€ï¼Œåˆ™apiserverä¼šè¿”å›410 StatusGone â€œtoo old Resource Versionâ€çš„é”™è¯¯ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¤„ç†è¯¥é”™è¯¯çš„æ–¹å¼å°±æ˜¯é‡æ–°listè¯¥èµ„æºã€‚é€šè¿‡ç‰ˆæœ¬å·çš„æœºåˆ¶ï¼Œå¯ä»¥ä¿è¯ä¸ä¼šé—æ¼äº‹ä»¶ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œlistä¹Ÿå¯èƒ½å‡ºç°é—®é¢˜ã€‚åœ¨1.17ç‰ˆæœ¬ä¸­ï¼Œreflectoré€»è¾‘è¿›è¡Œäº†ä¸€æ¬¡ä¿®æ”¹ï¼š1.17ä¹‹å‰reflectoråœ¨list-watchå¤±è´¥åé‡è¯•æ—¶ï¼Œä¼šç»Ÿä¸€ä½¿ç”¨resourceVersion=0å»listï¼Œæ­¤æ—¶apiserverçš„è¡Œä¸ºæ˜¯è¿”å›apiserver cacheä¸­çš„æ‰€æœ‰ç‰ˆæœ¬èµ„æºå¯¹è±¡ï¼›ä½†æ˜¯åœ¨1.17ç‰ˆæœ¬æ”¹æˆäº†ä½¿ç”¨æŒ‡å®šçš„resourceVersionå»è¿›è¡Œlistï¼Œæ­¤æ—¶apiserverçš„è¡Œä¸ºæ˜¯è¿”å›cacheä¸­å¤§äºè¯¥ç‰ˆæœ¬çš„èµ„æºå¯¹è±¡ï¼Œå¦‚æœcacheä¸­æ²¡æœ‰å¤§äºè¯¥ç‰ˆæœ¬çš„èµ„æºå¯¹è±¡ï¼Œä¼šç­‰å¾…3sï¼ŒæœŸæœ›etcdèƒ½æ¨é€æ–°çš„äº‹ä»¶æ›´æ–°apiserverç¼“å­˜ï¼Œå¦‚æœ3så†…æ²¡æœ‰æ›´æ–°ï¼Œåˆ™è¿”å›é”™è¯¯â€œTimeout: Too large resource versionâ€ã€‚æ­¤æ—¶reflectoréœ€è¦å¤„ç†è¿™ä¸ªè¶…æ—¶é”™è¯¯ï¼Œä½†æ˜¯æœ€åˆçš„å®ç°æ˜¯æ²¡æœ‰è¿›è¡Œå¤„ç†çš„ã€‚<a href="https://github.com/kubernetes/kubernetes/pull/92537/files">#92537</a>ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼ŒåŠæ³•å°±æ˜¯åœ¨reflectorä¸­å•ç‹¬å¤„ç†â€œToo large resource versionâ€é”™è¯¯ï¼Œå¦‚æœä¸Šä¸€æ¬¡watchå¤±è´¥æ˜¯å› ä¸ºè¯¥é”™è¯¯å¯¼è‡´ï¼Œreflectoråœ¨ä¸‹æ¬¡é‡è¯•listæ—¶ä¼šæŒ‡å®šresourceVersion=&quot;&quot;ï¼Œç›´æ¥ä»etcdä¸­è·å–æœ€æ–°çš„ç‰ˆæœ¬ã€‚</p>
<p>å½“ç„¶è¿™ä¹ˆåšåªæ˜¯ä¸€ä¸ªç®€å•çš„bugfixï¼Œé€ æˆé—®é¢˜çš„æ ¹æœ¬åŸå› è¿˜æ˜¯ç”±äºapiserverçš„æ— çŠ¶æ€ï¼Œå¤šä¸ªapiserverå†…éƒ¨çš„cacheæ•°æ®å¯èƒ½ä¸ä¸€è‡´ï¼Œè§£å†³cacheä¸ä¸€è‡´çš„é—®é¢˜æ‰æ˜¯ä»æºå¤´è§£å†³ã€‚å…·ä½“çš„è§£å†³æ–¹æ³•å¯ä»¥å‚è€ƒ<a href="https://github.com/kubernetes/enhancements/pull/1878/files">è¿™ä¸ªKEP</a>ã€‚</p>
<h2 id="watchçš„å®ç°åŸç†">watchçš„å®ç°åŸç†</h2>
<ol>
<li>
<p>clientè½®è¯¢</p>
<p>è¿™æ˜¯æœ€å®¹æ˜“æƒ³åˆ°å’Œå®ç°çš„æ–¹æ³•ï¼Œäº‹å®ä¸Šæœ€åˆetcdæä¾›çš„watchæœºåˆ¶å°±æ˜¯é€šè¿‡å®¢æˆ·ç«¯è½®è¯¢æ¥å®ç°çš„ã€‚</p>
</li>
<li>
<p>http1.x åˆ†å—ä¼ è¾“æœºåˆ¶</p>
<p>http1.xæä¾›äº†åˆ†å—ä¼ è¾“çš„æœºåˆ¶ï¼Œapiserverä¸å„ä¸ªå®¢æˆ·ç«¯ä¹‹é—´çš„watchæœºåˆ¶å°±æ˜¯å€ŸåŠ©åˆ†å—ä¼ è¾“æœºåˆ¶çš„å®ç°çš„ã€‚å®¢æˆ·ç«¯åªéœ€è¦å‘é€ä¸€æ¬¡getè¯·æ±‚ï¼Œapiserveræ¯å½“æ”¶åˆ°etcdæ¨é€çš„æ–°çš„äº‹ä»¶æ—¶ï¼Œå°±è¿”å›ä¸€ä¸ªå¤´éƒ¨å¸¦æœ‰<code>Transfer-Encoding: chunked</code>çš„httpå“åº”ã€‚</p>
</li>
<li>
<p>websocket</p>
<p>websocketä¸åƒhttpåè®®é‡Œé‚£æ ·æ˜¯åº”ç­”-å“åº”å¼çš„äº¤äº’ï¼Œå®ƒåœ¨TCPåè®®ä¹‹ä¸Šï¼Œé€šè¿‡åœ¨åº”ç”¨å±‚è¿›è¡ŒäºŒè¿›åˆ¶å¸§çš„ç»„åŒ…ï¼Œè¾¾åˆ°å…¨åŒå·¥é€šä¿¡çš„èƒ½åŠ›ã€‚websocketåè®®å’Œhttpå…¶å®å®Œå…¨ä¸åŒï¼Œä½†æ˜¯ç”±äºå®ƒçš„ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯åœ¨webæœåŠ¡ä¸­ï¼Œæ‰€ä»¥å®ƒçš„æ¡æ‰‹è¿‡ç¨‹æ­äº†httpåè®®çš„ä¾¿è½¦ï¼šWebSocket çš„æ¡æ‰‹æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ HTTP GET è¯·æ±‚ï¼Œä½†è¦å¸¦ä¸Šä¸¤ä¸ªåè®®å‡çº§çš„ä¸“ç”¨å¤´å­—æ®µã€‚</p>
<p>å› æ­¤é€šè¿‡websocket (ws)ä¹Ÿå¯ä»¥å®ç°watchåŠŸèƒ½ã€‚</p>
</li>
<li>
<p>http/2 æœåŠ¡ç«¯æ¨é€</p>
<p>etcd v3ç‰ˆæœ¬å‡çº§åˆ°ä½¿ç”¨åŸºäºhttp/2çš„gRPCåè®®ã€‚http/2é™¤äº†è§£å†³äº†TCPè¿æ¥å¤ç”¨å’Œhttpåè®®é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ä»¥å¤–ï¼Œç”±äºhttp/2æ”¯æŒæœåŠ¡ç«¯ä¸»åŠ¨æ¨é€æ¶ˆæ¯ï¼Œå› æ­¤etcdå¯ä»¥ä¸»åŠ¨å‘apiserver pushæ•°æ®ï¼Œä»è€Œç›¸æ¯”clientç«¯è½®è¯¢ï¼Œæ›´åŠ é«˜æ•ˆçš„å®ç°äº†watchæœºåˆ¶ã€‚</p>
</li>
</ol>
<h2 id="lease">lease</h2>
<p>etcd çš„ç§Ÿçº¦æ¨¡å—çš„ä½¿ç”¨æ–¹æ³•æ˜¯ï¼š</p>
<ol>
<li>clientåˆ›å»ºleaseï¼Œå¹¶æŒ‡å®šTTL</li>
<li>clientåˆ›å»ºkvï¼Œå¹¶å…³è”æŸä¸ªlease</li>
<li>clientæŒç»­çš„å¯¹leaseè¿›è¡Œç»­ç§Ÿ</li>
</ol>
<p><strong>Kubernetes Eventçš„è‡ªåŠ¨æ·˜æ±°æœºåˆ¶å’Œcontrollerçš„leaderé€‰ä¸¾éƒ½æ˜¯åŸºäºetcdçš„leaseæœºåˆ¶å®ç°çš„</strong>ã€‚</p>
<p>controllerçš„é€‰ä¸»æœºåˆ¶ï¼šé€šè¿‡åˆ›å»ºé”å¯¹è±¡å¹¶ç»‘å®šleaseæ¥å®ç°leaderç»­ç§Ÿè¶…æ—¶é”è¢«è‡ªåŠ¨é”€æ¯ï¼›ç”±äºæ‰€æœ‰çš„clientéƒ½ä¼šwatchè¿™ä¸ªé”çš„deleteäº‹ä»¶ï¼Œä»è€Œå¯ä»¥å¿«é€Ÿå‘èµ·æ–°çš„åŠ é”æ“ä½œã€‚ä¸ºäº†é¿å…æƒŠç¾¤ï¼Œclientç«¯åªä¼šwatchæ¯”è‡ªå·±revisionå°çš„é‚£ä¸ªkeyçš„deleteäº‹ä»¶ï¼Œç±»ä¼¼äºä»å°åˆ°å¤§æ’é˜Ÿå–é”ï¼Œä»è€Œé¿å…æ‰€æœ‰clientåŒæ—¶å‘èµ·æŠ¢é”çš„æƒ…å†µå‘ç”Ÿã€‚</p>
<p>etcdæ˜¯ä¸€ä¸ªåŸºäº Raft å®ç°çš„å¼ºä¸€è‡´æ•°æ®åº“ã€‚ç›¸æ¯” Redis åŸºäºä¸»å¤‡å¼‚æ­¥å¤åˆ¶åšæ•°æ®åŒæ­¥å¯èƒ½å¯¼è‡´çš„é”çš„å®‰å…¨æ€§é—®é¢˜ï¼Œetcdä¸­ä¸€ä¸ªå†™è¯·æ±‚éœ€è¦ç»è¿‡é›†ç¾¤å¤šæ•°èŠ‚ç‚¹ç¡®è®¤ï¼Œå› æ­¤ä¸€æ—¦åˆ†å¸ƒå¼é”ç”³è¯·è¿”å›ç»™ client æˆåŠŸåï¼Œå®ƒä¸€å®šæ˜¯æŒä¹…åŒ–åˆ°äº†é›†ç¾¤å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œä¸ä¼šå‡ºç° Redis ä¸»å¤‡å¼‚æ­¥å¤åˆ¶å¯èƒ½å¯¼è‡´ä¸¢æ•°æ®çš„é—®é¢˜ï¼Œå…·å¤‡æ›´é«˜çš„å®‰å…¨æ€§ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>æµ…è°ˆå¼€æºé›†ç¾¤è”é‚¦çš„è®¾è®¡å’Œå®ç°åŸç†</title>
			<link>https://cvvz.fun/post/kube-federation/</link>
			<pubDate>Tue, 11 Jan 2022 19:47:01 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/kube-federation/</guid>
			<description>é›†ç¾¤è”é‚¦ é›†ç¾¤è”é‚¦æ˜¯ä¸ºäº†è§£å†³å•k8sé›†ç¾¤èŠ‚ç‚¹æ•°é‡æœ‰é™çš„é—®é¢˜è€Œå‡ºç°çš„å¤šé›†ç¾¤ç®¡ç†æ–¹æ¡ˆã€‚æ›´å…·ä½“ä¸€ç‚¹ï¼Œé›†ç¾¤è”é‚¦è¦è§£å†³ä¸‰ç±»é—®é¢˜ï¼š å¤šk8sé›†ç¾¤ç®¡ç†ã€‚è¿™ä¸€å—</description>
			<content type="html"><![CDATA[<h2 id="é›†ç¾¤è”é‚¦">é›†ç¾¤è”é‚¦</h2>
<p>é›†ç¾¤è”é‚¦æ˜¯ä¸ºäº†è§£å†³å•k8sé›†ç¾¤èŠ‚ç‚¹æ•°é‡æœ‰é™çš„é—®é¢˜è€Œå‡ºç°çš„å¤šé›†ç¾¤ç®¡ç†æ–¹æ¡ˆã€‚æ›´å…·ä½“ä¸€ç‚¹ï¼Œé›†ç¾¤è”é‚¦è¦è§£å†³ä¸‰ç±»é—®é¢˜ï¼š</p>
<ol>
<li><strong>å¤šk8sé›†ç¾¤ç®¡ç†</strong>ã€‚è¿™ä¸€å—å¯¹åº”æœ‰ç¤¾åŒºçš„<a href="https://github.com/kubernetes-retired/cluster-registry">cluster-registryï¼ˆå·²å½’æ¡£ï¼‰</a>é¡¹ç›®å’Œ<a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a>é¡¹ç›®</li>
<li><strong>å¤šé›†ç¾¤workloadç®¡ç†</strong>ã€‚<a href="https://timewitch.net/post/2020-03-31-multicluster-workloads/">A Model For Multicluster Workloads (In Kubernetes And Beyond)</a> è¿™ç¯‡æ–‡ç« æå‡ºäº†ä¸€ç§å¤šé›†ç¾¤workloadçš„æ¨¡å‹ï¼Œç°åœ¨çš„é›†ç¾¤è”é‚¦çš„åº”ç”¨ç®¡ç†æ¡†æ¶åŸºæœ¬ä¸Šéƒ½ç¬¦åˆè¯¥æ¨¡å‹ã€‚</li>
<li><strong>å¤šé›†ç¾¤serviceï¼ˆæœåŠ¡æš´éœ²å’ŒæœåŠ¡å‘ç°ï¼‰</strong>ã€‚ç¤¾åŒºé‡Œæœ‰ <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-multicluster/1645-multi-cluster-services-api">Multi-Cluster Services API</a> çš„KEPï¼ŒOCMä¸­æœ‰ç›¸åº”çš„å®ç°ã€‚</li>
</ol>
<h2 id="kubefed-v2httpsgithubcomkubernetes-sigskubefed"><a href="https://github.com/kubernetes-sigs/kubefed">KubeFed v2</a></h2>
<figure>
    <img src="/kubefed.png" width="650px"/> 
</figure>

<p><strong>KubeFed v2å’Œå…¶ä»–é›†ç¾¤è”é‚¦äº§å“çš„åŒºåˆ«æ˜¯å®ƒçš„â€œå…ƒé›†ç¾¤â€ä¸­ä¹Ÿä¼šæœ‰å„ç§workloadï¼ŒKubeFedçš„åŠŸèƒ½æ˜¯å¤åˆ¶å’Œä¼ æ’­workloadåˆ°å…¶ä»–k8sé›†ç¾¤</strong>ã€‚è€Œå…¶ä»–é›†ç¾¤è”é‚¦äº§å“çš„å…ƒé›†ç¾¤åˆ™æ˜¯ä¸“æ³¨äºç®¡ç†å’Œåˆ†å‘workloadåˆ°æˆå‘˜é›†ç¾¤ä¸­ï¼Œå…ƒé›†ç¾¤æœ¬èº«æ²¡æœ‰ä»»ä½•workloadã€‚</p>
<p>é›†ç¾¤æ³¨å†Œå’Œç®¡ç†ï¼šç”¨æˆ·é€šè¿‡å®šä¹‰<code>Cluster Configuration</code>æ¥å£°æ˜å“ªäº›æˆå‘˜é›†ç¾¤éœ€è¦çº³å…¥ç®¡æ§ï¼Œä»¥åŠæˆå‘˜é›†ç¾¤ä¿¡æ¯ï¼›</p>
<p>workloadç®¡ç†ï¼š</p>
<ul>
<li>ç”¨æˆ·é€šè¿‡åˆ›å»º<code>Type Configuration</code>æ¥å£°æ˜å“ªäº›èµ„æºç±»å‹éœ€è¦è¢«çº³å…¥ç®¡æ§ï¼›</li>
<li><code>Federated Type</code>å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ª<strong>å…·ä½“</strong>çš„èµ„æºç±»å‹å¯¹åº”çš„Federatedç‰ˆæœ¬ï¼Œå…¶ä¸­å®šä¹‰äº†èµ„æºçš„ï¼š<code>Template</code>ï¼ˆèµ„æºæ¨¡æ¿ï¼‰ã€<code>Placement</code>ï¼ˆè¦è¢«æ”¾ç½®åœ¨å“ªå‡ ä¸ªé›†ç¾¤ï¼‰ã€<code>Overrides</code>ï¼ˆå¯¹æŸä¸ªé›†ç¾¤çš„æ¨¡ç‰ˆçš„æŸäº›æŒ‡å®šå­—æ®µè¿›è¡Œè¦†ç›–ï¼‰
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>Federated Type</code>ä¸æ˜¯ç”±ç”¨æˆ·ç”Ÿæˆçš„ã€‚è€Œæ˜¯ç”±æ§åˆ¶å™¨æ ¹æ®ç”¨æˆ·åœ¨<code>Type Configuration</code>ä¸­å®šä¹‰çš„è¢«çº³å…¥ç®¡æ§çš„èµ„æºç±»å‹ï¼Œå°†é›†ç¾¤ä¸­å·²æœ‰çš„èµ„æºå¤åˆ¶åˆ°<code>Federated Type</code>è¿™ä¸ªCRDçš„templateå­—æ®µä¸­ã€‚</p>
</blockquote>
</li>
<li>KubeFedæ§åˆ¶å™¨ä¼šæ ¹æ®<code>Federated Type</code>å»åŠ¨æ€çš„åˆ›å»ºå’Œå¯åŠ¨ä¸¤ç§é‡è¦çš„æ§åˆ¶å™¨ï¼Œsync controllerï¼ˆå¯¹åº”å›¾ä¸­çš„<code>Propagation</code>ï¼‰å’Œstatus controllerï¼ˆå¯¹åº”å›¾ä¸­çš„<code>Status</code>ï¼‰ï¼Œä½œç”¨åˆ†åˆ«æ˜¯å¾€é›†ç¾¤é‡Œåˆ›å»ºå’Œæ›´æ–°èµ„æº å’Œ è·å–èµ„æºé›†ç¾¤ä¸­çš„èµ„æºå½“å‰çš„å®é™…çŠ¶æ€</li>
<li>ç”¨æˆ·é€šè¿‡å®šä¹‰<code>ReplicaSchedulingPreferenceï¼ˆRSPï¼‰</code>è¿™ä¸ªCRDæ¥å£°æ˜æŸä¸ªèµ„æºåœ¨é›†ç¾¤èŒƒå›´å†…çš„è°ƒåº¦è§„åˆ™ã€‚RSP Controllerï¼ˆå¯¹åº”å›¾ä¸­çš„<code>Scheduling</code>ï¼‰ä¼šæ ¹æ®è°ƒåº¦è§„åˆ™ä»¥åŠèµ„æºçŠ¶æ€æ¥è¿›è¡Œè°ƒåº¦ã€‚æ‰€è°“çš„è°ƒåº¦ï¼Œå°±æ˜¯å»ä¿®æ”¹<code>Federated Type</code>ä¸­çš„<code>Placement</code>æˆ–<code>Overrides</code>ã€‚sync controller watchåˆ°<code>Federated Type</code>çš„å˜æ›´ï¼Œå°±ä¼šå»æ›´æ–°æˆå‘˜é›†ç¾¤èµ„æºã€‚</li>
</ul>
<h2 id="karmadahttpsgithubcomkarmada-iokarmada"><a href="https://github.com/karmada-io/karmada">Karmada</a></h2>
<figure>
    <img src="/karmada.png" width="450px"/> 
</figure>

<p>Karmadaæœ€å¤§çš„ç‰¹è‰²æ˜¯<strong>æ•´ä¸ªæ§åˆ¶å¹³é¢æ˜¯ä¸€ä¸ªéƒ¨ç½²åœ¨k8sä¸­çš„å®šåˆ¶åŒ–çš„k8sï¼ˆk8s-on-k8sï¼‰ï¼ŒåŒ…æ‹¬etcd</strong>ã€‚åº•å±‚çš„è¿™ä¸ªk8så”¯ä¸€çš„ä½œç”¨å°±æ˜¯éƒ¨ç½²karmadaçš„k8så…ƒé›†ç¾¤ï¼Œkarmadaåªå¯¹å¤–æš´éœ²å…ƒé›†ç¾¤apiserverçš„APIï¼ˆå›¾ä¸­<code>karmada apiserver</code>ï¼‰ã€‚</p>
<p><strong>Karmadaçš„k8såŸé›†ç¾¤ä¸­çš„controllerç»„ä»¶ï¼Œé€šè¿‡å¯åŠ¨flagé™åˆ¶äº†å¾ˆå¤šå†…ç½®æ§åˆ¶å™¨çš„è¿è¡Œï¼Œæœ€å…¸å‹çš„ä¾‹å¦‚ä¸å¯åŠ¨replicaset/deploymentæ§åˆ¶å™¨</strong>ã€‚è€ŒKarmadaçš„controllerï¼ˆå›¾ä¸­<code>Karmada controllers</code>ï¼‰åˆ™ä¼šwatch replicaset/deploymentç­‰k8såŸç”Ÿèµ„æºï¼Œè¿™æ ·ï¼Œç”¨æˆ·åœ¨åˆ›å»ºä¸€ä¸ªdeploymentæ—¶ï¼Œå®é™…æ˜¯karmada controllerå¯¹å…¶è¿›è¡Œreconcileï¼Œreconcileçš„é€»è¾‘è‡ªç„¶æ˜¯å°†workloadåˆ†å‘åˆ°æˆå‘˜é›†ç¾¤ä¸­å»ã€‚</p>
<p>Karmadaçš„æ”¯æŒPushå’ŒPullä¸¤ç§æ¨¡å¼åˆ†å‘workloadï¼špushæ¨¡å¼ä¸‹ç”±Karmadaæ§åˆ¶å™¨å°†åº”ç”¨æ¨é€åˆ°æˆå‘˜é›†ç¾¤ï¼ŒPullæ¨¡å¼ä¸‹ç”±è¿è¡Œåœ¨æˆå‘˜é›†ç¾¤ä¾§çš„Karmada Agentæ§åˆ¶å™¨å°†åº”ç”¨ä¸‹æ‹‰åˆ°æœ¬åœ°ã€‚</p>
<figure>
    <img src="/karmada-resource-relation.png" width="450px"/> 
</figure>

<p>Karmadaå€Ÿé‰´äº†KubeFedçš„å¾ˆå¤šè®¾è®¡æ€æƒ³ã€‚Karmadaå°†KubeFedä¸­å®šä¹‰åœ¨åŒä¸€ä¸ª<code>Federated Type</code>ä¸­çš„<code>Template</code>ã€<code>placement</code>ã€<code>overrides</code>æ‹†åˆ†æˆäº†3ä¸ªå•ç‹¬çš„å¯¹è±¡ï¼šåŸç”Ÿèµ„æºï¼ˆå›¾ä¸­<code>Resource Template</code>ï¼‰ã€èµ„æºä¼ æ’­ç­–ç•¥ï¼ˆå›¾ä¸­<code>propagation policy</code>ï¼‰ã€å•é›†ç¾¤å·®å¼‚åŒ–é…ç½®ç­–ç•¥ï¼ˆå›¾ä¸­<code>override policy</code>ï¼‰ã€‚</p>
<p>æ•´ä½“å·¥ä½œæµç¨‹ï¼š</p>
<ol>
<li>Karmadaæ§åˆ¶å™¨ä¼šå°†k8såŸç”Ÿçš„workloadå’Œ<code>propagation policy</code>è¿›è¡Œç»‘å®šç”Ÿæˆ<code>Resource Binding</code></li>
<li>karmada schedulerä¼šæ ¹æ®<code>Resource Binding</code>ä¸­å®šä¹‰çš„è°ƒåº¦ç­–ç•¥ï¼Œæ¥é€‰æ‹©å…·ä½“çš„é›†ç¾¤</li>
<li>resourcebinding controllerä¼šæ ¹æ®<code>Resource Binding</code>ç”Ÿæˆ<code>Work</code>ï¼Œ<code>Work</code>é‡Œé¢å°±æ˜¯å…·ä½“èµ„æºçš„manifest</li>
<li>execution controllerè´Ÿè´£æ ¹æ®workå»æˆå‘˜é›†ç¾¤ä¸­åˆ›å»ºworkloadï¼›æˆ–è€…æˆå‘˜é›†ç¾¤ä¸­çš„agentæ„ŸçŸ¥åˆ°workäº‹ä»¶ï¼Œåˆ›å»ºworkload</li>
<li>å¯¹äºæ¯ä¸€ä¸ªworkå¯¹åº”çš„èµ„æºç±»å‹ï¼Œkarmadaä¹Ÿä¼šå»watchæˆå‘˜é›†ç¾¤ï¼Œå¹¶åŒæ­¥åˆ°å…ƒé›†ç¾¤ä¸­å¯¹åº”çš„workçŠ¶æ€ä¸­ã€‚</li>
</ol>
<h2 id="ocmhttpsgithubcomopen-cluster-management-io"><a href="https://github.com/open-cluster-management-io">OCM</a></h2>
<figure>
    <img src="/ocm-arch.png" width="500px"/> 
</figure>

<p>OCMæ•´ä½“åˆ†ä¸ºä¸‰å¤§éƒ¨åˆ†ï¼š</p>
<ul>
<li>éƒ¨ç½²åœ¨æˆå‘˜é›†ç¾¤ä¸­çš„klusterletæ§åˆ¶å™¨ï¼š
<ol>
<li>å†…ç½®registration-agentæ§åˆ¶å™¨ç”¨äºé›†ç¾¤çš„æ³¨å†Œã€å¿ƒè·³ç­‰</li>
<li>å†…ç½®work-agentæ§åˆ¶å™¨ç”¨äºwatchä¸­å¤®é›†ç¾¤ä¸­çš„workï¼Œç„¶ååœ¨æœ¬é›†ç¾¤ä¸­åˆ›å»ºå¯¹åº”çš„workload</li>
</ol>
</li>
<li>ä¸­å¤®é›†ç¾¤ä¸­çš„Cluster Manageræ§åˆ¶å™¨ï¼š
<ol>
<li>å†…ç½®registration-controllerï¼šç”¨äºé›†ç¾¤çš„ç®¡ç†ï¼ˆæ³¨å†Œã€åˆ é™¤ï¼‰ç­‰</li>
<li>å†…ç½®placement-controllerï¼šè¿™ä¸ªæ§åˆ¶å™¨ç”¨æ¥è¿›è¡Œâ€œè·¨é›†ç¾¤è°ƒåº¦â€workloadã€‚</li>
</ol>
</li>
<li>è‡ªå®šä¹‰æ’ä»¶ï¼ˆadd-onï¼‰ï¼š
<ol>
<li>å¼€å‘è€…å¯ä»¥åˆ©ç”¨OCMæä¾›çš„ Addon framework æ¥åˆ›å»ºä»–ä»¬è‡ªå·±çš„ç®¡ç†å·¥å…·æˆ–è€…å°†å…¶ä»–å¼€æºé¡¹ç›®é›†æˆè¿›æ¥ä»¥åŠ å¼ºå¤šé›†ç¾¤ç®¡ç†èƒ½åŠ›ã€‚å›¾ä¸­ï¼ŒOCMåŸç”Ÿè‡ªå¸¦äº†ä¸¤ä¸ªå†…ç½®çš„addonçš„å®ç°ï¼šApplication Addonç”¨äºåº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒPolicy Addonç”¨äºå®‰å…¨ç­–ç•¥ç®¡ç†ã€‚</li>
</ol>
</li>
</ul>
<p>é›†ç¾¤æ³¨å†Œå’Œç®¡ç†ï¼šé€šè¿‡åœ¨æˆå‘˜é›†ç¾¤ä¸­å®‰è£…agentç»„ä»¶ï¼Œagentä¼šå‘ä¸­å¤®é›†ç¾¤æ³¨å†Œè‡ªå·±ï¼Œå³åˆ›å»º<code>ManagedCluster</code>å¯¹è±¡ï¼Œä¸­å¤®é›†ç¾¤éœ€è¦è¿›è¡Œacceptæ“ä½œã€‚</p>
<p>workloadç®¡ç†ï¼š</p>
<ol>
<li>å®šä¹‰è°ƒåº¦ç­–ç•¥ï¼šé¦–å…ˆåœ¨ä¸­å¤®é›†ç¾¤ä¸­åˆ›å»º<code>placement</code>å¯¹è±¡ï¼Œå…¶ä¸­å®šä¹‰äº†<code>predicate</code>å’Œ<code>priority</code>è§„åˆ™ï¼›æ§åˆ¶å™¨ä¼šè‡ªåŠ¨åˆ›å»ºå‡º<code>PlacementDecision</code>å¯¹è±¡ï¼Œè°ƒåº¦ç»“æœä¼šå­˜æ”¾åœ¨<code>PlacementDecision</code>ä¸­ã€‚</li>
<li>èµ„æºéƒ¨ç½²ï¼šéœ€è¦åˆ›å»º<code>ManifestWork</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡é‡Œå®šä¹‰äº†manifestså­—æ®µï¼Œå³èµ„æºæ¨¡æ¿ã€‚å¯¹åº”çš„clusterä¸Šçš„agent watchåˆ°äº†<code>ManifestWork</code>ï¼Œä¼šåœ¨è‡ªå·±çš„é›†ç¾¤å†…åˆ›å»ºå¯¹åº”çš„èµ„æºã€‚å¹¶ä¸”ä¼šå°†çŠ¶æ€åŒæ­¥åˆ°ä¸­å¤®é›†ç¾¤ä¸­çš„<code>ManifestWork</code> statuså­—æ®µã€‚</li>
</ol>
<p><strong>OCMæ—¨åœ¨æä¾›ä¸€ä¸ªç²¾ç®€çš„å¤šé›†ç¾¤/å¤šåº”ç”¨ç®¡ç†çš„å†…æ ¸ï¼Œä¸ä¼šå»å®šä¹‰é¢å‘ç”¨æˆ·çš„æ¥å£éƒ¨åˆ†ï¼Œè€Œæ˜¯å¸Œæœ›æä¾›ä¸‹å±‚èƒ½åŠ›ï¼Œä½¿å¾—å…¶ä»–é¢å‘æœ€ç»ˆç”¨æˆ·çš„æ¥å£å®ç°å¯ä»¥å¾ˆè½»æ˜“çš„é›†æˆè¿›æ¥ï¼Œæ¢å¥è¯è¯´OCMä¸åƒå…¶ä»–é›†ç¾¤è”é‚¦äº§å“é‚£æ ·å¯ä»¥å¼€ç®±å³ç”¨</strong>ã€‚</p>
<p>OCM å’Œ kubernetes å¼€æºç¤¾åŒºç»“åˆçš„æ¯”è¾ƒçš„å¯†åˆ‡ï¼š</p>
<ol>
<li>å®ç°äº† kubernetes <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-multicluster">sig-multicluster</a> çš„å¤šä¸ªè®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ KEP-2149ä¸­çš„Cluster IDã€KEP-1645 Multi-Cluster Services API ä¸­å…³äº clusterset çš„æ¦‚å¿µã€‚</li>
<li>å’Œå…¶ä»–ç¤¾åŒºå¼€å‘è€…å…±åŒæ¨åŠ¨ <a href="https://github.com/kubernetes-sigs/work-api">Work API</a> çš„å¼€å‘ï¼Œå¾ˆå¤šè®¾è®¡æ¥è‡ªäº<a href="https://docs.google.com/document/d/1cWcdB40pGg3KS1eSyb9Q6SIRvWVI8dEjFp9RI0Gk0vg/edit#">Multi-Cluster Works API
è®¾è®¡æ–‡æ¡£</a></li>
</ol>
<h2 id="clusternethttpsgithubcomclusternetclusternet"><a href="https://github.com/clusternet/clusternet">Clusternet</a></h2>
<figure>
    <img src="/clusternet-apps-concepts.png" width="1000px"/> 
</figure>

<p>å·¥ä½œåŸç†å’Œå‰é¢å‡ ä¸ªäº§å“å¤§åŒå°å¼‚ï¼Œå› ä¸ºå¤§å®¶è¦è§£å†³çš„é—®é¢˜å·®ä¸å¤šã€‚</p>
<p>è¯´å‡ ä¸ªæœ‰ç‰¹è‰²çš„ç‚¹ï¼š</p>
<ol>
<li>clusternet-hub ä»¥èšåˆå±‚api(AA)çš„å½¢å¼è¿è¡Œï¼Œä¸ä¾èµ–é¢å¤–çš„å­˜å‚¨å’Œç«¯å£ã€‚<strong>è¿™ä¸ªè®¾è®¡ä½¿å¾—clusternetæ¯”è¾ƒçš„è½»é‡ï¼Œæ—¢ä¸ä¼šåƒKubefed v2é‚£æ ·ä¼šç”Ÿæˆå¤§é‡Federated Typeèµ„æºï¼Œä¹Ÿä¸ä¼šåƒKarmadaé‚£æ ·éœ€è¦åœ¨k8sé›†ç¾¤ä¸­å®Œæ•´çš„éƒ¨ç½²ä¸€ä¸ªk8sã€‚åŒæ—¶è¿™ä¸ªè®¾è®¡ä¹Ÿä½¿å¾— clusternet å¯ä»¥å…¼å®¹ K8s åŸç”Ÿ APIï¼Œå®¢æˆ·ç«¯éœ€è¦è¿›è¡Œå¾ˆä½æˆæœ¬çš„æ”¹é€ ã€‚</strong>
<blockquote>
<p><strong>clusternetä¸­AAçš„ä½œç”¨ï¼Œå°±æ˜¯æŠŠk8såŸç”Ÿçš„apiè½¬æ¢ä¸ºAAä¸­çš„æ˜ å°„apiï¼Œä¾‹å¦‚podå­˜åœ¨apis/shadow/v1alpha1/podsä¸‹ã€‚æ‰€ä»¥å®¢æˆ·ç«¯å¿…é¡»è¦è¿›è¡Œæ”¹é€ ï¼Œä»åŸæ¥ä½¿ç”¨k8såŸç”Ÿçš„apiï¼Œå˜ä¸ºä½¿ç”¨clusternetä¸“ç”¨çš„apiã€‚è¿™ä¸ªæ”¹é€ ç›¸å½“è½»é‡ï¼Œåªéœ€è¦æ”¹ä¸€è¡Œä»£ç ã€‚</strong></p>
</blockquote>
</li>
<li>æ”¯æŒç›´æ¥ä»hubé›†ç¾¤ä¸­ç›´æ¥è®¿é—®ç®¡ç†é›†ç¾¤ï¼Œå¹¶ä¸”ç”¨RBACè¿›è¡Œäº†é‰´æƒç®¡ç†ï¼ˆæ˜¯é€šè¿‡hubé›†ç¾¤çš„apiserverè¿›è¡Œè½¬å‘ï¼‰è¿™æ ·å°±ç®€åŒ–äº†å¤šé›†ç¾¤çš„èµ„æºç®¡ç†æ–¹å¼ï¼Œä¸ç”¨ç™»å½•åˆ°å­é›†ç¾¤ä¸­å»æŸ¥çœ‹èµ„æºã€‚</li>
<li>clusternet-agentä¼šå»ºç«‹ä¸çˆ¶é›†ç¾¤çš„ TCP å…¨åŒå·¥çš„ websocket é€šä¿¡ä¿¡é“ã€‚ç›®å‰æˆ‘è¿˜æ²¡ææ‡‚è¿™ä¹ˆåšçš„å¥½å¤„åœ¨å“ªã€‚</li>
</ol>
<p>è¯•ç©è¿‡ç¨‹ä¸­ç¢°åˆ°äº†å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å…ˆé€šè¿‡clusternetéƒ¨ç½²å¤šé›†ç¾¤deploymentï¼Œç„¶åæˆ‘å»å­é›†ç¾¤ä¸­æŠŠdeploymentåˆ é™¤äº†ï¼Œä½†æ˜¯é€šè¿‡clusternetæ˜¾ç¤ºdeploymentçš„çŠ¶æ€è¿˜æ˜¯sucessï¼Œè€Œä¸”æ²¡æœ‰é‡æ–°å¸®æˆ‘æŠŠdeploymentåˆ›å»ºå‡ºæ¥ã€‚è¿™ä¸ªfeatureç°åœ¨å·²ç»å®ç°äº†ï¼š<a href="https://github.com/clusternet/clusternet/pull/194">#194</a></li>
<li>æˆå‘˜é›†ç¾¤çš„deploymentçš„statusã€eventæ— æ³•å’Œclusternetä¸­çš„deploymentå…³è”èµ·æ¥ï¼Œè¿˜æ˜¯å¾—é€šè¿‡æŸ¥çœ‹clusternetå®šä¹‰çš„crdèµ„æºæˆ–è€…å»æˆå‘˜é›†ç¾¤ä¸­æŸ¥çœ‹å…·ä½“çš„deploymentçŠ¶æ€ã€‚è¿˜æ˜¯å’Œç›´æ¥åœ¨å•k8sé›†ç¾¤ä¸Šæ“ä½œçš„ä½“éªŒä¸ä¸€è‡´ã€‚<strong>è¿™ä¼šç›´æ¥å¯¼è‡´æˆ‘åœ¨å•k8sé›†ç¾¤ä¸­å†™çš„operatoræ²¡æ³•ç›´æ¥ç§»æ¤åˆ°clusternetä¸­æ¥</strong>ã€‚clusterneté¡¹ç›®ç»´æŠ¤è€…è¡¨ç¤ºåç»­ä¼šç€åŠ›è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„å¹¶å‘é—®é¢˜</title>
			<link>https://cvvz.fun/post/atomic-in-different-context/</link>
			<pubDate>Mon, 29 Nov 2021 15:37:20 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/atomic-in-different-context/</guid>
			<description>é—®è¿™ä¸ªé—®é¢˜çš„èµ·å› æ˜¯æˆ‘åœ¨è¿›è¡Œcode reviewæ—¶ï¼Œå¯¹ä¸€ä¸ªè¯»mapå‰åŠ è¯»é”çš„ä»£ç ç•™ä¸‹äº†å¦‚ä¸‹commentï¼š å•ç‹¬ç»™ä¸€ä¸ªè¯»æ“ä½œåŠ é”æ²¡æœ‰å¿…è¦ã€‚ ä½†éšå</description>
			<content type="html"><![CDATA[<p>é—®è¿™ä¸ªé—®é¢˜çš„èµ·å› æ˜¯æˆ‘åœ¨è¿›è¡Œcode reviewæ—¶ï¼Œå¯¹ä¸€ä¸ªè¯»mapå‰åŠ è¯»é”çš„ä»£ç ç•™ä¸‹äº†å¦‚ä¸‹commentï¼š</p>
<p><code>å•ç‹¬ç»™ä¸€ä¸ªè¯»æ“ä½œåŠ é”æ²¡æœ‰å¿…è¦ã€‚</code></p>
<p>ä½†éšåè‡ªå·±éšçº¦è§‰å¾—å“ªé‡Œä¸å¯¹ï¼ŒæŸ¥äº†ä¸€ä¸‹ï¼ŒåŸæ¥golangçš„mapå°±æ˜¯ä¸å…è®¸å¹¶å‘è¯»å†™çš„ï¼Œå…¶å®å¯¹mapåŠ è¯»å†™é”å°±è·Ÿ <code>if err != nil</code> ä¸€æ ·å¸¸è§ã€‚è‡ªå·±çŠ¯äº†ä¸€ä¸ªå°ç™½é”™è¯¯ã€‚</p>
<p>å›è¿‡å¤´æ¥ä¹Ÿåº†å¹¸è‡ªå·±ä¼šçŠ¯è¿™ç§é”™è¯¯ï¼Œä¸ç„¶æˆ‘å¯èƒ½æ°¸è¿œåªè®°å¾— <strong>mapæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œä½¿ç”¨æ—¶è¦åŠ é”</strong> è¿™ä¸ªç»“è®ºï¼Œä»¥åŠä½¿ç”¨å‰mapåŠ é”çš„è‚Œè‚‰è®°å¿†ï¼Œå´å¹¶ä¸ä¼šåœä¸‹æ¥æƒ³ä¸€æƒ³ç»å¸¸æŒ‚åœ¨å˜´è¾¹çš„çº¿ç¨‹å®‰å…¨ã€å¹¶å‘åˆ°åº•åœ¨è¯´ä»€ä¹ˆï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦åŠ é”ã€‚</p>
<p>ä¹‹æ‰€ä»¥ä¼šçŠ¯è¿™ä¸ªåˆå­¦è€…é”™è¯¯ï¼ŒåŸå› åœ¨äºæˆ‘ææ··äº†å‡ ç§å¹¶å‘é—®é¢˜å‘ç”Ÿçš„ç»´åº¦ã€‚<strong>è™½ç„¶ä¼ ç»Ÿçš„é”ï¼ˆæˆ–è€…golangæ›´æ¨èçš„CSPï¼‰éƒ½æ˜¯ä¸ºäº†è§£å†³å¹¶å‘é—®é¢˜ï¼Œä½†æ˜¯åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè¦è§£å†³çš„å¹¶å‘é—®é¢˜ä¹Ÿå„ä¸ç›¸åŒ</strong>ã€‚</p>
<h2 id="ä¸šåŠ¡é€»è¾‘å±‚">ä¸šåŠ¡é€»è¾‘å±‚</h2>
<p>æ¯”å¦‚æ•°æ®åº“çš„Serializableéš”ç¦»çº§åˆ«ï¼Œè¯»åŠ å…±äº«ï¼ˆè¯»ï¼‰é”ï¼Œå†™åŠ æ’ä»–ï¼ˆå†™ï¼‰é”ï¼Œè¯»å†™äº’æ–¥ã€‚åœ¨ä¸šåŠ¡é€»è¾‘å±‚ï¼Œé€šå¸¸æœ€ç®€å•æœ‰æ•ˆçš„è§£å†³å¹¶å‘é—®é¢˜çš„æ–¹æ³•å°±æ˜¯<strong>é€šè¿‡åŠ é”æŠŠå¹¶å‘å˜æˆä¸²è¡Œ</strong>ã€‚æˆ‘åœ¨code reviewä¸­çŠ¯çš„é”™è¯¯ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¥ä¸ºç»™mapåŠ é”æ˜¯ä¸ºäº†è§£å†³ä¸šåŠ¡é€»è¾‘ä¸Šçš„å¹¶å‘é—®é¢˜ï¼Œè€Œä»ä¸šåŠ¡é€»è¾‘ä¸Šçœ‹ï¼Œæ²¡æœ‰å¿…è¦å•ç‹¬ç»™ä¸€ä¸ªè¯»æ“ä½œåŠ é”ï¼Œå› ä¸ºå¹¶ä¸æ˜¯ä¸€è¿ä¸²æ“ä½œã€‚</p>
<blockquote>
<p>é¡ºä¾¿æä¸€å¥ï¼Œgolangæ¨èä½¿ç”¨CSPæ¥è§£å†³å¹¶å‘é—®é¢˜ã€‚ä¹‹æ‰€ä»¥è¦ç”¨CSPï¼Œæ˜¯å› ä¸ºä¼ ç»Ÿçš„å…±äº«å†…å­˜ï¼ˆé”ï¼‰çš„æ–¹å¼è¿›è¡Œå¹¶å‘å¾ˆéš¾æ­£ç¡®ä½¿ç”¨ï¼Œä½†æ˜¯éµå¾ªCSPåŸåˆ™çš„è¯­è¨€ï¼ˆgoï¼‰åˆ™æ›´æ˜“é˜…è¯»å’Œç¼–å†™ã€‚ä½†æ˜¯Goè¯­è¨€ç¡®å®åœ¨syncåŒ…ä¸­æä¾›äº†ä¼ ç»Ÿçš„é”æœºåˆ¶ã€‚</p>
<p>golangä¸­çš„é”ä¸€èˆ¬ç”¨åœ¨ä¿æŠ¤æŸä¸ªç»“æ„çš„å†…éƒ¨çŠ¶æ€ã€‚å³åœ¨ struct å†…éƒ¨ä½¿ç”¨ sync.Mutexï¼Œè¿™æ ·å¯ä»¥ä¸ºè°ƒç”¨è€…éšè—å®ç°ç»†èŠ‚ã€‚é™¤æ­¤ä»¥å¤–çš„å…¶ä»–æƒ…å†µåŸºæœ¬ä¸Šéƒ½åº”è¯¥ç”¨channelã€‚</p>
</blockquote>
<h2 id="è¯­è¨€è¿è¡Œæ—¶å±‚">è¯­è¨€è¿è¡Œæ—¶å±‚</h2>
<ol>
<li>
<p>golangçš„sliceåœ¨appendæ—¶ï¼Œå¦‚æœæ²¡æœ‰è¶…å‡ºcapå¤§å°ï¼Œé‚£ä¹ˆæ˜¯ä¸ä¼šé‡æ–°åˆ†é…å†…å­˜çš„ï¼Œè¿™æ—¶æ•°æ®æ˜¯ç›´æ¥appendåˆ°åº•å±‚çš„æ•°ç»„ä¸­çš„ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹å¹¶å‘çš„appendåŒä¸€ä¸ªsliceï¼Œé‚£ä¹ˆå°±å¯èƒ½å†™åŒä¸€ç‰‡å†…å­˜ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´appendåçš„æ€»æ•°ä¸ç¬¦åˆé¢„æœŸï¼ˆå˜å°‘ï¼‰ã€‚</p>
</li>
<li>
<p>golangçš„mapè¢«è®¾è®¡ä¸ºéå¹¶å‘å®‰å…¨çš„ï¼ˆ<a href="https://go.dev/doc/faq#atomic_maps">åŸå› </a>ï¼‰ï¼Œåœ¨åº”ç”¨å±‚å¦‚æœå¹¶å‘æ—¶ä¸åŠ è¯»é”æˆ–è€…å†™é”ï¼Œå°±å¯èƒ½ä¼šæŠ¥é”™ï¼Œ<code>fatal error: concurrent map read and map write</code>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<a href="https://go.dev/doc/articles/race_detector">golang race detector</a>è¿›è¡Œæ£€æŸ¥ã€‚é‚£ä¸ºä»€ä¹ˆmapçš„è¯»å†™éœ€è¦åŠ é”å‘¢ï¼ˆä¸ç®¡æ˜¯åŠ åœ¨ä¸šåŠ¡é€»è¾‘é‡Œè¿˜æ˜¯åŠ åœ¨è¯­è¨€è¿è¡Œæ—¶é‡Œï¼‰ï¼ŸåŸå› åœ¨äºmapç±»å‹çš„ä¸€æ¬¡è¯»å†™ä¸æ˜¯åŸå­æ€§çš„ï¼ˆéœ€è¦è¿›è¡Œå“ˆå¸Œè®¡ç®—ã€è§£å†³å“ˆå¸Œå†²çªç­‰ï¼‰ã€‚</p>
</li>
</ol>
<h2 id="ç¼–è¯‘å™¨æ“ä½œç³»ç»Ÿå±‚">ç¼–è¯‘å™¨/æ“ä½œç³»ç»Ÿå±‚</h2>
<p>è¿™é‡Œåˆåˆ†ä¸ºå››ç§æƒ…å½¢åˆ†æï¼š</p>
<ol>
<li>
<p>ç¬¬ä¸€ç§æ˜¯å¹¶å‘æ‰§è¡Œi++ï¼Œç”±äºi++åœ¨ç¼–è¯‘ååœ¨åº•å±‚çš„å®ç°æ˜¯å…ˆè¯»iï¼Œå†+1ï¼Œå†å†™iï¼Œåˆ†ä¸ºä¸‰æ­¥ï¼Œæ“ä½œç³»ç»Ÿå¹¶ä¸ä¿è¯è¿™ä¸‰æ­¥æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥å¹¶å‘æ—¶å¯èƒ½æœ‰é—®é¢˜ã€‚</p>
</li>
<li>
<p>ç¬¬äºŒç§ä»ç„¶è€ƒè™‘å¹¶å‘æ‰§è¡Œi++ï¼Œå³ä½¿ä¸‰æ­¥æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œä½†æ˜¯ç”±äºç°ä»£CPUæ˜¯å¤šæ ¸å¿ƒçš„ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œå†™æ“ä½œå®é™…æ˜¯å†™å…¥å„è‡ªçš„ç¼“å­˜ä¸­å†å†™åˆ°L3 cacheå’Œå†…å­˜ä¸­ï¼Œæ‰€ä»¥å¹¶å‘æ‰§è¡Œi++æ˜¯å¦çº¿ç¨‹å®‰å…¨è¿˜ä¾èµ–å†™æ“ä½œæ˜¯å†™åˆ°cpuè‡ªå·±çš„ç¼“å­˜ä¸­è¿˜æ˜¯å†™åˆ°å†…å­˜ä¸­ã€‚</p>
</li>
<li>
<p>ç¬¬ä¸‰ç§æ˜¯è¯»å†™è¶…è¿‡ä¸€ä¸ªè®¡ç®—æœºå­—é•¿çš„æ•°æ®ï¼ˆæ¯”å¦‚structï¼Œæˆ–è€…å¤åˆç±»å‹ï¼Œæ¯”å¦‚stringï¼Œgolangçš„å¤æ•°ç±»å‹ç­‰ï¼‰ï¼Œå’Œç¬¬ä¸€æ¡ç±»ä¼¼ï¼Œè¿™æ—¶ä¹Ÿæ— æ³•é€šè¿‡ä¸€æ¡æœºå™¨æŒ‡ä»¤è¿›è¡Œè¯»å†™ã€‚</p>
</li>
<li>
<p>ç¬¬å››ç§ï¼Œç¼–è¯‘å™¨/å¤„ç†å™¨ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œå¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥çš„æ‰§è¡Œå…ˆåé¡ºåºåŒä»£ç ä¸­çš„é¡ºåºä¸€è‡´ï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œè¿™å°±æ˜¯æŒ‡ä»¤é‡æ’åºï¼ˆInstruction Reorderï¼‰ã€‚<strong>æŒ‡ä»¤é‡æ’åºä¸ä¼šå½±å“å•ä¸ªçº¿ç¨‹çš„æ‰§è¡Œï¼Œä½†æ˜¯ä¼šå½±å“åˆ°çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚</strong></p>
<blockquote>
<p>æ‰€ä»¥<a href="https://go.dev/ref/mem">goå†…å­˜æ¨¡å‹</a>å»ºè®®æˆ‘ä»¬<code>Don't be clever.</code>ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¯·ä¸è¦è‡ªä½œèªæ˜ã€‚<code>To serialize access, protect the data with channel operations or other synchronization primitives such as those in the sync and sync/atomic packages.</code><strong>ä¸ºäº†ä¿è¯è¯»å†™é¡ºåºï¼Œä½¿ç”¨channelæˆ–è€…å…¶ä»–åŒæ­¥åŸè¯­æ¯”å¦‚syncå’Œsync/atomicåŒ…ä¸­æä¾›çš„æ–¹æ³•æ¥ä¿æŠ¤ä½ çš„æ•°æ®ã€‚</strong></p>
</blockquote>
</li>
</ol>
<h3 id="æ‹“å±•golangä¸­çš„cow">æ‹“å±•ï¼šgolangä¸­çš„COW</h3>
<p>è™½ç„¶åŠ é”å¾ˆå¿«ï¼Œå¹¶ä¸”åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹æˆ‘ä»¬éƒ½ä¸ä¼šç¢°åˆ°é”æ€§èƒ½é—®é¢˜ã€‚ä½†æ˜¯åœ¨æŸäº›æç«¯åœºæ™¯ä¸‹ï¼Œå¦‚æœå¯¹mapé¢‘ç¹çš„åŠ è¯»å†™é”ï¼Œè¿˜æ˜¯ä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½æŸå¤±ã€‚æˆ‘ä»¬å¯ä»¥é‡‡å–copy-on-writeï¼ˆ<strong>åªæœ‰åœ¨éœ€è¦å¯¹å†…å­˜è¿›è¡Œå†™å…¥çš„æ—¶å€™æ‰è¿›è¡Œæ‹·è´ï¼Œè¯»æ—¶ç›´æ¥è¯»åŸå†…å­˜</strong>ï¼‰çš„æ–¹å¼é¿å…å¯¹mapåŠ é”ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</p>
<p>æ–¹æ³•å°±æ˜¯<strong>æŠŠå¯¹mapçš„å†™å…¥æ“ä½œå˜æˆæ–°mapçš„æ›¿æ¢</strong>ï¼Œç”±äºmapæ›¿æ¢æœ¬èº«å¯ä»¥çœ‹æˆæ˜¯è¿›è¡Œä¸€æ¬¡æŒ‡é’ˆèµ‹å€¼ï¼Œè€ŒæŒ‡é’ˆèµ‹å€¼åœ¨golangä¸­æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥å°±ä¸ä¼šå­˜åœ¨mapå¹¶å‘é—®é¢˜ã€‚</p>
<p>å…¸å‹ä»£ç å¯ä»¥æŸ¥çœ‹<a href="https://github.com/Terry-Mao">æ¯›å‰‘</a>çš„<a href="https://github.com/Terry-Mao/gopush-cluster/blob/master/rpc/rand_lb.go#L221-L232">è¿™æ®µä»£ç </a></p>
<blockquote>
<p>ä½†æ˜¯è¿™æ®µä»£ç ä¹Ÿå¼•èµ·äº†ä¸€äº›<a href="https://github.com/Terry-Mao/gopush-cluster/issues/44">äº‰è®®</a>ï¼Œä¸»è¦äº‰è®®åœ¨äºgolangçš„æŒ‡é’ˆèµ‹å€¼åˆ°åº•æ˜¯ä¸æ˜¯åŸå­çš„ã€‚å…³äºè¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥çœ‹çœ‹<a href="https://stackoverflow.com/questions/21447463/is-assigning-a-pointer-atomic-in-go">è¿™ä¸ªé—®ç­”</a>ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼Œé™¤äº† <code>sync.atomic</code> ä¸­çš„æ“ä½œä»¥å¤–ï¼Œå…¶ä»–ä»»ä½•æ“ä½œéƒ½ä¸å»ºè®®çœ‹ä½œæ˜¯åŸå­æ€§çš„ã€‚å› ä¸ºå³ä½¿å½“å‰ç‰ˆæœ¬golangä¸­çš„å®ç°æ˜¯åŸå­çš„ï¼Œä¸ä»£è¡¨ä»¥åæŸä¸€å¤©ä¸ä¼šè¢«æ”¹æˆéåŸå­çš„ã€‚</p>
<p>è¿™å¯èƒ½ä¹Ÿæ˜¯<a href="https://go.dev/ref/mem">goå†…å­˜æ¨¡å‹</a>é‡Œè®©æˆ‘ä»¬<code>Don't be clever.</code>çš„åŸå› å§ã€‚<strong>æˆ‘ä¸ªäººçš„ç†è§£æ˜¯ï¼Œå¦‚æœä½ å†™golangï¼Œå¯èƒ½éœ€è¦é€‚å½“çš„â€œç¬¨â€ä¸€ç‚¹ï¼Œè®©è¿è¡Œæ—¶å¸®ä½ åšåº•å±‚çš„äº‹æƒ…ï¼›å¦‚æœä½ æƒ³è¿½æ±‚æè‡´çš„æ€§èƒ½ï¼Œæ˜¯ä¸€ä¸ªâ€œèªæ˜â€çš„ç¨‹åºå‘˜ï¼Œä½ å¯ä»¥é€‰æ‹©æ›´åŠ åº•å±‚çš„è¯­è¨€ :)</strong></p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>informerå’Œcontroller-runtimeæºç </title>
			<link>https://cvvz.fun/post/controller-reconcile/</link>
			<pubDate>Sat, 20 Nov 2021 14:17:23 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/controller-reconcile/</guid>
			<description>é—®é¢˜ æœ€è¿‘åœ¨å†™operatoræ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªåœºæ™¯éœ€è¦è®©controlleræ¯éš”1åˆ†é’Ÿåšä¸€æ¬¡reconcileï¼Œè€Œä¸éœ€è¦å€ŸåŠ©å¤–éƒ¨äº‹ä»¶è§¦å‘ã€‚ è™½ç„¶cl</description>
			<content type="html"><![CDATA[<h2 id="é—®é¢˜">é—®é¢˜</h2>
<figure>
    <img src="/informer.jpeg" width="500px"/> 
</figure>

<p>æœ€è¿‘åœ¨å†™operatoræ—¶ï¼Œç¢°åˆ°ä¸€ä¸ªåœºæ™¯éœ€è¦è®©controlleræ¯éš”1åˆ†é’Ÿåšä¸€æ¬¡reconcileï¼Œè€Œä¸éœ€è¦å€ŸåŠ©å¤–éƒ¨äº‹ä»¶è§¦å‘ã€‚</p>
<p>è™½ç„¶<code>client-go</code>å’Œ<code>controller-runtime</code>éƒ½æä¾›äº†å¾ˆæ–¹ä¾¿çš„æ¥å£è¿›è¡Œè®¾ç½®ã€‚ä½†æ˜¯çŸ¥å…¶ç„¶è¿˜è¦çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå€Ÿç€è§£å†³è¿™ä¸ªé—®é¢˜çš„å¥‘æœºï¼Œä»”ç»†é˜…è¯»äº†ä¸€ä¸‹<code>infomer</code>å’Œ<code>controller-runtime</code>çš„ä»£ç ï¼Œææ¸…æ¥šäº†åº•å±‚å®ç°åŸç†ã€‚</p>
<h2 id="æ–¹æ³•ä¸€">æ–¹æ³•ä¸€</h2>
<p>åˆ›å»º<code>informerFactory</code>å¯¹è±¡æ—¶ï¼Œè®¾ç½®<code>defaultResync</code>å‚æ•°</p>
<figure>
    <img src="/1.png" width="800px&#34;"/> 
</figure>

<h3 id="åŸç†">åŸç†</h3>
<p>reflectoré™¤äº†ä¼šwatch apiserverï¼Œè¿˜ä¼šæ¯éš” defaultResync ä»indexerä¸­é‡æ–°è·å–Objectï¼Œå¹¶å°†å…¶å…¥é˜Ÿfifoï¼Œè¿™æ ·å°±ä¼šé‡æ–°è§¦å‘ä¸€æ¬¡informerçš„Addäº‹ä»¶å¹¶å…¥é˜Ÿå·¥ä½œé˜Ÿåˆ—ã€‚</p>
<h3 id="client-goæºç ">client-goæºç </h3>
<p>reflectoråœ¨è¿›è¡Œ<a href="https://github.com/kubernetes/client-go/blob/10e087ca394e2987f09e759438f9949a746c1ca0/tools/cache/reflector.go#L254">ListAndWatch</a>çš„åŒæ—¶ä¹Ÿä¼šå‘¨æœŸæ€§çš„åšresyncï¼š</p>
<figure>
    <img src="/2.png" width="500px&#34;"/> 
</figure>

<p>è¿™é‡Œçš„storeå°±æ˜¯fifoï¼Œfifoçš„Resyncå®ç°å¦‚ä¸‹ï¼š</p>
<figure>
    <img src="/3.png" width="500px&#34;"/> 
</figure>

<p>è¿™é‡Œè°ƒç”¨knownObjects.ListKeys()æ¥è·å–æ‰€æœ‰çš„Object keyç„¶åå†å…¥é˜Ÿfifoï¼Œè¿™ä¸ªknownObjectså…¶å®å°±æ˜¯indexer cacheï¼ˆä¸€ä¸ªå¸¦é”çš„mapï¼‰</p>
<figure>
    <img src="/00.png" width="600px&#34;"/> 
</figure>

<h3 id="controller-runtimeæºç ">controller-runtimeæºç </h3>
<p>å¯¹äºcontroller-runtimeåº“ï¼Œreflectorã€informerã€indexerç­‰ç»„ä»¶è¢«å°è£…åœ¨cacheå¯¹è±¡ä¸­ï¼Œcacheå¯¹è±¡æ˜¯Managerå¯¹è±¡çš„å±æ€§ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/controller-runtime.drawio.svg" width="500px&#34;"/> 
</figure>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨åˆ›å»ºManagerå¯¹è±¡æ—¶ï¼Œä¼ å…¥SyncPeriodå‚æ•°æ¥è¾¾åˆ°è¿™ä¸€ç›®çš„ï¼Œå½“ç„¶SyncPeriodåº”è¯¥æ˜¯å¯é…ç½®çš„ï¼š</p>
<figure>
    <img src="/4.png" width="700px&#34;"/> 
</figure>

<h2 id="æ–¹æ³•äºŒ">æ–¹æ³•äºŒ</h2>
<p>ä½¿ç”¨<code>controller-runtime</code>åº“æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡åœ¨<code>Reconcile</code>ä¸­ï¼Œè®¾ç½®è¿”å›çš„<code>Result.RequeueAfter</code>ä¸º1åˆ†é’Ÿæ¥å®ç°ï¼š</p>
<figure>
    <img src="/5.png" width="700px&#34;"/> 
</figure>

<h3 id="åŸç†-1">åŸç†</h3>
<p>å…ˆæ‰¾åˆ°Reconcileçš„è°ƒç”¨ç‚¹ï¼š</p>
<ol>
<li>
<p>ControllerManagedByé€šè¿‡<strong>Builderæ¨¡å¼</strong>å°†Controlleræ·»åŠ è¿›Managerä¸­</p>
<figure>
    <img src="/6.png" width="700px&#34;"/> 
</figure>

</li>
<li>
<p>Managerå¯åŠ¨æ—¶ä¼šå¯åŠ¨æ‰€æœ‰controllerï¼Œå¯¹äºcontrollerï¼Œâ€œå¯åŠ¨â€çš„å«ä¹‰å°±æ˜¯å¯åŠ¨å¤šä¸ªgoroutineå¾ªç¯çš„ä»workqueueä¸­å–keyï¼Œç„¶åæ‰§è¡ŒReconcileï¼Œé¡ºç€Manager.Startä¸€å±‚å±‚çš„æ‰¾åˆ°<a href="https://github.com/kubernetes-sigs/controller-runtime/blob/master/pkg/internal/controller/controller.go#L148">Controllerçš„Startå…¥å£</a>ï¼Œæœ€ç»ˆå¯ä»¥çœ‹åˆ°ç†Ÿæ‚‰çš„ <code>processNextWorkItem</code>ï¼š</p>
<figure>
    <img src="/7.png" width="700px&#34;"/> 
</figure>

<p><code>processNextWorkItem</code>çš„é€»è¾‘å½“ç„¶å°±æ˜¯ä»workqueueé‡Œå–keyï¼Œç„¶åæ‰§è¡ŒReconcileçš„ä¸šåŠ¡é€»è¾‘ï¼š</p>
<figure>
    <img src="/8.png" width="700px&#34;"/> 
</figure>

</li>
<li>
<p>å¯ä»¥çœ‹åˆ°å½“<code>result.RequeueAfter &gt; 0</code>æ—¶ï¼Œæ‰§è¡Œäº†<code>c.Queue.Forget(obj)</code>å’Œ<code>c.Queue.AddAfter(req, result.RequeueAfter)</code>ï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè¦ææ¸…æ¥šè¿™ä¸€ç‚¹ï¼Œé¦–å…ˆæˆ‘ä»¬è¦å¼„æ¸…æ¥šworkqueueçš„å®ç°ã€‚</p>
</li>
</ol>
<h3 id="workqueue">workqueue</h3>
<ol>
<li>
<p>workqueueçš„åˆ›å»ºæ–¹æ³•å®šä¹‰åœ¨controllerä¸­ï¼šï¼š</p>
<figure>
    <img src="/9.png" width="700px&#34;"/> 
</figure>

</li>
<li>
<p>è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ªé™é€Ÿé˜Ÿåˆ—ï¼Œé™é€Ÿé˜Ÿåˆ—ç”±<strong>å»¶è¿Ÿé˜Ÿåˆ—</strong>å’Œ<strong>é™é€Ÿå™¨</strong>ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>
<figure>
    <img src="/10.png" width="700px&#34;"/> 
</figure>

</li>
</ol>
<h3 id="addafter">AddAfter</h3>
<p><code>AddAfter</code>æ˜¯å»¶è¿Ÿé˜Ÿåˆ—æä¾›çš„æ–¹æ³•ï¼Œå®ƒå‘<code>waitingForAddCh</code>è¿™ä¸ªchannelä¸­ä¼ å…¥äº†ä¸€ä¸ªæ„é€ çš„<code>waitFor</code>å¯¹è±¡</p>
<figure>
    <img src="/11.png" width="700px&#34;"/> 
</figure>

<p>è€Œè¿™ä¸ªchannelçš„æ¥æ”¶æ–¹ï¼Œåˆ™æ˜¯åœ¨åˆ›å»ºå»¶è¿Ÿé˜Ÿåˆ—æ—¶å¯åŠ¨çš„ä¸€ä¸ªgoroutineï¼š</p>
<figure>
    <img src="/12.png" width="700px&#34;"/> 
</figure>

<p>åœ¨è¿™ä¸ªgoroutineä¸­ï¼Œæ”¶åˆ°<code>waitFor</code>å¯¹è±¡åï¼Œå¦‚æœè¿˜æ²¡åˆ°æ‰§è¡Œæ—¶é—´ï¼Œåˆ™ä¼šæ’å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ï¼ˆ<strong>å¯ä»¥çœ‹åˆ°ï¼Œé«˜æ€§èƒ½å®šæ—¶å™¨ä¸€èˆ¬ç”¨å †å®ç°</strong>ï¼‰</p>
<figure>
    <img src="/13.png" width="700px&#34;"/> 
</figure>

<p>éšåä¼šåˆ¤æ–­ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­å †é¡¶å…ƒç´ çš„æ—¶é—´æ˜¯å¦åˆ°è¾¾ï¼Œå¦‚æœæ—¶é—´åˆ°äº†ï¼Œå°±å–å‡ºå †é¡¶å…ƒç´ ï¼Œå¹¶å…¥é˜Ÿworkqueueï¼Œæ—¶é—´æ²¡åˆ°å°±è®¡ç®—éœ€è¦ç­‰å¤šé•¿æ—¶é—´ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªtimerè¿›è¡Œç­‰å¾…</p>
<figure>
    <img src="/14.png" width="700px&#34;"/> 
</figure>

<h3 id="forget">Forget</h3>
<p>åœ¨çœ‹Forgetæ–¹æ³•å‰ï¼Œå…ˆçœ‹é™é€Ÿé˜Ÿåˆ—ä¸­æˆ‘ä»¬æœ€å¸¸ç”¨çš„<code>AddRateLimited</code>æ–¹æ³•ï¼Œä¸€èˆ¬è¿™ä¸ªæ–¹æ³•ä¼šåœ¨æˆ‘ä»¬Reconcileå¤±è´¥çš„æ—¶å€™è¿›è¡Œè°ƒç”¨ï¼Œç›®çš„å°±æ˜¯ä»¥æŸç§é™å®šçš„é€Ÿç‡é‡æ–°å…¥é˜Ÿworkqueueï¼Œä»è€Œè¾¾åˆ°é™åˆ¶é‡è¯•é€Ÿåº¦çš„ç›®çš„ï¼š</p>
<figure>
    <img src="/15.png" width="700px&#34;"/> 
</figure>

<p>å¯ä»¥çœ‹åˆ°å…¶å®å°±æ˜¯è°ƒç”¨å»¶è¿Ÿé˜Ÿåˆ—çš„<code>AddAfter</code>æ–¹æ³•ï¼Œåªæ˜¯<code>AddAfter</code>çš„æ–¹æ³•çš„å‚æ•°ä¸æ˜¯å›ºå®šçš„æ—¶é—´ï¼Œè€Œæ˜¯ç”±ratelimiterè®¡ç®—å¾—åˆ°</p>
<p><a href="https://github.com/kubernetes/client-go/blob/10e087ca394e2987f09e759438f9949a746c1ca0/util/workqueue/default_rate_limiters.go">workqueue</a>åŒ…ä¸­æä¾›çš„é»˜è®¤é™é€Ÿå™¨æ˜¯<strong>æŒ‡æ•°é€€é¿é™é€Ÿå™¨ + ä»¤ç‰Œæ¡¶é™é€Ÿå™¨</strong>ï¼š</p>
<figure>
    <img src="/16.png" width="700px&#34;"/> 
</figure>

<p><code>Forget</code>æ˜¯ratelimiteræä¾›çš„æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯æŠŠå¤±è´¥çš„å¯¹è±¡ä»ratelimiterä¸­ç§»é™¤ï¼Œè¿™æ ·ratelimiterå°±ä¸ä¼šå†æ ¹æ®è¯¥å¯¹è±¡çš„å¤±è´¥æ¬¡æ•°å¯¹å…¶è¿›è¡Œé™é€Ÿè®¡ç®—äº†</p>
<figure>
    <img src="/17.png" width="700px&#34;"/> 
</figure>

<p>å› æ­¤ï¼Œåœ¨Reconcileæ‰§è¡ŒæˆåŠŸåï¼Œ<strong>éœ€è¦è°ƒç”¨Forgetå°†å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²namespace/nameï¼‰ä»é™é€Ÿå™¨ä¸­ç§»é™¤</strong>ï¼Œå¦åˆ™ä¼šé‡å¤å…¥é˜Ÿworkqueueä¸€æ¬¡å¹¶ä¸”ä¼šå½±å“åç»­é™é€Ÿå™¨å¯¹äºç›¸åŒkeyçš„é™é€Ÿè®¡ç®—ã€‚</p>
<p>å›åˆ°æœ€å¼€å§‹çš„é—®é¢˜ï¼Œå½“è®¾ç½®<code>result.RequeueAfter</code>ä¸º1minæ—¶ï¼Œä¼šè°ƒç”¨<code>c.Queue.Forget(obj)</code>å’Œ<code>c.Queue.AddAfter(req, result.RequeueAfter)</code>ï¼Œä¹Ÿå°±æ˜¯è¯´1åˆ†é’Ÿä¹‹åä¼šå†æ¬¡å…¥é˜Ÿï¼Œè§¦å‘reconciliationã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>æµ…è°ˆäº‘åŸç”Ÿæ•°æ®åº“</title>
			<link>https://cvvz.fun/post/the-difficulty-of-distributed-db-on-cloud/</link>
			<pubDate>Sun, 25 Jul 2021 08:58:26 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/the-difficulty-of-distributed-db-on-cloud/</guid>
			<description>äº‘åŸç”Ÿæ•°æ®åº“ã€shared-nothingã€ç®—å­˜åˆ†ç¦»&amp;hellip; è¿™äº›æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œç½‘ä¸Šèµ„æ–™ä¸€å¤§æŠŠï¼Œçœ‹å®Œä»¥åæ„Ÿè§‰æ‡‚äº†ï¼Œä½†æ˜¯å°è¯•ç”¨è‡ªå·±çš„è¯å¤</description>
			<content type="html"><![CDATA[<p><code>äº‘åŸç”Ÿæ•°æ®åº“</code>ã€<code>shared-nothing</code>ã€<code>ç®—å­˜åˆ†ç¦»</code>&hellip; è¿™äº›æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œç½‘ä¸Šèµ„æ–™ä¸€å¤§æŠŠï¼Œçœ‹å®Œä»¥åæ„Ÿè§‰æ‡‚äº†ï¼Œä½†æ˜¯å°è¯•ç”¨è‡ªå·±çš„è¯å¤è¿°å‡ºæ¥æ—¶ï¼Œåˆæ„Ÿè§‰æ²¡æ‡‚ã€‚</p>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§æ„Ÿè§‰å‘¢ï¼Ÿæˆ‘è§‰å¾—åŸå› åœ¨äºçœ‹å®Œäº†ç½‘ä¸Šçš„èµ„æ–™ï¼Œæˆ‘çŸ¥é“äº†whatï¼›ä½†æ˜¯å¾ˆå¤šèµ„æ–™å¹¶æ²¡æœ‰è§£é‡Šwhyï¼Œæ‰€ä»¥æˆ‘æ— æ³•æŠŠçŸ¥è¯†è½¬å˜æˆè‡ªå·±çš„ï¼Œä¹Ÿå°±æ— æ³•ç”¨è‡ªå·±çš„è¯­è¨€æŠŠè¿™äº›æ¦‚å¿µè§£é‡Šä¸€éã€‚åªæœ‰ææ¸…æ¥šä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§è®¾è®¡ï¼Œæ‰èƒ½å¤Ÿæ¶ˆåŒ–çŸ¥è¯†ï¼ŒåªçŸ¥é“whatçš„è¯ï¼Œåªèƒ½é æ­»è®°ç¡¬èƒŒæ‰èƒ½â€œæŒæ¡â€çŸ¥è¯†ã€‚</strong></p>
</blockquote>
<figure>
    <img src="/database-architecture.jpg" width="800px"/> 
</figure>

<p>è¿™å¼ å›¾æ¥è‡ªäºæé£é£çš„ä¸€ç‰‡<a href="https://mp.weixin.qq.com/s/rOL1drNzhWW1HBkgTz2wHQ">æ–‡ç« </a>ï¼Œä»‹ç»äº†æ•°æ®åº“çš„è¿‡å»å’Œæœªæ¥ã€‚æˆ‘å°è¯•åœ¨è¿™å¼ å›¾çš„åŸºç¡€ä¸Šè¡¥å……è‡ªå·±çš„ç†è§£ï¼š</p>
<h2 id="å•æœºæ•°æ®åº“">å•æœºæ•°æ®åº“</h2>
<p>ç»å¸¸å¬åˆ°è¯´ä¼ ç»Ÿå•æœºæ•°æ®åº“æ˜¯ä¸€ç§<code>shared-everything</code>çš„æ¶æ„ï¼Œæ€ä¹ˆç†è§£å‘¢ï¼Ÿå®é™…ä¸Šè¿™é‡Œçš„<code>everything</code>æŒ‡çš„æ˜¯å†¯Â·è¯ºä¾æ›¼æ¶æ„ä¸­çš„ã€Œè®¡ç®—ã€å’Œã€Œå­˜å‚¨ã€ï¼Œè€Œ<code>shared</code>æŒ‡çš„æ˜¯å•æœºæ•°æ®åº“å¯ä»¥éšæ„ä½¿ç”¨æœ¬åœ°çš„æ‰€æœ‰ã€Œè®¡ç®—ã€å’Œã€Œå­˜å‚¨ã€èµ„æºã€‚</p>
<h2 id="åˆ†å¸ƒå¼æ•°æ®åº“">åˆ†å¸ƒå¼æ•°æ®åº“</h2>
<p>å¾ˆå¿«ï¼Œå•æœºæ•°æ®åº“å°±é¢ä¸´ç€å¯æ‰©å±•æ€§é—®é¢˜ï¼Œè¿™æ—¶å°±éœ€è¦é€šè¿‡åŠ èµ„æºçš„æ–¹å¼è§£å†³ï¼Œäºæ˜¯å‡ºç°äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼šScale upå’ŒScale outã€‚</p>
<p>è¿™é‡ŒScale upå¹¶ä¸æ˜¯æŒ‡å•æœºç»´åº¦çš„scale upï¼Œè€Œæ˜¯ä»èµ„æºè§†è§’çš„scale upï¼Œæ›´å…·ä½“åœ°è¯´ï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨æ± åŒ–ï¼šæ•°æ®åº“çš„åº•å±‚å­˜å‚¨ç”±åŸæ¥çš„å•æœºç£ç›˜ï¼ˆç£ç›˜é˜µåˆ—ï¼‰ã€å•æœºæ–‡ä»¶ç³»ç»Ÿï¼Œæ¼”å˜ä¸ºåŸºäºåˆ†å¸ƒå¼å—å­˜å‚¨ã€åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ã€å¯¹è±¡å­˜å‚¨ç­‰çš„<code>shared-storage</code>åˆ†å¸ƒå¼æ•°æ®åº“ã€‚</p>
<p>Scale outåˆ™æ˜¯å„ä¸ªæ•°æ®åº“å®ä¾‹ç‹¬ç«‹è¿è¡Œï¼Œå®ä¾‹ä¹‹é—´é€šè¿‡raft/paxosç­‰å…±è¯†ç®—æ³•å®ç°æ•°æ®åŒæ­¥ï¼Œè€Œä¸ä¾èµ–åº•å±‚çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿã€‚è¿™å°±æ˜¯æ‰€è°“çš„<code>shared-nothing</code>åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œæ•°æ®åº“ä¸å…±äº«ä»»ä½•IaaSå±‚çš„èµ„æºï¼Œå®Œå…¨ä¾èµ–äºPaaSå±‚ï¼ˆDBï¼‰æœ¬èº«ï¼Œå»åšé«˜å¯ç”¨å’Œå¼ºä¸€è‡´ï¼Œå®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<h2 id="äº‘åŸç”Ÿæ•°æ®åº“">äº‘åŸç”Ÿæ•°æ®åº“</h2>
<p><strong>äº‘åŸç”Ÿæ•°æ®åº“ = åˆ†å¸ƒå¼æ•°æ®åº“(scale out) + èµ„æºæ± åŒ–(scale up)</strong>ã€‚</p>
<p><strong>äº‘åŸç”Ÿ = äº‘ + åŸç”Ÿ</strong>ã€‚ã€Œäº‘ã€å°±ä»£è¡¨ç€IaaSèµ„æºæ± åŒ–ï¼Œã€ŒåŸç”Ÿã€æ„å‘³ç€åº”ç”¨ï¼ˆPaaSã€SaaSï¼‰å¤©ç„¶å°±æ˜¯é’ˆå¯¹è¿™ç§æ± åŒ–çš„ç‰¹æ€§è¿›è¡Œè®¾è®¡çš„ã€‚</p>
<p>ç°åœ¨çš„åˆ†å¸ƒå¼æ•°æ®åº“å¤§å¤šæ˜¯<code>shared-nothing</code>çš„ï¼Œä¾‹å¦‚tidbå’Œobï¼Œä½¿ç”¨äº†æœ¬åœ°ç›˜ã€‚ä¸€æ—¦ä½¿ç”¨æœ¬åœ°ç›˜ï¼Œå°±æ„å‘³ç€ä¸Šäº‘å¾ˆå›°éš¾ï¼Œå› ä¸ºäº‘çš„ç‰¹æ€§å°±æ˜¯èµ„æºæ± åŒ–ï¼Œå…¬æœ‰äº‘å‚å•†ä¸€èˆ¬ä¼šæä¾›ç½‘ç»œå­˜å‚¨è€Œéæœ¬åœ°å­˜å‚¨ã€‚è€Œäº‘ç›˜çš„æ€§èƒ½æ²¡æœ‰æœ¬åœ°ç›˜å¥½ï¼Œè¿™å°±è¦æ±‚åº”ç”¨å±‚ï¼Œä¹Ÿå°±æ˜¯DBè¿™ä¸€å±‚ï¼Œæ˜¯é¢å‘å…¬æœ‰äº‘çš„åŸºç¡€æœåŠ¡è¿›è¡Œè®¾è®¡çš„ã€‚è¿™å°±æ˜¯äº‘åŸç”Ÿçš„æ•°æ®åº“ï¼Œå³åœ¨æ•°æ®åº“è®¾è®¡çš„æ—¶å€™ï¼Œå°±è€ƒè™‘å„ç§èµ„æºæ˜¯åœ¨äº‘ä¸Šï¼Œä»¥æ± åŒ–çš„æ–¹å¼æä¾›ã€‚è¿™ç§æ–¹å¼æ„å‘³ç€<code>shared-nothing</code>å’Œ<code>shared-everything</code>
çš„ç»“åˆï¼šå®è§‚ä¸Šçœ‹ï¼Œæ˜¯<code>shared-everything</code>çš„ï¼Œè®¡ç®—å’Œå­˜å‚¨å±‚ç”±äº‘å‚å•†æä¾›èµ„æºæ± çš„æŠ½è±¡ï¼ˆæœªæ¥ç”šè‡³å†…å­˜ä¹Ÿå¯èƒ½ä¼šæ± åŒ–ï¼‰ï¼Œä½†ä»å•æœºè§’åº¦çœ‹ï¼Œå®é™…ä¸Šå„ä¸ªå®ä¾‹åˆæ˜¯åˆ†å¸ƒå¼çš„ï¼Œ<code>shared-nothing</code>ã€‚</p>
<p>è¿™æ˜¯<strong>ç®—å­˜åˆ†ç¦»</strong>çš„ç»ˆæ€ï¼š<strong>åœ¨å•æœºéƒ¨ç½²æƒ…å†µä¸‹ï¼Œé€šä¿¡å°±æ˜¯è®¡ç®—é€šè¿‡ Memory Busã€IO Buså’Œå†…å­˜ã€å­˜å‚¨é€šä¿¡ã€‚ä½†åœ¨é›†ç¾¤éƒ¨ç½²çš„æƒ…å†µä¸‹ï¼Œè®¡ç®—å’Œå­˜å‚¨çš„é€šä¿¡å°±æ˜¯ç½‘ç»œ</strong>ã€‚æ•°æ®åº“åˆšè¯ç”Ÿçš„å¹´ä»£ï¼Œå•æœºçš„å­˜å‚¨è®¿é—®é€Ÿåº¦è‚¯å®šè¦å¿«äºé›†ç¾¤ï¼Œä½†æ˜¯éšç€ç½‘ç»œã€å­˜å‚¨ç­‰åŸºç¡€è®¾æ–½çš„ä¸æ–­å‘å±•ï¼Œæœªæ¥è¿™ä¸ªæƒ…å†µå¯èƒ½å°±ä¸ä¸€å®šäº†ï¼Œæ± åŒ–èµ„æºï¼Œäº‘åŸç”Ÿï¼Œæ˜¯æ•°æ®åº“å’Œå…¶ä»–ä¸Šå±‚åº”ç”¨æœªæ¥çš„è¶‹åŠ¿ã€‚</p>
<h2 id="åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šäº‘">åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šäº‘</h2>
<p>ä¸ºäº†è¿½æ±‚æè‡´æ€§èƒ½ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ä¸€èˆ¬ä¼šç›´æ¥éƒ¨ç½²åœ¨ç‰©ç†æœºç”šè‡³å®šåˆ¶åŒ–çš„è£¸é‡‘å±æœºä¸Šï¼Œè€Œä¸æ˜¯åŸºäºäº‘åŸºç¡€è®¾æ–½ã€‚å°†åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šäº‘ï¼Œå¹¶ä¾æ‰˜k8sè¿›è¡Œç®¡ç†ï¼Œå¯ä»¥çœ‹æˆæ˜¯äº‘åŸç”Ÿæ•°æ®åº“çš„ä¸€ç§è¿‡æ¸¡å½¢æ€ã€‚</p>
<p>å¦‚æœä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“åœ¨ç”¨k8sè¿›è¡Œç®¡ç†çš„æ—¶å€™æœ‰äº›æ°´åœŸä¸æœï¼šä¸æ”¯æŒå‚ç›´åŠ¨æ€ä¼¸ç¼©ã€èŠ‚ç‚¹ä¸‹çº¿éœ€è¦è¿ç§»æ•°æ®ã€‚å¦‚æœä½¿ç”¨ç½‘ç»œå­˜å‚¨ï¼Œå°±è¦é¢å¯¹æ€§èƒ½å’Œå»¶è¿ŸæŠ–åŠ¨ç­‰é—®é¢˜ã€‚ç°æœ‰çš„äº‘åŸç”Ÿæ•°æ®åº“ï¼ˆæ¯”å¦‚snowflakeï¼‰ä¸€èˆ¬éƒ½æ˜¯é¢å‘OLAPçš„æ•°æ®ä»“åº“ï¼ŒåŸå› åœ¨äºæ•°æ®ä»“åº“å¯¹äºååçš„è¦æ±‚å…¶å®æ˜¯æ›´é«˜çš„ï¼Œå¯¹äºå»¶è¿Ÿå¹¶ä¸æ˜¯é‚£ä¹ˆåœ¨æ„ï¼Œä¸€ä¸ª query å¯èƒ½è·‘äº”ç§’å‡ºç»“æœå°±è¡Œäº†ï¼Œä¸ç”¨è¦æ±‚äº”æ¯«ç§’ä¹‹å†…ç»™å‡ºç»“æœã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>é‡å­¦æ•°æ®ç»“æ„å’Œç®—æ³•</title>
			<link>https://cvvz.fun/post/data-structure-and-algorithm/</link>
			<pubDate>Sun, 18 Jul 2021 21:14:55 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/data-structure-and-algorithm/</guid>
			<description>æˆ‘çš„é¢˜åº“ æˆ‘çš„leetcode å¸¸è§æ•°æ®ç»“æ„ æ•°ç»„ æ•°ç»„çš„æ—¶é—´æ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯ç©ºé—´æ•ˆç‡å¾ˆä½ï¼Œè€Œä¸”ä¸å®‰å…¨ï¼Œæ¯”å¦‚è®¿é—®è¶Šç•Œé€ æˆè¸©å†…å­˜ã€‚ å¾ˆå¤šé«˜çº§è¯­è¨€éƒ½åŸºäºåŸºç¡€</description>
			<content type="html"><![CDATA[<blockquote>
<p><a href="https://github.com/cvvz/go-algorithm">æˆ‘çš„é¢˜åº“</a></p>
<p><a href="https://leetcode-cn.com/u/cvz">æˆ‘çš„leetcode</a></p>
</blockquote>
<h2 id="å¸¸è§æ•°æ®ç»“æ„">å¸¸è§æ•°æ®ç»“æ„</h2>
<h3 id="æ•°ç»„">æ•°ç»„</h3>
<p>æ•°ç»„çš„æ—¶é—´æ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯ç©ºé—´æ•ˆç‡å¾ˆä½ï¼Œè€Œä¸”ä¸å®‰å…¨ï¼Œæ¯”å¦‚è®¿é—®è¶Šç•Œé€ æˆè¸©å†…å­˜ã€‚</p>
<p>å¾ˆå¤šé«˜çº§è¯­è¨€éƒ½åŸºäºåŸºç¡€çš„æ•°ç»„å®ç°äº†<strong>åŠ¨æ€æ•°ç»„</strong>ï¼Œæ¯”å¦‚Javaä¸­çš„ArrayListã€C++ STLä¸­çš„vectorå’Œgolangä¸­çš„sliceï¼ŒåŠ¨æ€æ•°ç»„çš„ä¼˜åŠ¿åœ¨äºå¯ä»¥åŠ¨æ€æ‰©å®¹ï¼Œä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œ<strong>åœ¨å®ç°ç®—æ³•æ—¶æ›´åŠ handy</strong>ã€‚ä½†æ˜¯ç”±äºå°è£…äº†é¢å¤–çš„æ•°æ®è¿ç§»ç­‰æ“ä½œï¼Œæ—¶é—´æ•ˆç‡ä¸Šä¸å¦‚æ•°ç»„é«˜ã€‚</p>
<h3 id="é“¾è¡¨">é“¾è¡¨</h3>
<h3 id="å•é“¾è¡¨åŒé“¾è¡¨å¾ªç¯é“¾è¡¨">å•é“¾è¡¨ã€åŒé“¾è¡¨ã€å¾ªç¯é“¾è¡¨</h3>
<p>ğŸŒŸ<strong>æŠ€å·§ï¼šä½¿ç”¨å“¨å…µèŠ‚ç‚¹ç®€åŒ–æ’å…¥å’Œåˆ é™¤èŠ‚ç‚¹çš„é€»è¾‘ã€‚</strong></p>
<blockquote>
<p>æ‰€æœ‰é«˜çº§æ•°æ®ç»“æ„éƒ½æ˜¯åœ¨æ•°ç»„å’Œé“¾è¡¨çš„åŸºç¡€ä¸Šè¡ç”Ÿå‡ºæ¥çš„ã€‚</p>
</blockquote>
<h3 id="æ ˆå’Œé˜Ÿåˆ—">æ ˆå’Œé˜Ÿåˆ—</h3>
<p>â€œæ“ä½œå—é™â€çš„çº¿æ€§è¡¨ï¼Œåªæ”¯æŒä¸¤ç§åŸºæœ¬æ“ä½œï¼špush, popã€‚</p>
<p>é€’å½’çš„ç®—æ³•éƒ½å¯ä»¥ç”¨æ ˆæ¥å®ç°ã€‚</p>
<blockquote>
<p>é«˜æ€§èƒ½å®šæ—¶å™¨ï¼Œé™¤äº†å¯ä»¥ç”¨å †å®ç°ï¼ˆ<strong>æ¯”å¦‚golangçš„timerå°±æ˜¯ç”¨æœ€å°å››å‰å †</strong>ï¼‰ï¼Œè¿˜å¯ä»¥ç”¨<strong>ç¯å½¢é˜Ÿåˆ—</strong>ï¼Œè¯¦è§ <a href="https://zhuanlan.zhihu.com/p/65835110">æ—¶é—´è½®ç®—æ³• HashedWheelTimer</a> ã€<a href="http://russellluo.com/2018/10/golang-implementation-of-hierarchical-timing-wheels.html">å±‚çº§æ—¶é—´è½®çš„ Golang å®ç°</a></p>
</blockquote>
<h3 id="hashè¡¨">hashè¡¨</h3>
<p>é«˜çº§è¯­è¨€å†…ç½®äº†hashè¡¨ï¼Œæ¯”å¦‚Java ä¸­çš„ HashMapï¼Œgolangä¸­çš„mapæ•°æ®ç±»å‹ã€‚</p>
<blockquote>
<p><strong>Java JDKä¸­è‡ªå¸¦TreeMap</strong>ï¼Œå¯ä»¥æŒ‰ key è¿›è¡Œæ’åºã€‚</p>
<p>ä½†æ˜¯åœ¨ Go è¯­è¨€çš„â€œç®€çº¦è®¾è®¡â€é¢å‰ï¼Œè¿™äº›éƒ½æ˜¯ä¸å­˜åœ¨çš„â€”â€”Go åªæä¾›äº†æœ€åŸºç¡€çš„ hash mapã€‚å¹¶ä¸”ï¼Œåœ¨å€ŸåŠ© range å…³é”®å­—å¯¹ Go çš„ map è¿›è¡Œéå†è®¿é—®çš„æ—¶å€™ï¼Œä¼šå¯¹ map çš„ key çš„é¡ºåºåšéšæœºåŒ–å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿æ˜¯åŒä¸€ä¸ª map åœ¨åŒä¸€ä¸ªç¨‹åºé‡Œè¿›è¡Œä¸¤æ¬¡ç›¸åŒçš„éå†ï¼Œå‰åä¸¤è½®è®¿é—® key çš„é¡ºåºä¹Ÿæ˜¯éšæœºåŒ–çš„ã€‚(å¯ä»¥åœ¨<a href="https://go.dev/play/p/LYJSbQBjWa6">è¿™é‡Œ</a>è¿›è¡ŒéªŒè¯)ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ï¼Œæˆ–è€…å€ŸåŠ©å…¶ä»–å¼€æºè§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚<a href="https://github.com/emirpasic/gods">emirpasic/gods</a>ã€‚</p>
</blockquote>
<ol>
<li>
<p>hashè¡¨æ¥æºäº<strong>æ•°ç»„</strong>ï¼Œå€ŸåŠ©<strong>æ•£åˆ—å‡½æ•°</strong>å¯¹æ•°ç»„è¿™ç§æ•°æ®ç»“æ„è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå°±æ˜¯å°†keyæ˜ å°„ä¸ºæ•°ç»„ä¸‹æ ‡indexã€‚</p>
</li>
<li>
<p>å°†keyè½¬åŒ–ä¸ºæ•°ç»„ä¸‹æ ‡çš„æ–¹æ³•ç§°ä¸º<strong>æ•£åˆ—å‡½æ•°</strong>ï¼Œæ•£åˆ—å‡½æ•°çš„è®¡ç®—ç»“æœç§°ä¸º<strong>hashå€¼</strong>ã€‚æ•°æ®å­˜å‚¨åœ¨<strong>hashå€¼</strong>å¯¹åº”çš„<strong>æ•°ç»„ä¸‹æ ‡</strong>ä½ç½®ã€‚</p>
</li>
</ol>
<blockquote>
<p>å®ç°hashè¡¨æ‰€ä½¿ç”¨çš„hashç®—æ³•è¦æ±‚æ‰§è¡Œ<strong>é€Ÿåº¦å¿«</strong>ï¼Œå€¼æ˜¯å¦èƒ½<strong>å¹³å‡åˆ†å¸ƒ</strong>åœ¨å„ä¸ªæ§½ä¸­ï¼ˆæ¯”å¦‚ç®€å•çš„å–æ¨¡ç®—æ³•ï¼‰ã€‚å¹¶ä¸æ˜¯å¾ˆåœ¨ä¹<strong>å®‰å…¨æ€§</strong>ï¼ˆæ˜¯å¦èƒ½åå‘è§£å¯†å‡ºåŸå§‹æ•°æ®ï¼‰å’Œ<strong>hashå†²çª</strong>ï¼ˆå“ˆå¸Œå€¼ç›¸åŒï¼‰ã€‚æ‰€ä»¥ä¸ä¼šä½¿ç”¨<strong>åŠ å¯†ç”¨</strong>çš„å“ˆå¸Œç®—æ³•ã€‚</p>
<p>hashå‡½æ•°,æœ‰åŠ å¯†å‹å’ŒéåŠ å¯†å‹ã€‚åŠ å¯†å‹çš„ä¸€èˆ¬ç”¨äºåŠ å¯†æ•°æ®ã€æ•°å­—æ‘˜è¦ç­‰ï¼Œå…¸å‹ä»£è¡¨å°±æ˜¯md5ã€sha1ã€sha256ã€aes256 ã€‚éåŠ å¯†å‹çš„ä¸€èˆ¬å°±æ˜¯æŸ¥æ‰¾ã€‚</p>
</blockquote>
<h3 id="hashç®—æ³•">hashç®—æ³•</h3>
<p>hashç®—æ³•çš„åº”ç”¨ï¼š</p>
<ul>
<li><strong>hashè¡¨ä¸­çš„æ•£åˆ—å‡½æ•°ã€‚</strong></li>
<li><a href="https://time.geekbang.org/column/article/67388">åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨</a>ï¼š
<ol>
<li>è´Ÿè½½å‡è¡¡ï¼ˆ<strong>ä¸€è‡´æ€§å“ˆå¸Œ</strong>ï¼‰</li>
<li>æ•°æ®åˆ†ç‰‡ç­‰</li>
</ol>
</li>
<li>åŠ å¯†ã€éªŒè¯ï¼Œæ¯”å¦‚go modä½¿ç”¨go.sumæ–‡ä»¶æ¥éªŒè¯ä¾èµ–åº“æ˜¯å¦å‘ç”Ÿå˜åŒ–</li>
</ul>
<h3 id="æ ‘">æ ‘</h3>
<h4 id="äºŒå‰æ ‘">äºŒå‰æ ‘</h4>
<ul>
<li>äºŒå‰æ ‘çš„éå†ï¼š
<ul>
<li>å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼šå±‚åºéå†</li>
<li>æ·±åº¦ä¼˜å…ˆæœç´¢ï¼šå‰ä¸­ååºéå†ã€‚</li>
</ul>
<blockquote>
<p><strong>â€œå‰ä¸­åâ€æŒ‡çš„æ˜¯å½“å‰èŠ‚ç‚¹å’Œå·¦å³å­æ ‘è°å…ˆæ‰“å°</strong></p>
<p>æ·±åº¦æœç´¢å¯ä»¥ç”¨æ ˆæˆ–è€…é€’å½’ï¼Œé€’å½’ç®—æ³•å®ç°èµ·æ¥å¾ˆç®€å•ï¼›å¹¿åº¦æœç´¢åªèƒ½ç”¨é˜Ÿåˆ—ã€‚</p>
</blockquote>
</li>
<li>å®Œå…¨äºŒå‰æ ‘å’Œæ»¡äºŒå‰æ ‘ï¼š
<blockquote>
<p><strong>å®Œå…¨äºŒå‰æ ‘å¯ä»¥ç”¨æ•°ç»„å®ç°ï¼Œè€Œå †æ˜¯ä¸€ä¸ªå®Œå…¨äºŒå‰æ ‘ï¼Œå› æ­¤å †æ˜¯ç”¨æ•°ç»„å®ç°çš„</strong></p>
</blockquote>
</li>
<li>äºŒå‰æŸ¥æ‰¾æ ‘ï¼š
<blockquote>
<p><strong>ä¸­åºéå†äºŒå‰æŸ¥æ‰¾æ ‘å¯ä»¥å¾—åˆ°ä¸€ä¸ªæœ‰åºæ•°ç»„ï¼Œå’Œæœ‰åºæ•°ç»„çš„äºŒåˆ†æŸ¥ç±»ä¼¼</strong></p>
</blockquote>
</li>
<li>å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼šäºŒå‰æŸ¥æ‰¾æ ‘åœ¨é¢‘ç¹çš„åŠ¨æ€æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°æ ‘çš„é«˜åº¦è¿œå¤§äº log2n çš„æƒ…å†µï¼Œä»è€Œå¯¼è‡´å„ä¸ªæ“ä½œçš„æ•ˆç‡ä¸‹é™ã€‚<strong>æç«¯æƒ…å†µä¸‹ï¼Œä¼šé€€åŒ–ä¸ºé“¾è¡¨</strong>ï¼Œæ—¶é—´å¤æ‚åº¦ä¼šé€€åŒ–åˆ° O(n)ã€‚æ‰€ä»¥åˆå‘æ˜äº†<strong>å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘</strong>ã€‚
<blockquote>
<p>â€œå¹³è¡¡â€çš„æ„æ€ï¼Œå…¶å®å°±æ˜¯è®©æ•´æ£µæ ‘å·¦å³çœ‹èµ·æ¥æ¯”è¾ƒâ€œå¯¹ç§°â€ã€æ¯”è¾ƒâ€œå¹³è¡¡â€ï¼Œä¸è¦å‡ºç°å·¦å­æ ‘å¾ˆé«˜ã€å³å­æ ‘å¾ˆçŸ®çš„æƒ…å†µã€‚è¿™æ ·å°±èƒ½è®©æ•´æ£µæ ‘çš„é«˜åº¦ç›¸å¯¹æ¥è¯´ä½ä¸€äº›ï¼Œç›¸åº”çš„æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰æ“ä½œçš„æ•ˆç‡é«˜ä¸€äº›ã€‚</p>
</blockquote>
</li>
<li>çº¢é»‘æ ‘ï¼š<strong>çº¢é»‘æ ‘æ˜¯ä¸€ç§å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘</strong>ã€‚å®ƒæ˜¯ä¸ºäº†è§£å†³æ™®é€šäºŒå‰æŸ¥æ‰¾æ ‘åœ¨æ•°æ®æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œå¤æ‚åº¦é€€åŒ–çš„é—®é¢˜è€Œäº§ç”Ÿçš„ã€‚
<blockquote>
<p><strong>Javaä¸­çš„TreeMapå¯ä»¥å¯¹å“ˆå¸Œè¡¨çš„keyè¿›è¡Œæ’åºï¼Œåº•å±‚å°±ç”¨åˆ°äº†çº¢é»‘æ ‘</strong>ã€‚</p>
</blockquote>
</li>
</ul>
<h4 id="å †ä¼˜å…ˆçº§é˜Ÿåˆ—httpsleetcode-cncomtagheap-priority-queueproblemset"><a href="https://leetcode-cn.com/tag/heap-priority-queue/problemset/">å †/ä¼˜å…ˆçº§é˜Ÿåˆ—</a></h4>
<blockquote>
<p>æ€è€ƒï¼šä¸ºå•¥å †åˆå«åšä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Ÿ<strong>çœ‹èµ·æ¥å †ä¼¼ä¹æ˜¯ä¸€ä¸ªæ ‘ï¼Œè€Œé˜Ÿåˆ—æ˜¯æ•°ç»„ã€‚ä½†æ˜¯å®é™…ä¸Šå †æ˜¯ä¸€ä¸ªå®Œå…¨äºŒå‰æ ‘ï¼Œè€Œå®Œå…¨äºŒå‰æ ‘é€šå¸¸ç”¨æ•°ç»„è¡¨ç¤ºï¼Œæ‰€ä»¥å †ä¹Ÿæ˜¯ç”¨æ•°ç»„æ¥å­˜å‚¨çš„</strong>ã€‚</p>
</blockquote>
<p><strong>å †çš„æ ¸å¿ƒæ“ä½œï¼š</strong></p>
<ol>
<li>æ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼šå †åŒ–ï¼ˆheapifyï¼‰
<ol>
<li><strong>ä»ä¸Šå¾€ä¸‹<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/container/heap/heap.go;l=101-119">down</a></strong></li>
<li><strong>ä»ä¸‹å¾€ä¸Š<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/container/heap/heap.go;l=90-99">up</a></strong></li>
</ol>
</li>
<li>æ›¿æ¢å †é¡¶å…ƒç´ ï¼Œç„¶åä»ä¸Šå¾€ä¸‹å †åŒ–ï¼š<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/container/heap/heap.go;l=57-65">Pop</a></li>
<li>å‘å †å°¾æ·»åŠ å…ƒç´ ï¼š<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/container/heap/heap.go;l=50-55">Push</a>ï¼Œå¹¶è¿›è¡Œä»ä¸‹å¾€ä¸Šå †åŒ–</li>
<li>å»ºå †ï¼š<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/container/heap/heap.go;l=42-48">Init</a></li>
</ol>
<p><a href="https://time.geekbang.org/column/article/70187"><strong>å †çš„åº”ç”¨</strong></a>:</p>
<ol>
<li>é«˜æ€§èƒ½å®šæ—¶å™¨
<blockquote>
<p>golangå®˜æ–¹åº“Timerçš„å®ç°ï¼Œå’Œinformerä¸­çš„å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°éƒ½ç”¨åˆ°äº†å †</p>
</blockquote>
</li>
<li><a href="https://leetcode-cn.com/problems/find-median-from-data-stream/">æ•°æ®æµçš„ä¸­ä½æ•°</a>ã€99çº¿é—®é¢˜</li>
<li>TopKé—®é¢˜
<ol>
<li><a href="https://leetcode-cn.com/problems/kth-largest-element-in-an-array/">é™æ€topK</a></li>
<li><a href="https://leetcode-cn.com/problems/kth-largest-element-in-a-stream/">åŠ¨æ€topK</a></li>
</ol>
<blockquote>
<p><strong>å¯¹äºé™æ€topKçš„é—®é¢˜ï¼Œå¦‚æœæ•°æ®é‡èƒ½å¤Ÿç›´æ¥åŠ è½½è¿›å†…å­˜ï¼Œé‚£ä¹ˆç”¨å¿«é€Ÿæ’åºæ€æƒ³æ±‚è§£ä¼šæ›´å¿«</strong></p>
<p><strong>ä½†å¯¹äºåŠ¨æ€topKçš„é—®é¢˜ï¼Œå°±åªèƒ½ä½¿ç”¨å †æ¥è§£å†³äº†ï¼Œå› ä¸ºè¦é€šè¿‡ç½‘ç»œ/ç£ç›˜IOæ„é€ æµæ•°æ®</strong></p>
</blockquote>
</li>
</ol>
<h3 id="å›¾">å›¾</h3>
<p><strong>æ•°æ®ç»“æ„ï¼ˆå­˜å‚¨æ–¹æ³•ï¼‰</strong>ï¼šé‚»æ¥çŸ©é˜µï¼ˆäºŒä½æ•°ç»„ï¼‰ å’Œ é‚»æ¥è¡¨</p>
<ul>
<li><strong>é‚»æ¥çŸ©é˜µ</strong>
<blockquote>
<p><strong>ä¸€èˆ¬å›¾çš„BFSã€DFSï¼Œæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰æ‹“æ‰‘æ’åºç®—æ³•ï¼Œä»¥é‚»æ¥çŸ©é˜µï¼ˆäºŒç»´æ•°ç»„ï¼‰çš„å½¢å¼è€ƒå¯Ÿçš„æ¯”è¾ƒçš„å¤šã€‚è€Œæ ‘å‹ç»“æ„ï¼ˆé“¾è¡¨ï¼‰ä¸€èˆ¬ç”¨äºŒå‰æ ‘çš„BFSå’ŒDFSæ¥è€ƒå¯Ÿã€‚</strong></p>
</blockquote>
</li>
<li>é‚»æ¥è¡¨</li>
</ul>
<h2 id="å¸¸è§ç®—æ³•">å¸¸è§ç®—æ³•</h2>
<h3 id="æ’åº">æ’åº</h3>
<p><strong>å†’æ³¡æ’åºã€æ’å…¥æ’åºã€é€‰æ‹©æ’åº</strong>ï¼šä¸‰ç§O(n2)çš„<strong>ç®€å•æ— è„‘çš„</strong>ç®—æ³•ï¼Œæ•°æ®é‡ä¸å¤§æ—¶å¯ä»¥ç”¨ä¸€ç”¨ã€‚</p>
<p><strong>å½’å¹¶æ’åº</strong>ï¼šä¸æ–­äºŒåˆ†ï¼Œé€’å½’ä¸‹å»ï¼Œç„¶åâ€œ<strong>ä»ä¸‹å¾€ä¸Š</strong>â€mergeã€‚ç”±äºè¿™ä¸ªmergeæ— æ³•åŸåœ°æ‰§è¡Œï¼Œå› æ­¤ç©ºé—´å¤æ‚åº¦ä¸ºO(n)ã€‚</p>
<blockquote>
<p>è™½ç„¶å½’å¹¶æ’åºç”¨åˆ°äº†é€’å½’ï¼Œä½†æ˜¯ç©ºé—´å¤æ‚åº¦ä¸æ˜¯O(n2)ï¼Œå› ä¸ºæ¯æ¬¡mergeæ—¶ï¼Œä¸‹é¢é‚£ä¸€å±‚çš„å†…å­˜å°±è¢«é‡Šæ”¾æ‰äº†ã€‚</p>
<p>å½’å¹¶æ’åºæ˜¯stableçš„ï¼Œæ‰€ä»¥<strong>golangçš„<a href="https://github.com/golang/go/blob/master/src/sort/sort.go#L378-L404">sort.Stable</a>ä½¿ç”¨å½’å¹¶æ’åºå®ç°</strong>ã€‚</p>
</blockquote>
<p><strong>å¿«é€Ÿæ’åº</strong>ï¼šé€‰æ‹©ä¸€ä¸ªpivotï¼Œç„¶åâ€œ<strong>ä»ä¸Šå¾€ä¸‹</strong>â€ä¸æ–­è¿›è¡Œ<strong>åŸåœ°çš„</strong>partitionæ“ä½œï¼Œç”±äºpartitionæ˜¯åŸåœ°çš„ï¼Œå› æ­¤ç©ºé—´å¤æ‚åº¦ä¸ºO(1)ã€‚</p>
<blockquote>
<p><strong>å¿«é€Ÿæ’åºçš„å…³é”®æ˜¯åŸåœ°partition</strong>
å› ä¸ºå¿«é€Ÿæ’åºä¼˜åŒ–äº†å†…å­˜ä½¿ç”¨ï¼Œæ‰€ä»¥åº”ç”¨æ¯”å½’å¹¶æ’åºè¦å¹¿æ³›ã€‚ä½†æ˜¯å¿«é€Ÿæ’åºåœ¨æœ€åæƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n2)ï¼Œ<strong>éœ€è¦è§£å†³è¿™ä¸ªâ€œå¤æ‚åº¦æ¶åŒ–â€çš„é—®é¢˜</strong>ã€‚è¿™ä¸ªé—®é¢˜çš„æ ¹å› è¿˜æ˜¯æˆ‘ä»¬é€‰æ‹©çš„åˆ†åŒºç‚¹ï¼ˆpivotï¼‰ä¸åˆç†å¯¼è‡´çš„ï¼Œç†æƒ³çš„åˆ†åŒºç‚¹åº”è¯¥æ˜¯å·¦å³ä¸¤è¾¹çš„æ•°æ®é‡å·®ä¸å¤šï¼Œæœ€å¥½èƒ½äºŒåˆ†ï¼Œè¿™æ ·é€’å½’çš„å±‚æ¬¡å°±æœ€å°‘ã€‚pivotçš„é€‰æ‹©æ–¹æ³•æœ€å¸¸è§çš„æœ‰ä¸¤ç§ï¼š</p>
</blockquote>
<ol>
<li>ä¸‰æ•°å–ä¸­æ³•ï¼šé€‰æ‹©ä¸‰ä¸ªæˆ–è€…æ›´å¤šçš„æ•°ï¼Œé€‰æ‹©ä»–ä»¬çš„ä¸­é—´å€¼ä½œä¸ºpivotã€‚</li>
<li>éšæœºæ³•ï¼šä»æ¦‚ç‡ä¸Šè¯´ä¸ä¼šä¸€ç›´é€‰çš„éƒ½æ˜¯æœ€å·®çš„ç‚¹ä½œä¸ºpivotã€‚</li>
</ol>
<p><strong>å½’å¹¶æ’åº</strong>å’Œ<strong>å¿«é€Ÿæ’åº</strong>éƒ½ç”¨åˆ°äº†<strong>åˆ†æ²»</strong>æ€æƒ³ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å€Ÿé‰´å¿«æ’çš„æ€æƒ³ï¼Œæ¥è§£å†³éæ’åºçš„é—®é¢˜ï¼Œæ¯”å¦‚ç”¨O(n)çš„æ—¶é—´å¤æ‚åº¦è§£å†³<a href="https://leetcode-cn.com/problems/kth-largest-element-in-an-array/">é™æ€topK</a>é—®é¢˜ã€‚</p>
<p><strong>å †æ’åº</strong>ï¼š<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/sort/sort.go;l=66-81">heapSort</a></p>
<ol>
<li>å»ºå †ï¼š
<ol>
<li>æ–¹æ³•ä¸€ï¼š<strong>ä»ç¬¬ä¸€ä¸ªéå¶å­ç»“ç‚¹å¼€å§‹</strong>ï¼Œä¾æ¬¡æ‰§è¡Œä»ä¸Šå¾€ä¸‹å †åŒ–ï¼Œå³<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/container/heap/heap.go;l=42-48">Init</a></li>
<li>æ–¹æ³•äºŒï¼šä¸æ–­å…¥é˜Ÿï¼Œå¹¶å¯¹æ–°å…¥é˜ŸèŠ‚ç‚¹æ‰§è¡Œä»ä¸‹å¾€ä¸Šå †åŒ–ï¼Œå³<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/container/heap/heap.go;l=50-55">Push</a></li>
</ol>
</li>
<li>è°ƒæ•´ï¼šäº¤æ¢å †é¡¶å’Œå †å°¾å…ƒç´ ï¼Œå †å°¾å…ƒç´ å‡ºé˜Ÿï¼Œä»ä¸Šå¾€ä¸‹é‡æ–°å †åŒ–ï¼Œå³<a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17.5:src/container/heap/heap.go;l=57-65">Pop</a></li>
</ol>
<h3 id="æœç´¢">æœç´¢</h3>
<p><strong>å¹¿åº¦ä¼˜å…ˆæœç´¢å’Œæ·±åº¦ä¼˜å…ˆæœç´¢</strong>åœ¨ç®—æ³•é¢è¯•ä¸­éƒ½æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>æŒæ¡BFSå’ŒDFSæ˜¯åŸºç¡€è¦æ±‚</strong>ï¼Œå¾ˆå¤šæ—¶å€™<strong>ä½¿ç”¨ä»»æ„ä¸€ç§</strong>æœç´¢ç®—æ³•å°±èƒ½è§£å†³æŸäº›ä¸å›¾ç›¸å…³çš„é¢è¯•é¢˜ã€‚</p>
<p>å¦‚æœé¢è¯•é¢˜è¦æ±‚åœ¨æ— æƒå›¾ä¸­æ‰¾å‡ºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æœ€çŸ­è·ç¦»ï¼Œé‚£ä¹ˆå¹¿åº¦ä¼˜å…ˆæœç´¢å¯èƒ½æ˜¯æ›´åˆé€‚çš„ç®—æ³•ã€‚
å¦‚æœé¢è¯•é¢˜è¦æ±‚æ‰¾å‡ºç¬¦åˆæ¡ä»¶çš„è·¯å¾„ï¼Œé‚£ä¹ˆæ·±åº¦ä¼˜å…ˆæœç´¢å¯èƒ½æ˜¯æ›´åˆé€‚çš„ç®—æ³•ã€‚</p>
<h3 id="äºŒåˆ†æŸ¥æ‰¾">äºŒåˆ†æŸ¥æ‰¾</h3>
<p>æ¯”è¾ƒç®€å•</p>
<h2 id="åŸºæœ¬ç®—æ³•æ€æƒ³">åŸºæœ¬ç®—æ³•æ€æƒ³</h2>
<h3 id="è´ªå¿ƒhttpsleetcode-cncomtaggreedyproblemset"><a href="https://leetcode-cn.com/tag/greedy/problemset/">è´ªå¿ƒ</a></h3>
<blockquote>
<p>ä¸¥æ ¼åœ°è¯æ˜è´ªå¿ƒç®—æ³•çš„æ­£ç¡®æ€§ï¼Œæ˜¯éå¸¸å¤æ‚çš„ï¼Œéœ€è¦æ¶‰åŠæ¯”è¾ƒå¤šçš„æ•°å­¦æ¨ç†ã€‚è€Œä¸”ï¼Œä»å®è·µçš„è§’åº¦æ¥è¯´ï¼Œå¤§éƒ¨åˆ†èƒ½ç”¨è´ªå¿ƒç®—æ³•è§£å†³çš„é—®é¢˜ï¼Œè´ªå¿ƒç®—æ³•çš„æ­£ç¡®æ€§éƒ½æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä¹Ÿä¸éœ€è¦ä¸¥æ ¼çš„æ•°å­¦æ¨å¯¼è¯æ˜ã€‚</p>
</blockquote>
<h3 id="åˆ†æ²»httpsleetcode-cncomtagdivide-and-conquerproblemset"><a href="https://leetcode-cn.com/tag/divide-and-conquer/problemset/">åˆ†æ²»</a></h3>
<blockquote>
<p>åˆ†æ²»ç»å¸¸ç”¨åœ¨æµ·é‡æ•°æ®å¤„ç†çš„åœºæ™¯ä¸‹ï¼Œå†…å­˜æ— æ³•ç›´æ¥è£…è½½å…¨éƒ¨æ•°æ®ï¼Œå°±å°†æ•°æ®åˆ†æ‰¹è£…è½½è¿›å†…å­˜å¤„ç†ï¼Œå†å°†ç»“æœè¿›è¡Œåˆå¹¶ã€‚ï¼ˆç»™1TBçš„è®¢å•æ’åºï¼‰</p>
<p><strong>è¦åˆ¤æ–­æ¸…æ¥šæ•°æ®è§„æ¨¡æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥è£…è½½è¿›å†…å­˜</strong>ï¼Œæ¯”å¦‚è·å–10äº¿ä¸ªæ•´æ•°ç¬¬kå¤§çš„æ•°ï¼š10äº¿ä¸ªæ•´æ•° = 80äº¿Byte( int=64bit ) â‰ˆï¼ˆä¸è¶³ï¼‰8GBï¼Œè¿™ä¸ªæ—¶å€™è¦è€ƒè™‘å•æœºçš„å®é™…å¯ç”¨å†…å­˜å¤§å°æ˜¯å¦å¯ä»¥ç›´æ¥è£…è½½8GBã€‚å¦‚æœèƒ½ç›´æ¥è£…è¿›å»ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨å¿«æ’æ€æƒ³åšï¼›å¦‚æœä¸èƒ½ç›´æ¥è£…è¿›å»ï¼Œé‚£ä¹ˆæ„é€ å¤§å°ä¸ºkçš„å †ï¼Œç„¶åä»æ–‡ä»¶è¯»æ•°æ®è¿›è¡Œå¤„ç†ã€‚
è¿˜æœ‰çš„æ—¶å€™å¦‚æœæ–‡ä»¶å¤ªå¤§ï¼Œé‚£ä¹ˆéœ€è¦è¿›è¡Œ<strong>æ•°æ®åˆ†ç‰‡</strong>ï¼Œåˆ†æˆè‹¥å¹²ä¸ªå°æ–‡ä»¶ä»¥åï¼Œå†åˆ†è€Œæ²»ä¹‹ï¼Œå³é€ä¸ªå¤„ç†å¯ä»¥ç›´æ¥è½½å…¥å†…å­˜çš„å°æ–‡ä»¶ï¼Œæœ€ååˆå¹¶å¾—åˆ°ç»“æœã€‚</p>
</blockquote>
<h3 id="å›æº¯httpsleetcode-cncomtagbacktrackingproblemset"><a href="https://leetcode-cn.com/tag/backtracking/problemset/">å›æº¯</a></h3>
<blockquote>
<p>é€šå¸¸<strong>é€’å½’å®ç°</strong>ã€‚DFSåˆ©ç”¨çš„å°±æ˜¯å›æº¯ç®—æ³•æ€æƒ³ã€‚</p>
</blockquote>
<h3 id="åŠ¨æ€è§„åˆ’httpsleetcode-cncomtagdynamic-programmingproblemset"><a href="https://leetcode-cn.com/tag/dynamic-programming/problemset/">åŠ¨æ€è§„åˆ’</a></h3>
<blockquote>
<p>dpçš„ä¸»è¦å­¦ä¹ éš¾ç‚¹è·Ÿé€’å½’ç±»ä¼¼ï¼Œé‚£å°±æ˜¯ï¼Œæ±‚è§£é—®é¢˜çš„è¿‡ç¨‹ä¸å¤ªç¬¦åˆäººç±»å¸¸è§„çš„çº¿æ€§æ€ç»´æ–¹å¼ã€‚</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>é‡å­¦è®¾è®¡æ¨¡å¼</title>
			<link>https://cvvz.fun/post/design-pattern/</link>
			<pubDate>Sun, 18 Jul 2021 20:40:19 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/design-pattern/</guid>
			<description>è®¾è®¡æ¨¡å¼å’Œè®¾è®¡åŸåˆ™çš„åˆç†åº”ç”¨éå¸¸ä¾èµ–ä¸ªäººç»éªŒï¼Œç”¨ä¸å¥½æœ‰æ—¶å€™ä¼šé€‚å¾—å…¶åã€‚å­¦ç”Ÿæ—¶ä»£æ—¶å­¦ä¹ è®¾è®¡æ¨¡å¼è§‰å¾—æ¯ç‡¥ï¼Œæ˜¯å› ä¸ºæ²¡æœ‰å®è·µç»éªŒã€‚è¦å¤šå®è·µï¼Œç„¶åå†æ¸©</description>
			<content type="html"><![CDATA[<blockquote>
<p>è®¾è®¡æ¨¡å¼å’Œè®¾è®¡åŸåˆ™çš„åˆç†åº”ç”¨éå¸¸ä¾èµ–ä¸ªäººç»éªŒï¼Œç”¨ä¸å¥½æœ‰æ—¶å€™ä¼šé€‚å¾—å…¶åã€‚å­¦ç”Ÿæ—¶ä»£æ—¶å­¦ä¹ è®¾è®¡æ¨¡å¼è§‰å¾—æ¯ç‡¥ï¼Œæ˜¯å› ä¸ºæ²¡æœ‰å®è·µç»éªŒã€‚è¦å¤šå®è·µï¼Œç„¶åå†æ¸©æ•…çŸ¥æ–°ã€‚</p>
</blockquote>
<h2 id="ä¸ºä»€ä¹ˆè¦å­¦è®¾è®¡æ¨¡å¼è®¾è®¡åŸåˆ™">ä¸ºä»€ä¹ˆè¦å­¦è®¾è®¡æ¨¡å¼/è®¾è®¡åŸåˆ™ï¼Ÿ</h2>
<ol>
<li>åœ¨ç»å…¸çš„å¼€æºè½¯ä»¶åº“ã€æ¡†æ¶ä¸­ï¼Œå¤§é‡ä½¿ç”¨äº†è®¾è®¡æ¨¡å¼ï¼Œ<strong>ä¸æ‡‚è®¾è®¡æ¨¡å¼å¾ˆéš¾çœ‹æ‡‚å¼€æºä»£ç </strong>ï¼å³ä½¿çœ‹æ‡‚äº†ä¹Ÿæ— æ³•é¢†ä¼šå…¶ä¸­çš„ç²¾é«“ã€‚æ›´åˆ«è¯´è‡ªå·±å»åˆ›é€ ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚</li>
<li>ä¸€äº›è®¾è®¡æ¨¡å¼ä¼šä½¿å¾—ä»£ç å˜å¾—<strong>ä¸ç›´è§‚</strong>ï¼Œ<strong>å¯è¯»æ€§å˜å·®</strong>ï¼Œä½†æ˜¯å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§æ›´å¼ºäº†ã€‚èƒ½å†™å‡ºç›´è§‚çš„ä»£ç çš„äººå¾ˆå¤šï¼Œä½†èƒ½å†™å‡ºâ€œå¤æ‚â€ä»£ç ï¼ˆ<strong>æŒ‡å¼•å…¥äº†è®¾è®¡æ¨¡å¼ï¼Œè€Œä¸æ˜¯æŒ‡å¤æ‚çš„ä¸šåŠ¡é€»è¾‘</strong>ï¼‰çš„äººå¾ˆå°‘ã€‚
<blockquote>
<p>è®¾è®¡æ¨¡å¼/SOLIDè®¾è®¡åŸåˆ™æ˜¯è§£å†³ä»£ç çš„æ‰©å±•æ€§é—®é¢˜ï¼ŒKISSè®¾è®¡åŸåˆ™æ˜¯è§£å†³ä»£ç çš„å¯è¯»æ€§é—®é¢˜ã€‚</p>
</blockquote>
</li>
<li>æœ‰èƒ½åŠ›å»åš<strong>æŒç»­é‡æ„</strong>ã€‚åˆçº§å·¥ç¨‹å¸ˆåœ¨ç»´æŠ¤ä»£ç ï¼Œé«˜çº§å·¥ç¨‹å¸ˆåœ¨è®¾è®¡ä»£ç ï¼Œèµ„æ·±å·¥ç¨‹å¸ˆåœ¨é‡æ„ä»£ç </li>
</ol>
<h2 id="é¢å‘å¯¹è±¡å’Œgolang">é¢å‘å¯¹è±¡å’Œgolang</h2>
<blockquote>
<p><strong>é¢å‘å¯¹è±¡åˆ†æã€è®¾è®¡</strong>ï¼šç¨‹åºè¢«æ‹†è§£ä¸ºå“ªäº›ç±»ã€ç±»é‡Œé¢æœ‰å“ªäº›æ–¹æ³•ï¼ˆ<strong>golangçš„interface</strong>ï¼‰å’Œå±æ€§ï¼ˆ<strong>golangçš„struct</strong>ï¼‰ã€ç±»å’Œç±»ä¹‹é—´å¦‚ä½•äº¤äº’ï¼ˆ<strong>golangé‡Œåº”è¯¥ä½¿ç”¨æ¥å£è¿›è¡Œäº¤äº’</strong>ï¼‰ã€‚</p>
<p><strong>é¢å‘å¯¹è±¡ç¼–ç¨‹</strong>ï¼šæŠŠè®¾è®¡ç¿»è¯‘æˆä»£ç ã€‚</p>
</blockquote>
<h3 id="å°è£…encapsulation">å°è£…ï¼ˆEncapsulationï¼‰</h3>
<p>å°è£…ä¹Ÿå«ä½œ<strong>ä¿¡æ¯éšè—</strong>æˆ–è€…<strong>æ•°æ®è®¿é—®ä¿æŠ¤</strong>ï¼šä»…<strong>æš´éœ²æœ‰é™çš„æ–¹æ³•ï¼Œå¹¶ä¸”é™åˆ¶ç±»ä¸­çš„éƒ¨åˆ†å±æ€§çš„è®¿é—®æƒé™ã€‚</strong></p>
<p>æ¯”å¦‚å°†å±æ€§è®¾ç½®ä¸ºprivateï¼Œé¿å…ç›´æ¥ä¿®æ”¹å¯¹è±¡å±æ€§ï¼›åªæä¾›éƒ¨åˆ†å±æ€§çš„getã€setæ–¹æ³•ï¼Œå¯¹äºä¸å¯å˜æ›´çš„å±æ€§ï¼Œå¦‚idï¼Œä¸æä¾›ä»»ä½•è®¿é—®æˆ–ä¿®æ”¹æ–¹æ³•ã€‚</p>
<blockquote>
<p><strong>golangä¸­ï¼Œstructä¸­å¤§å†™å­—æ¯å¼€å¤´çš„å­—æ®µç›¸å½“äºpublicï¼Œå°å†™å­—æ¯å¼€å¤´çš„å­—æ®µç›¸å½“äºprivateã€‚</strong></p>
</blockquote>
<h3 id="æŠ½è±¡abstraction">æŠ½è±¡ï¼ˆAbstractionï¼‰</h3>
<p>å°è£…çš„ä¸»è¦ç›®çš„æ˜¯éšè—æ•°æ®ï¼Œè€ŒæŠ½è±¡çš„ç›®çš„æ˜¯<strong>éšè—æ–¹æ³•çš„å…·ä½“å®ç°</strong>ã€‚</p>
<p>å‡½æ•°å°±å¯ä»¥çœ‹æˆæ˜¯ä¸€ç§æŠ½è±¡ï¼Œå³ä½¿ç”¨è€…æ— éœ€å…³æ³¨åº•å±‚å®ç°ï¼Œåªéœ€è¦é€šè¿‡æ³¨é‡Šã€æ–‡æ¡£ç­‰çŸ¥é“è¿™ä¸ªæ¥å£/å‡½æ•°æ˜¯å¹²å•¥çš„ã€æ€ä¹ˆç”¨å°±è¡Œäº†ã€‚å…¶å®å°±æ˜¯å¸®åŠ©å¤§è„‘è¿‡æ»¤éå¿…è¦ä¿¡æ¯ï¼Œè®©æˆ‘ä»¬åªå…³æ³¨åŠŸèƒ½ç‚¹ã€‚</p>
<p>å¯ä»¥çœ‹å‡ºæ¥æŠ½è±¡æ˜¯ä¸€ä¸ªéå¸¸é€šç”¨çš„è®¾è®¡æ€æƒ³ï¼Œå¹¶éé¢å‘å¯¹è±¡è®¾è®¡ç‰¹æœ‰ã€‚<strong>æ‰€ä»¥æŠ½è±¡æœ‰çš„æ—¶å€™ä¼šè¢«æ’é™¤åœ¨é¢å‘å¯¹è±¡çš„å››å¤§ç‰¹æ€§ä¹‹å¤–ã€‚</strong></p>
<h3 id="ç»§æ‰¿inheritance">ç»§æ‰¿ï¼ˆInheritanceï¼‰</h3>
<p><strong>ç»§æ‰¿æœ€å¤§çš„å¥½å¤„æ˜¯ä»£ç å¤ç”¨ã€‚</strong></p>
<blockquote>
<p>ä»£ç å¤ç”¨çš„é—®é¢˜ä¹Ÿå¯ä»¥åˆ©ç”¨ç»„åˆæ¥è§£å†³ã€‚<strong>golangå°±æ˜¯åˆ©ç”¨ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿æ¥å®ç°ä»£ç å¤ç”¨</strong>ã€‚</p>
<p>é€šè¿‡ç»„åˆåŒ¿åæ¥å£æˆ–è€…åŒ¿åstructï¼Œè¿˜å¯ä»¥è¿›è¡Œâ€œè¦†ç›–â€ï¼ˆå…¶å®ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„è¦†ç›–ï¼‰ã€‚</p>
</blockquote>
<h3 id="å¤šæ€polymorphism">å¤šæ€ï¼ˆPolymorphismï¼‰</h3>
<p>å¤šæ€æ˜¯æŒ‡ï¼Œå­ç±»å¯ä»¥æ›¿æ¢çˆ¶ç±»ã€‚åˆ©ç”¨ç»§æ‰¿+è¦†ç›–å®ç°ã€‚</p>
<blockquote>
<p>åœ¨golangä¸­ï¼Œé€šè¿‡æ¥å£æ¥å®ç°å¤šæ€ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»ä½•å®ç°äº†æ¥å£çš„å¯¹è±¡éƒ½èƒ½å½“å‚æ•°ä¼ å…¥ã€‚è€Œgolangæœ¬èº«æ˜¯æ”¯æŒduck typeè¯­æ³•çš„ï¼Œæ‰€ä»¥è¿™äº›å¯¹è±¡ä¹‹é—´å¯ä»¥æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚</p>
</blockquote>
<h2 id="è®¾è®¡åŸåˆ™">è®¾è®¡åŸåˆ™</h2>
<blockquote>
<p>åŒæ—¶è¿™ä¹Ÿæ˜¯ Code Review çš„é‡è¦æ ‡å‡†ä¹‹ä¸€</p>
</blockquote>
<ol>
<li>
<p>é’ˆå¯¹æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é’ˆå¯¹å®ç°ç¼–ç¨‹ã€‚</p>
<blockquote>
<p>åœ¨golangé‡Œï¼Œå³ä½¿ä¸€ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œä¹Ÿè¦ç”¨æ¥å£ï¼Œè€Œä¸è¦æ“ä½œå…·ä½“ç±»ï¼Œå› ä¸ºè¦ä¸ºåç»­çš„å¯æ‰©å±•æ€§åšå¥½å‡†å¤‡ï¼›</p>
</blockquote>
</li>
<li>
<p>å¤šç”¨ç»„åˆï¼Œå°‘ç”¨ç»§æ‰¿ï¼›æ¢å¥è¯è¯´ï¼Œâ€œhas-aâ€ï¼Œæ¯”â€œis-aâ€æ›´å¥½ã€‚å› ä¸ºç»§æ‰¿å¯èƒ½å¯¼è‡´å±‚æ¬¡è¿‡æ·±çš„é—®é¢˜ã€‚</p>
<blockquote>
<p>golangæ²¡æœ‰ç»§æ‰¿çš„æ¦‚å¿µï¼Œé€šè¿‡ç»„åˆå¤šä¸ªå°æ¥å£æ¥å®ç°ä¸€ä¸ªæ›´å¤§çš„æ¥å£ï¼›</p>
<p>ä½¿ç”¨åŒ¿åæ¥å£/åŒ¿åç»“æ„ä½“å¯ä»¥è¾¾åˆ°<strong>ç±»ä¼¼ç»§æ‰¿</strong>çš„æ•ˆæœï¼Œä½†è¿™ä¸æ˜¯ç»§æ‰¿ã€‚</p>
</blockquote>
</li>
<li>
<p>SOLIDï¼š</p>
<ol>
<li>å•ä¸€èŒè´£åŸåˆ™ï¼šä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä»¶äº‹æƒ…ã€‚ä¸ºäº†èƒ½åšåˆ°å•ä¸€èŒè´£ï¼Œåº”è¯¥è¿›è¡Œ<strong>æŒç»­é‡æ„</strong>ã€‚</li>
<li>å¼€é—­åŸåˆ™ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚<strong>å¼€é—­åŸåˆ™è®²çš„å°±æ˜¯ä»£ç çš„æ‰©å±•æ€§é—®é¢˜</strong>ã€‚åœ¨23ç§ç»å…¸è®¾è®¡æ¨¡å¼ä¸­ï¼Œå¤§éƒ¨åˆ†è®¾è®¡æ¨¡å¼éƒ½æ˜¯ä¸ºäº†è§£å†³ä»£ç çš„<strong>æ‰©å±•æ€§</strong>é—®é¢˜è€Œå­˜åœ¨çš„ï¼Œä¸»è¦éµä»çš„è®¾è®¡åŸåˆ™å°±æ˜¯å¼€é—­åŸåˆ™ã€‚åªè¦å®ƒ<strong>æ²¡æœ‰ç ´ååŸæœ‰çš„ä»£ç çš„æ­£å¸¸è¿è¡Œï¼Œæ²¡æœ‰ç ´ååŸæœ‰çš„å•å…ƒæµ‹è¯•</strong>ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæ ¼çš„ä»£ç æ”¹åŠ¨ã€‚</li>
<li>é‡Œæ°æ›¿æ¢åŸåˆ™ï¼šæŒ‰ç…§â€œåè®®â€æ¥è®¾è®¡å­ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>å­ç±»åœ¨è¦†ç›–çˆ¶ç±»çš„æ–¹æ³•çš„æ—¶å€™ï¼Œä¸è¦è¿èƒŒçˆ¶ç±»å¯¹æŸä¸ªæ–¹æ³•çš„â€œçº¦å®šâ€</strong>ï¼Œè¿™æ ·ï¼Œå½“ä»£ç é‡Œç”¨åˆ°çˆ¶ç±»çš„åœ°æ–¹ï¼Œæ‰<strong>çœŸæ­£çš„</strong>å¯ä»¥ç”¨å­ç±»å»è¿›è¡Œæ›¿æ¢ï¼Œè€Œä¸ä¼šå¼•å‘é—®é¢˜ï¼ˆè¿™é‡Œè¦åŒºåˆ†å®ƒå’Œå¤šæ€çš„åŒºåˆ«ï¼‰ã€‚åˆ¤æ–­å­ç±»çš„è®¾è®¡å®ç°æ˜¯å¦è¿èƒŒé‡Œå¼æ›¿æ¢åŸåˆ™ï¼Œæœ‰ä¸€ä¸ªå°çªé—¨ï¼Œ<strong>é‚£å°±æ˜¯æ‹¿çˆ¶ç±»çš„å•å…ƒæµ‹è¯•å»éªŒè¯å­ç±»çš„ä»£ç ã€‚å¦‚æœæŸäº›å•å…ƒæµ‹è¯•è¿è¡Œå¤±è´¥ï¼Œå°±æœ‰å¯èƒ½è¯´æ˜ï¼Œå­ç±»çš„è®¾è®¡å®ç°æ²¡æœ‰å®Œå…¨åœ°éµå®ˆçˆ¶ç±»çš„çº¦å®šï¼Œå­ç±»æœ‰å¯èƒ½è¿èƒŒäº†é‡Œå¼æ›¿æ¢åŸåˆ™ã€‚</strong></li>
<li>æ¥å£éš”ç¦»åŸåˆ™ï¼šä¸åº”è¯¥è®©è°ƒç”¨æ–¹çœ‹åˆ°ä»–ä¸å…³å¿ƒ/ä¸åº”è¯¥è°ƒç”¨çš„æ¥å£ã€‚<strong>åœ¨golangä¸­ï¼Œæå€¡è®¾è®¡å°æ¥å£ï¼Œå¹¶å°†å°æ¥å£ç»„åˆæˆå¤§çš„æ¥å£ã€‚</strong></li>
<li>ä¾èµ–åè½¬åŸåˆ™ï¼šç”¨æ¥æŒ‡å¯¼æ¡†æ¶å±‚é¢çš„è®¾è®¡ï¼Œè€Œä¸æ˜¯ä¸šåŠ¡ä»£ç å¼€å‘ã€‚é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼ŒäºŒè€…ä¸­é—´é€šè¿‡æ¥å£æŠ½è±¡è¿›è¡Œè¿æ¥ï¼Œä½å±‚æ¨¡å—ä¾èµ–æ¥å£æŠ½è±¡å±‚ã€‚<strong>æ¯”å¦‚webæœåŠ¡å™¨ &lt;-&gt; gunicorn &lt;-&gt; webæ¡†æ¶</strong>ã€‚</li>
</ol>
</li>
<li>
<p>KISSå’ŒYAGNI</p>
<p>KISSå’ŒYAGNIåŸåˆ™ç”¨æ¥ä¿æŒä»£ç çš„<strong>å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§</strong>ã€‚ä½†æ˜¯å¯è¯»æ€§å¾ˆå¤šæ—¶å€™å’Œ<strong>å¯æ‰©å±•æ€§</strong>äº’ç›¸çŸ›ç›¾ã€‚è¿‡åº¦å¼•å…¥è®¾è®¡æ¨¡å¼ä¼šå¯¼è‡´å¯è¯»æ€§é™ä½ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œæƒè¡¡ã€‚</p>
<p>æ­¤å¤–ï¼Œå®è·µKISSåŸåˆ™æ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šå’Œ<strong>æ€§èƒ½</strong>ç›¸äº’å†²çªï¼ˆæ¯”å¦‚ç›´æ¥å¼•ç”¨ç°æˆçš„ä¸‰æ–¹åº“ä¸­çš„é€šç”¨æ¥å£å’Œè‡ªå·±æ¥å®ç°ä¸€ç§æ›´é«˜æ•ˆçš„ç®—æ³•ï¼‰ã€‚ä½†æ˜¯ï¼Œé™¤éé‡åˆ°æ€§èƒ½ç“¶é¢ˆï¼Œå¦åˆ™å¯è¯»æ€§æ›´é‡è¦ã€‚</p>
<p>YAGNIï¼šYou Ain&rsquo;t Gonna Need It.ä¸è¦å»è®¾è®¡ä½ ç”¨ä¸åˆ°çš„ä¸œè¥¿ï¼Œä¸è¦è¿‡åº¦è®¾è®¡ã€‚ä½†æ˜¯è¿˜æ˜¯è¦ä¿æŒä»£ç çš„å¯æ‰©å±•æ€§ã€‚</p>
</li>
</ol>
<h2 id="é‡æ„ä¸ç¼–ç¨‹è§„èŒƒ">é‡æ„ä¸ç¼–ç¨‹è§„èŒƒ</h2>
<h3 id="é‡æ„">é‡æ„</h3>
<h4 id="why">why</h4>
<p><strong>æŠ€æœ¯åœ¨æ›´æ–°ã€éœ€æ±‚åœ¨å˜åŒ–ã€äººå‘˜åœ¨æµåŠ¨ï¼Œä»£ç è´¨é‡æ€»ä¼šåœ¨ä¸‹é™ï¼Œä»£ç æ€»ä¼šå­˜åœ¨ä¸å®Œç¾ï¼Œé‡æ„å°±ä¼šæŒç»­åœ¨è¿›è¡Œ</strong>ã€‚æ—¶åˆ»å…·æœ‰æŒç»­é‡æ„æ„è¯†ï¼Œæ‰èƒ½é¿å…å¼€å‘åˆæœŸå°±è¿‡åº¦è®¾è®¡ï¼Œé¿å…ä»£ç ç»´æŠ¤çš„è¿‡ç¨‹ä¸­è´¨é‡çš„ä¸‹é™ã€‚</p>
<p><strong>ä¸€æ—¦å‡ºç°â€œç ´çª—æ•ˆåº”â€ï¼Œä¸€ä¸ªäººå¾€é‡Œå †äº†ä¸€äº›çƒ‚ä»£ç ï¼Œä¹‹åå°±ä¼šæœ‰æ›´å¤šçš„äººå¾€é‡Œå †æ›´çƒ‚çš„ä»£ç </strong>ã€‚æ¯•ç«Ÿå¾€é¡¹ç›®é‡Œå †ç Œçƒ‚ä»£ç çš„æˆæœ¬å¤ªä½äº†ã€‚</p>
<h4 id="when">when</h4>
<p>ä¸è¦ç­‰åˆ°é—®é¢˜å †å¾—å¤ªå¤šäº†å»åšå¤§åˆ€é˜”æ–§çš„é‡æ„ï¼Œç”šè‡³é‡å†™ï¼Œè¦æ—¶åˆ»æœ‰äººå¯¹ä»£ç æ•´ä½“è´¨é‡è´Ÿè´£ä»»ï¼Œ<strong>å¹³æ—¶æ²¡äº‹å°±æ”¹æ”¹ä»£ç ï¼ŒæŒç»­æ€§çš„è¿›è¡Œå°é‡æ„</strong>ã€‚</p>
<h3 id="ç¼–ç¨‹è§„èŒƒ">ç¼–ç¨‹è§„èŒƒ</h3>
<ol>
<li>
<p>å•å…ƒæµ‹è¯•ã€‚ä¿è¯ä»£ç è´¨é‡çš„ä¸¤ä¸ªæ‰‹æ®µï¼šCode Reviewå’Œå•æµ‹ã€‚å•å…ƒæµ‹è¯•æœ¬èº«çš„ä»£ç è´¨é‡å¯ä»¥æ”¾ä½è¦æ±‚ï¼Œcopy-pasteã€æœ‰é‡å¤ä»£ç ä¹Ÿæ˜¯å¯ä»¥å…è®¸çš„ã€‚å•å…ƒæµ‹è¯•åªå…³å¿ƒè¢«æµ‹å‡½æ•°å®ç°äº†ä»€ä¹ˆåŠŸèƒ½ï¼Œä¸ç”¨é€è¡Œé˜…è¯»å‡½æ•°é‡Œé¢çš„ä»£ç ã€‚</p>
</li>
<li>
<p>å‘½åã€‚å¯¹äºæ¥å£çš„å‘½åï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ã€‚ä¸€ç§æ˜¯åŠ å‰ç¼€â€œIâ€ï¼Œè¡¨ç¤ºä¸€ä¸ª Interfaceã€‚æ¯”å¦‚ IUserServiceï¼Œå¯¹åº”çš„å®ç°ç±»å‘½åä¸º UserServiceã€‚å¦ä¸€ç§æ˜¯ä¸åŠ å‰ç¼€ï¼Œæ¯”å¦‚ UserServiceï¼Œå¯¹åº”çš„å®ç°ç±»åŠ åç¼€â€œImplâ€ï¼Œæ¯”å¦‚ UserServiceImplã€‚</p>
</li>
<li>
<p>å½“å‡½æ•°å‚æ•°è¿‡å¤šæ—¶ï¼Œå¯ä»¥è€ƒè™‘å°†å‡½æ•°å‚æ•°å˜æˆå¯¹è±¡ï¼Œå‡½æ•°å˜æˆæ–¹æ³•ã€‚</p>
</li>
<li>
<p>ä¸è¦åœ¨å‡½æ•°ä¸­ä½¿ç”¨å¸ƒå°”ç±»å‹çš„æ ‡è¯†å‚æ•°æ¥æ§åˆ¶å†…éƒ¨é€»è¾‘ï¼Œtrue çš„æ—¶å€™èµ°è¿™å—é€»è¾‘ï¼Œfalse çš„æ—¶å€™èµ°å¦ä¸€å—é€»è¾‘ã€‚</p>
</li>
</ol>
<h2 id="golangè®¾è®¡æ¨¡å¼">golangè®¾è®¡æ¨¡å¼</h2>
<blockquote>
<p>åˆ›å»ºå‹ï¼šä¸»è¦è§£å†³â€œå¯¹è±¡çš„åˆ›å»ºâ€é—®é¢˜</p>
<p>ç»“æ„å‹ï¼šä¸»è¦è§£å†³â€œç±»æˆ–å¯¹è±¡çš„ç»„åˆæˆ–ç»„è£…â€é—®é¢˜</p>
<p>è¡Œä¸ºå‹ï¼šä¸»è¦è§£å†³â€œç±»æˆ–å¯¹è±¡ä¹‹é—´çš„äº¤äº’â€é—®é¢˜</p>
</blockquote>
<ol>
<li>åˆ›å»ºå‹
<ul>
<li><a href="https://github.com/cvvz/go-design-pattern/tree/master/golang/singleton">å•ä¾‹</a></li>
<li><a href="https://github.com/cvvz/go-design-pattern/tree/master/golang/factory">å·¥å‚</a></li>
<li><a href="https://github.com/cvvz/go-design-pattern/tree/master/golang/builder">å»ºé€ è€…</a></li>
</ul>
</li>
<li>ç»“æ„å‹</li>
<li>è¡Œä¸ºå‹</li>
</ol>
<h2 id="æ‹“å±•golangå¸¸ç”¨ç¼–ç¨‹æ¨¡å¼">æ‹“å±•ï¼šgolangå¸¸ç”¨ç¼–ç¨‹æ¨¡å¼</h2>
<ul>
<li><a href="https://github.com/cvvz/go-design-pattern/tree/master/golang/decorator">Functional Option</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>å®¹å™¨2</title>
			<link>https://cvvz.fun/post/container2/</link>
			<pubDate>Fri, 23 Apr 2021 16:52:20 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/container2/</guid>
			<description>è¿›ç¨‹ å•è¿›ç¨‹æ¨¡å‹ å®¹å™¨ä¸­çš„1å·è¿›ç¨‹å¯¹äºå®¿ä¸»æœºè€Œè¨€å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„è¿›ç¨‹ï¼Œå®ƒçš„çˆ¶è¿›ç¨‹æ˜¯runCï¼ŒrunCçš„çˆ¶è¿›ç¨‹æ˜¯containerd-shimã€‚è¿™ä¸ª</description>
			<content type="html"><![CDATA[<h2 id="è¿›ç¨‹">è¿›ç¨‹</h2>
<h3 id="å•è¿›ç¨‹æ¨¡å‹">å•è¿›ç¨‹æ¨¡å‹</h3>
<p>å®¹å™¨ä¸­çš„1å·è¿›ç¨‹å¯¹äºå®¿ä¸»æœºè€Œè¨€å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„è¿›ç¨‹ï¼Œå®ƒçš„çˆ¶è¿›ç¨‹æ˜¯runCï¼ŒrunCçš„çˆ¶è¿›ç¨‹æ˜¯containerd-shimã€‚è¿™ä¸ªcontainerd-shimç”¨äºç®¡ç†å®¹å™¨è¿›ç¨‹ï¼Œç±»ä¼¼äºinitæˆ–è€…systemdè¿›ç¨‹çš„ä½œç”¨(å›æ”¶åƒµå°¸è¿›ç¨‹)ï¼Œå½“è¿›ç¨‹é€€å‡ºæ—¶ï¼Œcontainerd-shimä¼šé€šè¿‡runCé‡æ–°å°†è¿›ç¨‹æ‹‰èµ·ã€‚</p>
<p>å®¹å™¨çš„â€œå•è¿›ç¨‹æ¨¡å‹â€æ„å‘³ç€å®¹å™¨è¿›ç¨‹æœ¬èº«ï¼Œè™½ç„¶æ˜¯1å·è¿›ç¨‹ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å…·æœ‰é€šå¸¸æ„ä¹‰ä¸Š1å·è¿›ç¨‹ï¼Œå¦‚systemdæˆ–initæ‰€å…·æœ‰çš„è¿›ç¨‹ç®¡ç†èƒ½åŠ›ï¼Œæ¯”å¦‚æ‰˜ç®¡å­¤å„¿è¿›ç¨‹ï¼Œå›æ”¶åƒµå°¸è¿›ç¨‹ç­‰ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„åº”ç”¨è¿›ç¨‹ã€‚</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥ç»™è¿™ä¸ª1å·è¿›ç¨‹èµ‹äºˆè¿™ç§èƒ½åŠ›ï¼Œå¦‚dockerå¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼ŒåŠ ä¸Š<code>--init</code>å‚æ•°ï¼Œèµ·æ¥çš„å®¹å™¨å°±å¼ºåˆ¶ä½¿ç”¨ <a href="https://github.com/krallin/tini">tini</a> ä½œä¸º init è¿›ç¨‹äº†ã€‚è¿™ç§1å·è¿›ç¨‹éåº”ç”¨å®¹å™¨ï¼Œè€Œæ˜¯ç”±ä¸“é—¨çš„initè¿›ç¨‹æ‹‰èµ·å…¶ä»–æ‰€æœ‰åº”ç”¨è¿›ç¨‹çš„åšæ³•ï¼Œç§°ä¸ºâ€œå¯Œå®¹å™¨â€ï¼ˆrich containerï¼‰ã€‚å¯Œå®¹å™¨çš„å¥½å¤„æ˜¯å¯ä»¥æŠŠå®¹å™¨å½“æˆè™šæ‹Ÿæœºä¸€æ ·å¯¹å¾…ï¼Œæ–¹ä¾¿å’Œç»å…¸PaaSä½“ç³»å¯¹æ¥ã€‚</p>
<p>äº‘åŸç”Ÿæå€¡ä½¿ç”¨è½»é‡çº§å®¹å™¨ï¼Œå› ä¸ºåªæœ‰å½“1å·è¿›ç¨‹å°±æ˜¯åº”ç”¨è¿›ç¨‹æœ¬èº«æ—¶ï¼Œæ‰èƒ½å‡†ç¡®çš„å‘å®¹å™¨è¿è¡Œæ—¶æš´éœ²è¿›ç¨‹çš„å®é™…çŠ¶å†µï¼Œæ–¹ä¾¿ä½¿ç”¨kubernetesæ¢é’ˆï¼Œä»¥åŠä¾èµ–è¿™äº›æ¢é’ˆçš„å‘¨è¾¹ç»„ä»¶ï¼Œå¦‚serviceç­‰ã€‚</p>
<h3 id="ä¿¡å·">ä¿¡å·</h3>
<p>ç¼ºçœçŠ¶æ€ä¸‹ï¼Œ</p>
<ul>
<li>C è¯­è¨€ç¨‹åºé‡Œï¼Œä¸€ä¸ªä¿¡å· handler éƒ½æ²¡æœ‰æ³¨å†Œï¼›</li>
<li>Golang ç¨‹åºé‡Œï¼Œå¾ˆå¤šä¿¡å·éƒ½æ³¨å†Œäº†è‡ªå·±çš„ handlerï¼›</li>
<li>bash ç¨‹åºé‡Œæ³¨å†Œäº†ä¸¤ä¸ª handlerï¼Œbit 2 å’Œ bit 17ï¼Œä¹Ÿå°±æ˜¯ <code>SIGINT</code> å’Œ <code>SIGCHLD</code>ã€‚</li>
</ul>
<blockquote>
<p>å¯ä»¥é€šè¿‡æŸ¥çœ‹ <code>/proc/$PID/status</code>ä¸­çš„<code>SigCgt</code> è¡Œæ¥äº†è§£å“ªäº›ä¿¡å·è¢«æ•è·äº†ï¼ˆæ³¨å†Œäº†ä¿¡å·å¤„ç†å‡½æ•°ï¼‰ã€‚</p>
</blockquote>
<p>è™½ç„¶SIGTERMï¼ˆ15ï¼‰çš„é»˜è®¤è¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œä½†æ˜¯å½“1å·è¿›ç¨‹<strong>æ²¡æœ‰ä¸ºSIGTERMæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</strong>æ—¶ï¼Œ</p>
<ul>
<li>é€šè¿‡<code>kubectl exec</code>è¿›å…¥å®¹å™¨åï¼Œé€šè¿‡<code>kill</code>å‘½ä»¤å»ä¼˜é›…ç»ˆæ­¢1å·è¿›ç¨‹ï¼Œæ˜¯ä¸ä¼šé€€å‡ºçš„</li>
<li>é€šè¿‡å®¿ä¸»æœºkill $PIDï¼Œè¿›ç¨‹ä¹Ÿä¸ä¼šé€€å‡º</li>
</ul>
<p>æ­¤å¤–ï¼Œ<strong>æ— è®ºä»€ä¹ˆæƒ…å†µä¸‹ï¼Œåœ¨å®¹å™¨ä¸­é€šè¿‡<code>kill -9</code>å°è¯•å¼ºæ€1å·è¿›ç¨‹éƒ½ä¸å¯èƒ½æˆåŠŸ</strong>ã€‚</p>
<p>å…·ä½“åŸå› æ˜¯ï¼Œ<code>kill</code> å‘½ä»¤å®é™…ä¸Šè°ƒç”¨äº† <code>kill()</code> è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸å°è¯•å°†ä¿¡å·å‘é€ç»™1å·è¿›ç¨‹ä¹‹å‰ï¼Œåœ¨ <a href="https://github.com/torvalds/linux/blob/master/kernel/signal.c#L88-L89">sig_task_ignored</a> å‡½æ•°ä¸­å¯¹ä¸€äº›ç‰¹æ®Šæƒ…å†µè¿›è¡Œäº†è¿‡æ»¤ã€‚</p>
<p>æ³¨å†Œäº†ä¿¡å·å¤„ç†å‡½æ•°åï¼Œ1å·è¿›ç¨‹åˆåº”è¯¥æ€æ ·å¤„ç† <code>SIGTERM</code> å‘¢ï¼Ÿ<strong>å¦‚æœç›´æ¥é€€å‡ºçš„è¯ï¼Œ1å·è¿›ç¨‹ä¼šå‘åŒ Namespace ä¸­çš„å…¶ä»–è¿›ç¨‹éƒ½å‘é€ä¸€ä¸ª <code>SIGKILL</code> ä¿¡å·ã€‚è¿™ä¼šå¯¼è‡´å®¹å™¨ä¸­çš„å…¶ä»–è¿›ç¨‹æ²¡æœ‰ä¼˜é›…é€€å‡ºã€‚</strong></p>
<p>æ‰€ä»¥ <a href="https://github.com/krallin/tini">tini</a> çš„å®ç°æ–¹å¼æ˜¯ï¼šæŠŠé™¤äº† <code>SIGCHILD</code> ä»¥å¤–çš„å…¶ä»–æ‰€æœ‰ä¿¡å·éƒ½è½¬å‘ç»™å®ƒçš„å­è¿›ç¨‹ï¼›è‡ªå·±åˆ™è´Ÿè´£é€šè¿‡ <code>waitpid</code> æ¥å›æ”¶å­è¿›ç¨‹èµ„æºï¼Œé¿å…åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿã€‚</p>
<blockquote>
<p>åƒµå°¸è¿›ç¨‹æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç©ºçš„<code>task_struct</code>ï¼Œå®ƒæ‰€æ‹¥æœ‰çš„èµ„æºï¼ˆå†…å­˜ã€æ–‡ä»¶å¥æŸ„ã€ä¿¡å·é‡ç­‰ï¼‰éƒ½å·²ç»è¢«å†…æ ¸å›æ”¶äº†ï¼Œå”¯ä¸€æ¶ˆè€—çš„èµ„æºæ˜¯pidã€‚</p>
<p>è¿›ç¨‹å®é™…é€€å‡ºå‰çš„åƒµå°¸æ€æ˜¯æœ‰å¿…è¦çš„ï¼Œå®ƒä¼šé€šè¿‡<code>SIGCHILD</code>ä¿¡å·å‘Šè¯‰çˆ¶è¿›ç¨‹è‡ªå·±å·²ç»æ­»äº†ï¼Œè®©çˆ¶è¿›ç¨‹çŸ¥é“å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œæ¯”å¦‚å¼‚å¸¸é€€å‡ºé‡æ–°æ‹‰èµ·ã€‚</p>
<p>åƒµå°¸è¿›ç¨‹è¿‡å¤šä¼šå¯¼è‡´pidè¢«å æ»¡ï¼Œæ— æ³•å†è¿è¡Œæ–°çš„è¿›ç¨‹ã€‚å®¹å™¨çš„æœ€å¤§è¿›ç¨‹æ•°é‡ç”±/sys/fs/cgroup/pidsï¼ˆpid cgroupï¼‰ä¸‹çš„ <code>pids.max</code> æ–‡ä»¶é™åˆ¶ã€‚</p>
</blockquote>
<h2 id="cpu">CPU</h2>
<h3 id="ä½¿ç”¨ç‡">ä½¿ç”¨ç‡</h3>
<p>kubernetesä¸­Podçš„cpuèµ„æºçš„<code>request</code> å’Œ <code>limit</code>å­—æ®µé™åˆ¶çš„æ˜¯cpuçš„<strong>ä½¿ç”¨ç‡</strong>ã€‚</p>
<blockquote>
<p>topå‘½ä»¤å¯ä»¥æŸ¥çœ‹cpuçš„ä½¿ç”¨ç‡ï¼Œ100%è¡¨ç¤ºç¬æ—¶ä½¿ç”¨äº†1ä¸ªCPUï¼Œ200%è¡¨ç¤º2ä¸ªã€‚è¿™ä¸ªæ—¶é—´æ˜¯ä»æ€ä¹ˆæ¥çš„ï¼Ÿ<strong>æ˜¯ä»procæ–‡ä»¶ç³»ç»Ÿé‡Œæ‹¿åˆ°æŒ‡æ ‡è®¡ç®—å¾—æ¥çš„ã€‚</strong></p>
<p>è¿›ç¨‹cpuä½¿ç”¨ç‡çš„å…·ä½“å®šä¹‰æ˜¯ï¼šï¼ˆè¿›ç¨‹ç”¨æˆ·æ€å’Œå†…æ ¸æ€åœ¨cpuè°ƒåº¦ä¸­è·å¾—çš„cpu ticks/ å•ä¸ª CPU äº§ç”Ÿçš„æ€» ticksï¼‰*100%</p>
<p>tickï¼šLinux æ—¶é’Ÿå‘¨æœŸæ€§åœ°ï¼ˆæ¯”å¦‚1/100ç§’ï¼‰äº§ç”Ÿä¸­æ–­ï¼Œæ¯æ¬¡ä¸­æ–­éƒ½ä¼šè§¦å‘ Linux å†…æ ¸å»åšä¸€æ¬¡è¿›ç¨‹è°ƒåº¦ï¼Œè€Œè¿™ä¸€æ¬¡ä¸­æ–­å°±æ˜¯ä¸€ä¸ª tickã€‚</p>
</blockquote>
<p><code>limit</code>æ„å‘³ç€æœ€å¤§cpuçš„ä½¿ç”¨ç‡èƒ½è¾¾åˆ°å¤šå°‘ï¼Œè¿™ä¸ªå€¼æ˜¯é€šè¿‡cpu cgroupçš„<code>cpu.cfs_quota_us</code>ï¼ˆä¸€ä¸ªè°ƒåº¦å‘¨æœŸé‡Œè¿™ä¸ªæ§åˆ¶ç»„è¢«å…è®¸çš„è¿è¡Œæ—¶é—´ï¼‰é™¤ä»¥ <code>cpu.cfs_period_us</code>ï¼ˆCPUè°ƒåº¦å‘¨æœŸï¼‰å¾—æ¥çš„ï¼›</p>
<p><code>request</code>è¡¨ç¤ºå³ä½¿å½“æ•´ä¸ªèŠ‚ç‚¹cpuè¢«å®Œå…¨ç”¨æ»¡æ—¶ï¼Œæˆ‘çš„cpuåˆ©ç”¨ç‡ä¹Ÿèƒ½è¾¾åˆ°è¿™ä¹ˆå¤šï¼Œå®ƒæ˜¯é€šè¿‡è®¾ç½®<code>cpu.shares</code>ï¼ˆèŠ‚ç‚¹ä¸Šcgroup å¯ç”¨cpuçš„ç›¸å¯¹æ¯”ä¾‹ï¼‰æ¥å®ç°çš„ã€‚</p>
<blockquote>
<p>å¯¹äºç³»ç»Ÿ<strong>å„ä¸ªç±»å‹çš„ CPU ä½¿ç”¨ç‡</strong>ï¼Œåˆ™éœ€è¦è¯»å– /proc/stat æ–‡ä»¶ï¼Œå¾—åˆ°ç¬æ—¶å„é¡¹ CPU ä½¿ç”¨ç‡çš„ ticks å€¼ï¼Œç›¸åŠ å¾—åˆ°ä¸€ä¸ªæ€»å€¼ï¼Œå•é¡¹å€¼é™¤ä»¥æ€»å€¼å°±æ˜¯å„é¡¹ CPU çš„ä½¿ç”¨ç‡ã€‚</p>
</blockquote>
<h3 id="å®¹å™¨èµ„æºè§†å›¾éš”ç¦»">å®¹å™¨èµ„æºè§†å›¾éš”ç¦»</h3>
<p>ç›¸æ¯”ä½¿ç”¨è™šæ‹Ÿæœºï¼Œä½¿ç”¨å®¹å™¨ï¼Œæœ€å¤§çš„é—®é¢˜åœ¨äº<strong>èµ„æºè§†å›¾çš„éš”ç¦»</strong>ã€‚ç”±äºå®¹å™¨æ²¡æœ‰å¯¹/procï¼Œ/sysç­‰æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œéš”ç¦»ï¼Œå› æ­¤åœ¨å®¹å™¨ä¸­ä½¿ç”¨freeã€topç­‰å‘½ä»¤çœ‹åˆ°çš„å…¶å®æ˜¯ç‰©ç†æœºçš„æ•°æ®ã€‚æ­¤å¤–ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šä»<code>/sys/devices/system/cpu/online</code>ä¸­è·å–cpuçš„æ ¸æ•°ï¼Œæ¥å†³å®šé»˜è®¤çº¿ç¨‹æ•°ï¼Œæ¯”å¦‚<code>GOMAXPROCS</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<a href="https://github.com/lxc/lxcfs">lxcfs</a>æ¥å¯¹å®¹å™¨èµ„æºè§†å›¾è¿›è¡Œéš”ç¦»ï¼Œè®©å®¹å™¨â€œè¡¨ç°çš„â€æ›´åƒä¸€å°è™šæ‹Ÿæœºã€‚å¯¹äºgoç¨‹åºï¼Œè¿˜å¯ä»¥é€šè¿‡<a href="https://github.com/uber-go/automaxprocs">automaxprocs</a>è¿™ä¸ªåŒ…æ¥åœ¨å®¹å™¨ä¸­æ­£ç¡®è®¾ç½®<code>GOMAXPROCS</code>å€¼ã€‚</p>
<h2 id="å†…å­˜">å†…å­˜</h2>
<h3 id="memoryusage_in_bytes">memory.usage_in_bytes</h3>
<p><code>malloc()</code>ç”³è¯·çš„å…¶å®æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œå®¹å™¨æ ¹æ®è¿›ç¨‹çš„å®é™…ç‰©ç†å†…å­˜ä½¿ç”¨å€¼<code>memory.stat[rss]</code>æ˜¯å¦è¶…è¿‡äº†<code>memory.limit_in_bytes</code>ï¼Œå†åŠ ä¸Š<code>memory.oom_control</code>æ¥åˆ¤æ–­æ˜¯å¦è¿›è¡Œoomã€‚</p>
<blockquote>
<p>ä½ å¯ä»¥è°ƒæ•´<code>memory.oom_control</code>å‚æ•°ï¼Œè¿™æ ·å³ä½¿ç‰©ç†å†…å­˜å·²ç»è¾¾åˆ°ä¸Šé™äº†ï¼Œå®¹å™¨è¿˜æ˜¯ä¸ä¼šè¢«cgroupå¹²æ‰ï¼Œå¯æ˜¯è¿™æ ·çš„è¯ï¼Œ<strong>ç”±äºç”³è¯·ä¸åˆ°ç‰©ç†å†…å­˜èµ„æºï¼Œè¿›ç¨‹ä¼šå¤„äºå¯ä¸­æ–­ç¡çœ çŠ¶æ€ã€‚</strong></p>
</blockquote>
<p>cgroupå½“ä¸­çš„<code>memory.usage_in_bytes</code>å®é™…ä¸Šæ˜¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šç”¨æˆ·æ€ç‰©ç†å†…å­˜(<code>memory.stat[rss]</code>) + å†…æ ¸æ€å†…å­˜(<code>memory.kmem.usage_in_bytes</code>) + page cache(<code>memory.stat[cache]</code>)ï¼Œå³<code>memory.usage_in_bytes</code> = <code>memory.stat[rss]</code> + <code>memory.stat[cache]</code> + <code>memory.kmem.usage_in_bytes</code>ã€‚</p>
<p>æœ‰æ—¶å€™æˆ‘ä»¬å‘ç°å®¹å™¨çš„å†…å­˜ä½¿ç”¨é‡<code>memory.usage_in_bytes</code>ä¸€ç›´ç­‰äº<code>memory.limit_in_bytes</code>ï¼Œä½†æ˜¯ä¹Ÿä¸ä¼šå‘ç”ŸOOMï¼Œæ˜¯å› ä¸ºå®é™…ä¸Šæ¯æ¬¡ä»¥<strong>Buffered IO</strong>çš„æ–¹å¼è¯»å†™ç£ç›˜æ—¶ï¼ŒLinuxéƒ½ä¼šå…ˆå°†æ•°æ®ç¼“å­˜åˆ°page cacheå½“ä¸­æ¥åŠ å¿«write/readç³»ç»Ÿè°ƒç”¨çš„é€Ÿåº¦ï¼Œä¹Ÿå°±æ˜¯<code>memory.stat[rss]</code>å€¼æ¯”è¾ƒé«˜ï¼Œå½“è¿›ç¨‹éœ€è¦ç‰©ç†å†…å­˜æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨é‡Šæ”¾ä¸€éƒ¨åˆ†page cacheå†…å­˜ç»™rsså†…å­˜ä½¿ç”¨ã€‚</p>
<h3 id="swap">swap</h3>
<p>kubeletç¼ºçœä¸èƒ½åœ¨æ‰“å¼€swapçš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚é…ç½®<code>--fail-swap-on=false</code>ï¼Œkubeletå¯ä»¥åœ¨swap enabledçš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p>
<p>rsså†…å­˜ä¸­å¤§éƒ¨åˆ†<code>æ²¡æœ‰ç£ç›˜æ–‡ä»¶å¯¹åº”</code>ï¼Œè¿™ç§å†…å­˜ç§°ä¸ºåŒ¿åå†…å­˜ã€‚swapç”¨äºåœ¨å†…å­˜èµ„æºç´§å¼ æ—¶ï¼Œé‡Šæ”¾éƒ¨åˆ†åŒ¿åå†…å­˜åˆ°ç£ç›˜çš„swapç©ºé—´ã€‚</p>
<p>å†…æ ¸çš„<code>/proc/sys/vm/swappiness</code>å‚æ•°ä½œç”¨æ˜¯å½“ç³»ç»Ÿå­˜åœ¨swapç©ºé—´æ—¶ï¼Œæ˜¯ä¼˜å…ˆé‡Šæ”¾page cacheè¿˜æ˜¯ä¼˜å…ˆé‡Šæ”¾åŒ¿åå†…å­˜ï¼Œå³å†™å…¥swapã€‚</p>
<p>cgroupä¸­çš„<code>memory.swappiness</code>å’Œå…¨å±€çš„<code>/proc/sys/vm/swappiness</code>ä½œç”¨å·®ä¸å¤šã€‚<strong>å”¯ä¸€åŒºåˆ«æ˜¯è®¾ç½®<code>memory.swappiness</code>ä¸º0ï¼Œå¯ä»¥è®©è¿™ä¸ªcgroupæ§åˆ¶ç»„é‡Œçš„å†…å­˜ç¦æ­¢ä½¿ç”¨swapã€‚</strong></p>
<h2 id="å­˜å‚¨">å­˜å‚¨</h2>
<h3 id="å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ">å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ</h3>
<p>å®¹å™¨æ–‡ä»¶ç³»ç»ŸUnionFSï¼Œä»åŸç†ä¸Šè¯´ï¼Œå°±æ˜¯å¤šä¸ªç›®å½•è”åˆæŒ‚è½½åˆ°ä¸€ä¸ªç›®å½•ä¸‹ï¼Œè¯»/å†™è¿™ä¸ªç›®å½•å°±ç›¸å½“äºè¯»/å†™äº†å¯¹åº”ç›®å½•ä¸­çš„å†…å®¹ã€‚å¸¸ç”¨çš„æœ‰ï¼šaufsï¼ˆæ²¡æœ‰åˆåˆ°linux kernelä¸»å¹²ï¼‰ã€devicemapperå’ŒoverlayFSã€‚</p>
<p>ä»¥OverlayFSä¸ºä¾‹ï¼Œ OverlayFSæœ‰ä¸¤å±‚ï¼Œåˆ†åˆ«æ˜¯ lowerdir å’Œ upperdirã€‚lowerdir é‡Œæ˜¯å®¹å™¨é•œåƒä¸­çš„æ–‡ä»¶ï¼Œå¯¹äºå®¹å™¨æ¥è¯´æ˜¯åªè¯»çš„ï¼›upperdir å­˜æ”¾çš„æ˜¯å®¹å™¨å¯¹æ–‡ä»¶ç³»ç»Ÿé‡Œçš„æ‰€æœ‰æ”¹åŠ¨ï¼Œå®ƒæ˜¯å¯è¯»å†™çš„ã€‚lowerå’Œupperè”åˆæŒ‚è½½åˆ°mergedã€‚</p>
<h3 id="blkio-cgroup">blkio cgroup</h3>
<p>ç£ç›˜ioçš„ä¸¤ä¸ªä¸»è¦æ€§èƒ½æŒ‡æ ‡ï¼š</p>
<ul>
<li>iopsï¼šæ¯ç§’é’Ÿç£ç›˜è¿›è¡ŒIOçš„æ¬¡æ•°</li>
<li>ååé‡ï¼ˆå¸¦å®½ï¼‰ï¼šä»¥MB/sä¸ºå•ä½ï¼Œä¸€æ¬¡IOè¯»å†™çš„æ•°æ®å—è¶Šå¤§ï¼Œååé‡è¶Šå¤§ã€‚å³<strong>ååé‡ = IOPS * æ•°æ®å—å¤§å°</strong>ã€‚</li>
</ul>
<p>cgroup v1çš„é™åˆ¶ï¼šæ¯ä¸€ä¸ªå­ç³»ç»Ÿéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¯¹äºæŸè¿›ç¨‹ï¼Œåªèƒ½<strong>ç‹¬ç«‹çš„</strong>åœ¨å„ä¸ªcgroupå­ç³»ç»Ÿä¸­é™åˆ¶å®ƒçš„èµ„æºä½¿ç”¨ã€‚è¿™æ ·çš„é—®é¢˜åœ¨äºï¼Œå¯¹äºbuffered I/Oï¼Œå®ƒæ˜¯å…ˆæŠŠæ•°æ®å†™å…¥page cacheï¼Œå†ä»page cacheåˆ·åˆ°ç£ç›˜ï¼›ç”±äºblkioå’Œmemoryä¸¤ä¸ªå­ç³»ç»Ÿç›¸äº’ç‹¬ç«‹ï¼Œå¯¹äºbuffered I/Oå°±æ— æ³•é™é€Ÿäº†ã€‚</p>
<p>Cgroup v2çš„å˜åŒ–ï¼šä¸€ä¸ªè¿›ç¨‹å±äºä¸€ä¸ª<strong>æ§åˆ¶ç»„</strong>ï¼Œåœ¨è¿™ä¸ªæ§åˆ¶ç»„é‡Œå¤šä¸ªå­ç³»ç»Ÿå¯ä»¥<strong>ååŒè¿è¡Œ</strong>ã€‚å¯¹æŸä¸ªè¿›ç¨‹ï¼Œåœ¨æ§åˆ¶ç»„é‡ŒåŒæ—¶é™åˆ¶memory + blkioå°±èƒ½å¯¹Buffered I/O ä½œç£ç›˜è¯»å†™çš„é™é€Ÿ</p>
<h2 id="ç½‘ç»œ">ç½‘ç»œ</h2>
<p>å®¹å™¨ Network Namespace çš„ç½‘ç»œå‚æ•°å¹¶ä¸æ˜¯å®Œå…¨ä»å®¿ä¸»æœº Host Namespace é‡Œç»§æ‰¿çš„ï¼Œä¹Ÿä¸æ˜¯å®Œå…¨åœ¨æ–°çš„ Network Namespace å»ºç«‹çš„æ—¶å€™é‡æ–°åˆå§‹åŒ–çš„ã€‚åœ¨å†…æ ¸å‡½æ•° <a href="https://github.com/torvalds/linux/blob/v5.4/net/ipv4/tcp_ipv4.c#L2631">tcp_sk_init()</a> é‡Œï¼Œå¯ä»¥çœ‹åˆ° <code>tcp_keepalive</code> çš„ä¸‰ä¸ªå‚æ•°éƒ½æ˜¯é‡æ–°åˆå§‹åŒ–çš„ï¼Œè€Œ <code>tcp_congestion_control</code> çš„å€¼åˆ™æ˜¯ä» Host Namespace é‡Œå¤åˆ¶è¿‡æ¥çš„ã€‚</p>
<p>åœ¨ Linux ä¸­ï¼Œç®¡ç†å‘˜å¯ä»¥é€šè¿‡ sysctl æ¥å£ä¿®æ”¹å†…æ ¸è¿è¡Œæ—¶çš„å‚æ•°ã€‚åœ¨ <code>/proc/sys/</code> è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹å­˜æ”¾è®¸å¤šå†…æ ¸å‚æ•°ã€‚è¿™äº›å‚æ•°æ¶‰åŠäº†å¤šä¸ªå†…æ ¸å­ç³»ç»Ÿï¼Œæ¯”å¦‚å†…æ ¸å­ç³»ç»Ÿï¼ˆé€šå¸¸å‰ç¼€ä¸º: kernel.ï¼‰ã€ç½‘ç»œå­ç³»ç»Ÿï¼ˆé€šå¸¸å‰ç¼€ä¸º: net.ï¼‰ç­‰ã€‚é€šè¿‡ <code>sysctl -a</code> å¯ä»¥è·å–æ‰€æœ‰å†…æ ¸å‚æ•°åˆ—è¡¨ã€‚</p>
<p>åœ¨kubernetesä¸­ï¼Œå¦‚æœå¯¹å†…æ ¸ç½‘ç»œå‚æ•°æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¯ä»¥é€šè¿‡ <a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/sysctl-cluster/#%E8%AE%BE%E7%BD%AE-pod-%E7%9A%84-sysctl-%E5%8F%82%E6%95%B0">è®¾ç½®Podçš„sysctlå‚æ•°</a>ï¼Œæˆ–è€…åœ¨ç»™init containerèµ‹äºˆç‰¹æƒï¼Œå¹¶é€šè¿‡ sysctl ä¿®æ”¹å†…æ ¸ç½‘ç»œå‚æ•°ã€‚</p>
<h2 id="å®‰å…¨">å®‰å…¨</h2>
<h3 id="capabilityhttpsman7orglinuxman-pagesman7capabilities7html"><a href="https://man7.org/linux/man-pages/man7/capabilities.7.html">capability</a></h3>
<p>k8sæ²¡æœ‰å¯¹user namespaceè¿›è¡Œéš”ç¦»ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®¹å™¨é‡Œè¿è¡Œçš„æ˜¯rootç”¨æˆ·ã€‚ä½†æ˜¯ç”±äºç¼ºçœå¯åŠ¨å®¹å™¨æ—¶ï¼Œç³»ç»Ÿåªä¸º1å·è¿›ç¨‹å¼€å¯äº† <a href="https://github.com/opencontainers/runc/blob/v1.0.0-rc92/libcontainer/SPEC.md#security">15ä¸ªcapabilities</a>ã€‚è€Œé€šè¿‡<code>kubectl exec -- sh</code>è¿›å…¥åˆ°å®¹å™¨é‡Œï¼Œå¯åŠ¨çš„<code>sh</code>è¿›ç¨‹ï¼ˆ<strong>æ‰€æœ‰å‘½ä»¤çš„çˆ¶è¿›ç¨‹</strong>ï¼‰å’Œå®¹å™¨çš„1å·è¿›ç¨‹çš„ capabilities ç›¸åŒã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®å®¹å™¨çš„ <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#securitycontext-v1-core">SecurityContext</a> é‡Œçš„<code>capabilities</code>ï¼Œæˆ–è€…é…ç½®å®¹å™¨ä¸º<code>privileged</code>ã€‚</p>
<h3 id="user-namespace">user namespace</h3>
<p>å°½ç®¡å®¹å™¨ä¸­ root ç”¨æˆ·çš„ Linux capabilities å·²ç»å‡å°‘äº†å¾ˆå¤šï¼Œä½†æ˜¯åœ¨æ²¡æœ‰ User Namespace çš„æƒ…å†µä¸‹ï¼Œå®¹å™¨ä¸­ root ç”¨æˆ·å’Œå®¿ä¸»æœºä¸Šçš„ root ç”¨æˆ·çš„ uid æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œæ²¡æœ‰éš”ç¦»ã€‚ä¸€æ—¦æœ‰è½¯ä»¶çš„æ¼æ´ï¼Œå®¹å™¨ä¸­çš„ root ç”¨æˆ·å°±å¯ä»¥æ“æ§æ•´ä¸ªå®¿ä¸»æœºã€‚</p>
<p>ä¸ºäº†å‡å°‘å®‰å…¨é£é™©ï¼Œä¸šç•Œéƒ½æ˜¯å»ºè®®åœ¨å®¹å™¨ä¸­ä»¥é root ç”¨æˆ·æ¥è¿è¡Œè¿›ç¨‹ã€‚ä¸è¿‡åœ¨<a href="https://github.com/kubernetes/enhancements/pull/2101">kubernetesç›®å‰è¿˜ä¸æ”¯æŒ User Namespace</a> çš„æƒ…å†µä¸‹ï¼Œåœ¨å®¹å™¨ä¸­ä½¿ç”¨é root ç”¨æˆ·çš„è¯ï¼Œå¯¹ uid çš„ç®¡ç†å’Œåˆ†é…å°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>kubernetesç½‘ç»œä¹‹service</title>
			<link>https://cvvz.fun/post/k8s-network-service/</link>
			<pubDate>Wed, 30 Dec 2020 15:42:01 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/k8s-network-service/</guid>
			<description>åœ¨kubernetesä¸­ï¼Œserviceå…¶å®åªæ˜¯ä¸€ä¸ªä¿å­˜åœ¨etcdé‡Œçš„APIå¯¹è±¡ï¼Œå¹¶ä¸å¯¹åº”ä»»ä½•å…·ä½“çš„å®ä¾‹ã€‚serviceå³k8sä¸­çš„â€œå¾®æœåŠ¡</description>
			<content type="html"><![CDATA[<p>åœ¨kubernetesä¸­ï¼Œserviceå…¶å®åªæ˜¯ä¸€ä¸ªä¿å­˜åœ¨etcdé‡Œçš„APIå¯¹è±¡ï¼Œå¹¶ä¸å¯¹åº”ä»»ä½•å…·ä½“çš„å®ä¾‹ã€‚serviceå³k8sä¸­çš„â€œå¾®æœåŠ¡â€ï¼Œè€Œå®ƒçš„æœåŠ¡æ³¨å†Œä¸å‘ç°ã€å¥åº·æ£€æŸ¥ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½å…¶å®æ˜¯åº•å±‚watch serviceã€endpointã€podç­‰èµ„æºçš„DNSã€kube-proxyï¼Œä»¥åŠiptablesç­‰å…±åŒé…åˆå®ç°çš„ã€‚</p>
<h2 id="ä»é›†ç¾¤å†…éƒ¨è®¿é—®clusteripæœåŠ¡">ä»é›†ç¾¤å†…éƒ¨è®¿é—®ClusterIPæœåŠ¡</h2>
<p>åœ¨<a href="https://cvvz.github.io/post/k8s-network-dns/">kubernetesç½‘ç»œä¹‹DNS
</a>ä¸€æ–‡ä¸­ï¼Œå·²ç»è¯¦ç»†è¯´æ˜äº†ä»åŸŸååˆ°ClusterIPçš„è½¬æ¢è¿‡ç¨‹ã€‚</p>
<p>ä¸‹é¢ä»¥kubernetesé›†ç¾¤ä¸­æŸä¸ªPodè®¿é—®<code>kubernetes</code>æœåŠ¡ï¼ˆkube-apiserverï¼‰ä¸ºä¾‹ï¼Œåˆ†æä¸€ä¸‹kubernetesæ˜¯æ€ä¹ˆå°†å¯¹ClusterIPçš„è®¿é—®è½¬å˜æˆå¯¹æŸä¸ªåç«¯Podçš„è®¿é—®çš„ã€‚</p>
<blockquote>
<p>æ³¨ï¼škube-proxyä»¥iptablesæ¨¡å¼å·¥ä½œ</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>âœ  ~ k get svc <span class="p">|</span> grep kubernetes
<span class="ln">2</span>kubernetes                      ClusterIP      192.168.0.1       &lt;none&gt;                  443/TCP                                             348d
<span class="ln">3</span>
<span class="ln">4</span>âœ  ~ k get ep kubernetes
<span class="ln">5</span>NAME         ENDPOINTS                                                AGE
<span class="ln">6</span>kubernetes   10.20.126.169:6443,10.28.116.8:6443,10.28.126.199:6443   348d
</code></pre></div><ol>
<li>é¦–å…ˆæ•°æ®åŒ…ä»å®¹å™¨ä¸­è¢«è·¯ç”±åˆ°cniç½‘æ¡¥ï¼Œå‡ºç°åœ¨å®¿ä¸»æœºç½‘ç»œæ ˆä¸­ã€‚</li>
<li>Netfilteråœ¨<code>PREROUTING</code>é“¾ä¸­å¤„ç†è¯¥æ•°æ®åŒ…ï¼Œæœ€ç»ˆä¼šå°†å…¶è½¬åˆ°<code>KUBE-SERVICES</code>é“¾ä¸Šè¿›è¡Œå¤„ç†ï¼š</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A PREROUTING -m comment --comment <span class="s2">&#34;kubernetes service portals&#34;</span> -j KUBE-SERVICES
</code></pre></div><ol start="3">
<li><code>KUBE-SERVICES</code>é“¾å°†ç›®çš„åœ°å€ä¸º<code>192.168.0.1</code>çš„æ•°æ®åŒ…è·³è½¬åˆ°<code>KUBE-SVC-NPX46M4PTMTKRN6Y</code>é“¾è¿›è¡Œå¤„ç†ï¼š</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A KUBE-SERVICES -d 192.168.0.1/32 -p tcp -m comment --comment <span class="s2">&#34;default/kubernetes:https cluster IP&#34;</span> -m tcp --dport <span class="m">443</span> -j KUBE-SVC-NPX46M4PTMTKRN6Y
</code></pre></div><ol start="4">
<li><code>KUBE-SVC-NPX46M4PTMTKRN6Y</code>é“¾ä»¥<strong>ç›¸ç­‰æ¦‚ç‡</strong>å°†æ•°æ®åŒ…è·³è½¬åˆ°<code>KUBE-SEP-A66XJ5Q22M6AZV5X</code>ã€<code>KUBE-SEP-TYGT5TFZZ2W5DK4V</code>æˆ–<code>KUBE-SEP-KQD4HGXQYU3ORDNS</code>é“¾è¿›è¡Œå¤„ç†ï¼š</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A KUBE-SVC-NPX46M4PTMTKRN6Y -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-A66XJ5Q22M6AZV5X
<span class="ln">2</span>-A KUBE-SVC-NPX46M4PTMTKRN6Y -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-TYGT5TFZZ2W5DK4V
<span class="ln">3</span>-A KUBE-SVC-NPX46M4PTMTKRN6Y -j KUBE-SEP-KQD4HGXQYU3ORDNS
</code></pre></div><ol start="5">
<li>è€Œè¿™ä¸‰æ¡é“¾ï¼Œå…¶å®ä»£è¡¨äº†ä¸‰æ¡ DNAT è§„åˆ™ã€‚DNAT è§„åˆ™çš„ä½œç”¨ï¼Œå°±æ˜¯å°† IP åŒ…çš„ç›®çš„åœ°å€å’Œç«¯å£ï¼Œæ”¹æˆ <code>--to-destination</code> æ‰€æŒ‡å®šçš„æ–°çš„ç›®çš„åœ°å€å’Œç«¯å£ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªç›®çš„åœ°å€å’Œç«¯å£ï¼Œæ­£æ˜¯åç«¯ Pod çš„ IP åœ°å€å’Œç«¯å£ã€‚è€Œè¿™ä¸€åˆ‡å‘ç”Ÿåœ¨Netfilterçš„<code>PREROUTING</code>é“¾ä¸Šï¼Œæ¥ä¸‹æ¥Netfilterå°±ä¼šæ ¹æ®è¿™ä¸ªç›®çš„åœ°å€ï¼Œå¯¹æ•°æ®åŒ…è¿›è¡Œè·¯ç”±ã€‚</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A KUBE-SEP-A66XJ5Q22M6AZV5X -p tcp -m tcp -j DNAT --to-destination 10.20.126.169:6443
<span class="ln">2</span>-A KUBE-SEP-TYGT5TFZZ2W5DK4V -p tcp -m tcp -j DNAT --to-destination 10.28.116.8:6443
<span class="ln">3</span>-A KUBE-SEP-KQD4HGXQYU3ORDNS -p tcp -m tcp -j DNAT --to-destination 10.28.126.199:6443
</code></pre></div><ol start="6">
<li>å¦‚æœç›®çš„Podçš„IPåœ°å€å°±åœ¨æœ¬èŠ‚ç‚¹ï¼Œåˆ™æ•°æ®åŒ…ä¼šè¢«è·¯ç”±å›cniç½‘æ¡¥ï¼Œç”±cniç½‘æ¡¥è¿›è¡Œè½¬å‘ï¼›å¦‚æœç›®çš„Podçš„IPåœ°å€åœ¨å…¶ä»–èŠ‚ç‚¹ï¼Œåˆ™è¦è¿›è¡Œä¸€æ¬¡å®¹å™¨è·¨èŠ‚ç‚¹é€šä¿¡ï¼Œè·¨èŠ‚ç‚¹é€šä¿¡çš„è¿‡ç¨‹å¯ä»¥å‚è€ƒ<a href="https://cvvz.github.io/post/k8s-network-cross-host/">kubernetesç½‘ç»œä¹‹CNIä¸è·¨èŠ‚ç‚¹é€šä¿¡åŸç†</a>è¿™ç¯‡æ–‡ç« ã€‚</li>
</ol>
<h2 id="ä»é›†ç¾¤å¤–éƒ¨è®¿é—®nodeportæœåŠ¡">ä»é›†ç¾¤å¤–éƒ¨è®¿é—®NodePortæœåŠ¡</h2>
<p>ä»¥ä¸‹é¢è¿™ä¸ªæœåŠ¡(<strong>NodePortä¸º<code>31849</code></strong>)ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>âœ  ~ k get svc webapp
<span class="ln">2</span>NAME     TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
<span class="ln">3</span>webapp   NodePort   192.168.15.113   &lt;none&gt;        8081:31849/TCP   319d
</code></pre></div><ol>
<li>kube-proxyä¼šåœ¨ä¸»æœºä¸Šæ‰“å¼€31849ç«¯å£ï¼Œå¹¶é…ç½®ä¸€ç³»åˆ—iptablesè§„åˆ™ï¼š</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ sudo lsof -i:31849
<span class="ln">2</span>COMMAND      PID USER   FD   TYPE     DEVICE SIZE/OFF NODE NAME
<span class="ln">3</span>kube-prox <span class="m">253942</span> root   12u  IPv6 <span class="m">1852002168</span>      0t0  TCP *:31849 <span class="o">(</span>LISTEN<span class="o">)</span>
</code></pre></div><ol start="2">
<li>å…¥å£é“¾<code>KUBE-NODEPORTS</code>æ˜¯<code>KUBE-SERVICES</code>ä¸­çš„<strong>æœ€åä¸€æ¡è§„åˆ™</strong>ï¼š</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A KUBE-SERVICES -m comment --comment <span class="s2">&#34;kubernetes service nodeports; NOTE: this must be the last rule in this chain&#34;</span> -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS
</code></pre></div><ol start="3">
<li>å…ˆè·³åˆ°<code>KUBE-MARK-MASQ</code>é“¾æ‰“ä¸Š<strong>ç‰¹æ®Šè®°å·<code>0x4000/0x4000</code></strong>ï¼Œè¿™ä¸ªç‰¹æ®Šè®°å·<strong>åç»­åœ¨<code>POSTROUTING</code>é“¾ä¸­è¿›è¡ŒSNATæ—¶ç”¨åˆ°</strong>ã€‚</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A KUBE-NODEPORTS -p tcp -m comment --comment <span class="s2">&#34;default/webapp:&#34;</span> -m tcp --dport <span class="m">31849</span> -j KUBE-MARK-MASQ
<span class="ln">2</span>
<span class="ln">3</span>-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
</code></pre></div><ol start="4">
<li>ç„¶åè·³åˆ°<code>KUBE-SVC-BL7FHTIPVYJBLWZN</code>é“¾ï¼š</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A KUBE-NODEPORTS -p tcp -m comment --comment <span class="s2">&#34;default/webapp:&#34;</span> -m tcp --dport <span class="m">31849</span> -j KUBE-SVC-BL7FHTIPVYJBLWZN
</code></pre></div><ol start="5">
<li>åç»­çš„å¤„ç†æµç¨‹å’Œä¸Šä¸€èŠ‚æè¿°çš„ç›¸åŒï¼Œç›´åˆ°æ‰¾åˆ°äº†ç›®çš„Pod IPã€‚</li>
<li>å¦‚æœç›®çš„Pod IPåœ°å€å°±åœ¨æœ¬èŠ‚ç‚¹ï¼Œåˆ™è·¯ç”±ç»™cniç½‘æ¡¥è½¬å‘ï¼›å¦‚æœç›®çš„Pod IPåœ¨å…¶ä»–èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦è¿›è¡Œå®¹å™¨è·¨èŠ‚ç‚¹é€šä¿¡ã€‚<strong>æ³¨æ„ï¼Œè¿™ç§æƒ…å½¢ä¸‹ï¼Œæœ¬èŠ‚ç‚¹ç›¸å½“äºç½‘å…³çš„è§’è‰²ï¼Œåœ¨å°†æºæ•°æ®åŒ…è½¬å‘å‡ºå»ä¹‹å‰ï¼Œéœ€è¦è¿›è¡ŒSNATï¼Œå°†æºæ•°æ®åŒ…çš„æºIPåœ°å€ï¼Œè½¬æ¢ä¸ºç½‘å…³ï¼ˆæœ¬èŠ‚ç‚¹ï¼‰çš„IPåœ°å€ï¼Œè¿™æ ·ï¼Œæ•°æ®åŒ…æ‰å¯èƒ½åŸè·¯è¿”å›ï¼Œå³ä»ç›®çš„èŠ‚ç‚¹ç»è¿‡æœ¬èŠ‚ç‚¹è¿”å›åˆ°å®é™…çš„k8sé›†ç¾¤å¤–éƒ¨çš„å®¢æˆ·ç«¯</strong>ï¼š</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A KUBE-POSTROUTING -m comment --comment <span class="s2">&#34;kubernetes service traffic requiring SNAT&#34;</span> -m mark --mark 0x4000/0x4000 -j MASQUERADE
</code></pre></div><p>è¿™æ¡è§„åˆ™çš„æ„æ€å°±æ˜¯ï¼šå¸¦æœ‰<code>0x4000/0x4000</code>è¿™ä¸ªç‰¹æ®Šæ ‡è®°çš„æ•°æ®åŒ…åœ¨ç¦»å¼€èŠ‚ç‚¹ä¹‹å‰ï¼Œåœ¨<code>POSTROUTING</code>é“¾ä¸Šè¿›è¡Œä¸€æ¬¡SNATï¼Œå³<code>MASQUERADE</code>ã€‚è€Œè¿™ä¸ªç‰¹æ®Šæ ‡è®°ï¼Œå¦‚å‰æ‰€è¿°ï¼Œæ˜¯åœ¨å¤–éƒ¨å®¢æˆ·ç«¯æ•°æ®æµå…¥èŠ‚ç‚¹æ—¶æ‰“ä¸Šå»çš„ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œkube-proxy iptablesæ¨¡å¼ä¸­ï¼Œæœ€é‡è¦çš„æ˜¯ä¸‹é¢è¿™äº”æ¡é“¾ï¼š</p>
<ul>
<li><strong>KUBE-SERVICES</strong>ï¼šClusterIPæ–¹å¼è®¿é—®çš„å…¥å£é“¾ï¼›</li>
<li><strong>KUBE-NODEPORTS</strong>ï¼šNodePortæ–¹å¼è®¿é—®çš„å…¥å£é“¾ï¼›</li>
<li><strong>KUBE-SVC-</strong>*ï¼šç›¸å½“äºä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œå°†æ•°æ®åŒ…å¹³å‡åˆ†å‘ç»™<code>KUBE-SEP-*</code>é“¾ï¼›</li>
<li><strong>KUBE-SEP-</strong>*ï¼šé€šè¿‡DNATå°†Serviceçš„ç›®çš„IPå’Œç«¯å£ï¼Œæ›¿æ¢ä¸ºåç«¯Podçš„IPå’Œç«¯å£ï¼Œä»è€Œå°†æµé‡è½¬å‘åˆ°åç«¯Podã€‚</li>
<li><strong>KUBE-POSTROUTING</strong>ï¼šé€šè¿‡å¯¹è·¯ç”±åˆ°å…¶ä»–èŠ‚ç‚¹çš„æ•°æ®åŒ…è¿›è¡ŒSNATï¼Œä½¿å…¶èƒ½å¤ŸåŸè·¯è¿”å›ã€‚</li>
</ul>
<blockquote>
<p>å¯¹äºNodePortç±»å‹çš„serviceï¼Œ<strong>å¦‚æœæœ¬èŠ‚ç‚¹ä¸Šæ²¡æœ‰ç›®çš„Podï¼Œåˆ™æœ¬èŠ‚ç‚¹èµ·åˆ°çš„æ˜¯ç½‘å…³çš„ä½œç”¨</strong>ï¼Œå°†æ•°æ®è·¯ç”±åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>è®¿é—®Pod IPçš„é“¾è·¯ä¼šå¤šä¸€è·³</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†<code>externalTrafficPolicy</code>å­—æ®µè®¾ç½®ä¸º<code>local</code>ï¼Œå½“è¿™æ ·æœ¬èŠ‚ç‚¹ä¸Šä¸å­˜åœ¨Podæ—¶ï¼Œ<code>FORWARD</code>é“¾ä¸Šçš„<code>filter</code>è¡¨è§„åˆ™ä¼šç›´æ¥æŠŠåŒ…dropæ‰ï¼Œè€Œä¸ä¼šä»æœ¬èŠ‚ç‚¹è½¬å‘å‡ºå»ï¼š</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>-A KUBE-NODEPORTS -p tcp -m comment --comment <span class="s2">&#34;default/webapp:&#34;</span> -m tcp --dport <span class="m">31849</span> -j KUBE-XLB-BL7FHTIPVYJBLWZN
<span class="ln">2</span>
<span class="ln">3</span>-A KUBE-XLB-BL7FHTIPVYJBLWZN -m comment --comment <span class="s2">&#34;default/webapp: has no local endpoints&#34;</span> -j KUBE-MARK-DROP
<span class="ln">4</span>
<span class="ln">5</span>-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000
<span class="ln">6</span>
<span class="ln">7</span>-A KUBE-FIREWALL -m comment --comment <span class="s2">&#34;kubernetes firewall for dropping marked packets&#34;</span> -m mark --mark 0x8000/0x8000 -j DROP
</code></pre></div><h2 id="kube-proxyçš„ipvsæ¨¡å¼">kube-proxyçš„IPVSæ¨¡å¼</h2>
<p>ä¸Šè¿°æµç¨‹æè¿°çš„æ˜¯kube-proxyçš„iptablesæ¨¡å¼çš„å·¥ä½œæµç¨‹ï¼Œè¿™ä¸ªæ¨¡å¼æœ€å¤§çš„é—®é¢˜åœ¨äºï¼š</p>
<ul>
<li>kube-proxyéœ€è¦ä¸ºserviceé…ç½®å¤§é‡çš„iptablesè§„åˆ™ï¼Œå¹¶ä¸”åˆ·æ–°è¿™äº›è§„åˆ™ä»¥ç¡®ä¿æ­£ç¡®æ€§ï¼›</li>
<li>iptablesçš„è§„åˆ™æ˜¯ä»¥é“¾è¡¨çš„å½¢å¼ä¿å­˜çš„ï¼Œå¯¹iptablesçš„åˆ·æ–°éœ€è¦éå†é“¾è¡¨</li>
</ul>
<p>è§£å†³åŠæ³•å°±æ˜¯ä½¿ç”¨IPVSæ¨¡å¼çš„kube-proxyã€‚IPVSæ˜¯Linuxå†…æ ¸å®ç°çš„å››å±‚è´Ÿè½½å‡è¡¡ï¼Œå› æ­¤ç›¸æ¯”äºé€šè¿‡é…ç½®iptablesè§„åˆ™è¿›è¡Œâ€œæŠ•æœºå–å·§â€å¼çš„è´Ÿè½½å‡è¡¡ï¼ŒIPVSæ›´åŠ ä¸“ä¸šã€‚IPVS
å’Œiptablesä¸€æ ·åº•å±‚ä¹Ÿæ˜¯åŸºäºnetfilterï¼Œä½†ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼ˆæ•£åˆ—è¡¨ï¼‰ï¼Œå…è®¸å‡ ä¹æ— é™çš„è§„æ¨¡æ‰©å¼ ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªserviceæ—¶ï¼ŒIPVSæ¨¡å¼kube-proxyä¼šåˆ›å»ºä¸€å—è™šæ‹Ÿç½‘å¡ï¼Œå¹¶ä¸”æŠŠserviceçš„ClusterIPç»‘åœ¨ç½‘å¡ä¸Šï¼Œç„¶åè®¾ç½®è¿™ä¸ªç½‘å¡çš„åç«¯real serverï¼Œå¯¹åº”çš„æ˜¯EndPointsï¼Œå¹¶è®¾ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚è¿™æ ·ï¼Œæ•°æ®åŒ…å°±ä¼šå…ˆå‘é€åˆ°kube-proxyçš„è™šæ‹Ÿç½‘å¡ä¸Šï¼Œç„¶åè½¬å‘åˆ°åç«¯Podã€‚</p>
<p>IPVSæ²¡æœ‰SNATçš„èƒ½åŠ›ï¼Œæ‰€ä»¥åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œä¾ç„¶éœ€è¦ä¾èµ–iptablesã€‚ä½†æ˜¯ä½¿ç”¨IPVSæ¨¡å¼çš„kube-proxyï¼Œä¸å­˜åœ¨ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ï¼Œæ€§èƒ½è¦ä¼˜äºiptablesæ¨¡å¼ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>kubernetesç½‘ç»œä¹‹CNIä¸è·¨èŠ‚ç‚¹é€šä¿¡åŸç†</title>
			<link>https://cvvz.fun/post/k8s-network-cross-host/</link>
			<pubDate>Wed, 30 Dec 2020 09:51:44 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/k8s-network-cross-host/</guid>
			<description>åˆå§‹åŒ–infraå®¹å™¨ç½‘ç»œç¯å¢ƒ å½“kubeleté€šè¿‡è°ƒç”¨CRIçš„RunPodSandboxåˆ›å»ºå¥½PodSandboxï¼Œå³infraå®¹å™¨åï¼Œå°±éœ€è¦</description>
			<content type="html"><![CDATA[<h2 id="åˆå§‹åŒ–infraå®¹å™¨ç½‘ç»œç¯å¢ƒ">åˆå§‹åŒ–infraå®¹å™¨ç½‘ç»œç¯å¢ƒ</h2>
<p>å½“kubeleté€šè¿‡è°ƒç”¨CRIçš„<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/cri-api/pkg/apis/services.go#L66">RunPodSandbox</a>åˆ›å»ºå¥½<code>PodSandbox</code>ï¼Œå³infraå®¹å™¨åï¼Œå°±éœ€è¦è°ƒç”¨<a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/dockershim/network/plugins.go#L73">SetUpPod</a>æ–¹æ³•ä¸ºPodï¼ˆinfraå®¹å™¨ï¼‰åˆ›å»ºç½‘ç»œç¯å¢ƒï¼Œåº•å±‚æ˜¯è°ƒç”¨CNIçš„<a href="https://github.com/containernetworking/cni/blob/master/libcni/api.go#L80">AddNetwork</a>ä¸ºinfraå®¹å™¨é…ç½®ç½‘ç»œç¯å¢ƒã€‚</p>
<p>è¿™ä¸ªé…ç½®ç½‘ç»œç¯å¢ƒçš„è¿‡ç¨‹ï¼Œå°±æ˜¯kubeletä»cnié…ç½®æ–‡ä»¶ç›®å½•ï¼ˆ<code>--cni-conf-dir</code>å‚æ•°æŒ‡å®šï¼‰ä¸­è¯»å–æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨è¯¥æ–‡ä»¶ä¸­çš„CNIé…ç½®é…ç½®infraç½‘ç»œã€‚kubeletæ ¹æ®é…ç½®æ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨CNIæ’ä»¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå­˜æ”¾åœ¨<code>--cni-bin-dir</code>å‚æ•°æŒ‡å®šçš„ç›®å½•ä¸‹ï¼‰å®é™…é…ç½®infraç½‘ç»œã€‚</p>
<p>è¿™äº› CNI çš„åŸºç¡€å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŒ‰ç…§åŠŸèƒ½å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ol>
<li><strong>Main æ’ä»¶</strong>ï¼Œå®ƒæ˜¯ç”¨æ¥åˆ›å»ºå…·ä½“ç½‘ç»œè®¾å¤‡çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚bridgeï¼ˆç½‘æ¡¥è®¾å¤‡ï¼‰ã€loopbackï¼ˆlo è®¾å¤‡ï¼‰ã€ptpï¼ˆVeth Pair è®¾å¤‡ï¼‰ç­‰ç­‰</li>
<li><strong>IPAMï¼ˆIP Address Managementï¼‰æ’ä»¶</strong>ï¼Œç”¨æ¥ç»™å®¹å™¨åˆ†é…IPåœ°å€ï¼Œæ¯”å¦‚dhcpå’Œhost-localã€‚</li>
<li><strong>CNI ç¤¾åŒºç»´æŠ¤çš„ç¬¬ä¸‰æ–¹ CNI æ’ä»¶</strong>ï¼Œæ¯”å¦‚<code>flannel</code>ï¼Œæä¾›è·¨ä¸»æœºé€šä¿¡æ–¹æ¡ˆ</li>
</ol>
<p>åˆå§‹åŒ–ä¸€ä¸ªå®¹å™¨ç½‘ç»œç¯å¢ƒçš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ²¡æœ‰ç½‘æ¡¥å°±ä½¿ç”¨<code>bridge</code>åˆ›å»ºä¸€ä¸ªç½‘æ¡¥è®¾å¤‡</li>
<li>ä½¿ç”¨<code>ptp</code>åˆ›å»ºä¸€ä¸ªveth pairè®¾å¤‡ï¼Œå¹¶ä¸”æŠŠä¸€ç«¯æ’åœ¨å®¹å™¨é‡Œï¼Œæˆä¸ºå®¹å™¨çš„eth0ç½‘å¡ï¼Œå¦ä¸€ç«¯æ’åœ¨ç½‘æ¡¥ä¸Š</li>
<li>ä½¿ç”¨<code>dhcp</code>æˆ–<code>host-local</code>ä¸ºeth0ç½‘å¡åˆ†é…IPåœ°å€</li>
<li>è°ƒç”¨ç¬¬ä¸‰æ–¹CNIæ’ä»¶ï¼Œæ¯”å¦‚<code>flannel</code>ï¼Œå®ç°å®¹å™¨è·¨ä¸»æœºé€šä¿¡æ–¹æ¡ˆ</li>
</ol>
<h2 id="å®¹å™¨è·¨èŠ‚ç‚¹é€šä¿¡">å®¹å™¨è·¨èŠ‚ç‚¹é€šä¿¡</h2>
<p>åœ¨<a href="https://cvvz.github.io/post/container-network/">æµ…è°ˆå•æœºå®¹å™¨ç½‘ç»œ</a>ä¸€æ–‡ä¸­ï¼Œå·²ç»è¯¦ç»†åˆ†æäº†åŒä¸€ä¸»æœºå†…éƒ¨å®¹å™¨ä¹‹é—´é€šè¿‡veth + ç½‘æ¡¥çš„æ–¹å¼é€šä¿¡çš„è¿‡ç¨‹ï¼Œä¸‹é¢åˆ†æä¸€ä¸‹å®¹å™¨è·¨ä¸»æœºé€šä¿¡çš„è¿‡ç¨‹ã€‚</p>
<p>å®¹å™¨çš„è·¨ä¸»æœºç½‘ç»œæ–¹æ¡ˆå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š<strong>overlay</strong>å’Œ<strong>underlay</strong>ã€‚</p>
<h3 id="underlayå’Œoverlay">underlayå’Œoverlay</h3>
<p>æ‰€è°“underlayï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åœ¨å®¿ä¸»æœºç½‘ç»œä¸Šçš„è™šæ‹Ÿå±‚ï¼Œå®¹å™¨å’Œå®¿ä¸»æœºå¤„äºåŒä¸€ä¸ªç½‘ç»œå±‚é¢ä¸Šã€‚</p>
<blockquote>
<p>åœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼ŒKubernetes å†…å¤–ç½‘ç»œæ˜¯äº’é€šçš„ï¼Œè¿è¡Œåœ¨kubernetesä¸­çš„å®¹å™¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„å’Œå…¬å¸å†…éƒ¨å·²æœ‰çš„éäº‘åŸç”ŸåŸºç¡€è®¾æ–½è¿›è¡Œè”åŠ¨ï¼Œæ¯”å¦‚DNSã€è´Ÿè½½å‡è¡¡ã€é…ç½®ä¸­å¿ƒç­‰ï¼Œè€Œä¸éœ€è¦å€ŸåŠ©kuberneteså†…éƒ¨çš„DNSã€ingresså’ŒserviceåšæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚</p>
</blockquote>
<p>æ‰€è°“overlayï¼Œå…¶å®å°±æ˜¯åœ¨å®¹å™¨çš„IPåŒ…å¤–é¢é™„åŠ é¢å¤–çš„æ•°æ®åŒ…å¤´ï¼Œç„¶å<strong>æ•´ä½“ä½œä¸ºå®¿ä¸»æœºç½‘ç»œæŠ¥æ–‡ä¸­çš„æ•°æ®è¿›è¡Œä¼ è¾“</strong>ã€‚å®¹å™¨çš„IPåŒ…åŠ ä¸Šé¢å¤–çš„æ•°æ®åŒ…å¤´å°±ç”¨äºè·¨ä¸»æœºçš„å®¹å™¨ä¹‹é—´é€šä¿¡ï¼Œ<strong>å®¹å™¨ç½‘ç»œå°±ç›¸å½“äºè¦†ç›–(overlay)åœ¨å®¿ä¸»æœºç½‘ç»œä¸Šçš„ä¸€å±‚è™šæ‹Ÿç½‘ç»œ</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/overlay-network.png" width="600px"/> 
</figure>

<h3 id="flannel-udpæ¨¡å¼">Flannel UDPæ¨¡å¼</h3>
<p>Flannelçš„UDPæ¨¡å¼çš„å·¥ä½œæµç¨‹ï¼š</p>
<ol>
<li>container-1æ ¹æ®é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œå°†IPåŒ…å‘å¾€cniç½‘æ¡¥ï¼Œå‡ºç°åœ¨å®¿ä¸»æœºçš„ç½‘ç»œæ ˆä¸Šï¼›</li>
<li>flanneldé¢„å…ˆåœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºå¥½äº†è·¯ç”±è§„åˆ™ï¼Œæ•°æ®åŒ…åˆ°è¾¾cniç½‘æ¡¥åï¼Œéšå³è¢«è½¬å‘ç»™äº†flannel0</li>
<li>flannel0çš„åŠŸèƒ½å°±æ˜¯å°†æ•°æ®åŒ…ä¼ ç»™ç”¨æˆ·æ€çš„flanneldè¿›ç¨‹</li>
<li>flanneldè¿›ç¨‹æŸ¥è¯¢etcdï¼Œæ‰¾åˆ°ç›®çš„å®¹å™¨ipåœ°å€å’Œç›®çš„å®¿ä¸»æœºipçš„å¯¹åº”å…³ç³»ï¼Œç„¶åå°†åŸipåŒ…å°è£…åœ¨ä¸€ä¸ªudpåŒ…ä¸­å‘é€åˆ°ç›®çš„å®¿ä¸»æœºä¸Šçš„flanneldè¿›ç¨‹ã€‚</li>
<li>ç›®çš„å®¿ä¸»æœºçš„flanneldæ”¶åˆ°åŒ…åï¼Œåå‘å¤„ç†ä¸€éå°±å‘é€åˆ°äº†ç›®çš„å®¹å™¨ä¸­ã€‚</li>
</ol>
<p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/flannel-udp.jpg" width="600px"/> 
</figure>

<p>ç”±äºè¿™ä¸­é—´æ•°æ®ä»flannel0å‘é€åˆ°äº†ç”¨æˆ·æ€çš„flanneldï¼Œåˆä»flanneldå‘é€åˆ°å®¿ä¸»æœºçš„eth0ç½‘å¡ï¼Œç”¨æˆ·æ€å’Œå†…æ ¸æ€å‘ç”Ÿäº†ä¸¤æ¬¡æ•°æ®ä¼ é€’ï¼Œä¸”åœ¨ç”¨æˆ·æ€è¿˜è¿›è¡Œäº†å°åŒ…æ“ä½œï¼Œæ‰€ä»¥udpæ¨¡å¼æ€§èƒ½å¾ˆå·®ã€‚</p>
<h3 id="flannel-vxlanæ¨¡å¼">Flannel VXLANæ¨¡å¼</h3>
<p>Flannel VXLANæ¨¡å¼çš„åŸç†å’ŒUDPæ¨¡å¼å·®ä¸å¤šï¼ŒåŒºåˆ«åœ¨äºï¼š</p>
<ol>
<li>UDPæ¨¡å¼åˆ›å»ºçš„æ˜¯TUNè®¾å¤‡(flannel0)ï¼ŒVXLANæ¨¡å¼åˆ›å»ºçš„æ˜¯VTEPè®¾å¤‡ï¼ˆflannel.1ï¼‰ã€‚</li>
<li>VTEPè®¾å¤‡å…¨ç¨‹å·¥ä½œåœ¨å†…æ ¸æ€ï¼Œæ€§èƒ½æ¯”UDPæ¨¡å¼æ›´å¥½ã€‚</li>
</ol>
<p>VXLANæ¨¡å¼çš„å·¥ä½œæµç¨‹ï¼š</p>
<ol>
<li>container-1æ ¹æ®é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œå°†IPåŒ…å‘å¾€cniç½‘æ¡¥ï¼Œå‡ºç°åœ¨å®¿ä¸»æœºçš„ç½‘ç»œæ ˆä¸Šï¼›</li>
<li>flanneldé¢„å…ˆåœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºå¥½äº†è·¯ç”±è§„åˆ™ï¼Œæ•°æ®åŒ…åˆ°è¾¾cniç½‘æ¡¥åï¼Œéšå³è¢«è½¬å‘ç»™äº†flannel.1ï¼Œflannel.1æ˜¯ä¸€ä¸ªVTEPè®¾å¤‡ï¼Œ<strong>å®ƒæ—¢æœ‰ IP åœ°å€ï¼Œä¹Ÿæœ‰ MAC åœ°å€</strong>ï¼›</li>
<li><strong>åœ¨node2ä¸Šçš„ç›®çš„VTEPè®¾å¤‡å¯åŠ¨æ—¶ï¼Œnode1ä¸Šçš„flanneldä¼šå°†ç›®çš„VTEPè®¾å¤‡çš„IPåœ°å€å’ŒMACåœ°å€åˆ†åˆ«å†™åˆ°node1ä¸Šçš„è·¯ç”±è¡¨å’ŒARPç¼“å­˜è¡¨ä¸­</strong>ã€‚</li>
<li>å› æ­¤ï¼Œnode1ä¸Šçš„flannel.1é€šè¿‡æŸ¥è¯¢è·¯ç”±è¡¨ï¼ŒçŸ¥é“è¦å‘å¾€ç›®çš„å®¹å™¨ï¼Œéœ€è¦ç»è¿‡10.1.16.0è¿™ä¸ªç½‘å…³ã€‚<strong>å…¶å®è¿™ä¸ªç½‘å…³ï¼Œå°±æ˜¯ç›®çš„VTEPè®¾å¤‡çš„ipåœ°å€</strong>ã€‚</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ route -n
<span class="ln">2</span>Kernel IP routing table
<span class="ln">3</span>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="ln">4</span>...
<span class="ln">5</span>10.1.16.0       10.1.16.0       255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> flannel.1
</code></pre></div><ol start="5">
<li>åˆç”±äº<strong>è¿™ä¸ªç½‘å…³çš„MACåœ°å€ï¼Œäº‹å…ˆå·²ç»è¢«flanneldå†™åˆ°äº†ARPç¼“å­˜è¡¨ä¸­</strong>ï¼Œæ‰€ä»¥å†…æ ¸ç›´æ¥æŠŠç›®çš„VTEPè®¾å¤‡çš„MACåœ°å€å°è£…åˆ°é“¾è·¯å±‚çš„å¸§å¤´å³å¯ï¼š
<figure>
    <img src="/flannel-vxlan-frame.jpg" width="500px"/> 
</figure>
</li>
<li><strong>flanneldè¿˜è´Ÿè´£ç»´æŠ¤FDBï¼ˆè½¬å‘æ•°æ®åº“ï¼‰ä¸­çš„ä¿¡æ¯</strong>ï¼ŒæŸ¥è¯¢FDBï¼Œå°±å¯ä»¥é€šè¿‡è¿™ä¸ªç›®çš„VTEPè®¾å¤‡çš„MACåœ°å€æ‰¾åˆ°å®¿ä¸»æœºNode2çš„ipåœ°å€ã€‚</li>
<li>æœ‰äº†ç›®çš„IPåœ°å€ï¼Œæ¥ä¸‹æ¥è¿›è¡Œä¸€æ¬¡å¸¸è§„çš„ã€å®¿ä¸»æœºç½‘ç»œä¸Šçš„å°åŒ…å³å¯ã€‚</li>
</ol>
<p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/flannel-vxlan.jpg" width="600px"/> 
</figure>

<p>å¯ä»¥çœ‹å‡ºï¼ŒVXLANæ¨¡å¼ä¸­ï¼Œflanneldç»´æŠ¤çš„éƒ½æ˜¯å†…æ ¸æ€æ•°æ®ï¼šè·¯ç”±è¡¨ã€arpç¼“å­˜è¡¨ã€FDBï¼ŒVXLANæ¨¡å¼å‡ ä¹å…¨ç¨‹è¿è¡Œåœ¨å†…æ ¸æ€ã€‚æ€§èƒ½è¦æ¯”UDPæ¨¡å¼å¥½ä¸å°‘ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>kubernetesç½‘ç»œä¹‹DNS</title>
			<link>https://cvvz.fun/post/k8s-network-dns/</link>
			<pubDate>Wed, 30 Dec 2020 09:41:51 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/k8s-network-dns/</guid>
			<description>é»˜è®¤DNSç­–ç•¥ Podé»˜è®¤çš„dnsç­–ç•¥æ˜¯ ClusterFirstï¼Œæ„æ€æ˜¯å…ˆé€šè¿‡kubernetesçš„æƒå¨DNSæœåŠ¡å™¨ï¼ˆå¦‚CoreDNSï¼‰ç›´æ¥è§£</description>
			<content type="html"><![CDATA[<h2 id="é»˜è®¤dnsç­–ç•¥">é»˜è®¤DNSç­–ç•¥</h2>
<p>Podé»˜è®¤çš„<a href="https://kubernetes.io/zh/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy">dnsç­–ç•¥</a>æ˜¯ <code>ClusterFirst</code>ï¼Œæ„æ€æ˜¯å…ˆé€šè¿‡kubernetesçš„<strong>æƒå¨DNSæœåŠ¡å™¨</strong>ï¼ˆå¦‚CoreDNSï¼‰ç›´æ¥è§£æå‡ºAè®°å½•æˆ–CNAMEè®°å½•ï¼›å¦‚æœè§£æå¤±è´¥ï¼Œå†æ ¹æ®é…ç½®ï¼Œå°†å…¶è½¬å‘ç»™<strong>ä¸Šæ¸¸DNSæœåŠ¡å™¨</strong>ã€‚ä»¥CoreDNSä¸ºä¾‹ï¼Œå®ƒçš„é…ç½®æ–‡ä»¶Corefileå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>âœ  ~ kubectl get cm -n kube-system coredns -o yaml
<span class="ln"> 2</span>apiVersion: v1
<span class="ln"> 3</span>data:
<span class="ln"> 4</span>  Corefile: <span class="p">|</span>
<span class="ln"> 5</span>    .:53 <span class="o">{</span>
<span class="ln"> 6</span>        errors
<span class="ln"> 7</span>        health <span class="o">{</span>
<span class="ln"> 8</span>           lameduck 5s
<span class="ln"> 9</span>        <span class="o">}</span>
<span class="ln">10</span>        ready
<span class="ln">11</span>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class="o">{</span>
<span class="ln">12</span>           pods insecure
<span class="ln">13</span>           fallthrough in-addr.arpa ip6.arpa
<span class="ln">14</span>           ttl <span class="m">30</span>
<span class="ln">15</span>        <span class="o">}</span>
<span class="ln">16</span>        prometheus :9153
<span class="ln">17</span>        forward . /etc/resolv.conf
<span class="ln">18</span>        cache <span class="m">30</span>
<span class="ln">19</span>        loop
<span class="ln">20</span>        reload
<span class="ln">21</span>        loadbalance
<span class="ln">22</span>    <span class="o">}</span>
<span class="ln">23</span>kind: ConfigMap
<span class="ln">24</span>...
</code></pre></div><p>ç¬¬17è¡Œä½¿ç”¨<a href="https://coredns.io/plugins/forward/">forwardæ’ä»¶</a>é…ç½®äº†ä¸Šæ¸¸åŸŸåæœåŠ¡å™¨ä¸ºä¸»æœºçš„<code>/etc/resolv.conf</code>ä¸­æŒ‡å®šçš„<code>nameserver</code>ã€‚</p>
<h2 id="serviceå’Œdns">Serviceå’ŒDNS</h2>
<p>å°½ç®¡kubeletåœ¨å¯åŠ¨å®¹å™¨æ—¶ï¼Œä¼šå°†åŒnamespaceä¸‹çš„Serviceä¿¡æ¯æ³¨å…¥åˆ°å®¹å™¨çš„ç¯å¢ƒå˜é‡ä¸­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>âœ  ~ kubectl get svc <span class="p">|</span> grep kubernetes
<span class="ln"> 2</span>kubernetes                      ClusterIP   192.168.0.1       &lt;none&gt;        443/TCP                                             347d
<span class="ln"> 3</span>
<span class="ln"> 4</span>âœ  ~ kubectl <span class="nb">exec</span> -it debug-pod -n default -- env <span class="p">|</span> grep KUBERNETES
<span class="ln"> 5</span><span class="nv">KUBERNETES_SERVICE_PORT</span><span class="o">=</span><span class="m">443</span>
<span class="ln"> 6</span><span class="nv">KUBERNETES_PORT</span><span class="o">=</span>tcp://192.168.0.1:443
<span class="ln"> 7</span><span class="nv">KUBERNETES_PORT_443_TCP_ADDR</span><span class="o">=</span>192.168.0.1
<span class="ln"> 8</span><span class="nv">KUBERNETES_PORT_443_TCP_PORT</span><span class="o">=</span><span class="m">443</span>
<span class="ln"> 9</span><span class="nv">KUBERNETES_PORT_443_TCP_PROTO</span><span class="o">=</span>tcp
<span class="ln">10</span><span class="nv">KUBERNETES_PORT_443_TCP</span><span class="o">=</span>tcp://192.168.0.1:443
<span class="ln">11</span><span class="nv">KUBERNETES_SERVICE_PORT_HTTPS</span><span class="o">=</span><span class="m">443</span>
<span class="ln">12</span><span class="nv">KUBERNETES_SERVICE_HOST</span><span class="o">=</span>192.168.0.1
</code></pre></div><p>ä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨DNSåŸŸåè§£æçš„æ–¹å¼è¿›è¡ŒæœåŠ¡æ³¨å†Œå’Œå‘ç°ã€‚</p>
<p>Kubernetesä¸­çš„DNSåº”ç”¨éƒ¨ç½²å¥½ä»¥åï¼Œä¼šå¯¹å¤–æš´éœ²ä¸€ä¸ªæœåŠ¡ï¼Œé›†ç¾¤å†…çš„å®¹å™¨å¯ä»¥é€šè¿‡è®¿é—®è¯¥æœåŠ¡çš„Cluster IPè¿›è¡ŒåŸŸåè§£æã€‚DNSæœåŠ¡çš„Cluster IPç”±Kubeletçš„<code>cluster-dns</code>å‚æ•°æŒ‡å®šã€‚å¹¶ä¸”åœ¨åˆ›å»ºPodæ—¶ï¼Œç”±Kubeletå°†DNS Serverçš„ä¿¡æ¯å†™å…¥å®¹å™¨çš„<code>/etc/resolv.conf</code>æ–‡ä»¶ä¸­ã€‚</p>
<p>æŸ¥çœ‹<code>resolv.conf</code>æ–‡ä»¶çš„é…ç½®ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>âœ  ~ k <span class="nb">exec</span> -it debug-pod -n default -- cat /etc/resolv.conf
<span class="ln">2</span>nameserver 192.168.0.2
<span class="ln">3</span>search default.svc.cluster.local svc.cluster.local cluster.local
<span class="ln">4</span>options ndots:5
</code></pre></div><ul>
<li>
<p><code>nameserver 192.168.0.2</code>è¿™ä¸€è¡Œå³è¡¨ç¤ºDNSæœåŠ¡çš„åœ°å€ï¼ˆCluster IPï¼‰ä¸º<code>192.168.0.2</code>ã€‚</p>
</li>
<li>
<p><code>search</code>è¿™ä¸€è¡Œè¡¨ç¤ºï¼Œå¦‚æœæ— æ³•ç›´æ¥è§£æåŸŸåï¼Œåˆ™ä¼šå°è¯•åŠ ä¸Š<code>default.svc.cluster.local</code>, <code>svc.cluster.local</code>, <code>cluster.local</code>åç¼€è¿›è¡ŒåŸŸåè§£æã€‚</p>
<blockquote>
<p>å…¶ä¸­<code>default</code>æ˜¯namespaceï¼Œ<code>cluster.local</code>æ˜¯é»˜è®¤çš„é›†ç¾¤åŸŸååç¼€ï¼Œkubeletä¹Ÿå¯ä»¥é€šè¿‡<code>--cluster-domain</code>å‚æ•°è¿›è¡Œé…ç½®ã€‚</p>
</blockquote>
</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<ul>
<li>åŒnamespaceä¸‹ï¼Œå¯ä»¥é€šè¿‡<code>nslookup</code> + <code>kubernetes</code>è§£æåŸŸå</li>
<li>ä¸åŒnamespaceä¸‹ï¼Œå¯ä»¥é€šè¿‡<code>nslookup</code> + <code>kubernetes.default</code>ã€<code>kubernetes.default.svc</code>ã€<code>kubernetes.default.svc.cluster.local</code>è§£æåŸŸå</li>
</ul>
<p>å› ä¸ºdnsæœåŠ¡å™¨ä¼šå¸®ä½ è¡¥é½å…¨åŸŸåï¼š<code>kubernetes.default.svc.cluster.local</code></p>
<blockquote>
<p><code>{svc name}.{svc namespace}.svc.{cluster domain}</code>å°±æ˜¯kubernetesçš„FQDNæ ¼å¼ã€‚</p>
</blockquote>
<h2 id="headless-serviceçš„åŸŸåè§£æ">Headless Serviceçš„åŸŸåè§£æ</h2>
<p><strong>æ— è®ºæ˜¯kube-dnsè¿˜æ˜¯CoreDNSï¼ŒåŸºæœ¬åŸç†éƒ½æ˜¯é€šè¿‡watch Serviceå’ŒPodï¼Œç”ŸæˆDNSè®°å½•</strong>ã€‚å¸¸è§„çš„ClusterIPç±»å‹çš„Serviceçš„åŸŸåè§£æå¦‚ä¸Šæ‰€è¿°ï¼ŒDNSæœåŠ¡ä¼šè¿”å›ä¸€ä¸ª<code>Aè®°å½•</code>ï¼Œå³åŸŸåå’ŒClusterIPçš„å¯¹åº”å…³ç³»ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>âœ  ~ k <span class="nb">exec</span> -it debug-pod -n default -- nslookup kubernetes.default
<span class="ln">2</span>Server:		192.168.0.2
<span class="ln">3</span>Address:	192.168.0.2#53
<span class="ln">4</span>
<span class="ln">5</span>Name:	kubernetes.default.svc.cluster.local
<span class="ln">6</span>Address: 192.168.0.1
</code></pre></div><p>Headless Serviceçš„åŸŸåè§£æç¨å¾®å¤æ‚ä¸€ç‚¹ã€‚</p>
<blockquote>
<p>ClusterIPå¯ä»¥çœ‹ä½œæ˜¯Serviceçš„å¤´ï¼Œè€ŒHeadless Serviceï¼Œé¡¾åæ€ä¹‰ä¹Ÿå°±æ˜¯æŒ‡å®šä»–çš„ClusterIPä¸ºNoneçš„Serviceã€‚</p>
</blockquote>
<h3 id="ç›´æ¥è§£æ">ç›´æ¥è§£æ</h3>
<p>å½“ä½ ç›´æ¥è§£æå®ƒçš„åŸŸåæ—¶ï¼Œè¿”å›çš„æ˜¯EndPointsä¸­çš„Pod IPåˆ—è¡¨ï¼š</p>
<blockquote>
<p>è¿™ä¸ªEndPointsåç«¯çš„Podï¼Œä¸ä»…å¯ä»¥é€šè¿‡åœ¨serviceä¸­æŒ‡å®šselectoræ¥é€‰æ‹©ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰ï¼Œåªè¦åå­—å’ŒserviceåŒåå³å¯ã€‚</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>âœ  ~ k <span class="nb">exec</span> -it debug-pod -n default -- nslookup headless
<span class="ln"> 2</span>Defaulting container name to debug.
<span class="ln"> 3</span>Use <span class="s1">&#39;kubectl describe pod/debug-pod -n default&#39;</span> to see all of the containers in this pod.
<span class="ln"> 4</span>Server:		192.168.0.2
<span class="ln"> 5</span>Address:	192.168.0.2#53
<span class="ln"> 6</span>
<span class="ln"> 7</span>Name:	headless.default.svc.cluster.local
<span class="ln"> 8</span>Address: 1.1.1.1
<span class="ln"> 9</span>Name:	headless.default.svc.cluster.local
<span class="ln">10</span>Address: 2.2.2.2
<span class="ln">11</span>Name:	headless.default.svc.cluster.local
<span class="ln">12</span>Address: 3.3.3.3
</code></pre></div><h3 id="ç»™podç”Ÿæˆaè®°å½•">ç»™Podç”ŸæˆAè®°å½•</h3>
<p>å¦‚æœ<strong>åœ¨<code>Pod.spec</code>ä¸­æŒ‡å®šäº†<code>hostname</code>å’Œ<code>subdomain</code>ï¼Œå¹¶ä¸”<code>subdomain</code>å’Œheadleass serviceçš„åå­—ç›¸åŒ</strong>ï¼Œé‚£ä¹ˆkubernetes DNSä¼šé¢å¤–ç»™è¿™ä¸ªPodçš„FQDNç”ŸæˆAè®°å½•ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>âœ  ~ k <span class="nb">exec</span> -it debug-pod -n default -- nslookup mywebsite.headless.default.svc.cluster.local
<span class="ln">2</span>Server:		192.168.0.2
<span class="ln">3</span>Address:	192.168.0.2#53
<span class="ln">4</span>
<span class="ln">5</span>Name:	mywebsite.headless.default.svc.cluster.local
<span class="ln">6</span>Address: 10.189.97.217
</code></pre></div><blockquote>
<p>Podçš„FQDNæ˜¯ï¼š<code>{hostname}.{subdomain}.{pod namespace}.svc.{cluster domain}</code></p>
</blockquote>
<h3 id="externalname-service">ExternalName Service</h3>
<p>ExternalName ç±»å‹çš„Serviceï¼Œkubernetes DNSä¼šæ ¹æ®<code>ExternalName</code>å­—æ®µï¼Œä¸ºå…¶ç”Ÿæˆ<strong>CNAMEè®°å½•</strong>ï¼Œåœ¨DNSå±‚è¿›è¡Œé‡å®šå‘ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="ln">1</span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="ln">2</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="ln">3</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="ln">4</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">external</span><span class="w">
</span><span class="ln">5</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="ln">6</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="ln">7</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ExternalName</span><span class="w">
</span><span class="ln">8</span><span class="w">  </span><span class="nt">externalName</span><span class="p">:</span><span class="w"> </span><span class="l">my.example.domain.com</span><span class="w">
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>âœ  ~ k <span class="nb">exec</span> -it debug-pod -n default -- nslookup external
<span class="ln">2</span>Server:		192.168.0.2
<span class="ln">3</span>Address:	192.168.0.2#53
<span class="ln">4</span>
<span class="ln">5</span>external.default.svc.cluster.local	canonical <span class="nv">name</span> <span class="o">=</span> my.example.domain.com.
<span class="ln">6</span>Name:	my.example.domain.com
<span class="ln">7</span>Address: 66.96.162.92
</code></pre></div>]]></content>
		</item>
		
		<item>
			<title>å®¹å™¨</title>
			<link>https://cvvz.fun/post/container/</link>
			<pubDate>Thu, 24 Dec 2020 10:33:00 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/container/</guid>
			<description>å®¹å™¨é•œåƒ å®¹å™¨é•œåƒå°±æ˜¯å®¹å™¨çš„rootfsã€‚é€šè¿‡ Dockerfile åˆ¶ä½œå®¹å™¨é•œåƒæ—¶ï¼Œå°±ç›¸å½“äºå¢åŠ  rootfs å±‚ã€‚é€šè¿‡å®¹å™¨é•œåƒè¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å…ˆå°†é•œåƒä¸­çš„æ¯ä¸€å±‚è”</description>
			<content type="html"><![CDATA[<h2 id="å®¹å™¨é•œåƒ">å®¹å™¨é•œåƒ</h2>
<p>å®¹å™¨é•œåƒå°±æ˜¯å®¹å™¨çš„rootfsã€‚é€šè¿‡ Dockerfile åˆ¶ä½œå®¹å™¨é•œåƒæ—¶ï¼Œå°±ç›¸å½“äºå¢åŠ  rootfs å±‚ã€‚é€šè¿‡å®¹å™¨é•œåƒè¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å…ˆå°†é•œåƒä¸­çš„æ¯ä¸€å±‚<strong>è”åˆæŒ‚è½½</strong>åœ¨ä¸€ä¸ªç»Ÿä¸€çš„ç›®å½•ä¸‹ï¼Œç„¶åå†é€šè¿‡<code>chroot</code>æŠŠå®¹å™¨çš„æ ¹ç›®å½•æŒ‚è½½åˆ°è¿™ä¸ªç»Ÿä¸€çš„ç›®å½•ä¸‹ã€‚</p>
<p>é€šè¿‡ Dockerfile ç”Ÿæˆå®¹å™¨é•œåƒæ—¶ï¼Œæ¯ä¸ªåŸè¯­æ‰§è¡Œåï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„é•œåƒå±‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿åŸè¯­æœ¬èº«å¹¶æ²¡æœ‰æ˜æ˜¾åœ°ä¿®æ”¹æ–‡ä»¶çš„æ“ä½œï¼ˆæ¯”å¦‚ï¼ŒENV åŸè¯­ï¼‰ï¼Œå®ƒå¯¹åº”çš„å±‚ä¹Ÿä¼šå­˜åœ¨ã€‚åªä¸è¿‡åœ¨å¤–ç•Œçœ‹æ¥ï¼Œ<strong>è¿™ä¸ªå±‚æ˜¯ç©ºçš„</strong>ã€‚</p>
<p>Docker ä¸­æœ€å¸¸ç”¨çš„è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆ<code>UnionFS</code>ï¼‰æœ‰ä¸‰ç§ï¼š<code>AUFS</code>ã€<code>Devicemapper</code> å’Œ <code>OverlayFS</code>ã€‚</p>
<blockquote>
<p>overlay2 æ–‡ä»¶ç³»ç»Ÿæœ€å¤šæ”¯æŒ 128 ä¸ªå±‚æ•°å åŠ ï¼Œæ¢å¥è¯è¯´ Dockerfile æœ€å¤šåªèƒ½å†™ 128 è¡Œã€‚</p>
</blockquote>
<h2 id="namespace">namespace</h2>
<p>é€šè¿‡æŸ¥çœ‹å®¿ä¸»æœºä¸Šçš„ <code>/proc/${pid}/ns</code> ç›®å½•å¯ä»¥çŸ¥é“å®¹å™¨è¿›ç¨‹å½“å‰çš„namespaceã€‚åŒä¸€ä¸ªPodä¸‹çš„å®¹å™¨ï¼Œå…±äº«å“ªäº›namespaceå‘¢ï¼Ÿçœ‹ä¸€çœ¼å°±çŸ¥é“äº†ï¼š</p>
<figure>
    <img src="/namespace.png" width="650px"/> 
</figure>

<p>å¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li>ä¸å…±äº«çš„namespaceæ˜¯ï¼šmntï¼ˆæŒ‚è½½ç‚¹ï¼‰ã€pidï¼ˆè¿›ç¨‹å·ï¼‰å’Œutsï¼ˆä¸»æœºåï¼‰</li>
<li>å…±äº«çš„namespaceæ˜¯ï¼šipcï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰ã€netï¼ˆç½‘ç»œï¼‰å’Œuserï¼ˆç”¨æˆ·ï¼‰ã€‚</li>
</ul>
<p>æˆ‘ç”¨ <code> kubectl exec -it ${pod} -c ${container} -n ${ns} -- sh</code> å‘½ä»¤è¿è¡Œçš„shè¿›ç¨‹ï¼Œå®ƒçš„namespaceå’Œæˆ‘æŒ‡å®šçš„<code>${container}</code>å®¹å™¨ä¸€æ¨¡ä¸€æ ·ã€‚<code>kubectl exec</code> æœ¬è´¨ä¸Šæ˜¯é€šè¿‡<code>setns</code>ç³»ç»Ÿè°ƒç”¨åŠ å…¥äº†æŒ‡å®šè¿›ç¨‹çš„namespaceã€‚</p>
<figure>
    <img src="/exec-namespace.png" width="650px"/> 
</figure>

<h2 id="cgroups">cgroups</h2>
<h3 id="cpu-cgroup">cpu cgroup</h3>
<ul>
<li>
<p>cpu.cfs_period_usï¼šCFSï¼ˆCompletely Fair Schedulerï¼‰è°ƒåº¦ç®—æ³•çš„ä¸€ä¸ªè°ƒåº¦å‘¨æœŸ</p>
</li>
<li>
<p>cpu.cfs_quota_usï¼šCFS è°ƒåº¦ç®—æ³•ä¸­ï¼Œåœ¨ä¸€ä¸ªè°ƒåº¦å‘¨æœŸé‡Œè¿™ä¸ªæ§åˆ¶ç»„è¢«å…è®¸çš„è¿è¡Œæ—¶é—´</p>
</li>
<li>
<p>cpu.sharesï¼šè¿™ä¸ªå€¼å†³å®šäº† CPU Cgroup ä¸‹æ§åˆ¶ç»„å¯ç”¨ CPU çš„ç›¸å¯¹æ¯”ä¾‹ã€‚<strong>ä¸è¿‡åªæœ‰å½“ç³»ç»Ÿä¸Š CPU å®Œå…¨è¢«å æ»¡çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¯”ä¾‹æ‰ä¼šåœ¨å„ä¸ªæ§åˆ¶ç»„é—´èµ·ä½œç”¨</strong>ã€‚</p>
<blockquote>
<p><code>cpu.cfs_quota_us</code> / <code>cpu.cfs_period_us</code> çš„å€¼å°±é™åˆ¶äº†å®¹å™¨è¿›ç¨‹çš„æœ€å¤§cpuä½¿ç”¨ç‡ã€‚</p>
<p>åœ¨æ“ä½œç³»ç»Ÿé‡Œï¼Œ<code>cpu.cfs_period_us</code> çš„å€¼ä¸€èˆ¬æ˜¯ä¸ªå›ºå®šå€¼ï¼Œæ‰€ä»¥åœ¨kubernetesä¸­ï¼Œå½“ä½ è®¾ç½®äº†Podçš„<code>limits.cpu</code>çš„å€¼åï¼Œkubeletä¼šå»ä¿®æ”¹cgroupä¸­çš„<code>cpu.cfs_quota_us</code>è¿™ä¸ªå‚æ•°æ¥è°ƒæ•´å®¹å™¨cpuçš„ä½¿ç”¨ä¸Šé™ã€‚</p>
<p>åœ¨kubernetesä¸­ï¼Œå½“è®¾ç½®äº† Podçš„<code>requests.cpu</code> çš„å€¼æ—¶ï¼Œkubeletä¼šå»è°ƒæ•´ <code>cpu.shares</code> è¿™ä¸ªå‚æ•°ï¼Œæ¥ä¿è¯å³ä½¿èŠ‚ç‚¹cpuä½¿ç”¨ç‡è¢«æ‰“æ»¡äº†ï¼Œå®¹å™¨ä»ç„¶èƒ½åˆ†å¾—ä¸€å®šé‡çš„cpuæ—¶é—´ã€‚</p>
</blockquote>
</li>
</ul>
<h3 id="cpu-ä½¿ç”¨ç‡">cpu ä½¿ç”¨ç‡</h3>
<p>cpuæ—¶é—´çš„ä½¿ç”¨ç±»å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/cpu-usage.jpeg" width="650px"/> 
</figure>

<p>æœ‰ä¸¤ç§æƒ…å½¢å¯ä»¥è®¤ä¸ºè¿›ç¨‹å¤„äºRï¼ˆè¿è¡Œæ€ï¼‰ï¼š</p>
<ul>
<li>åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…cpuè°ƒåº¦</li>
<li>è·å¾—äº†cpuèµ„æºï¼Œæ­£åœ¨è¿›è¡Œcpuè¿ç®—</li>
</ul>
<p>è¿›ç¨‹å¤„äºç¡çœ æ€ï¼ˆåœ¨cpuè°ƒåº¦å™¨çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼‰ä¹Ÿæœ‰ä¸¤ç§æƒ…å½¢ï¼š</p>
<ul>
<li>å¯ä¸­æ–­ï¼Œæ˜¾ç¤ºä¸º S çŠ¶æ€ï¼Œå¯èƒ½æ˜¯å› ä¸º<strong>ç”³è¯·ä¸åˆ°èµ„æº</strong>å¯¼è‡´è¢«æŒ‚èµ·</li>
<li>ä¸å¯ä¸­æ–­ç¡çœ ï¼Œæ˜¾ç¤ºä¸º D çŠ¶æ€ï¼Œå¯èƒ½æ˜¯å› ä¸º<strong>ç­‰å¾…I/Oæ“ä½œå®Œæˆ</strong>ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿™æ—¶è¿›ç¨‹ä¸å“åº”ä»»ä½•ä¿¡å·</li>
</ul>
<p>å¯¹äºè¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ï¼ŒåªåŒ…å«ä¸¤éƒ¨åˆ†:</p>
<ul>
<li>ä¸€ä¸ªæ˜¯ç”¨æˆ·æ€ï¼Œ us å’Œ niï¼›</li>
<li>è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯å†…æ ¸æ€ï¼Œä¹Ÿå°±æ˜¯ syã€‚</li>
</ul>
<p>è‡³äº waã€hiã€siï¼Œè¿™äº› I/O æˆ–è€…ä¸­æ–­ç›¸å…³çš„ CPU ä½¿ç”¨ï¼ŒCPU Cgroup ä¸ä¼šå»åšé™åˆ¶ã€‚å› ä¸ºæœ¬èº«è¿™äº›ä¹Ÿä¸å±äºæŸä¸ªè¿›ç¨‹çš„cpuæ—¶é—´ã€‚</p>
<h3 id="cpu-è´Ÿè½½">cpu è´Ÿè½½</h3>
<p>cpu ä½¿ç”¨ç‡å’Œ cpu å¹³å‡è´Ÿè½½çš„åŒºåˆ«ï¼š</p>
<ul>
<li>cpuä½¿ç”¨ç‡æ˜¯è¿›ç¨‹ä½¿ç”¨cpuçš„æ—¶é—´ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ—¶é—´ä¹‹å’Œã€‚</li>
<li>cpuå¹³å‡è´Ÿè½½â‰ˆCPUå¯è¿è¡Œé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹æ•°+<strong>CPUä¼‘çœ é˜Ÿåˆ—ä¸­ä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹æ•°</strong>ã€‚</li>
</ul>
<p>å½“èŠ‚ç‚¹ä¸Šå¤„äºDçŠ¶æ€çš„è¿›ç¨‹æ•°é‡å˜å¤šçš„æ—¶å€™ï¼Œcpuçš„å¹³å‡è´Ÿè½½ä¼šå‡é«˜ï¼Œæ­¤æ—¶å¤§é‡è¿›ç¨‹æ’é˜Ÿç«äº‰disk I/Oèµ„æºï¼Œä½†cpuå¯è¿è¡Œé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹æ•°å´å¾ˆå°‘ï¼Œæ‰€ä»¥è™½ç„¶ä½¿ç”¨ç‡å¾ˆä½ï¼Œä½†æ˜¯ä»ç„¶ä¼šæ‹–æ…¢è¿›ç¨‹é€Ÿåº¦ã€‚</p>
<h3 id="cpu-cgroup-1">cpu cgroup</h3>
<p>cpu cgroupèƒ½é™åˆ¶cpuçš„ä½¿ç”¨ç‡ï¼Œä½†æ˜¯cpu cgroupå¹¶æ²¡æœ‰åŠæ³•è§£å†³å¹³å‡è´Ÿè½½å‡é«˜çš„é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åšçš„æ˜¯ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›‘æ§å®¹å™¨çš„å®¿ä¸»æœºèŠ‚ç‚¹é‡Œ D çŠ¶æ€çš„è¿›ç¨‹æ•°é‡ï¼Œç„¶åå¯¹ D çŠ¶æ€è¿›ç¨‹æ•°ç›®å¼‚å¸¸çš„èŠ‚ç‚¹è¿›è¡Œåˆ†æï¼Œæ¯”å¦‚ç£ç›˜ç¡¬ä»¶å‡ºç°é—®é¢˜å¼•èµ· D çŠ¶æ€è¿›ç¨‹æ•°ç›®å¢åŠ ï¼Œè¿™æ—¶å°±éœ€è¦æ›´æ¢ç¡¬ç›˜ã€‚</p>
<h3 id="cpuset-cgroup">cpuset cgroup</h3>
<p>cpuset cgroupç”¨äºè¿›ç¨‹ç»‘æ ¸ï¼Œä¸»è¦é€šè¿‡è®¾ç½®<code>cpuset.cpus</code>å’Œ<code>cpuset.mems</code>ä¸¤ä¸ªå­—æ®µæ¥å®ç°ã€‚</p>
<p>åœ¨kubernetesä¸­ï¼Œå½“ Pod å±äº Guaranteed QoS ç±»å‹ï¼Œå¹¶ä¸” requests å€¼ä¸ limits è¢«è®¾ç½®ä¸ºåŒä¸€ä¸ªç›¸ç­‰çš„<strong>æ•´æ•°å€¼</strong>å°±ç›¸å½“äºå£°æ˜Podä¸­çš„å®¹å™¨è¦è¿›è¡Œç»‘æ ¸ã€‚</p>
<h3 id="memory-cgroup">memory cgroup</h3>
<ul>
<li>memory.limit_in_bytesï¼šä¸€ä¸ªæ§åˆ¶ç»„é‡Œæ‰€æœ‰è¿›ç¨‹å¯ä½¿ç”¨å†…å­˜çš„æœ€å¤§å€¼ã€‚ä¸€æ—¦è¾¾åˆ°äº†è¿™ä¸ªå€¼ï¼Œå¯èƒ½ä¼šè§¦å‘OOMã€‚
<blockquote>
<p>åœ¨kubernetesä¸­ï¼Œå½“ä½ æŒ‡å®šäº† Pod çš„ <code>limits.memory=128Mi</code> ä¹‹åï¼Œç›¸å½“äºå°† memory cgroup ä¸­çš„ <code>memory.limit_in_bytes</code> å­—æ®µ è®¾ç½®ä¸º 128 * 1024 * 1024</p>
</blockquote>
</li>
<li>memory.usage_in_bytesï¼šå½“å‰æ§åˆ¶ç»„é‡Œæ‰€æœ‰è¿›ç¨‹å®é™…ä½¿ç”¨çš„å†…å­˜æ€»å’Œï¼Œ<strong>åŒ…æ‹¬rsså’Œpage cacheä¸¤éƒ¨åˆ†</strong>ã€‚</li>
<li>memory.oom_controlï¼šå†³å®šäº†å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸Šé™æ—¶ï¼Œä¼šä¸ä¼šè§¦å‘OOM Killerã€‚è§¦å‘OOMæ—¶ï¼Œä¼šé€‰æ‹©æ§åˆ¶ç»„é‡Œçš„æŸä¸ªè¿›ç¨‹æ€æ‰ã€‚</li>
<li>memory.statï¼šæ˜¾ç¤ºäº†å„ç§å†…å­˜ç±»å‹çš„å®é™…å¼€é”€ã€‚<strong>å…¶ä¸­&quot;cache&quot;ä»£è¡¨page cacheï¼›&ldquo;rss&quot;ä»£è¡¨è¿›ç¨‹çœŸæ­£ç”³è¯·åˆ°çš„ç‰©ç†å†…å­˜å¤§å°ã€‚RSS å†…å­˜å’Œ Page Cache å†…å­˜çš„å’Œï¼Œç­‰äº<code>memory.usage_in_bytes</code> çš„å€¼</strong>ã€‚åˆ¤æ–­å®¹å™¨çœŸå®çš„å†…å­˜ä½¿ç”¨é‡ï¼Œæˆ‘ä»¬ä¸èƒ½ç”¨<code>memory.usage_in_bytes</code>ï¼Œè€Œéœ€è¦ç”¨ <code>memory.stat</code> é‡Œçš„ rss å€¼ã€‚</li>
<li>memory.swappinessï¼šå®šä¹‰Page Cache å†…å­˜å’ŒåŒ¿åå†…å­˜é‡Šæ”¾çš„æ¯”ä¾‹ã€‚</li>
</ul>
<blockquote>
<p>Qï¼šå½“æ‰§è¡Œ <code>kubectl exec</code> æ—¶ï¼Œåˆ›å»ºçš„è¿›ç¨‹ä¼šåŠ å…¥åˆ°å®¹å™¨çš„cgroupæ§åˆ¶ç»„å—ï¼Ÿ</p>
<p>Aï¼šä¼šã€‚ä»¥cpu cgroupä¸ºä¾‹ï¼ŒæŸ¥çœ‹<code>/sys/fs/cgroup/cpu/kubepods.slice/kubepods-pod{$uid}.slice/docker-{$containerID}.scope/tasks</code>æ–‡ä»¶å°±èƒ½å‘ç°æ–°åˆ›å»ºçš„è¿›ç¨‹è¢«åŠ å…¥åˆ°å®¹å™¨çš„cgroupæ§åˆ¶ç»„äº†ã€‚</p>
<p>Qï¼šæ‰§è¡Œ <code>kubectl top</code> å‘½ä»¤è·å–åˆ°çš„podæŒ‡æ ‡æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ</p>
<p>Aï¼šæ•´ä¸ªæ‰§è¡Œè·¯å¾„æ˜¯ï¼š<code>kubectl -&gt; apiserver -&gt; aggregated-apiserver -&gt; metric-server -&gt; kubelet(cAdvisor) -&gt; cgroup</code>ã€‚æœ€ç»ˆæ¥æºå°±æ˜¯cgroupã€‚è€ŒLinux <code>top</code>å‘½ä»¤çš„æŒ‡æ ‡æ•°æ®çš„æ¥æºæ˜¯<code>/proc</code>æ–‡ä»¶ç³»ç»Ÿã€‚</p>
</blockquote>
<h2 id="kubeletdockercrioci">kubeletã€Dockerã€CRIã€OCI</h2>
<p>docker æ¶æ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/docker.png" width="800px"/> 
</figure>

<p>kubeletå’Œdockerçš„é›†æˆæ–¹æ¡ˆï¼š</p>
<figure>
    <img src="/kubelet-docker.png" width="800px"/> 
</figure>

<p>ä»è¿™ä¸¤å¹…å›¾å°±èƒ½çœ‹å‡ºæ¥ï¼Œå½“å‰åœ¨kubernetesä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå®¹å™¨çš„è°ƒç”¨é“¾ä¸ºï¼š</p>
<p><code>kubelet -&gt; dockershim -&gt; docker daemon -&gt; containerd -&gt; containerd-shim -&gt; runc -&gt; container</code></p>
<p>dockershimå®ç°äº†<a href="https://github.com/kubernetes/kubernetes/blob/8327e433590f9e867b1e31a4dc32316685695729/pkg/kubelet/apis/cri/services.go">CRI</a>å®šä¹‰çš„gRPCæ¥å£ï¼Œå®ç°æ–¹å¼å°±æ˜¯å……å½“docker daemonçš„å®¢æˆ·ç«¯ï¼Œå‘docker daemonå‘é€å‘½ä»¤ã€‚å®é™…ä¸Šdockershimå’Œdocker daemonéƒ½å¯ä»¥è¢«å¹²æ‰ï¼Œ<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#deprecation">kubernetesåœ¨v1.20ä¹Ÿçš„ç¡®è¿™ä¹ˆåšäº†</a>ã€‚dockerä»kubernetesä¸­è¢«ç§»é™¤åï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨<a href="https://github.com/containerd/containerd">containerd</a>æˆ–<a href="https://github.com/cri-o/cri-o">CRI-O</a>ä½œä¸ºCRIã€‚</p>
<p><a href="https://github.com/opencontainers/runc">runC</a>åˆ™æ˜¯ä¸€ä¸ª<a href="https://github.com/opencontainers/runtime-spec">OCI</a>çš„å‚è€ƒå®ç°ï¼Œåº•å±‚é€šè¿‡Linuxç³»ç»Ÿè°ƒç”¨ä¸ºå®¹å™¨è®¾ç½® namespaces å’Œ cgroups, æŒ‚è½½ rootfsã€‚å½“ç„¶kuberneteså…¶å®ä¸å…³å¿ƒOCIçš„åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œåªè¦èƒ½ä¿è¯éµå¾ªOCIæ–‡æ¡£é‡Œçš„æ ‡å‡†ï¼Œå°±èƒ½è‡ªå·±å®ç°ä¸€ä¸ªOCIã€‚<a href="https://github.com/kata-containers/kata-containers">Kata</a>å°±æ˜¯éµå¾ªäº†OCIæ ‡å‡†å®ç°çš„å®‰å…¨å®¹å™¨ã€‚å®ƒçš„åº•å±‚æ˜¯ç”¨è™šæ‹Ÿæœºå®ç°çš„èµ„æºå¼ºéš”ç¦»ï¼Œè€Œä¸æ˜¯namespaceã€‚</p>
<p>Kataä¸­çš„VMå¯ä»¥å’ŒPodåšä¸€ä¸ªç±»æ¯”ï¼š</p>
<ul>
<li>kubeletè°ƒç”¨CRIçš„<code>RunPodSandbox</code>æ¥å£æ—¶ï¼Œå¦‚æœæ˜¯runCå®ç°çš„OCIï¼Œåˆ™ä¼šå»åˆ›å»º<code>infra</code>å®¹å™¨ï¼Œå¹¶æ‰§è¡Œ<code>/pause</code>å°†å®¹å™¨æŒ‚èµ·ï¼›å¦‚æœæ˜¯Kataï¼Œåˆ™ä¼šå»åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºã€‚</li>
<li>æ¥ç€kubeletè°ƒç”¨<code>CreateContainer</code>å»åˆ›å»ºå®¹å™¨ï¼Œå¯¹äºrunCï¼Œå°±æ˜¯åˆ›å»ºå®¹å™¨è¿›ç¨‹å¹¶å°†ä»–ä»¬çš„namespaceåŠ å…¥<code>infra</code>å®¹å™¨ä¸­å»ï¼›å¯¹äºKataï¼Œåˆ™æ˜¯å¾€VMä¸­æ·»åŠ å®¹å™¨ã€‚</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>ä¸ºä»€ä¹ˆåˆ é™¤Podæ—¶webhookæ”¶åˆ°ä¸‰æ¬¡deleteè¯·æ±‚</title>
			<link>https://cvvz.fun/post/k8s-3-deletion-webhook/</link>
			<pubDate>Sun, 13 Dec 2020 19:26:15 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/k8s-3-deletion-webhook/</guid>
			<description>æœ€è¿‘åœ¨ç©admission webhookæ—¶ï¼Œå‘ç°ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼šæˆ‘é…ç½®äº†validatingWebhookConfigurationä½¿å…¶ç›‘å¬</description>
			<content type="html"><![CDATA[<p>æœ€è¿‘åœ¨ç©admission webhookæ—¶ï¼Œå‘ç°ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼šæˆ‘é…ç½®äº†validatingWebhookConfigurationä½¿å…¶ç›‘å¬podçš„åˆ é™¤æ“ä½œï¼Œç»“æœå‘ç°æ¯æ¬¡åˆ é™¤Podçš„æ—¶å€™ï¼Œwebhookä¼šæ”¶åˆ°ä¸‰æ¬¡deleteè¯·æ±‚ï¼š</p>
<figure>
    <img src="/3-delete.png" width="1000px"/> 
</figure>

<p>ä»æ—¥å¿—æ‰“å°ä¸Šå¯ä»¥åˆ†æå‡ºï¼Œç¬¬ä¸€æ¬¡åˆ é™¤è¯·æ±‚æ¥è‡ªäºkubectlå®¢æˆ·ç«¯ï¼Œåé¢ä¸¤æ¬¡æ¥è‡ªäºpodæ‰€åœ¨çš„nodeèŠ‚ç‚¹ã€‚ä¸ºä»€ä¹ˆä¼šæ”¶åˆ°ä¸‰æ¬¡deleteè¯·æ±‚å‘¢ï¼Ÿ</p>
<h2 id="åˆ é™¤ä¸€ä¸ªpodçš„è¿‡ç¨‹">åˆ é™¤ä¸€ä¸ªPodçš„è¿‡ç¨‹</h2>
<p>é€šè¿‡é˜…è¯»kube-apiserverå’Œkubeletæºç ï¼Œæˆ‘æŠŠä¸€ä¸ªpodçš„åˆ é™¤è¿‡ç¨‹æ€»ç»“æˆå¦‚ä¸‹è¿™å¹…æµç¨‹å›¾ï¼Œä¸‰ä¸ªçº¢è‰²åŠ ç²—çš„è¯·æ±‚å³ä¸ºwebhookæ”¶åˆ°çš„ä¸‰æ¬¡deleteè¯·æ±‚ã€‚
<figure>
    <img src="/delete-pod.drawio.svg" width="800px"/> 
</figure>
</p>
<h3 id="kube-apiserverå¤„ç†ç¬¬ä¸€æ¬¡åˆ é™¤è¯·æ±‚">kube-apiserverå¤„ç†ç¬¬ä¸€æ¬¡åˆ é™¤è¯·æ±‚</h3>
<p>é¦–å…ˆï¼Œç”±kubectlå‘æ¥çš„deleteè¯·æ±‚ï¼Œä¼šç»è¿‡kube-apiserverçš„admission-controllerè¿›è¡Œå‡†å…¥æ ¡éªŒã€‚æˆ‘ä»¬å®šä¹‰äº†admission webhookï¼Œæ‰€ä»¥kube-apiserverä¼šå°†è¯¥è¯·æ±‚ç›¸å…³çš„ä¿¡æ¯å°è£…åœ¨<strong>AdmissionReview</strong>ç»“æ„ä½“ä¸­å‘é€ç»™webhookã€‚è¿™æ˜¯ç¬¬ä¸€æ¬¡webhookæ”¶åˆ°deleteè¯·æ±‚ã€‚</p>
<p>kube-apiserverä½œä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œå®ƒçš„handleråœ¨<code>staging/src/k8s.io/apiserver/pkg/endpoints/installer.go</code>æ–‡ä»¶ä¸­çš„<code>registerResourceHandlers</code>å‡½æ•°ä¸­å®šä¹‰ã€‚å…¶ä¸­<code>DELETE</code>è¯·æ±‚çš„handleræ˜¯<code>restfulDeleteResource</code>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="k">case</span> <span class="s">&#34;DELETE&#34;</span><span class="p">:</span> <span class="c1">// Delete a resource.
</span><span class="ln">2</span><span class="c1"></span>    <span class="c1">// ...
</span><span class="ln">3</span><span class="c1"></span>
<span class="ln">4</span>    <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">metrics</span><span class="p">.</span><span class="nf">InstrumentRouteFunc</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">Verb</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">subresource</span><span class="p">,</span> <span class="nx">requestScope</span><span class="p">,</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">APIServerComponent</span><span class="p">,</span> <span class="nx">deprecated</span><span class="p">,</span> <span class="nx">removedRelease</span><span class="p">,</span> <span class="nf">restfulDeleteResource</span><span class="p">(</span><span class="nx">gracefulDeleter</span><span class="p">,</span> <span class="nx">isGracefulDeleter</span><span class="p">,</span> <span class="nx">reqScope</span><span class="p">,</span> <span class="nx">admit</span><span class="p">))</span>
<span class="ln">5</span>
<span class="ln">6</span>    <span class="o">...</span>
</code></pre></div><p><code>restfulDeleteResource</code>è°ƒç”¨<code>DeleteResource</code>ï¼Œåè€…åˆ™è°ƒç”¨<code>staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go</code>æ–‡ä»¶ä¸­çš„<code>Delete</code>æ–¹æ³•å¯¹å¯¹è±¡è¿›è¡Œåˆ é™¤</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="kd">func</span> <span class="nf">restfulDeleteResource</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">GracefulDeleter</span><span class="p">,</span> <span class="nx">allowsOptions</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">scope</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admit</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">restful</span><span class="p">.</span><span class="nx">RouteFunction</span> <span class="p">{</span>
<span class="ln">2</span>	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>		<span class="nx">handlers</span><span class="p">.</span><span class="nf">DeleteResource</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">allowsOptions</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">admit</span><span class="p">)(</span><span class="nx">res</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
<span class="ln">4</span>	<span class="p">}</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="nf">DeleteResource</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">GracefulDeleter</span><span class="p">,</span> <span class="nx">allowsOptions</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">scope</span> <span class="o">*</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admit</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="c1">//...
</span><span class="ln"> 3</span><span class="c1"></span>
<span class="ln"> 4</span>    <span class="nx">trace</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">&#34;About to delete object from database&#34;</span><span class="p">)</span>
<span class="ln"> 5</span>		<span class="nx">wasDeleted</span> <span class="o">:=</span> <span class="kc">true</span>
<span class="ln"> 6</span>		<span class="nx">userInfo</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">UserFrom</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="ln"> 7</span>		<span class="nx">staticAdmissionAttrs</span> <span class="o">:=</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">NewAttributesRecord</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Resource</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Subresource</span><span class="p">,</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Delete</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">dryrun</span><span class="p">.</span><span class="nf">IsDryRun</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">DryRun</span><span class="p">),</span> <span class="nx">userInfo</span><span class="p">)</span>
<span class="ln"> 8</span>		<span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">finishRequest</span><span class="p">(</span><span class="nx">timeout</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>			<span class="nx">obj</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">AdmissionToValidateObjectDeleteFunc</span><span class="p">(</span><span class="nx">admit</span><span class="p">,</span> <span class="nx">staticAdmissionAttrs</span><span class="p">,</span> <span class="nx">scope</span><span class="p">),</span> <span class="nx">options</span><span class="p">)</span>
<span class="ln">10</span>			<span class="nx">wasDeleted</span> <span class="p">=</span> <span class="nx">deleted</span>
<span class="ln">11</span>			<span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">12</span>		<span class="p">})</span>
<span class="ln">13</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">14</span>			<span class="nx">scope</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="ln">15</span>			<span class="k">return</span>
<span class="ln">16</span>		<span class="p">}</span>
<span class="ln">17</span>        <span class="nx">trace</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">&#34;Object deleted from database&#34;</span><span class="p">)</span>
<span class="ln">18</span>        
<span class="ln">19</span>        <span class="o">...</span>
<span class="ln">20</span><span class="p">}</span>
</code></pre></div><p><code>Delete</code>æ–¹æ³•ä¸­ï¼Œåœ¨<code>BeforeDelete</code>å‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦éœ€è¦ä¼˜é›…åˆ é™¤ï¼Œåˆ¤æ–­çš„æ ‡å‡†æ˜¯<code>DeletionGracePeriodSeconds</code>å€¼æ˜¯å¦ä¸º0ï¼Œä¸ä¸ºé›¶åˆ™è®¤ä¸ºæ˜¯ä¼˜é›…åˆ é™¤ï¼Œkube-apiserverä¸ä¼šç«‹å³å°†è¿™ä¸ªAPIå¯¹è±¡ä»etcdä¸­åˆ é™¤ï¼Œå¦åˆ™ç›´æ¥åˆ é™¤ã€‚</p>
<p>å¯¹äºPodè€Œè¨€ï¼Œé»˜è®¤<code>DeletionGracePeriodSeconds</code>ä¸º30ç§’ï¼Œå› æ­¤è¿™é‡Œä¸ä¼šè¢«kube-apiserverç«‹åˆ»åˆ é™¤æ‰ã€‚è€Œæ˜¯å°†<code>DeletionTimestamp</code>è®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼Œ<code>DeletionGracePeriodSeconds</code>è®¾ç½®ä¸ºé»˜è®¤å€¼30ç§’ã€‚</p>
<h3 id="kubeletæ€æ‰å®¹å™¨">kubeletæ€æ‰å®¹å™¨</h3>
<p>kube-apiserverè®¾ç½®å¥½<code>DeletionTimestamp</code>å’Œ<code>DeletionGracePeriodSeconds</code>è¿™ä¸¤ä¸ªå­—æ®µåï¼Œkubelet ä¼šwatchåˆ°Podçš„æ›´æ–°ã€‚é‚£kubelet list-watchæœºåˆ¶åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<p>Kubeletåœ¨<code>makePodSourceConfig</code>å‡½æ•°ä¸­ï¼Œç›‘å¬äº†ä¸‰ç§ç±»å‹çš„Podï¼šé€šè¿‡<a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/static-pod/#configuration-files">æ–‡ä»¶ç³»ç»Ÿä¸Šçš„é…ç½®æ–‡ä»¶</a>é…ç½®çš„é™æ€Podï¼Œé€šè¿‡<a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/static-pod/#pods-created-via-http">web ç½‘ç»œä¸Šçš„é…ç½®æ–‡ä»¶</a>é…ç½®çš„é™æ€Podï¼Œä»¥åŠkube-apiserverä¸­çš„podã€‚æˆ‘ä»¬ä¸»è¦å…³å¿ƒç¬¬ä¸‰ç§ã€‚</p>
<p>Kubeleté€šè¿‡reflactor watchåˆ°Podèµ„æºå‘ç”Ÿå˜åŒ–åï¼Œæ˜¯é€šè¿‡channelçš„æ–¹å¼å°†PodåŠå…¶å˜åŒ–ä¼ é€’ç»™syncLoopä¸»æ§åˆ¶å¾ªç¯ä¸­è¿›è¡Œå¤„ç†çš„ï¼Œ<strong>å¹¶æ²¡æœ‰ä½¿ç”¨informer+workquequeçš„æ–¹å¼</strong>ã€‚</p>
<p>kubeletçš„ä¸»æ§åˆ¶å¾ªç¯åœ¨<code>pkg/kubelet/kubelet.go</code>æ–‡ä»¶ä¸­çš„<code>syncLoopIteration</code>å‡½æ•°ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">syncLoopIteration</span><span class="p">(</span><span class="nx">configCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">PodUpdate</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">SyncHandler</span><span class="p">,</span>
<span class="ln"> 2</span>	<span class="nx">syncCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">housekeepingCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">plegCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">pleg</span><span class="p">.</span><span class="nx">PodLifecycleEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
<span class="ln"> 3</span>	<span class="k">select</span> <span class="p">{</span>
<span class="ln"> 4</span>	<span class="k">case</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">open</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">configCh</span><span class="p">:</span>
<span class="ln"> 5</span>		<span class="c1">// Update from a config source; dispatch it to the right handler
</span><span class="ln"> 6</span><span class="c1"></span>		<span class="c1">// callback.
</span><span class="ln"> 7</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">open</span> <span class="p">{</span>
<span class="ln"> 8</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Update channel is closed. Exiting the sync loop.&#34;</span><span class="p">)</span>
<span class="ln"> 9</span>			<span class="k">return</span> <span class="kc">false</span>
<span class="ln">10</span>		<span class="p">}</span>
<span class="ln">11</span>
<span class="ln">12</span>		<span class="k">switch</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Op</span> <span class="p">{</span>
<span class="ln">13</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">:</span>
<span class="ln">14</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (ADD, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">15</span>			<span class="c1">// After restarting, kubelet will get all existing pods through
</span><span class="ln">16</span><span class="c1"></span>			<span class="c1">// ADD as if they are new pods. These pods will then go through the
</span><span class="ln">17</span><span class="c1"></span>			<span class="c1">// admission process and *may* be rejected. This can be resolved
</span><span class="ln">18</span><span class="c1"></span>			<span class="c1">// once we have checkpointing.
</span><span class="ln">19</span><span class="c1"></span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodAdditions</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">20</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">UPDATE</span><span class="p">:</span>
<span class="ln">21</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (UPDATE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">PodsWithDeletionTimestamps</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">22</span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodUpdates</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">23</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">REMOVE</span><span class="p">:</span>
<span class="ln">24</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (REMOVE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">25</span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodRemoves</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">26</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">RECONCILE</span><span class="p">:</span>
<span class="ln">27</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (RECONCILE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">28</span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodReconcile</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">29</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">:</span>
<span class="ln">30</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (DELETE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">31</span>			<span class="c1">// DELETE is treated as a UPDATE because of graceful deletion.
</span><span class="ln">32</span><span class="c1"></span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodUpdates</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">33</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">RESTORE</span><span class="p">:</span>
<span class="ln">34</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (RESTORE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">35</span>			<span class="c1">// These are pods restored from the checkpoint. Treat them as new
</span><span class="ln">36</span><span class="c1"></span>			<span class="c1">// pods.
</span><span class="ln">37</span><span class="c1"></span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodAdditions</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">38</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">:</span>
<span class="ln">39</span>			<span class="c1">// TODO: Do we want to support this?
</span><span class="ln">40</span><span class="c1"></span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Kubelet does not support snapshot update&#34;</span><span class="p">)</span>
<span class="ln">41</span>        <span class="p">}</span>
<span class="ln">42</span>
<span class="ln">43</span>        <span class="o">...</span>
</code></pre></div><p>å½“Podçš„<code>DeletionTimestamp</code>è¢«è®¾ç½®æ—¶ï¼ŒKubeletä¼šèµ°å…¥<code>kubetypes.DELETE</code>è¿™ä¸ªåˆ†æ”¯ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>pkg/kubelet/kubelet.go</code>ä¸­çš„<code>syncPod</code>å‡½æ•°ï¼Œ<strong><code>syncPod</code> è¿™ä¸ªå‡½æ•°æ˜¯ kubelet æ ¸å¿ƒå¤„ç†å‡½æ•°</strong>ã€‚è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨åˆ°å®¹å™¨è¿è¡Œæ—¶çš„<code>KillPod</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿›è€Œåˆä¼šä»¥goroutineçš„æ–¹å¼ï¼Œä½¿ç”¨<code>pkg/kubelet/kuberuntime/kuberuntime_container.go</code>ä¸­å®šä¹‰çš„<code>killContainer</code>æ–¹æ³•<strong>å¹¶è¡Œçš„æ€æ‰</strong>æ‰€æœ‰å®¹å™¨ã€‚<code>killContainer</code>çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">killContainer</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">containerID</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span> <span class="nx">containerName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln"> 2</span>	<span class="o">...</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span>	<span class="c1">// From this point, pod and container must be non-nil.
</span><span class="ln"> 5</span><span class="c1"></span>	<span class="nx">gracePeriod</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">minimumGracePeriodInSeconds</span><span class="p">)</span>
<span class="ln"> 6</span>	<span class="k">switch</span> <span class="p">{</span>
<span class="ln"> 7</span>	<span class="k">case</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
<span class="ln"> 8</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span>
<span class="ln"> 9</span>	<span class="k">case</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
<span class="ln">10</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span>
<span class="ln">11</span>	<span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
<span class="ln">14</span>		<span class="nx">message</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Stopping container %s&#34;</span><span class="p">,</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="ln">15</span>	<span class="p">}</span>
<span class="ln">16</span>	<span class="nx">m</span><span class="p">.</span><span class="nf">recordContainerEvent</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">containerSpec</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeNormal</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">KillingContainer</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
<span class="ln">17</span>
<span class="ln">18</span>	<span class="c1">// Run internal pre-stop lifecycle hook
</span><span class="ln">19</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">internalLifecycle</span><span class="p">.</span><span class="nf">PreStopContainer</span><span class="p">(</span><span class="nx">containerID</span><span class="p">.</span><span class="nx">ID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">20</span>		<span class="k">return</span> <span class="nx">err</span>
<span class="ln">21</span>	<span class="p">}</span>
<span class="ln">22</span>
<span class="ln">23</span>	<span class="c1">// Run the pre-stop lifecycle hooks if applicable and if there is enough time to run it
</span><span class="ln">24</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">Lifecycle</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">Lifecycle</span><span class="p">.</span><span class="nx">PreStop</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">gracePeriod</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
<span class="ln">25</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="nx">gracePeriod</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nf">executePreStopHook</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">,</span> <span class="nx">containerSpec</span><span class="p">,</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">26</span>	<span class="p">}</span>
<span class="ln">27</span>	<span class="c1">// always give containers a minimal shutdown window to avoid unnecessary SIGKILLs
</span><span class="ln">28</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">gracePeriod</span> <span class="p">&lt;</span> <span class="nx">minimumGracePeriodInSeconds</span> <span class="p">{</span>
<span class="ln">29</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="nx">minimumGracePeriodInSeconds</span>
<span class="ln">30</span>	<span class="p">}</span>
<span class="ln">31</span>	<span class="k">if</span> <span class="nx">gracePeriodOverride</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">32</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">gracePeriodOverride</span>
<span class="ln">33</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Killing container %q, but using %d second grace period override&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">,</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">34</span>	<span class="p">}</span>
<span class="ln">35</span>
<span class="ln">36</span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Killing container %q with %d second grace period&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">37</span>
<span class="ln">38</span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">runtimeService</span><span class="p">.</span><span class="nf">StopContainer</span><span class="p">(</span><span class="nx">containerID</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">39</span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">40</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Container %q termination failed with gracePeriod %d: %v&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="nx">gracePeriod</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="ln">41</span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">42</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Container %q exited normally&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
<span class="ln">43</span>	<span class="p">}</span>
<span class="ln">44</span>
<span class="ln">45</span>	<span class="nx">m</span><span class="p">.</span><span class="nx">containerRefManager</span><span class="p">.</span><span class="nf">ClearRef</span><span class="p">(</span><span class="nx">containerID</span><span class="p">)</span>
<span class="ln">46</span>
<span class="ln">47</span>	<span class="k">return</span> <span class="nx">err</span>
<span class="ln">48</span><span class="p">}</span>  
</code></pre></div><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯å…ˆè°ƒç”¨prestop hookï¼Œç„¶ååœ¨é€šè¿‡<code>runtimeService.StopContainer</code>æ–¹æ³•æ€æ‰å®¹å™¨è¿›ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹æ€»æ—¶é•¿ä¸èƒ½è¶…è¿‡<code>DeletionGracePeriodSeconds</code>ã€‚æ³¨æ„ï¼Œprestop hookæ˜¯ä¸ä¼šè¿›è¡Œé‡è¯•çš„ï¼Œå¤±è´¥äº†kubeletä¹Ÿä¸ç®¡ï¼Œå®¹å™¨è¿˜æ˜¯ç…§æ€ä¸è¯¯ã€‚</p>
<h3 id="statusmanagerå‘é€åˆ é™¤è¯·æ±‚">statusManagerå‘é€åˆ é™¤è¯·æ±‚</h3>
<p>kubeletä»¥goroutineçš„æ–¹å¼è¿è¡Œç€ä¸€ä¸ª<code>statusManager</code>ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å‘¨æœŸæ€§çš„ç›‘å¬Podçš„çŠ¶æ€å˜åŒ–ï¼Œç„¶åæ‰§è¡Œ<code>func (m *manager) syncPod(uid types.UID, status versionedPodStatus) {</code>ã€‚åœ¨<code>syncPod</code>ä¸­ï¼Œæ³¨æ„åˆ°æœ‰å¦‚ä¸‹çš„é€»è¾‘ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">manager</span><span class="p">)</span> <span class="nf">syncPod</span><span class="p">(</span><span class="nx">uid</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">status</span> <span class="nx">versionedPodStatus</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="o">...</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nf">canBeDeleted</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>		<span class="nx">deleteOptions</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">{</span>
<span class="ln"> 6</span>			<span class="nx">GracePeriodSeconds</span><span class="p">:</span> <span class="nb">new</span><span class="p">(</span><span class="kt">int64</span><span class="p">),</span>
<span class="ln"> 7</span>			<span class="c1">// Use the pod UID as the precondition for deletion to prevent deleting a
</span><span class="ln"> 8</span><span class="c1"></span>			<span class="c1">// newly created pod with the same name and namespace.
</span><span class="ln"> 9</span><span class="c1"></span>			<span class="nx">Preconditions</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">NewUIDPreconditions</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">UID</span><span class="p">)),</span>
<span class="ln">10</span>		<span class="p">}</span>
<span class="ln">11</span>		<span class="nx">err</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">deleteOptions</span><span class="p">)</span>
<span class="ln">12</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">13</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Failed to delete status for pod %q: %v&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pod</span><span class="p">(</span><span class="nx">pod</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
<span class="ln">14</span>			<span class="k">return</span>
<span class="ln">15</span>		<span class="p">}</span>
<span class="ln">16</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Pod %q fully terminated and removed from etcd&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pod</span><span class="p">(</span><span class="nx">pod</span><span class="p">))</span>
<span class="ln">17</span>		<span class="nx">m</span><span class="p">.</span><span class="nf">deletePodStatus</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span>
<span class="ln">18</span>	<span class="p">}</span>
<span class="ln">19</span><span class="p">}</span>
</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong><code>statusManager</code>å‘ç°Podå¯ä»¥è¢«åˆ é™¤çš„æ—¶å€™ï¼Œå°±ä¼šå»è°ƒç”¨clientsetçš„deleteæ¥å£å°†Podèµ„æºä»kube-apiserverä¸­åˆ æ‰</strong>ã€‚é‚£ä»€ä¹ˆæ—¶å€™Podå¯ä»¥è¢«åˆ é™¤å‘¢ï¼Ÿè‡ªç„¶æ˜¯åœ¨ä¸Šä¸€æ­¥ä¸­ï¼Œkubeletå°†Podçš„å®¹å™¨ã€å·ã€cgroup sandboxç­‰èµ„æºç»Ÿç»Ÿåˆ é™¤æ‰ï¼Œå°±å¯ä»¥è¢«åˆ é™¤äº†ã€‚</p>
<p>è¿™é‡Œï¼Œwebhookå°±ä¼šæ”¶åˆ°ç¬¬äºŒæ¬¡åˆ é™¤è¯·æ±‚ï¼Œè€Œä¸”è¿™æ¬¡è¯·æ±‚ä¸­ï¼Œå°†<code>GracePeriodSeconds</code>è®¾ç½®ä¸ºäº†0ï¼Œè¿™å°±ä»£è¡¨ç€kube-apiserveræ”¶åˆ°è¿™ä¸ªDELETEè¯·æ±‚åï¼Œå¯ä»¥å°†Podä»etcdä¸­åˆ é™¤äº†ã€‚</p>
<h3 id="ç¬¬ä¸‰æ¬¡deleteè¯·æ±‚">ç¬¬ä¸‰æ¬¡deleteè¯·æ±‚</h3>
<p>webhookä¸ºä»€ä¹ˆä¼šæ”¶åˆ°ç¬¬ä¸‰æ¬¡deleteè¯·æ±‚ï¼Œè¿™ä¸ªé—®é¢˜ç€å®å›°æ‰°äº†æˆ‘å¾ˆä¹…ã€‚</p>
<p>ä»æ—¥å¿—çš„serviceAccountçš„ä¿¡æ¯æ¥çœ‹ï¼Œå¾ˆåƒæ˜¯èŠ‚ç‚¹ä¸Šçš„ç»„ä»¶åˆå‘äº†ä¸€æ¬¡DELETEè¯·æ±‚ã€‚æ˜¯kubeletå—ï¼Ÿè¿˜æ˜¯kube-proxyï¼Ÿä½†æ˜¯æŸ¥çœ‹ç›¸å…³æ—¥å¿—å’Œä»£ç ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•å¯ç–‘ç‚¹ã€‚</p>
<p>å…¶å®ï¼Œç¬¬ä¸‰æ¬¡DELETEè¯·æ±‚æ˜¯kube-apiserverè‡ªå·±å‘çš„ã€‚</p>
<p>åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘æåˆ°kube-apiserveræ”¶åˆ°DELETEè¯·æ±‚åæœ€ç»ˆä¼šè°ƒç”¨<code>staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go</code>æ–‡ä»¶ä¸­çš„<code>Delete</code>æ–¹æ³•ï¼Œç„¶åç”±äºèµ°çš„æ˜¯ä¼˜é›…åˆ é™¤ï¼Œå®ƒæ›´æ–°å®ŒPodçš„<code>DeletionTimestamp</code>å’Œ<code>DeletionGracePeriodSeconds</code>ä¸¤ä¸ªå­—æ®µåï¼Œå°±è¿”å›äº†ã€‚</p>
<p>ç°åœ¨ï¼Œç¬¬äºŒæ¬¡DELETEè¯·æ±‚å°†<code>GracePeriodSeconds</code>è®¾ç½®ä¸ºäº†0ï¼Œäºæ˜¯ç°åœ¨å¯ä»¥å¼€å§‹æ‰§è¡Œå®é™…çš„åˆ é™¤æ“ä½œäº†ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deleteValidation</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">ValidateObjectFunc</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="o">...</span>
<span class="ln"> 3</span>    <span class="c1">// delete immediately, or no graceful deletion supported
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;going to delete %s from registry: &#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
<span class="ln"> 5</span>    <span class="nx">out</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">NewFunc</span><span class="p">()</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">preconditions</span><span class="p">,</span> <span class="nx">storage</span><span class="p">.</span><span class="nf">ValidateObjectFunc</span><span class="p">(</span><span class="nx">deleteValidation</span><span class="p">),</span> <span class="nx">dryrun</span><span class="p">.</span><span class="nf">IsDryRun</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">DryRun</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="c1">// Please refer to the place where we set ignoreNotFound for the reason
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="c1">// why we ignore the NotFound error .
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">storage</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ignoreNotFound</span> <span class="o">&amp;&amp;</span> <span class="nx">lastExisting</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">10</span>            <span class="c1">// The lastExisting object may not be the last state of the object
</span><span class="ln">11</span><span class="c1"></span>            <span class="c1">// before its deletion, but it&#39;s the best approximation.
</span><span class="ln">12</span><span class="c1"></span>            <span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">finalizeDelete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">lastExisting</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="ln">13</span>            <span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">14</span>        <span class="p">}</span>
<span class="ln">15</span>        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">storeerr</span><span class="p">.</span><span class="nf">InterpretDeleteError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">qualifiedResource</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
<span class="ln">16</span>    <span class="p">}</span>
<span class="ln">17</span>    <span class="o">...</span>
<span class="ln">18</span><span class="p">}</span>
</code></pre></div><p>åœ¨<code>e.Storage.Delete</code>æ–¹æ³•ä¸­ï¼Œå®šä¹‰äº†<code>storage.ValidateObjectFunc(deleteValidation)</code>å‚æ•°ï¼Œä»”ç»†é˜…è¯»è¿™ä¸ªæ–¹æ³•çš„å®ç°ç»†èŠ‚ï¼ŒåŸæ¥ï¼Œkube-apiserveråœ¨è¿›è¡Œåˆ é™¤å‰ï¼Œè¿˜ä¼šå†å¯¹è¿™ä¸ªåˆ é™¤æ“ä½œæ‰§è¡Œä¸€æ¬¡å‡†å…¥æ§åˆ¶æ ¡éªŒï¼Œå³Validatingå’ŒMutatingã€‚ä»£ç é€»è¾‘è§<code>staging/src/k8s.io/apiserver/pkg/storage/etcd3/store.go</code>ä¸­çš„<code>conditionalDelete</code>å‡½æ•°ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">store</span><span class="p">)</span> <span class="nf">conditionalDelete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">out</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">preconditions</span> <span class="o">*</span><span class="nx">storage</span><span class="p">.</span><span class="nx">Preconditions</span><span class="p">,</span> <span class="nx">validateDeletion</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">ValidateObjectFunc</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="o">...</span>
<span class="ln"> 3</span>    <span class="k">for</span> <span class="p">{</span>
<span class="ln"> 4</span>		<span class="nx">origState</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">getState</span><span class="p">(</span><span class="nx">getResp</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="ln"> 5</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln"> 6</span>			<span class="k">return</span> <span class="nx">err</span>
<span class="ln"> 7</span>		<span class="p">}</span>
<span class="ln"> 8</span>		<span class="k">if</span> <span class="nx">preconditions</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln"> 9</span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">preconditions</span><span class="p">.</span><span class="nf">Check</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">origState</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">10</span>				<span class="k">return</span> <span class="nx">err</span>
<span class="ln">11</span>			<span class="p">}</span>
<span class="ln">12</span>		<span class="p">}</span>
<span class="ln">13</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">validateDeletion</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">origState</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">14</span>			<span class="k">return</span> <span class="nx">err</span>
<span class="ln">15</span>		<span class="p">}</span>
<span class="ln">16</span>		<span class="nx">startTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
<span class="ln">17</span>		<span class="nx">txnResp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">KV</span><span class="p">.</span><span class="nf">Txn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">If</span><span class="p">(</span>
<span class="ln">18</span>			<span class="nx">clientv3</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nf">ModRevision</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="s">&#34;=&#34;</span><span class="p">,</span> <span class="nx">origState</span><span class="p">.</span><span class="nx">rev</span><span class="p">),</span>
<span class="ln">19</span>		<span class="p">).</span><span class="nf">Then</span><span class="p">(</span>
<span class="ln">20</span>			<span class="nx">clientv3</span><span class="p">.</span><span class="nf">OpDelete</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span>
<span class="ln">21</span>		<span class="p">).</span><span class="nf">Else</span><span class="p">(</span>
<span class="ln">22</span>			<span class="nx">clientv3</span><span class="p">.</span><span class="nf">OpGet</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span>
<span class="ln">23</span>        <span class="p">).</span><span class="nf">Commit</span><span class="p">()</span>
<span class="ln">24</span>    <span class="o">...</span>
<span class="ln">25</span>
<span class="ln">26</span><span class="p">}</span>
</code></pre></div><p>validateDeletion å³ä¸ºè¿›è¡ŒDELETEå‡†å…¥æ§åˆ¶æ ¡éªŒçš„åœ°æ–¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å¿…å®šä¼šè°ƒç”¨åˆ°Validating webhookï¼Œä¹Ÿå°±æœ‰äº†ç¬¬ä¸‰æ¬¡deleteè¯·æ±‚ã€‚è‡³äºä¸ºä»€ä¹ˆè¦å†åšä¸€æ¬¡å‡†å…¥æ§åˆ¶ï¼Œæˆ‘ä¹Ÿä¸å¤ªæ˜ç™½ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>Kuberneteså­˜å‚¨ä¹‹Volumeå®ç°åŸç†</title>
			<link>https://cvvz.fun/post/k8s-volume/</link>
			<pubDate>Sat, 12 Dec 2020 12:32:33 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/k8s-volume/</guid>
			<description>å®¹å™¨è¿è¡Œæ—¶æŒ‚è½½å·çš„è¿‡ç¨‹ å¦‚æœCRIæ˜¯é€šè¿‡dockershimå®ç°çš„è¯ï¼Œkubeleté€šè¿‡CRIæ¥å£å»æ‹‰èµ·ä¸€ä¸ªå®¹å™¨ï¼Œå°±å¥½æ¯”æ˜¯é€šè¿‡docker-d</description>
			<content type="html"><![CDATA[<h2 id="å®¹å™¨è¿è¡Œæ—¶æŒ‚è½½å·çš„è¿‡ç¨‹">å®¹å™¨è¿è¡Œæ—¶æŒ‚è½½å·çš„è¿‡ç¨‹</h2>
<p>å¦‚æœCRIæ˜¯é€šè¿‡dockershimå®ç°çš„è¯ï¼Œkubeleté€šè¿‡CRIæ¥å£å»æ‹‰èµ·ä¸€ä¸ªå®¹å™¨ï¼Œå°±å¥½æ¯”æ˜¯é€šè¿‡docker-daemonæ‰§è¡Œ<code>docker run</code>å‘½ä»¤ã€‚</p>
<p>è€Œå¦‚æœæƒ³è¦åœ¨å®¹å™¨ä¸­æŒ‚è½½å®¿ä¸»æœºç›®å½•çš„è¯ï¼Œå°±è¦å¸¦ä¸Š<code>-v</code>å‚æ•°ï¼Œä»¥ä¸‹é¢è¿™æ¡å‘½ä»¤ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>docker run -v /home:/test ...
</code></pre></div><p>å®ƒçš„å…·ä½“çš„å®ç°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p>åˆ›å»ºå®¹å™¨è¿›ç¨‹å¹¶å¼€å¯Mount namespace</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="ln">1</span><span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">main_function</span><span class="p">,</span> <span class="n">stack_size</span><span class="p">,</span> <span class="n">CLONE_NEWNS</span> <span class="o">|</span> <span class="n">SIGCHLD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> 
</code></pre></div></li>
<li>
<p>å°†å®¿ä¸»æœºç›®å½•æŒ‚è½½åˆ°å®¹å™¨è¿›ç¨‹çš„ç›®å½•ä¸­æ¥</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="ln">1</span><span class="n">mount</span><span class="p">(</span><span class="s">&#34;/home&#34;</span><span class="p">,</span> <span class="s">&#34;/test&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">MS_BIND</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
</code></pre></div><blockquote>
<p>æ­¤æ—¶è™½ç„¶å¼€å¯äº†mount namespaceï¼Œåªä»£è¡¨ä¸»æœºå’Œå®¹å™¨ä¹‹é—´mountç‚¹éš”ç¦»å¼€äº†ï¼Œå®¹å™¨ä»ç„¶å¯ä»¥çœ‹åˆ°ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿç›®å½•ã€‚</p>
</blockquote>
</li>
<li>
<p>è°ƒç”¨ <code>pivot_root</code> æˆ– <code>chroot</code>ï¼Œæ”¹å˜å®¹å™¨è¿›ç¨‹çš„æ ¹ç›®å½•ã€‚è‡³æ­¤ï¼Œå®¹å™¨å†ä¹Ÿçœ‹ä¸åˆ°å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿç›®å½•äº†ã€‚</p>
</li>
</ol>
<h2 id="kubeletæŒ‚è½½å·çš„è¿‡ç¨‹">kubeletæŒ‚è½½å·çš„è¿‡ç¨‹</h2>
<p>å½“ä¸€ä¸ªPodè¢«è°ƒåº¦åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¹‹åï¼Œkubeleté¦–å…ˆä¸ºè¿™ä¸ªPodåœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªVolumeç›®å½•ï¼š</p>
<p><strong>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</strong>ã€‚</p>
<p>åœ¨kubernetesä¸­ï¼Œå·<code>volumes</code>æ˜¯Podçš„ä¸€ä¸ªå±æ€§ï¼Œè€Œä¸æ˜¯å®¹å™¨çš„ã€‚kubeletå…ˆä»¥Podä¸ºå•ä½ï¼Œåœ¨å®¿ä¸»æœºè¿™ä¸ªVolumeç›®å½•ä¸­å‡†å¤‡å¥½Podéœ€è¦çš„å·ã€‚æ¥ç€å¯åŠ¨å®¹å™¨ï¼Œå®¹å™¨å¯åŠ¨æ—¶ï¼Œæ ¹æ®<code>volumeMounts</code>çš„å®šä¹‰å°†ä¸»æœºçš„è¿™ä¸ªç›®å½•ä¸‹çš„éƒ¨åˆ†å·èµ„æºæŒ‚è½½è¿›æ¥ã€‚æŒ‚è½½çš„è¿‡ç¨‹å¦‚å‰æ‰€è¿°ï¼Œç›¸å½“äºä¸ºæ¯ä¸ªå®¹å™¨æ‰§è¡Œäº†å‘½ä»¤ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>docker run -v /var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;:/&lt;å®¹å™¨å†…çš„ç›®æ ‡ç›®å½•&gt; æˆ‘çš„é•œåƒ ...
</code></pre></div><p>è€Œkubeletæ˜¯æ€ä¹ˆæŠŠå·æŒ‚è½½åˆ°ä¸»æœºçš„volumesç›®å½•ä¸‹çš„å‘¢ï¼Ÿè¿™å–å†³äºVolumeçš„ç±»å‹ã€‚</p>
<h3 id="è¿œç¨‹å—å­˜å‚¨">è¿œç¨‹å—å­˜å‚¨</h3>
<ol>
<li>
<p>Attachï¼šå°†è¿œç¨‹ç£ç›˜æŒ‚è½½åˆ°æœ¬åœ°ï¼Œæˆä¸ºä¸€ä¸ªä¸»æœºä¸Šçš„ä¸€ä¸ªå—è®¾å¤‡ï¼Œé€šè¿‡<code>lsblk</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°ã€‚</p>
<blockquote>
<p>Attach è¿™ä¸€æ­¥ï¼Œç”±<code>kube-controller-manager</code>ä¸­çš„<code>Volume Controller</code>è´Ÿè´£</p>
</blockquote>
</li>
<li>
<p>Mountï¼šæœ¬åœ°æœ‰äº†æ–°çš„å—è®¾å¤‡åï¼Œå…ˆå°†å…¶æ ¼å¼åŒ–ä¸ºæŸç§æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åï¼Œå°±å¯ä»¥è¿›è¡Œmountæ“ä½œäº†ã€‚</p>
<blockquote>
<p>Mount è¿™ä¸€æ­¥ï¼Œç”±kubeletä¸­çš„<code>VolumeManagerReconciler</code>è¿™ä¸ªæ§åˆ¶å¾ªç¯è´Ÿè´£ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹äºkubeletä¸»å¾ªç¯çš„goroutineã€‚</p>
</blockquote>
</li>
</ol>
<h3 id="nfs">NFS</h3>
<p>NFSæœ¬èº«å·²ç»æ˜¯ä¸€ä¸ªè¿œç¨‹çš„æ–‡ä»¶ç³»ç»Ÿäº†ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿›è¡Œmountï¼Œç›¸å½“äºæ‰§è¡Œï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>mount -t nfs &lt;NFSæœåŠ¡å™¨åœ°å€&gt;:/ /var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt; 
</code></pre></div><h3 id="hostpath">hostPath</h3>
<p>hostPathç±»å‹çš„æŒ‚è½½æ–¹å¼ï¼Œå’Œå®¿ä¸»æœºä¸Šçš„Volumeç›®å½•æ²¡å•¥å…³ç³»ï¼Œå°±æ˜¯å®¹å™¨ç›´æ¥æŒ‚è½½æŒ‡å®šçš„å®¿ä¸»æœºç›®å½•ã€‚</p>
<h3 id="emptydirdownwardapiconfigmapsecret">emptyDirã€downwardAPIã€configMapã€secret</h3>
<p>è¿™å‡ ç§æŒ‚è½½æ–¹å¼ï¼Œæ•°æ®éƒ½ä¼šéšç€Podçš„æ¶ˆäº¡è€Œè¢«åˆ é™¤ã€‚åŸå› æ˜¯kubeletåœ¨åˆ›å»ºPodçš„Volumeèµ„æºæ—¶ï¼Œå…¶å®æ˜¯åœ¨ä¸»æœºçš„Volumeç›®å½•ä¸‹åˆ›å»ºäº†ä¸€äº›å­ç›®å½•ä¾›å®¹å™¨è¿›è¡ŒæŒ‚è½½ã€‚Podè¢«åˆ é™¤æ—¶ï¼Œkubeletä¹Ÿä¼šæŠŠè¿™ä¸ªVolumeç›®å½•åˆ æ‰ï¼Œä»è€Œè¿™ä¸ªVolumeç›®å½•ä¸­çš„å­ç›®å½•ä¹Ÿéƒ½è¢«åˆ é™¤ï¼Œè¿™å‡ ç§ç±»å‹çš„æ•°æ®å°±è¢«åˆ æ‰äº†ã€‚</p>
<blockquote>
<p>è¿œç¨‹å—å­˜å‚¨ã€NFSå­˜å‚¨ç­‰æŒä¹…åŒ–çš„å­˜å‚¨ï¼Œå’ŒhostPathã€emptyDirã€downwardAPIã€configMapã€secretä¸ä¸€æ ·ï¼Œ<strong>ä¸æ˜¯åœ¨Podæˆ–ä»»ä½•ä¸€ç§workloadä¸­çš„volumeå­—æ®µä¸­ç›´æ¥å®šä¹‰çš„</strong>ï¼Œè€Œæ˜¯åœ¨PVä¸­å®šä¹‰çš„ã€‚</p>
</blockquote>
<h2 id="pvcpvå’Œstorageclass">PVCã€PVå’ŒStorageClass</h2>
<p>åœ¨Podä¸­ï¼Œå¦‚æœæƒ³ä½¿ç”¨æŒä¹…åŒ–çš„å­˜å‚¨ï¼Œå¦‚ä¸Šé¢æåˆ°çš„è¿œç¨‹å—å­˜å‚¨ã€NFSå­˜å‚¨ï¼Œæˆ–æ˜¯æœ¬åœ°å—å­˜å‚¨ï¼ˆéhostPathï¼‰ï¼Œåˆ™åœ¨volumeså­—æ®µä¸­ï¼Œå®šä¹‰<code>persistentVolumeClaim</code>ï¼Œå³PVCã€‚</p>
<p>PVCå’ŒPVè¿›è¡Œç»‘å®šçš„è¿‡ç¨‹ï¼Œç”±<code>Volume Controller</code>ä¸­çš„<code>PersistentVolumeController</code>è¿™ä¸ªæ§åˆ¶å¾ªç¯è´Ÿè´£ã€‚æ‰€è°“â€œç»‘å®šâ€ï¼Œä¹Ÿå°±æ˜¯å¡«å†™PVCä¸­çš„<code>spec.volumeName</code>å­—æ®µè€Œå·²ã€‚<code>PersistentVolumeController</code>åªä¼šå°†StorageClassç›¸åŒçš„PVCå’ŒPVç»‘å®šèµ·æ¥ã€‚</p>
<p>StorageClassä¸»è¦ç”¨æ¥åŠ¨æ€åˆ†é…å­˜å‚¨(Dynamic Provisioning)ã€‚StorageClassä¸­çš„<code>provisioner</code>å­—æ®µç”¨äºæŒ‡å®šä½¿ç”¨å“ªç§<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner">å­˜å‚¨æ’ä»¶</a>è¿›è¡ŒåŠ¨æ€åˆ†é…ï¼Œå½“ç„¶ï¼Œå‰ææ˜¯ä½ è¦åœ¨kubernetesä¸­è£…å¥½å¯¹åº”çš„å­˜å‚¨æ’ä»¶ã€‚<code>parameters</code>å­—æ®µå°±æ˜¯ç”Ÿæˆå‡ºæ¥çš„PVçš„å‚æ•°ã€‚</p>
<blockquote>
<p><code>PersistentVolumeController</code>åªæ˜¯åœ¨æ‰¾ä¸åˆ°å¯¹åº”çš„PVèµ„æºå’ŒPVCè¿›è¡Œç»‘å®šæ—¶ï¼Œå€ŸåŠ©StorageClassç”Ÿæˆäº†ä¸€ä¸ªPVè¿™ä¸ªAPIå¯¹è±¡ã€‚å…·ä½“è¿™ä¸ªPVæ˜¯æ€ä¹ˆæˆä¸ºä¸»æœºvolumeç›®å½•ä¸‹çš„ä¸€ä¸ªå­ç›®å½•çš„ï¼Œåˆ™æ˜¯é å‰é¢æ‰€è¿°çš„Attach + Mountä¸¤é˜¶æ®µå¤„ç†åçš„ç»“æœã€‚å½“ç„¶å¦‚æœæ˜¯NFSæˆ–æœ¬åœ°æŒä¹…åŒ–å·ï¼Œå°±ä¸éœ€è¦<code>Volume Controller</code>è¿›è¡ŒAttachæ“ä½œäº†ã€‚</p>
</blockquote>
<h2 id="æœ¬åœ°æŒä¹…åŒ–å·">æœ¬åœ°æŒä¹…åŒ–å·</h2>
<p>å¯¹äºæœ¬åœ°æŒä¹…åŒ–å·ï¼Œé€šè¿‡åœ¨PVæ¨¡ç‰ˆä¸­</p>
<ul>
<li>å®šä¹‰<code>spec.nodeAffinity</code>æ¥æŒ‡å®šæŒä¹…åŒ–å·ä½äºå“ªä¸ªå®¿ä¸»æœºä¸Š</li>
<li>å®šä¹‰<code>spec.local.path</code>æ¥æŒ‡å®šå®¿ä¸»æœºçš„æŒä¹…åŒ–å·çš„è·¯å¾„ã€‚</li>
</ul>
<p>æ­¤å¤–ï¼Œç”±äº<code>PersistentVolumeController</code>åªä¼šå°†StorageClassç›¸åŒçš„PVCå’ŒPVç»‘å®šèµ·æ¥ï¼Œæ‰€ä»¥è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªStorageClassï¼Œå¹¶ä¸”ä½¿PVCå’ŒPVä¸­çš„<code>StorageClassName</code>ç›¸åŒã€‚</p>
<p>åœ¨ StorageClass é‡Œï¼Œè¿›è¡Œäº†å¦‚ä¸‹å®šä¹‰ï¼š<code>volumeBindingMode: WaitForFirstConsumer</code>ï¼Œè¿™ä¸ªå­—æ®µçš„ä½œç”¨æ˜¯<strong>å»¶è¿Ÿç»‘å®šPVå’ŒPVC</strong>ã€‚å®šä¹‰äº†è¿™ä¸ªå­—æ®µï¼ŒPVCå’ŒPVçš„ç»‘å®šå°±ä¸ä¼šåœ¨<code>PersistentVolumeController</code>ä¸­è¿›è¡Œï¼Œè€Œæ˜¯ç”±<strong>è°ƒåº¦å™¨</strong>åœ¨è°ƒåº¦Podçš„æ—¶å€™ï¼Œæ ¹æ®Podä¸­å£°æ˜çš„PVCï¼Œæ¥å†³å®šå’Œå“ªä¸ªPVè¿›è¡Œç»‘å®šã€‚</p>
<p>æœ¬åœ°æŒä¹…åŒ–å·æ˜¯æ²¡åŠæ³•è¿›è¡Œ Dynamic Provisioningçš„ï¼Œæ‰€ä»¥StorageClasså­—æ®µä¸­çš„<code>provisioner</code>å®šä¹‰çš„æ˜¯<code>kubernetes.io/no-provisioner</code>ã€‚ä½†æ˜¯å®ƒçš„Static Provisioningä¹Ÿå¹¶ä¸éœ€è¦çº¯æ‰‹å·¥æ“ä½œã€‚è¿ç»´äººå‘˜å¯ä»¥ä½¿ç”¨<a href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner">local-static-provisioner</a>å¯¹PVè¿›è¡Œè‡ªåŠ¨ç®¡ç†ã€‚å®ƒçš„åŸç†æ˜¯é€šè¿‡DaemonSetæ£€æµ‹èŠ‚ç‚¹çš„<code>/mnt/disks</code>ç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸‹å¦‚æœå­˜åœ¨æŒ‚è½½ç‚¹ï¼Œåˆ™æ ¹æ®è¿™ä¸ªè·¯å¾„è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„PVã€‚æ‰€ä»¥ï¼Œè¿ç»´äººå‘˜åªéœ€è¦åœ¨nodeèŠ‚ç‚¹ä¸Šï¼Œåœ¨<code>/mnt/disks</code>ç›®å½•ä¸‹å‡†å¤‡å¥½æŒ‚è½½ç‚¹å³å¯ã€‚</p>
<blockquote>
<p>Qï¼šhostPathå¯ä»¥æ˜¯æŒ‚è½½åœ¨å®¿ä¸»æœºä¸Šçš„ä¸€å—ç£ç›˜ï¼Œè€Œä¸æ˜¯å®¿ä¸»æœºçš„ä¸»ç›®å½•ï¼Œè¿™ç§æƒ…å†µä½¿ç”¨hostPathä½œä¸ºæŒä¹…åŒ–å­˜å‚¨ä¸ä¼šå¯¼è‡´å®¿ä¸»æœºå®•æœºã€‚é‚£æ˜¯ä¸æ˜¯å¯ä»¥ä½¿ç”¨hostPathä»£æ›¿PVC/PVä½œä¸ºæœ¬åœ°æŒä¹…åŒ–å·ï¼Ÿ</p>
<p>Aï¼šä¸å¯ä»¥ã€‚è¿™ç§ç©æ³•å¤±å»äº†<code>PersistentVolumeController</code>å¯¹PVCå’ŒPVè¿›è¡Œè‡ªåŠ¨ç»‘å®šã€è§£ç»‘çš„çµæ´»æ€§ã€‚ä¹Ÿå¤±å»äº†é€šè¿‡<code>local-static-provisioner</code>å¯¹PVè¿›è¡Œè‡ªåŠ¨ç®¡ç†çš„çµæ´»æ€§ã€‚æœ€å…³é”®çš„æ˜¯å¤±å»äº†<strong>å»¶è¿Ÿç»‘å®š</strong>çš„ç‰¹æ€§ï¼Œè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦çš„æ—¶å€™ï¼Œæ— æ³•å‚è€ƒèŠ‚ç‚¹å­˜å‚¨çš„ä½¿ç”¨æƒ…å†µã€‚</p>
<p>Qï¼šåˆ é™¤ä¸€ä¸ªè¢«Podä½¿ç”¨ä¸­çš„PVC/PVæ—¶ï¼Œkubectlä¼šå¡ä½ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>Aï¼šPVCå’ŒPVä¸­å®šä¹‰äº†<code>kubernetes.io/pvc-protection</code>ã€<code>kubernetes.io/pv-protection</code>è¿™ä¸ªfinalizerå­—æ®µï¼Œåˆ é™¤æ—¶ï¼Œèµ„æºä¸ä¼šè¢«apiserverç«‹å³åˆ é™¤ï¼Œè¦ç­‰åˆ°<code>volume controller</code>è¿›è¡Œ<strong>pre-delete</strong>æ“ä½œåï¼Œå°†finalizerå­—æ®µåˆ æ‰ï¼Œæ‰ä¼šè¢«å®é™…åˆ é™¤ã€‚è€Œ<code>volume controller</code>çš„<strong>pre-delete</strong>æ“ä½œå®é™…ä¸Šå°±æ˜¯æ£€æŸ¥PVC/PVæœ‰æ²¡æœ‰è¢«Podä½¿ç”¨ã€‚</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>kubernetesç½‘ç»œä¹‹æµ…è°ˆå•æœºå®¹å™¨ç½‘ç»œ</title>
			<link>https://cvvz.fun/post/container-network/</link>
			<pubDate>Thu, 03 Dec 2020 00:16:18 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/container-network/</guid>
			<description>å®¹å™¨ç½‘ç»œç¯å¢ƒéš”ç¦»æ€ä¹ˆç†è§£ï¼Ÿ å®¹å™¨çš„ç½‘ç»œç¯å¢ƒæ˜¯éš”ç¦»çš„ï¼Œè¿™ä¸ªéš”ç¦»å°±ä½“ç°åœ¨ä¸å…±ç”¨å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œå³ä¸å…±ç”¨ç½‘ç»œåè®®æ ˆè¦ç”¨åˆ°çš„æ•°æ®å’Œè®¾å¤‡äº†ï¼š ä¼ è¾“å±‚ï¼šç«¯å£</description>
			<content type="html"><![CDATA[<h2 id="å®¹å™¨ç½‘ç»œç¯å¢ƒéš”ç¦»æ€ä¹ˆç†è§£">å®¹å™¨ç½‘ç»œç¯å¢ƒéš”ç¦»æ€ä¹ˆç†è§£ï¼Ÿ</h2>
<p>å®¹å™¨çš„ç½‘ç»œç¯å¢ƒæ˜¯éš”ç¦»çš„ï¼Œè¿™ä¸ªéš”ç¦»å°±ä½“ç°åœ¨ä¸å…±ç”¨å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œå³<strong>ä¸å…±ç”¨ç½‘ç»œåè®®æ ˆè¦ç”¨åˆ°çš„æ•°æ®å’Œè®¾å¤‡</strong>äº†ï¼š</p>
<ul>
<li>ä¼ è¾“å±‚ï¼šç«¯å£å·</li>
<li>ç½‘ç»œå±‚ï¼šè·¯ç”±è¡¨ã€iptablesè§„åˆ™</li>
<li>æ•°æ®é“¾è·¯å±‚ï¼šç½‘å¡è®¾å¤‡ã€arpç¼“å­˜è¡¨</li>
</ul>
<p>å¦‚æœåœ¨å®¹å™¨ä¸­æ‰§è¡Œ<code>iptables</code>ã€<code>ifconfig</code>ã€<code>arp</code>å’Œ<code>route</code>å‘½ä»¤çœ‹åˆ°çš„è‚¯å®šæ˜¯ä¸åŒçš„iptablesè§„åˆ™ã€ç½‘ç»œè®¾å¤‡ã€arpç¼“å­˜è¡¨å’Œè·¯ç”±è¡¨ã€‚</p>
<h2 id="ç½‘æ¡¥å’Œveth-pair">ç½‘æ¡¥å’Œveth pair</h2>
<p>åŒä¸€ä¸ªå®¿ä¸»æœºçš„å®¹å™¨ä¹‹é—´é€šä¿¡æ˜¯é€šè¿‡äºŒå±‚ç½‘ç»œè¿›è¡Œé€šä¿¡çš„ã€‚ç‰©ç†æœºå¦‚æœæƒ³é€šè¿‡äºŒå±‚ç½‘ç»œé€šä¿¡ï¼Œé‚£ä¹ˆå¿…é¡»è¦æœ‰ä¸¤æ ·ä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯ç½‘çº¿ï¼Œä¸€ä¸ªæ˜¯äº¤æ¢æœºã€‚</p>
<p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œæ‰®æ¼”è™šæ‹Ÿäº¤æ¢æœºè§’è‰²çš„ï¼Œå«åšç½‘æ¡¥ï¼›æ‰®æ¼”ç½‘çº¿è§’è‰²çš„ï¼Œå«åšveth pairã€‚</p>
<p>ä»¥Dockerä¸ºä¾‹ï¼Œåœ¨bridgeæ¨¡å¼ä¸‹ï¼š</p>
<ul>
<li>Docker Daemonç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ä¼šåˆ›å»º<code>docker0</code>ç½‘æ¡¥ï¼›</li>
<li>åœ¨åˆ›å»ºå®¹å™¨æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªveth pairï¼Œå³vethè®¾å¤‡å¯¹ã€‚</li>
</ul>
<p>veth pairæœ‰ä¸¤ä¸ªç«¯ç‚¹ï¼š</p>
<ul>
<li>ä¸€ç«¯åœ¨å®¿ä¸»æœºä¸­ï¼Œå¯ä»¥çœ‹æˆæ˜¯å®¿ä¸»æœºçš„ä¸€å—è™šæ‹Ÿç½‘å¡ï¼Œä½†è¢«å…³è”åˆ°docker0ç½‘æ¡¥ä¸Šï¼›</li>
<li>å¦ä¸€ç«¯ï¼Œåˆ™å€ŸåŠ©net namespaceæŠ€æœ¯ï¼Œå˜æˆäº†å®¹å™¨ä¸­çš„eth0ç½‘å¡ã€‚</li>
</ul>
<blockquote>
<p>veth pairä¹‹æ‰€ä»¥å¯ä»¥è¢«çœ‹æˆâ€œç½‘çº¿â€ï¼Œæ˜¯å› ä¸ºå®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼Œåªè¦æœ‰ä¸€ç«¯æ”¶åˆ°äº†æ•°æ®åŒ…ï¼ŒåŒæ ·çš„æ•°æ®åŒ…ä¹Ÿä¼šåœ¨å¦ä¸€ç«¯å‡ºç°ã€‚ä¸å—namespaceçš„çº¦æŸã€‚</p>
</blockquote>
<p>ç½‘æ¡¥ï¼šLinuxçš„ç½‘æ¡¥æä¾›äº†åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šå„ç§ç½‘ç»œè®¾å¤‡ä¹‹é—´äº’ç›¸è½¬å‘æ•°æ®çš„è®¾å¤‡ã€‚<strong>æ™®é€šçš„äº¤æ¢æœºå¯¹äºæ¥æ”¶åˆ°çš„æŠ¥æ–‡ï¼Œè¦ä¹ˆè½¬å‘ï¼Œè¦ä¹ˆä¸¢å¼ƒï¼Œç½‘æ¡¥é™¤äº†å…·å¤‡æ™®é€šäº¤æ¢æœºçš„åŠŸèƒ½ä»¥å¤–ï¼Œå®ƒè¿˜å¯ä»¥è°ƒç”¨å†…æ ¸åè®®æ ˆï¼Œå¤„ç†å‘é€ç»™æœ¬æœºçš„æŠ¥æ–‡</strong>ã€‚</p>
<h2 id="åŒå®¿ä¸»æœºä¸­çš„å®¹å™¨é€šä¿¡è¿‡ç¨‹">åŒå®¿ä¸»æœºä¸­çš„å®¹å™¨é€šä¿¡è¿‡ç¨‹</h2>
<p>åŒä¸€å°å®¿ä¸»æœºä¸­çš„ä¸¤ä¸ªå®¹å™¨ï¼ˆå®¹å™¨A -&gt; å®¹å™¨Bï¼‰å»ºç«‹é€šä¿¡çš„è¿‡ç¨‹å¦‚ä¸‹ï¼ˆ<strong>å®¹å™¨Bçš„ipåœ°å€ä¸º172.17.0.3</strong>ï¼‰ï¼š</p>
<ol>
<li>
<p>å®¹å™¨Aä¸­çš„å†…æ ¸ç½‘ç»œåè®®æ ˆå¯¹ç½‘ç»œå±‚è¿›è¡Œå¤„ç†æ—¶ï¼Œå»æŸ¥è·¯ç”±è¡¨ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ route
<span class="ln">2</span>Kernel IP routing table
<span class="ln">3</span>Destination     Gateway        Genmask       Flags  Metric Ref Use Iface
<span class="ln">4</span>default         172.17.0.1     0.0.0.0        UG     <span class="m">0</span>     <span class="m">0</span>   <span class="m">0</span>   eth0
<span class="ln">5</span>172.17.0.0      0.0.0.0        255.255.0.0    U      <span class="m">0</span>     <span class="m">0</span>   <span class="m">0</span>   eth0
</code></pre></div><p>å‘ç°è·¯ç”±è¡¨ä¸­å®¹å™¨Bçš„ç½‘ç»œåœ°å€å’Œç¬¬äºŒæ¡è§„åˆ™åŒ¹é…ã€‚è¿™æ¡è·¯ç”±è§„åˆ™çš„ç½‘å…³ï¼ˆGatewayï¼‰æ˜¯ <code>0.0.0.0</code>ï¼Œè¿™å°±æ„å‘³ç€è¿™æ˜¯ä¸€æ¡ç›´è¿è§„åˆ™ï¼Œå³ï¼šå‡¡æ˜¯åŒ¹é…åˆ°è¿™æ¡è§„åˆ™çš„ IP åŒ…ï¼Œåº”è¯¥ç»è¿‡ eth0 ç½‘å¡ï¼Œé€šè¿‡äºŒå±‚ç½‘ç»œç›´æ¥å‘å¾€ç›®çš„ä¸»æœºã€‚</p>
</li>
<li>
<p>å®¹å™¨Aäºæ˜¯æŸ¥è¯¢æœ¬åœ°çš„arpç¼“å­˜è¡¨ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®çš„MACåœ°å€ï¼Œåˆ™å‘ä¸€æ¡arpå¹¿æ’­ï¼Œé€šè¿‡å®¹å™¨çš„eth0ç½‘å¡å‘é€å‡ºå»ã€‚</p>
</li>
<li>
<p>veth pairçš„å¦ä¸€ç«¯æ”¶åˆ°è¿™ä¸ªarpæ¶ˆæ¯ï¼ŒæŠŠå®ƒè½¬å‘ç»™docker0ç½‘æ¡¥ã€‚</p>
<blockquote>
<p>è¿™ä¸ªå¦ä¸€ç«¯æ˜¯å®¿ä¸»æœºçš„ä¸€å—è™šæ‹Ÿç½‘å¡ï¼Œæœ¬æ¥æ˜¯åº”è¯¥å¯ä»¥è°ƒç”¨ç½‘ç»œåè®®æ ˆæ¥å¤„ç†æ”¶åˆ°çš„æ•°æ®åŒ…çš„ï¼Œä½†æ˜¯å®ƒè¢«å’Œdocker0ç½‘æ¡¥ç»‘å®šäº†ï¼Œæ‰€ä»¥å®ƒçš„åŠŸèƒ½è¢«é™çº§ä¸ºäº¤æ¢æœºçš„ä¸€ä¸ªç«¯å£ï¼Œåªèƒ½æ— è„‘æŠŠæ•°æ®åŒ…å‘ç»™ç½‘æ¡¥å»å¤„ç†ã€‚</p>
</blockquote>
</li>
<li>
<p>docker0ç½‘æ¡¥æ‰®æ¼”äºŒå±‚äº¤æ¢æœºçš„è§’è‰²ï¼ŒæŠŠarpè¯·æ±‚å¹¿æ’­å‡ºå»ï¼Œæ”¶åˆ°å®¹å™¨Bè¿”å›çš„MACåœ°å€åï¼Œå†é€šè¿‡åŸé“¾è·¯æŠŠMACåœ°å€è¿”å›ç»™å®¹å™¨Aã€‚</p>
</li>
<li>
<p>å®¹å™¨Aä½¿ç”¨ç›®çš„MACåœ°å€å’ŒæºMACåœ°å€å°è£…é“¾è·¯å±‚å¤´éƒ¨ï¼Œå°†æ¶ˆæ¯é€šè¿‡eth0ç½‘å¡å‘é€å‡ºå»ã€‚</p>
</li>
<li>
<p>docker0ç½‘æ¡¥æ”¶åˆ°æ•°æ®åŒ…ï¼Œç›´æ¥æ ¹æ®ç›®çš„MACåœ°å€å°†å…¶è½¬å‘ç»™å®¹å™¨Bã€‚</p>
</li>
</ol>
<p>æ•´ä¸ªè¿‡ç¨‹å¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾æ¦‚æ‹¬ï¼š</p>
<figure>
    <img src="/container-network.png" width="600px"/> 
</figure>

<h2 id="podä¸­çš„å®¹å™¨ç½‘ç»œ">Podä¸­çš„å®¹å™¨ç½‘ç»œ</h2>
<p>åˆ›å»ºä¸€ä¸ªPodå‰ï¼Œé¦–å…ˆè¦åˆ›å»ºinfraå®¹å™¨ï¼Œè¿™ä¸ªinfraå®¹å™¨å°±é€šè¿‡vethè®¾å¤‡è¿æ¥åˆ°ç½‘æ¡¥ï¼Œæ¥ç€åˆ›å»ºå…¶ä»–å®¹å™¨ï¼Œå…¶ä»–å®¹å™¨<strong>åŠ å…¥</strong>infraå®¹å™¨çš„net namespaceï¼Œè¿™æ ·ï¼Œå°±èƒ½åšåˆ°å’Œinfraå®¹å™¨ä¹‹é—´ä»¥localhostçš„æ–¹å¼é€šä¿¡ï¼Œ<strong>å› ä¸ºåŒä¸€ä¸ªnamespaceä¸­çš„è¿›ç¨‹ï¼Œå…±äº«å†…æ ¸æ•°æ®å’Œç½‘ç»œè®¾å¤‡</strong>ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>ä»¥aggregated apiserverçš„æ–¹å¼éƒ¨ç½²admission webhook</title>
			<link>https://cvvz.fun/post/why-aggregated-api-server-webhook/</link>
			<pubDate>Tue, 01 Dec 2020 07:19:06 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/why-aggregated-api-server-webhook/</guid>
			<description>çƒ­èº«æ¦‚å¿µï¼šapiserverè®¤è¯å®¢æˆ·ç«¯çš„æ–¹å¼ apiserverä¸ºå®¢æˆ·ç«¯æä¾›ä¸‰ç§è®¤è¯æ–¹å¼ï¼š httpsåŒå‘è®¤è¯ï¼ˆæ³¨æ„æ˜¯åŒå‘è®¤è¯ï¼Œä¾‹å¦‚kubeco</description>
			<content type="html"><![CDATA[<h2 id="çƒ­èº«æ¦‚å¿µapiserverè®¤è¯å®¢æˆ·ç«¯çš„æ–¹å¼">çƒ­èº«æ¦‚å¿µï¼šapiserverè®¤è¯å®¢æˆ·ç«¯çš„æ–¹å¼</h2>
<p>apiserverä¸ºå®¢æˆ·ç«¯æä¾›ä¸‰ç§è®¤è¯æ–¹å¼ï¼š</p>
<ol>
<li>https<strong>åŒå‘</strong>è®¤è¯ï¼ˆæ³¨æ„æ˜¯åŒå‘è®¤è¯ï¼Œä¾‹å¦‚kubeconfigæ–‡ä»¶ä¸­æ—¢è¦é…ç½®å®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥ï¼Œåˆè¦é…ç½®CAè¯ä¹¦ï¼‰</li>
<li>http tokenè®¤è¯ï¼ˆä¾‹å¦‚serviceaccountå¯¹åº”çš„secretä¸­ï¼ŒåŒ…å«tokenæ–‡ä»¶ã€caè¯ä¹¦ï¼Œå®¹å™¨å°±æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªæ–‡ä»¶å’Œapiserverè¿›è¡Œhttp tokenè®¤è¯çš„ï¼‰</li>
<li>http baseè®¤è¯ï¼ˆç”¨æˆ·å+å¯†ç ï¼‰</li>
</ol>
<h2 id="admission-webhookå’Œæ‰©å±•apiserver">admission webhookå’Œæ‰©å±•apiserver</h2>
<blockquote>
<p>å¯¹äºadmission webhookå’Œæ‰©å±•apiserverè€Œè¨€ï¼Œ<strong>apiserverå¯ä»¥ç®€å•çš„çœ‹ä½œæ˜¯å®¢æˆ·ç«¯</strong>ï¼Œadmission webhookå’Œæ‰©å±•apiserveråˆ™ä½œä¸ºæœåŠ¡ç«¯ã€‚</p>
</blockquote>
<h3 id="apiserveré€šè¿‡httpsè¿æ¥admission-webhook">apiserveré€šè¿‡HTTPSè¿æ¥admission webhook</h3>
<p>å½“apiserverä½œä¸ºå®¢æˆ·ç«¯è¿æ¥admission webhookæ—¶ï¼Œè¦æ±‚admission webhookå¿…é¡»æä¾›httpså®‰å…¨è®¤è¯ï¼Œä½†æ˜¯é»˜è®¤æ˜¯<strong>å•å‘</strong>è®¤è¯å³å¯ã€‚<strong>ä¹Ÿå°±æ˜¯admission webhookè´Ÿè´£æä¾›æœåŠ¡ç«¯è¯ä¹¦ä¾›apiserverè¿›è¡ŒéªŒè¯ï¼Œä½†webhooké»˜è®¤å¯ä»¥ä¸éªŒè¯apiserver</strong>ã€‚apiserveræ‰€éœ€è¦çš„CAè¯ä¹¦åœ¨webhookconfigurationæ–‡ä»¶ä¸­çš„<code>caBundle</code>å­—æ®µä¸­è¿›è¡Œé…ç½®ã€‚å¦‚æœä¸é…ç½®ï¼Œåˆ™é»˜è®¤ä½¿ç”¨apiserverè‡ªå·±çš„CAè¯ä¹¦ã€‚</p>
<p>ç®¡ç†æœåŠ¡ç«¯è¯ä¹¦çš„æ–¹å¼æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥è‡ªå·±ç­¾å‘webhookçš„è¯ä¹¦ï¼Œå¦‚ <code>istio</code> é¡¹ç›®ä¸­ä½¿ç”¨çš„<a href="https://github.com/istio/istio/blob/release-0.7/install/kubernetes/webhook-create-signed-cert.sh">è„šæœ¬</a></li>
<li>åƒ<code>openkruise</code>é¡¹ç›®ä¸€æ ·<a href="https://github.com/openkruise/kruise/blob/master/pkg/webhook/util/controller/webhook_controller.go#L262">åœ¨controllerä¸­è‡ªåŠ¨ç”Ÿæˆè¯ä¹¦</a></li>
<li>ä½¿ç”¨å¼€æºçš„<a href="https://github.com/cert-manager/cert-manager">cert-manager</a>è‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç†è¯ä¹¦</li>
</ul>
<h3 id="admission-webhookéªŒè¯apiserver">admission webhookéªŒè¯apiserver</h3>
<p>å¦‚æœä½ çš„admission webhookæƒ³è¦éªŒè¯å®¢æˆ·ç«¯ï¼ˆä¹Ÿå°±æ˜¯apiserverï¼‰ï¼Œé‚£ä¹ˆå°±éœ€è¦é¢å¤–ç»™apiserveræä¾›ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶çš„å†…å®¹å’Œkubeconfigå¾ˆåƒï¼Œå¯ä»¥æŒ‡å®šapiseverä½¿ç”¨http baseè®¤è¯ã€http tokenæˆ–è€…è¯ä¹¦æ¥å‘webhookæä¾›èº«ä»½è¯æ˜ï¼Œå…·ä½“è¿‡ç¨‹è¯¦è§<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/#authenticate-apiservers">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<p>ç®€å•æ¥è®²å°±æ˜¯ï¼šåœ¨å¯åŠ¨ apiserveræ—¶ï¼Œé€šè¿‡<code>--admission-control-config-file</code> è¿™ä¸ªå‚æ•°æŒ‡å®šäº†å®¢æˆ·ç«¯è®¤è¯çš„é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„æ ¼å¼å’Œç”¨ kubectl è¿æ¥ apiserver æ—¶ç”¨åˆ°çš„ <code>kubeconfig</code> æ ¼å¼å‡ ä¹ä¸€æ ·ã€‚åªä¸è¿‡è¿™é‡Œï¼Œå®¢æˆ·ç«¯æ˜¯apiserverï¼ŒæœåŠ¡ç«¯æ˜¯admission webhookã€‚</p>
<p>é€šè¿‡è¿™ç§æ–¹å¼éªŒè¯å®¢æˆ·ç«¯ï¼Œæœ€éº»çƒ¦çš„åœ°æ–¹æ˜¯éœ€è¦æ‰‹å·¥ç»´æŠ¤kubeconfigï¼Œä¸”å¯¹äºæ¯ä¸ªwebhookéƒ½éœ€è¦ç»´æŠ¤ä¸€ä¸ªã€‚</p>
<h3 id="apiserveré€šè¿‡httpsåŒå‘è¿æ¥æ‰©å±•apiserver">apiserveré€šè¿‡HTTPSï¼ˆåŒå‘ï¼‰è¿æ¥æ‰©å±•apiserver</h3>
<p>aggregated apiserveråœ¨è®¾è®¡ä¹‹åˆå°±è§£å†³äº†å®¢æˆ·ç«¯è®¤è¯çš„é—®é¢˜ï¼Œå…·ä½“å®ç°è¿‡ç¨‹è¯¦è§<a href="https://kubernetes.io/zh/docs/tasks/extend-kubernetes/configure-aggregation-layer/#kubernetes-apiserver-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%A4%E8%AF%81">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h2 id="ä»¥æ‰©å±•apiserverçš„æ–¹å¼éƒ¨ç½²admission-webhook">ä»¥æ‰©å±•apiserverçš„æ–¹å¼éƒ¨ç½²admission webhook</h2>
<p>openshift çš„ <a href="https://github.com/openshift/generic-admission-server#generic-admission-server">generic-admission-serveråº“</a> æ˜¯ä¸€ç§ç”¨æ¥ç¼–å†™admission webhookçš„libåº“ï¼Œä½¿ç”¨å®ƒå¯ä»¥<strong>é¿å…äººå·¥åˆ›å»ºå’Œç»´æŠ¤å®¢æˆ·ç«¯keyå’Œè¯ä¹¦çš„å¤æ‚æ€§ï¼ˆå³ä¸Šé¢æåˆ°çš„apiserverçš„kubeconfigæ–‡ä»¶ï¼‰ã€‚ä¸è¿‡æˆ‘è§‰å¾—å®ƒæ›´å¤§çš„å¥½å¤„æ˜¯åŒæ—¶ä¹Ÿçœå»äº†åˆ›å»ºå’Œç»´æŠ¤æœåŠ¡ç«¯è¯ä¹¦çš„æ­¥éª¤ï¼Œä½¿å¾—å¼€å‘äººå‘˜å¯ä»¥æ›´åŠ ä¸“æ³¨äºwebhookçš„åŠŸèƒ½æœ¬èº«ï¼Œå®‰å…¨æ€§ç›¸å…³çš„åŠŸèƒ½å€Ÿç”±kubernetesçš„èšåˆå±‚apiserverçš„åŒå‘è®¤è¯æœºåˆ¶è‡ªåŠ¨å®Œæˆ</strong>ï¼Œè¿™æ˜¯é€šè¿‡å¸¸è§„æ–¹å¼éƒ¨ç½²admission webhookæ—¶æ‰€åŠä¸åˆ°çš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„åŸç†æ˜¯æ€æ ·çš„ï¼š</p>
<ol>
<li>
<p>é¦–å…ˆåœ¨ WebhookConfiguration ä¸­ï¼Œé…ç½®admission webhookä¸ºkubernetesæœåŠ¡ï¼Œå³apiserverè‡ªå·±ï¼Œå¹¶è®¾ç½®pathä¸ºä¸€ä¸ªç‰¹æ®Šçš„groupã€versionï¼Œ<strong>è¿™ä¸€æ­¥ç›¸å½“äºæ˜¯apiserveræŠŠè¯·æ±‚è½¬å‘ç»™äº†è‡ªå·±</strong>ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="ln">1</span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="ln">2</span><span class="w"></span>- <span class="nt">clientConfig</span><span class="p">:</span><span class="w">
</span><span class="ln">3</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="ln">4</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes</span><span class="w">
</span><span class="ln">5</span><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="ln">6</span><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/apis/{group}/{version}/{resource}</span><span class="w">
</span><span class="ln">7</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></code></pre></div></li>
<li>
<p>åœ¨ ApiService ä¸­ï¼Œé…ç½®èšåˆapiçš„groupã€versionï¼Œä»¥åŠåç«¯çš„serviceï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="ln">1</span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="ln">2</span><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span>{<span class="l">group}</span><span class="w">
</span><span class="ln">3</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="ln">4</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{<span class="l">webhook-service}</span><span class="w">
</span><span class="ln">5</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span>{<span class="l">namespace}</span><span class="w">
</span><span class="ln">6</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span><span class="ln">7</span><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span>{<span class="l">version}</span><span class="w">
</span></code></pre></div></li>
</ol>
<p>è¿™ç§æ–¹å¼éƒ¨ç½²çš„admission webhookçš„æ•´ä¸ªå·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<figure>
    <img src="/webhook.drawio.svg" width="400px"/> 
</figure>
</p>
<ol>
<li>
<p>apiserverè¿‡æ»¤æŒ‡å®šçš„è¯·æ±‚ï¼Œ<strong>å°†å®ƒå‘åˆ°è‡ªå·±çš„è·¯å¾„ä¸‹</strong>ã€‚</p>
</li>
<li>
<p>å†ç”±aggregatorè½¬å‘åˆ°æ‰©å±•apiserverï¼Œä¹Ÿå°±æ˜¯çœŸæ­£çš„admission webhookè¿›è¡Œå¤„ç†ã€‚</p>
</li>
</ol>
<p><strong>ä½¿ç”¨èšåˆapiserverè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„å¥½å¤„ï¼šå¯ä»¥è®¾ç½®apiserviceä¸­çš„ <code>spec.insecureSkipTLSVerify</code>å­—æ®µä¸ºtrueï¼Œä½¿ç”¨ä¸å®‰å…¨çš„è¿æ¥ï¼Œè¿™æ ·åœ¨æµ‹è¯•ç¯å¢ƒè°ƒè¯•æ—¶ä»»ä½•è¯ä¹¦éƒ½ä¸éœ€è¦äº†</strong></p>
]]></content>
		</item>
		
		<item>
			<title>kubectl patch</title>
			<link>https://cvvz.fun/post/k8s-kubectl-patch/</link>
			<pubDate>Sun, 22 Nov 2020 23:16:44 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/k8s-kubectl-patch/</guid>
			<description>kubectl patch ç”¨æ¥ä¿®æ”¹ Kubernetes API å¯¹è±¡çš„å­—æ®µã€‚å¯ä»¥é€šè¿‡ --type å‚æ•°æŒ‡å®šä¸‰ç§ä¸åŒç±»å‹çš„ patch æ–¹å¼ï¼š strategicï¼šstrategic merge patch mergeï¼š json merge patch jsonï¼š json</description>
			<content type="html"><![CDATA[<p><code>kubectl patch</code> ç”¨æ¥ä¿®æ”¹ Kubernetes API å¯¹è±¡çš„å­—æ®µã€‚å¯ä»¥é€šè¿‡ <code>--type</code> å‚æ•°æŒ‡å®šä¸‰ç§ä¸åŒç±»å‹çš„ patch æ–¹å¼ï¼š</p>
<ul>
<li><code>strategic</code>ï¼šstrategic merge patch</li>
<li><code>merge</code>ï¼š json merge patch</li>
<li><code>json</code>ï¼š json patch</li>
</ul>
<p>å®é™…ä½¿ç”¨æƒ…å†µï¼š</p>
<ul>
<li>strategic merge patch ç”¨çš„æ¯”è¾ƒå°‘ï¼›å¤§å¤šä½¿ç”¨ json merge patch å’Œ json patch</li>
<li>json merge patch å’Œ json patch çš„å…·ä½“åŒºåˆ«å¯ä»¥æŸ¥çœ‹<a href="https://erosb.github.io/post/json-patch-vs-merge-patch/">è¿™ç¯‡æ–‡ç« </a></li>
<li>json patch ç›¸æ¯”äº json merge patch ä½¿ç”¨èµ·æ¥å¤æ‚ä¸€ç‚¹ï¼Œä½†ä½¿ç”¨æ–¹æ³•æ›´çµæ´»ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼Œå‰¯ä½œç”¨æ›´å°‘ã€‚å› æ­¤æ›´æ¨èä½¿ç”¨ã€‚</li>
</ul>
<h2 id="strategic-merge-patch">strategic merge patch</h2>
<p>è¿™æ˜¯é»˜è®¤çš„patchç±»å‹ï¼Œstrategic merge patch åœ¨è¿›è¡Œ patch æ“ä½œæ—¶ï¼Œåˆ°åº•æ˜¯è¿›è¡Œ<strong>æ›¿æ¢</strong>è¿˜æ˜¯è¿›è¡Œ<strong>åˆå¹¶</strong>ï¼Œç”± Kubernetes æºä»£ç ä¸­å­—æ®µæ ‡è®°ä¸­çš„ <code>patchStrategy</code> é”®çš„å€¼æŒ‡å®šã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼š</p>
<ul>
<li>å¦‚æœä½ å¯¹deploymentçš„ <code>.spec.template.spec.containers</code> å­—æ®µè¿›è¡Œ strategic merge patchï¼Œé‚£ä¹ˆæ–°çš„ containers ä¸­çš„å­—æ®µå€¼ä¼šåˆå¹¶åˆ°åŸæ¥çš„å­—æ®µä¸­å»ï¼Œå› ä¸º <code>PodSpec</code> ç»“æ„ä½“çš„ <code>Containers</code> å­—æ®µçš„ <code>patchStrategy</code> ä¸º <code>merge</code>ã€‚</li>
<li>å¦‚æœä½ å¯¹deploymentçš„ <code>.spec.template.spec.tolerations</code> å­—æ®µè¿›è¡Œ strategic merge patchï¼Œé‚£ä¹ˆä¼šç”¨æ–°çš„ tolerations å­—æ®µå€¼å°†è€çš„å­—æ®µå€¼ç›´æ¥æ›¿æ¢ã€‚</li>
</ul>
<h2 id="json-merge-patch">json merge patch</h2>
<p><strong>æœ‰ç›¸åŒçš„å­—æ®µå°±æ›¿æ¢ï¼Œæ²¡æœ‰ç›¸åŒçš„å­—æ®µå°±åˆå¹¶</strong>ã€‚è¿™åœ¨è¯­ä¹‰ä¸Šéå¸¸å®¹æ˜“ç†è§£ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹å¼Šç«¯ï¼š</p>
<ul>
<li>é”®å€¼æ— æ³•è¢«è®¾ç½®ä¸º <code>null</code>ï¼Œè®¾ç½®ä¸º <code>null</code> çš„å­—æ®µä¼šç›´æ¥è¢« json merge patch åˆ é™¤æ‰</li>
<li>æ“ä½œæ•°ç»„éå¸¸åƒåŠ›ã€‚å¦‚æœä½ æƒ³æ·»åŠ æˆ–ä¿®æ”¹æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¿…é¡»åœ¨copyåŸæ¥çš„æ•°ç»„ï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œæ”¹åŠ¨ã€‚å› ä¸º<strong>æ–°çš„æ•°ç»„ä¼šè¦†ç›–åŸæ¥çš„æ•°ç»„</strong>ã€‚</li>
</ul>
<p>ç‰¹åˆ«æ˜¯ç¬¬äºŒç‚¹ï¼Œè¿™å¯¼è‡´åªè¦æ˜¯å’Œæ•°ç»„ç›¸å…³çš„patchæ“ä½œï¼Œæœ€å¥½ä½¿ç”¨json patchã€‚</p>
<h2 id="json-patch">json patch</h2>
<p>json patch çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="ln">1</span><span class="p">[</span>
<span class="ln">2</span>    <span class="p">{</span>
<span class="ln">3</span>        <span class="nt">&#34;op&#34;</span> <span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
<span class="ln">4</span>        <span class="nt">&#34;path&#34;</span> <span class="p">:</span> <span class="s2">&#34;&#34;</span> <span class="p">,</span>
<span class="ln">5</span>        <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="s2">&#34;&#34;</span>
<span class="ln">6</span>    <span class="p">}</span>
<span class="ln">7</span><span class="p">]</span>
</code></pre></div><p>å³ç”±æ“ä½œã€å­—æ®µè·¯å¾„ã€æ–°å€¼ç»„æˆã€‚å…·ä½“ä¾‹å­æŸ¥çœ‹<a href="https://erosb.github.io/post/json-patch-vs-merge-patch/">è¿™ç¯‡æ–‡ç« </a>ã€‚å¯ä»¥çœ‹åˆ°è¿™ç§æ“ä½œæ–¹å¼éå¸¸çµæ´»ã€‚</p>
<h2 id="json-patch-è½¬ä¹‰å­—ç¬¦">json patch è½¬ä¹‰å­—ç¬¦</h2>
<ul>
<li>&ldquo;~&quot;ï¼ˆæ³¢æµªçº¿ï¼‰å¯¹åº”çš„æ˜¯ï¼š&quot;~0&rdquo;</li>
<li>&ldquo;/&quot;ï¼ˆæ–œæ ï¼‰å¯¹åº”çš„æ˜¯ï¼š&quot;~1&rdquo;</li>
</ul>
<p>å…·ä½“å¯ä»¥æŸ¥çœ‹è¿™ä¸ª<a href="https://github.com/json-patch/json-patch-tests/issues/42">issue</a>ä¸­çš„è®¨è®ºã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>æµ…è°ˆkubernetesç›‘æ§ä½“ç³»</title>
			<link>https://cvvz.fun/post/k8s-monitor/</link>
			<pubDate>Fri, 20 Nov 2020 00:24:35 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/k8s-monitor/</guid>
			<description>ç›‘æ§å’ŒæŒ‡æ ‡ ç†è§£ç›‘æ§ æˆ‘ä»¬å¯ä»¥æŠŠç›‘æ§ç³»ç»Ÿåˆ’åˆ†ä¸ºï¼šé‡‡é›†æŒ‡æ ‡ã€å­˜å‚¨ã€å±•ç¤ºå’Œå‘Šè­¦å››ä¸ªéƒ¨åˆ†ã€‚ å­˜å‚¨ä½¿ç”¨æ—¶åºæ•°æ®åº“TSDBã€å‰ç«¯å±•ç¤ºä½¿ç”¨grafanaã€å‘Šè­¦</description>
			<content type="html"><![CDATA[<h2 id="ç›‘æ§å’ŒæŒ‡æ ‡">ç›‘æ§å’ŒæŒ‡æ ‡</h2>
<h3 id="ç†è§£ç›‘æ§">ç†è§£ç›‘æ§</h3>
<p>æˆ‘ä»¬å¯ä»¥æŠŠç›‘æ§ç³»ç»Ÿåˆ’åˆ†ä¸ºï¼šé‡‡é›†æŒ‡æ ‡ã€å­˜å‚¨ã€å±•ç¤ºå’Œå‘Šè­¦å››ä¸ªéƒ¨åˆ†ã€‚</p>
<p>å­˜å‚¨ä½¿ç”¨æ—¶åºæ•°æ®åº“TSDBã€å‰ç«¯å±•ç¤ºä½¿ç”¨grafanaã€å‘Šè­¦ç³»ç»Ÿä¹Ÿæœ‰å¤šç§å¼€æºå®ç°ã€‚æˆ‘é‡ç‚¹ä»‹ç»ä¸€ä¸‹å’ŒæŒ‡æ ‡é‡‡é›†ç›¸å…³çš„å†…å®¹ã€‚</p>
<h3 id="ç†è§£æŒ‡æ ‡">ç†è§£æŒ‡æ ‡</h3>
<blockquote>
<p><strong>æˆ‘ä»¬æ‰€é‡‡é›†çš„æŒ‡æ ‡ (metrics)ï¼Œè¿½æ ¹æº¯æºï¼Œè¦ä¹ˆæ¥è‡ªäºæ“ä½œç³»ç»Ÿï¼Œè¦ä¹ˆæ¥è‡ªäºåº”ç”¨è¿›ç¨‹è‡ªèº«</strong>ã€‚</p>
</blockquote>
<p>åœ¨kubernetesä¸­ï¼Œæœ‰ä¸‰ç§æŒ‡æ ‡éœ€è¦è¢«å…³æ³¨ï¼Œåˆ†åˆ«æ¥è‡ªäºï¼š</p>
<ul>
<li>kubernetesåŸºç¡€ç»„ä»¶ã€‚ä¹Ÿå°±æ˜¯ç»„æˆkubernetesçš„åº”ç”¨è¿›ç¨‹ï¼Œå¦‚api-serverã€controller-managerã€schedulerã€kubeletç­‰ã€‚</li>
<li>nodeèŠ‚ç‚¹ã€‚ä¹Ÿå°±æ˜¯ç»„æˆkubernetesçš„æœºå™¨ã€‚</li>
<li>Pod/å®¹å™¨ã€‚ä¹Ÿå°±æ˜¯ä¸šåŠ¡è¿›ç¨‹çš„<strong>è¿è¡Œç¯å¢ƒ</strong>ã€‚</li>
</ul>
<p>åŸºç¡€è®¾æ–½å’Œkubernetesè¿ç»´äººå‘˜ä¸»è¦å…³æ³¨å‰ä¸¤é¡¹æŒ‡æ ‡ï¼Œä¿è¯kubernetesé›†ç¾¤çš„ç¨³å®šè¿è¡Œã€‚</p>
<p>è€Œä¸šåŠ¡æ–¹å¼€å‘/è¿ç»´ä¸»è¦å…³æ³¨<a href="https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md#prometheus-container-metrics">Pod/å®¹å™¨æŒ‡æ ‡</a>ï¼Œè¿™å’Œä»¥å¾€å…³æ³¨<a href="https://book.open-falcon.org/zh_0_2/faq/linux-metrics.html">æ“ä½œç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡</a>å¤§ä¸ä¸€æ ·ã€‚<strong>åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œä¸šåŠ¡è¿›ç¨‹çš„è¿è¡Œç¯å¢ƒä»ç‰©ç†æœº/è™šæ‹Ÿæœºè½¬å˜ä¸ºäº†Pod/å®¹å™¨ã€‚å¯è§ï¼ŒPod/å®¹å™¨å°±æ˜¯äº‘åŸç”Ÿæ—¶ä»£çš„<code>ä¸å¯å˜åŸºç¡€è®¾æ–½</code></strong>ã€‚</p>
<h3 id="é‡‡é›†å®¹å™¨æŒ‡æ ‡çš„è¿‡ç¨‹">é‡‡é›†å®¹å™¨æŒ‡æ ‡çš„è¿‡ç¨‹</h3>
<ol>
<li>kubeletå†…ç½®çš„cAdvisorè´Ÿè´£é‡‡é›†å®¹å™¨æŒ‡æ ‡</li>
<li>kubeletå¯¹å¤–æš´éœ²å‡ºAPI</li>
<li>Promeheusã€Metrics-Serverï¼ˆå–ä»£äº†Heapsterï¼‰é€šè¿‡è¿™äº›APIé‡‡é›†å®¹å™¨æŒ‡æ ‡</li>
</ol>
<h2 id="prometheus">Prometheus</h2>
<p>Prometheusæ˜¯Kubernetesç›‘æ§ä½“ç³»çš„æ ¸å¿ƒã€‚å®ƒçš„<a href="https://prometheus.io/docs/introduction/overview/#architecture">æ¶æ„</a>å¦‚å®˜ç½‘çš„è¿™å¹…ç¤ºæ„å›¾æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/prometheus.png" width="700px"/> 
</figure>

<p>ä»å·¦åˆ°å³å°±åˆ†åˆ«æ˜¯é‡‡é›†æŒ‡æ ‡ã€å­˜å‚¨ã€å±•ç¤ºå’Œå‘Šè­¦è¿™å››å¤§æ¨¡å—ã€‚æˆ‘è¿˜æ˜¯åªä»‹ç»é‡‡é›†æŒ‡æ ‡ç›¸å…³çš„å†…å®¹ã€‚</p>
<h3 id="prometheusæ˜¯å¦‚ä½•é‡‡é›†æŒ‡æ ‡çš„">Prometheusæ˜¯å¦‚ä½•é‡‡é›†æŒ‡æ ‡çš„</h3>
<ol>
<li>ç›´æ¥é‡‡é›†ã€‚Prometheusæä¾›äº†å„è¯­è¨€çš„<a href="https://prometheus.io/docs/instrumenting/clientlibs/#client-libraries">libåº“</a>ï¼Œä½¿åº”ç”¨èƒ½å¤Ÿå¯¹å¤–æš´éœ²HTTPç«¯å£ä¾›prometheusæ‹‰å–æŒ‡æ ‡å€¼ã€‚</li>
<li>é—´æ¥é‡‡é›†ã€‚å¯¹äºæ— æ³•é€šè¿‡ç›´æ¥å¼•å…¥libåº“æˆ–æ”¹ä»£ç çš„æ–¹å¼æ¥å…¥Prometheusçš„åº”ç”¨ç¨‹åºå’Œæ“ä½œç³»ç»Ÿï¼Œåˆ™éœ€è¦å€ŸåŠ©<a href="https://prometheus.io/docs/instrumenting/exporters/#third-party-exporters">exporter</a>ï¼Œä»£æ›¿è¢«ç›‘æ§å¯¹è±¡æ¥å¯¹ Prometheus æš´éœ²å‡ºå¯ä»¥è¢«æŠ“å–çš„ Metrics ä¿¡æ¯ã€‚</li>
</ol>
<h3 id="prometheusæ˜¯å¦‚ä½•é‡‡é›†kubernetesçš„æŒ‡æ ‡çš„">Prometheusæ˜¯å¦‚ä½•é‡‡é›†Kubernetesçš„æŒ‡æ ‡çš„</h3>
<ul>
<li>kubernetesåŸºç¡€ç»„ä»¶ï¼šPrometheusæ˜¯Kubernetesç›‘æ§ä½“ç³»çš„æ ¸å¿ƒï¼Œæ‰€ä»¥è¿™äº›åŸºç¡€ç»„ä»¶å½“ç„¶ç›´æ¥ä½¿ç”¨libåº“é‡‡é›†è‡ªå·±çš„æŒ‡æ ‡å¹¶æš´éœ²å‡ºAPIã€‚</li>
<li>nodeèŠ‚ç‚¹ï¼šæ“ä½œç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡è‚¯å®šåªèƒ½å€ŸåŠ©<a href="https://github.com/prometheus/node_exporter#node-exporter">node exporter</a>æ¥é‡‡é›†äº†ã€‚
<blockquote>
<p><strong>å¦‚æœnode exporterè¿è¡Œåœ¨å®¹å™¨é‡Œï¼Œé‚£ä¹ˆä¸ºäº†è®©å®¹å™¨é‡Œçš„è¿›ç¨‹è·å–åˆ°ä¸»æœºä¸Šçš„ç½‘ç»œã€PIDã€IPCæŒ‡æ ‡ï¼Œå°±éœ€è¦è®¾ç½®<code>hostNetwork: true</code>ã€<code>hostPID: true</code>ã€<code>hostIPC: true</code>ï¼Œæ¥ä¸ä¸»æœºå…±ç”¨ç½‘ç»œã€PIDã€IPCè¿™ä¸‰ä¸ªnamespace</strong>ã€‚</p>
</blockquote>
</li>
<li>Pod/å®¹å™¨ã€‚å¦‚å‰æ‰€è¿°ï¼ŒPrometheuså¯ä»¥é€šè¿‡kubelet(cAdvisor)æš´éœ²å‡ºæ¥çš„APIé‡‡é›†æŒ‡æ ‡ã€‚</li>
</ul>
<h2 id="kubernetes-hpa">kubernetes HPA</h2>
<p>é‡‡é›†åˆ°äº†æ€§èƒ½æŒ‡æ ‡ä¹‹åï¼Œå‘é€å‘é€å‘Šè­¦ï¼Œè®©è¿ç»´ä»‹å…¥ï¼Œè¿™åªæ˜¯æœ€åˆçº§çš„è¿ç»´æ–¹å¼ã€‚æ›´é«˜çº§çš„æ–¹å¼æ˜¯è®©ç³»ç»Ÿè‡ªèº«å…·å¤‡æ ¹æ®æŒ‡æ ‡è¿›è¡Œæ°´å¹³å¼¹æ€§ä¼¸ç¼© (HPA) çš„èƒ½åŠ›ã€‚</p>
<h3 id="metrics-server">Metrics-Server</h3>
<p>Metrics-serverï¼ˆheapsterçš„æ›¿ä»£å“ï¼‰<strong>ä»kubeletä¸­</strong>è·å–Podçš„ç›‘æ§æŒ‡æ ‡ï¼Œå¹¶é€šè¿‡<a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">apiserverèšåˆå±‚</a>çš„æ–¹å¼æš´éœ²APIï¼ŒAPIè·¯å¾„ä¸ºï¼š<code>/apis/metrics.k8s.io/</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ è®¿é—®è¿™ä¸ªapiè·¯å¾„æ—¶ï¼Œapiserverä¼šå¸®ä½ è½¬å‘åˆ°Metrics-serveré‡Œå»å¤„ç†ï¼Œè€Œä¸æ˜¯è‡ªå·±å¤„ç†ã€‚<strong>è¿™æ ·ï¼ŒKubernetesä¸­çš„HPAç»„ä»¶å°±å¯ä»¥é€šè¿‡è®¿é—®è¿™ä¸ªAPIè·å¾—æŒ‡æ ‡æ¥è¿›è¡Œå‚ç›´æ‰©ç¼©å®¹å†³ç­–äº†</strong>ã€‚</p>
<blockquote>
<p><code>kubectl top</code>å‘½ä»¤ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªAPIè·å¾—ç›‘æ§æŒ‡æ ‡çš„ã€‚</p>
</blockquote>
<h3 id="custom-metrics">Custom Metrics</h3>
<p><strong>ä½†æ˜¯åº”ç”¨ç¨‹åºå¾€å¾€æ›´ä¾èµ–è¿›ç¨‹æœ¬èº«çš„ç›‘æ§æŒ‡æ ‡ï¼ˆå¦‚httpè¯·æ±‚æ•°ã€æ¶ˆæ¯é˜Ÿåˆ—çš„å¤§å°ï¼‰è€Œä¸æ˜¯è¿è¡Œç¯å¢ƒçš„ç›‘æ§æŒ‡æ ‡åšå†³ç­–</strong>ã€‚æ‰€ä»¥åªæœ‰Metrics-Serveræš´éœ²å‡ºæ¥çš„APIè‚¯å®šæ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤ï¼ŒKubernetesæä¾›äº†å¦ä¸€ä¸ªAPIä¾›åº”ç”¨ç¨‹åºæš´éœ²è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡ï¼Œè·¯å¾„ä¸º<code>/apis/custom.metrics.k8s.io/</code>ã€‚</p>
<p>Custom Metricsçš„ç©æ³•åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<p><figure>
    <img src="/hpa.drawio.svg" width="600px"/> 
</figure>

å¦‚ä¸Šå›¾æ‰€ç¤º</p>
<ol>
<li>åº”ç”¨Podï¼Œæˆ–è€…å®ƒçš„exporteræš´éœ²å‡ºAPIä¾›Prometheusé‡‡é›†</li>
<li>ç¼–å†™Custom Metrics Serverï¼Œä»Prometheusä¸­è·å–ç›‘æ§æ•°æ®</li>
<li>HPAç»„ä»¶é€šè¿‡è®¿é—®<code>/apis/custom.metrics.k8s.io/</code>è¿›è¡Œæ‰©ç¼©å®¹å†³ç­–ã€‚</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>ã€é—®é¢˜å®šä½ã€‘Celery Workeräº§ç”Ÿåƒµå°¸è¿›ç¨‹</title>
			<link>https://cvvz.fun/post/celery-worker-zombie/</link>
			<pubDate>Mon, 30 Mar 2020 10:36:36 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/celery-worker-zombie/</guid>
			<description>ç»„å†…æœ‰ä¸€ä¸ªåŸºäºFlask + rabbitMQ + Celeryæ­å»ºçš„webå¹³å°ï¼Œæœ€è¿‘åœ¨ä¸Šé¢å¼€å‘éœ€æ±‚æ—¶ç¢°åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ¥ã€‚ é—®é¢˜èƒŒæ™¯ webå¹³å°</description>
			<content type="html"><![CDATA[<blockquote>
<p>ç»„å†…æœ‰ä¸€ä¸ªåŸºäºFlask + rabbitMQ + Celeryæ­å»ºçš„webå¹³å°ï¼Œæœ€è¿‘åœ¨ä¸Šé¢å¼€å‘éœ€æ±‚æ—¶ç¢°åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ¥ã€‚</p>
</blockquote>
<h2 id="é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯</h2>
<p>webå¹³å°æ•´ä½“æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/platform.drawio.svg" width="700px"/> 
</figure>

<p>Flaskå‘rabbitMQå‘é€ä»»åŠ¡æ¶ˆæ¯ï¼Œåè€…å†å°†ä»»åŠ¡åˆ†å‘ç»™ä¸åŒçš„Celery workerè¿›è¡Œå¤„ç†ã€‚ç”±äºæ¯ä¸€ä¸ªä»»åŠ¡çš„å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œä¸ºäº†ä¸é˜»å¡workerå¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œåœ¨workerä¸­ï¼Œé€šè¿‡ä¸¤æ¬¡forkçš„æ–¹å¼ï¼Œç”Ÿæˆå­¤å„¿è¿›ç¨‹åœ¨åå°è¿›è¡Œä»»åŠ¡å¤„ç†ã€‚</p>
<h2 id="é—®é¢˜ç°è±¡">é—®é¢˜ç°è±¡</h2>
<ol>
<li>
<p>worker ç”Ÿæˆçš„å­¤å„¿è¿›ç¨‹åœ¨æŠ›å‡ºå¼‚å¸¸åï¼Œæ²¡æœ‰è‡ªåŠ¨é€€å‡ºï¼Œä»ç„¶å¤„äºè¿è¡ŒçŠ¶æ€ã€‚</p>
</li>
<li>
<p>kill workerçš„çˆ¶è¿›ç¨‹ï¼ˆSIGTERMï¼‰ï¼Œçˆ¶è¿›ç¨‹ä¸é€€å‡ºï¼Œå¾ˆå¤šworkerå˜æˆåƒµå°¸è¿›ç¨‹ã€‚ï¼ˆ<strong>æ‰€æœ‰çš„celery workeréƒ½æ˜¯ç”±åŒä¸€ä¸ªçˆ¶è¿›ç¨‹forkå‡ºæ¥çš„</strong>ï¼‰</p>
</li>
</ol>
<h2 id="æ’æŸ¥è¿‡ç¨‹">æ’æŸ¥è¿‡ç¨‹</h2>
<p>è¿™ä¸ªé—®é¢˜åŸºæœ¬ä¸Šæ˜¯é€šè¿‡èµ°è¯»ä»£ç å®šä½å‡ºæ¥çš„ï¼Œä¸‹é¢ç»™å‡ºç®€åŒ–åçš„workerä»£ç ä¾¿äºåé¢åˆ†æã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="k">def</span> <span class="nf">worker</span><span class="p">():</span>
<span class="ln"> 2</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="ln"> 3</span>        <span class="c1"># ç­‰å¾…ä»»åŠ¡...</span>
<span class="ln"> 4</span>        <span class="n">wait_task</span><span class="p">()</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span>        <span class="k">try</span><span class="p">:</span>
<span class="ln"> 7</span>            <span class="c1"># å¤„ç†ä»»åŠ¡</span>
<span class="ln"> 8</span>            <span class="n">execute</span><span class="p">()</span>
<span class="ln"> 9</span>        <span class="k">except</span><span class="p">:</span>
<span class="ln">10</span>            <span class="n">on_failure</span><span class="p">()</span>
<span class="ln">11</span>        
<span class="ln">12</span>        <span class="o">...</span>
<span class="ln">13</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="k">def</span> <span class="nf">execute</span><span class="p">():</span>
<span class="ln">16</span>    <span class="k">try</span><span class="p">:</span>
<span class="ln">17</span>        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="ln">18</span>        <span class="k">if</span> <span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="ln">19</span>            <span class="k">raise</span> <span class="ne">Exception</span>
<span class="ln">20</span>        <span class="k">elif</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="ln">21</span>            <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="ln">22</span>            <span class="k">if</span> <span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="ln">23</span>                <span class="k">raise</span> <span class="ne">Exception</span>
<span class="ln">24</span>            <span class="k">elif</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="ln">25</span>                <span class="c1"># å®é™…æ‰§è¡Œä»»åŠ¡å¤„ç†ï¼Œé‡åˆ°å¼‚å¸¸ç›´æ¥raise</span>
<span class="ln">26</span>                <span class="n">do_execute</span><span class="p">()</span>
<span class="ln">27</span>                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="ln">28</span>            <span class="k">else</span><span class="p">:</span>
<span class="ln">29</span>                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="ln">30</span>        <span class="k">else</span><span class="p">:</span>
<span class="ln">31</span>            <span class="k">return</span>
<span class="ln">32</span>    <span class="k">except</span><span class="p">:</span>
<span class="ln">33</span>        <span class="k">raise</span>
</code></pre></div><h2 id="é—®é¢˜åŸå› ">é—®é¢˜åŸå› </h2>
<p>åœ¨åˆ†æé—®é¢˜åŸå› å‰ï¼Œå…ˆæ¥è¿è¡Œè¿™æ ·ä¸€æ®µä»£ç ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="ln">2</span>    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="ln">3</span>    <span class="k">if</span> <span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="ln">4</span>        <span class="k">print</span> <span class="s2">&#34;fork failed&#34;</span>
<span class="ln">5</span>    <span class="k">elif</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="ln">6</span>        <span class="k">print</span> <span class="s2">&#34;child pid &#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
<span class="ln">7</span>    <span class="k">else</span><span class="p">:</span>
<span class="ln">8</span>        <span class="k">print</span> <span class="s2">&#34;parent pid &#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
<span class="ln">9</span>    <span class="k">print</span> <span class="s2">&#34;pid &#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</code></pre></div><p>è¿è¡Œç»“æœæ˜¯ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>parent pid  <span class="m">78216</span>
<span class="ln">2</span>pid  <span class="m">78216</span>
<span class="ln">3</span>child pid  <span class="m">78217</span>
<span class="ln">4</span>pid  <span class="m">78217</span>
</code></pre></div><p>ä»è¿™ä¸ªç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<strong>forkå‡ºæ¥çš„å­è¿›ç¨‹è™½ç„¶å’Œçˆ¶è¿›ç¨‹ä¸å…±äº«å †æ ˆï¼ˆå­è¿›ç¨‹è·å¾—çˆ¶è¿›ç¨‹å †æ ˆçš„å‰¯æœ¬ï¼‰ï¼Œä½†æ˜¯ä»–ä»¬å…±äº«æ­£æ–‡æ®µ</strong>ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½æ‰§è¡Œäº†ç¨‹åºçš„æœ€åä¸€è¡Œï¼Œå„è‡ªè¾“å‡ºäº†è‡ªå·±çš„pidã€‚</p>
<p>æ¥ç€æ¥åˆ†æä¸Šè¿°workerçš„ä»£ç ï¼Œåœ¨<code>execute()</code>ä¸­ï¼Œé€šè¿‡ä¸¤æ¬¡forkï¼Œæœ€ç»ˆä½¿å¾—<code>do_execute()</code>è¿è¡Œåœ¨ä¸€ä¸ªå­¤å„¿è¿›ç¨‹ä¸­ï¼Œå¦‚æœæ­£å¸¸è¿è¡Œï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ<code>os._exit(0)</code>æ­£å¸¸é€€å‡ºã€‚ç„¶è€Œï¼Œå¦‚æœè¿è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸åˆä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæ ¹æ®çˆ¶å­è¿›ç¨‹å…±äº«æ­£æ–‡æ®µè¿™ä¸€ç»“è®ºï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ä¸ªå­¤å„¿è¿›ç¨‹æŠ›å‡ºçš„å¼‚å¸¸ä¼šè¢«ç¬¬32è¡Œçš„<code>except</code>æ•è·åˆ°ï¼Œå¹¶ç»§ç»­å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åä¼šè¢«ç¬¬9è¡Œ<code>worker()</code>ä¸­çš„<code>except</code>æ•è·ï¼Œå¹¶æ‰§è¡Œ<code>on_failure()</code>ã€‚<strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå­¤å„¿è¿›ç¨‹æœ€ç»ˆæ‰§è¡Œåˆ°äº†workerçš„ä»£ç é‡Œå»äº†ï¼Œè€Œworkeræœ¬èº«æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå› æ­¤è¿™ä¸ªå­¤å„¿è¿›ç¨‹å°±ä¸ä¼šé€€å‡ºäº†ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæœ€ç»ˆå®ƒä¼šè¿è¡Œåˆ°ç¬¬4è¡Œï¼Œæˆä¸ºä¸€ä¸ªâ€œworkerå‰¯æœ¬â€ï¼Œç­‰å¾…æ¥æ”¶ä»»åŠ¡</strong>ã€‚</p>
<p>è‡³äºä¸ºä»€ä¹ˆkill workerçš„çˆ¶è¿›ç¨‹ä¼šå¯¼è‡´workerå˜åƒµå°¸è¿›ç¨‹ï¼Œéœ€è¦æ·±å…¥ç ”ç©¶ä¸€ä¸‹celeryæºç ä¸­çš„ä¿¡å·å¤„ç†æ–¹æ³•ã€‚çŒœæµ‹æ˜¯çˆ¶è¿›ç¨‹åœ¨é€€å‡ºå‰ï¼Œä¼šå…ˆä¿è¯æ‰€æœ‰workerå­è¿›ç¨‹å·²ç»é€€å‡ºï¼Œè€Œå®ƒè¯¯ä»¥ä¸ºè¿™ä¸ªâ€œworkerå‰¯æœ¬â€ä¹Ÿæ˜¯è‡ªå·±çš„å­è¿›ç¨‹ï¼Œä½†æ˜¯å´æ²¡åŠæ³•é€šè¿‡å‘å­è¿›ç¨‹å‘é€ä¿¡å·çš„æ–¹å¼ä½¿å…¶é€€å‡ºï¼Œäºæ˜¯å°±é˜»å¡ä½äº†è‡ªå·±çš„é€€å‡ºæµç¨‹ã€‚è€Œå…¶ä»–å·²ç»æ­£å¸¸é€€å‡ºçš„workerå°±ä¼šä¸€ç›´å¤„äºåƒµå°¸çŠ¶æ€ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>ç”¨æ ‘è“æ´¾åˆ†æå‡½æ•°è°ƒç”¨æ ˆ</title>
			<link>https://cvvz.fun/post/call-stack/</link>
			<pubDate>Tue, 03 Sep 2019 18:44:12 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/call-stack/</guid>
			<description>ç†è§£æœ¬ç¯‡æ–‡ç« éœ€è¦å…·å¤‡ä¸€äº›GDBã€æ±‡ç¼–ã€å¯„å­˜å™¨çš„åŸºç¡€çŸ¥è¯†ã€‚å¯ä»¥åœ¨é˜…è¯»çš„è¿‡ç¨‹ä¸­ç¢°åˆ°ä¸ç†è§£çš„åœ°æ–¹å†é’ˆå¯¹æ€§çš„å­¦ä¹ ã€‚ å¯„å­˜å™¨ åˆ†æå‡½æ•°è°ƒç”¨æ ˆæ¶‰åŠåˆ°çš„å‡ ä¸ªç‰¹</description>
			<content type="html"><![CDATA[<blockquote>
<p>ç†è§£æœ¬ç¯‡æ–‡ç« éœ€è¦å…·å¤‡ä¸€äº›GDBã€æ±‡ç¼–ã€å¯„å­˜å™¨çš„åŸºç¡€çŸ¥è¯†ã€‚å¯ä»¥åœ¨é˜…è¯»çš„è¿‡ç¨‹ä¸­ç¢°åˆ°ä¸ç†è§£çš„åœ°æ–¹å†é’ˆå¯¹æ€§çš„å­¦ä¹ ã€‚</p>
</blockquote>
<h2 id="å¯„å­˜å™¨">å¯„å­˜å™¨</h2>
<p>åˆ†æå‡½æ•°è°ƒç”¨æ ˆæ¶‰åŠåˆ°çš„å‡ ä¸ªç‰¹æ®Šç”¨é€”çš„å¯„å­˜å™¨å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">ARM</th>
<th style="text-align:center">X86</th>
<th style="text-align:center">ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">r11ï¼ˆfpï¼‰</td>
<td style="text-align:center">rbpï¼ˆebpï¼‰</td>
<td style="text-align:center">æ ˆå¸§æŒ‡é’ˆ</td>
</tr>
<tr>
<td style="text-align:center">r13ï¼ˆspï¼‰</td>
<td style="text-align:center">rspï¼ˆespï¼‰</td>
<td style="text-align:center">æ ˆé¡¶æŒ‡é’ˆ</td>
</tr>
<tr>
<td style="text-align:center">r14ï¼ˆlrï¼‰</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">è¿”å›åœ°å€</td>
</tr>
<tr>
<td style="text-align:center">r15ï¼ˆpcï¼‰</td>
<td style="text-align:center">rip</td>
<td style="text-align:center">æŒ‡ä»¤æŒ‡é’ˆï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰</td>
</tr>
</tbody>
</table>
<h2 id="å‡½æ•°è°ƒç”¨æ ˆ">å‡½æ•°è°ƒç”¨æ ˆ</h2>
<p>å¦‚ä¸‹å›¾ï¼ˆã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹å›¾10-4ï¼‰æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/%e6%a0%88.jpg" width="500px"/> 
</figure>

<p>å›¾ä¸­ï¼Œæ ˆå¸§æŒ‡é’ˆï¼ˆebpï¼‰æŒ‡å‘çš„å†…å­˜ç©ºé—´ä¸­ä¿å­˜çš„æ˜¯ä¸Šä¸€ä¸ªæ ˆçš„æ ˆå¸§æŒ‡é’ˆï¼ˆold ebpï¼‰ã€‚è¿™æ˜¯X86çš„æƒ…å½¢ï¼Œåœ¨æ ‘è“æ´¾ä¸­åˆ†æå‡½æ•°è°ƒç”¨æ ˆæ—¶å‘ç°ï¼ŒARMçš„æ ˆå¸§æŒ‡é’ˆï¼ˆfpï¼‰æŒ‡å‘çš„æ˜¯å‡½æ•°è¿”å›åœ°å€ã€‚</p>
<p>è¿™åªæ˜¯ä¸åŒæ¶æ„CPUçš„åº•å±‚å®ç°çš„ä¸åŒï¼Œå¹¶æ²¡æœ‰ä¼˜åŠ£ä¹‹åˆ†ã€‚</p>
<h3 id="å…¥æ ˆè¿‡ç¨‹">å…¥æ ˆè¿‡ç¨‹</h3>
<p>ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p>
<ul>
<li>é¦–å…ˆå‹æ ˆçš„æ˜¯å‚æ•°ï¼Œä¸”<strong>ä»å³å‘å·¦</strong>ä¾æ¬¡å‹æ ˆï¼›</li>
<li>æ¥ç€å‹å…¥è¿”å›åœ°å€ï¼›</li>
<li>æ¥ç€è¢«è°ƒå‡½æ•°æ‰§è¡Œâ€œæ ‡å‡†å¼€å¤´â€ï¼ˆx86ï¼‰ï¼š</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>push rbp
<span class="ln">2</span>mov rbp rsp
</code></pre></div><p>â€œæ ‡å‡†å¼€å¤´â€æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>é¦–å…ˆrbpå…¥æ ˆï¼›</li>
<li>rbpå…¥æ ˆåï¼Œrspè‡ªåŠ¨åŠ 8ï¼ˆ64ä½ï¼‰ï¼Œrspæ­¤æ—¶æŒ‡å‘å­˜æ”¾rbpçš„æ ˆå¸§åœ°å€ï¼›</li>
<li>æ¥ç€ä»¤<code>%rbp=%rsp</code>ï¼Œè¿™å°±ä½¿å¾—rbpæŒ‡å‘å­˜æ”¾ç€ä¸Šä¸€ä¸ªæ ˆçš„rbpçš„å†…å­˜åœ°å€ã€‚</li>
</ul>
<p>è€ŒARMï¼ˆ32ä½ï¼‰çš„â€œæ ‡å‡†å¼€å¤´â€é•¿è¿™æ ·ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>push {fp, lr}
<span class="ln">2</span>add fp, sp, #4
</code></pre></div><ul>
<li>è¿”å›åœ°å€(lr)å…¥æ ˆ</li>
<li>æ ˆå¸§æŒ‡é’ˆ(fp)å…¥æ ˆ</li>
<li>æ¥ç€ä»¤<code>%fp=%sp+4</code>ï¼Œä¹Ÿå°±æ˜¯<strong>ä½¿fpï¼ˆæ ˆå¸§æŒ‡é’ˆï¼‰æŒ‡å‘å­˜æ”¾è¿”å›åœ°å€çš„å†…å­˜</strong>ã€‚</li>
</ul>
<p>ä¸è®ºæ ˆå¸§æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸Šä¸€ä¸ªæ ˆå¸§æŒ‡é’ˆï¼Œè¿˜æ˜¯è¿”å›åœ°å€ï¼Œéƒ½èƒ½<strong>é€šè¿‡å‡½æ•°çš„æ ˆå¸§æŒ‡é’ˆåç§»æ‰¾åˆ°è°ƒç”¨å‡½æ•°çš„åœ°å€ï¼Œå› æ­¤æ ¹æ®æ ˆå¸§æŒ‡é’ˆçš„é“¾å¼å…³ç³»ï¼Œå¯ä»¥å›æº¯å‡ºæ•´ä¸ªå‡½æ•°çš„è°ƒç”¨å…³ç³»é“¾</strong>ã€‚è¿™å¯¹äºä¸€äº›å¤æ‚é—®é¢˜çš„å®šä½æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚</p>
<blockquote>
<p>GCCçš„ç¼–è¯‘é€‰é¡¹<code>--fomit-frame-pointer</code>å¯ä»¥ä½¿ç¨‹åºä¸ä½¿ç”¨æ ˆå¸§æŒ‡é’ˆï¼Œè€Œä½¿ç”¨æ ˆæŒ‡é’ˆé¡¶å®šä½å‡½æ•°çš„å±€éƒ¨å˜é‡ã€å‚æ•°ã€è¿”å›åœ°å€ç­‰ã€‚è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯å¯ä»¥å¤šå‡ºä¸€ä¸ªå¯„å­˜å™¨ï¼ˆæ ˆå¸§æŒ‡é’ˆï¼‰ä¾›ä½¿ç”¨ï¼Œç¨‹åºè¿è¡Œé€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯å°±æ²¡å‘å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨GDBè¿›è¡Œè°ƒè¯•äº†ã€‚</p>
</blockquote>
<h3 id="å‡ºæ ˆè¿‡ç¨‹">å‡ºæ ˆè¿‡ç¨‹</h3>
<p>å‡ºæ ˆä¸å…¥æ ˆåŠ¨ä½œåˆšå¥½ç›¸åã€‚</p>
<p>x86çš„â€œæ ‡å‡†ç»“å°¾â€å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>leaveq
<span class="ln">2</span>retq
</code></pre></div><p>å®é™…ä¸Š<code>leaveq</code>å†…éƒ¨åˆ†ä¸ºä¸¤æ¡æŒ‡ä»¤ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>movq %rbp, %rsp
<span class="ln">2</span>popq %rbp
</code></pre></div><p>æ‰€ä»¥ï¼Œå‡ºæ ˆè¿‡ç¨‹å¯ä»¥åˆ†è§£ä¸ºå¦‚ä¸‹ä¸‰æ­¥ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥æ˜¯é€šè¿‡å°†rbpåœ°å€èµ‹ç»™rspï¼Œå³æ­¤æ—¶rspæŒ‡å‘çš„å†…å­˜å­˜æ”¾çš„æ˜¯ä¸Šä¸€ä¸ªæ ˆçš„rbpã€‚</li>
<li>ç¬¬äºŒæ­¥å¼¹å‡ºæ ˆé¡¶çš„æ•°æ®åˆ°rbpä¸­ï¼Œå³rbpæŒ‡å‘ä¸Šä¸€ä¸ªæ ˆçš„æ ˆåº•ï¼Œå‡ºæ ˆåŠ¨ä½œå¯¼è‡´rspè‡ªå¢ï¼Œäºæ˜¯rspæ­¤æ—¶æŒ‡å‘çš„å†…å­˜ä¸­å­˜æ”¾å‡½æ•°è¿”å›åœ°å€ï¼›</li>
<li>ç¬¬ä¸‰æ­¥é€šè¿‡<code>retq</code>æŒ‡ä»¤å°†æ ˆé¡¶åœ°å€popåˆ°ripï¼Œå³ripæ­¤æ—¶æŒ‡å‘å‡½æ•°é€€å‡ºåçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œrspåˆ™æŒ‡å‘ä¸Šä¸€ä¸ªæ ˆçš„æ ˆé¡¶ã€‚</li>
</ul>
<p>è¿™ä¸‰æ­¥åšå®Œåï¼Œrspã€rbpã€ripå°±æ¢å¤åˆ°è°ƒç”¨å‡½æ•°ä»¥å‰çš„ç°åœºã€‚</p>
<p>ARMçš„è¡Œä¸ºå’Œx86ä¸€è‡´ï¼Œå®ƒçš„â€œæ ‡å‡†ç»“å°¾â€é•¿è¿™æ ·ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>sub sp, fp, #4
<span class="ln">2</span>pop {fp, pc}
</code></pre></div><h2 id="åŸºäºæ ‘è“æ´¾3åˆ†æå‡½æ•°è°ƒç”¨æ ˆ">åŸºäºæ ‘è“æ´¾3åˆ†æå‡½æ•°è°ƒç”¨æ ˆ</h2>
<p>æˆ‘åœ¨æ ‘è“æ´¾3ä¸­è¿è¡Œäº†å¦‚ä¸‹æ‰€ç¤ºçš„Cè¯­è¨€ä»£ç ï¼Œå¹¶ç”¨GDBè¿›è¡Œäº†è°ƒè¯•ï¼š</p>
<blockquote>
<p>æ ‘è“æ´¾3ä½¿ç”¨çš„æ˜¯<strong>32ä½ã€armæ¶æ„CPU</strong>ï¼Œå› æ­¤ä¸‹é¢çš„è°ƒè¯•è¿‡ç¨‹æ¶‰åŠåˆ°çš„å¯„å­˜å™¨ä»¥åŠåœ°å€ä¿¡æ¯å’Œ64ä½x86 CPUä¸åŒ</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-C" data-lang="C"><span class="ln"> 1</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="ln"> 2</span><span class="cp"></span>
<span class="ln"> 3</span><span class="kt">void</span> <span class="nf">test2</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="ln"> 4</span><span class="p">{</span>
<span class="ln"> 5</span>    <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="ln"> 7</span><span class="p">}</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="kt">char</span> <span class="nf">test</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="ln">10</span><span class="p">{</span>
<span class="ln">11</span>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="ln">12</span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%c&#34;</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
<span class="ln">13</span>    <span class="n">test2</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="ln">14</span>    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="ln">15</span><span class="p">}</span>
<span class="ln">16</span>
<span class="ln">17</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="ln">18</span><span class="p">{</span>
<span class="ln">19</span>    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
<span class="ln">20</span>    <span class="kt">char</span> <span class="n">ret</span><span class="p">;</span>
<span class="ln">21</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="ln">22</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">23</span><span class="p">}</span>
</code></pre></div><h3 id="åˆ†æå‡½æ•°è°ƒç”¨å…¥æ ˆè¿‡ç¨‹">åˆ†æå‡½æ•°è°ƒç”¨ï¼ˆå…¥æ ˆï¼‰è¿‡ç¨‹</h3>
<p>ä½¿ç”¨GDBè¿›è¡Œè°ƒè¯•ï¼Œå°†æ–­ç‚¹æ‰“åœ¨mainå‡½æ•°è°ƒç”¨testä¹‹å‰ï¼Œå¹¶ä½¿ç”¨<code>disassemble</code>æŸ¥çœ‹åæ±‡ç¼–ç»“æœï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>(gdb) b *0x000104bc
<span class="ln"> 2</span>Breakpoint 2 at 0x104bc: file main.c, line 21.
<span class="ln"> 3</span>(gdb) disassemble /m main
<span class="ln"> 4</span>Dump of assembler code for function main:
<span class="ln"> 5</span>18 {
<span class="ln"> 6</span>   0x000104a0 &lt;+0&gt;: push {r11, lr}
<span class="ln"> 7</span>   0x000104a4 &lt;+4&gt;: add r11, sp, #4
<span class="ln"> 8</span>   0x000104a8 &lt;+8&gt;: sub sp, sp, #8
<span class="ln"> 9</span>
<span class="ln">10</span>19 char c = &#39;a&#39;;
<span class="ln">11</span>   0x000104ac &lt;+12&gt;: mov r3, #97 ; 0x61
<span class="ln">12</span>   0x000104b0 &lt;+16&gt;: strb r3, [r11, #-5]
<span class="ln">13</span>
<span class="ln">14</span>20 char ret;
<span class="ln">15</span>21 ret = test(c);
<span class="ln">16</span>   0x000104b4 &lt;+20&gt;: ldrb r3, [r11, #-5]
<span class="ln">17</span>   0x000104b8 &lt;+24&gt;: mov r0, r3
<span class="ln">18</span>=&gt; 0x000104bc &lt;+28&gt;: bl 0x10468 &lt;test&gt;
<span class="ln">19</span>   0x000104c0 &lt;+32&gt;: mov r3, r0
<span class="ln">20</span>   0x000104c4 &lt;+36&gt;: strb r3, [r11, #-6]
<span class="ln">21</span>
<span class="ln">22</span>22 return 0;
<span class="ln">23</span>   0x000104c8 &lt;+40&gt;: mov r3, #0
<span class="ln">24</span>
<span class="ln">25</span>23 }
<span class="ln">26</span>   0x000104cc &lt;+44&gt;: mov r0, r3
<span class="ln">27</span>   0x000104d0 &lt;+48&gt;: sub sp, r11, #4
<span class="ln">28</span>   0x000104d4 &lt;+52&gt;: pop {r11, pc}
<span class="ln">29</span>
<span class="ln">30</span>End of assembler dump.
</code></pre></div><p>æŸ¥çœ‹æ­¤æ—¶æ ˆå¸§æŒ‡é’ˆå’Œæ ˆé¡¶æŒ‡é’ˆçš„å€¼ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>(gdb) i r r11 sp
<span class="ln">2</span>r11            0x7efffaec 2130705132
<span class="ln">3</span>sp             0x7efffae0 0x7efffae0
<span class="ln">4</span>(gdb) x /xw 0x7efffaec
<span class="ln">5</span>0x7efffaec: 0x76e8f678
<span class="ln">6</span>(gdb) info symbol 0x76e8f678
<span class="ln">7</span>__libc_start_main + 276 in section .text of /lib/arm-linux-gnueabihf/libc.so.6
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ ˆå¸§æŒ‡é’ˆæŒ‡å‘çš„è¿”å›åœ°å€æ˜¯<code>__libc_start_main + 276</code>ï¼Œå³<strong>mainå‡½æ•°æ˜¯ç”±__libc_start_mainè°ƒç”¨çš„</strong>ã€‚</p>
<p>ç”±å‰é¢åˆ†æå¾—çŸ¥ï¼Œæ ˆå¸§æŒ‡é’ˆ-4åœ°å€å¤„å­˜æ”¾çš„æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°çš„æ ˆå¸§æŒ‡é’ˆï¼Œäºæ˜¯æˆ‘ä»¬ç»§ç»­å‘ä¸Šè¿½æº¯<code>__libc_start_main</code>çš„è°ƒç”¨è€…åœ°å€ï¼Œå¯ä»¥å‘ç°å…¶å€¼ä¸º0ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>(gdb) x /xw 0x7efffaec-4
<span class="ln">2</span>0x7efffae8: 0x00000000
</code></pre></div><p><strong>å› æ­¤å¯ä»¥è®¤ä¸º<code>__libc_start_main</code>æ˜¯æ‰€æœ‰è¿›ç¨‹çœŸæ­£çš„èµ·ç‚¹ã€‚</strong></p>
<p>æ¥ç€æ‰§è¡Œè°ƒç”¨testå‡½æ•°çš„å‘½ä»¤ï¼Œä½¿ç”¨<code>si</code>å•æ­¥è¿è¡Œï¼Œå¹¶æŸ¥çœ‹æ±‡ç¼–æŒ‡ä»¤ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>(gdb) si
<span class="ln"> 2</span>test (c=0 &#39;\000&#39;) at main.c:10
<span class="ln"> 3</span>10 {
<span class="ln"> 4</span>(gdb) disassemble
<span class="ln"> 5</span>Dump of assembler code for function test:
<span class="ln"> 6</span>=&gt; 0x00010468 &lt;+0&gt;: push {r11, lr}
<span class="ln"> 7</span>   0x0001046c &lt;+4&gt;: add r11, sp, #4
<span class="ln"> 8</span>   0x00010470 &lt;+8&gt;: sub sp, sp, #16
<span class="ln"> 9</span>   0x00010474 &lt;+12&gt;: mov r3, r0
<span class="ln">10</span>   0x00010478 &lt;+16&gt;: strb r3, [r11, #-13]
<span class="ln">11</span>   0x0001047c &lt;+20&gt;: ldrb r3, [r11, #-13]
<span class="ln">12</span>   0x00010480 &lt;+24&gt;: mov r0, r3
<span class="ln">13</span>   0x00010484 &lt;+28&gt;: bl 0x10300 &lt;putchar@plt&gt;
<span class="ln">14</span>   0x00010488 &lt;+32&gt;: ldr r0, [r11, #-8]
<span class="ln">15</span>   0x0001048c &lt;+36&gt;: bl 0x10440 &lt;test2&gt;
<span class="ln">16</span>   0x00010490 &lt;+40&gt;: ldrb r3, [r11, #-13]
<span class="ln">17</span>   0x00010494 &lt;+44&gt;: mov r0, r3
<span class="ln">18</span>   0x00010498 &lt;+48&gt;: sub sp, r11, #4
<span class="ln">19</span>   0x0001049c &lt;+52&gt;: pop {r11, pc}
<span class="ln">20</span>End of assembler dump.
<span class="ln">21</span>(gdb) i r $lr
<span class="ln">22</span>lr             0x104c0 66752
<span class="ln">23</span>(gdb) info symbol $lr
<span class="ln">24</span>main + 32 in section .text of /root/main
</code></pre></div><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶lrå¯„å­˜å™¨ä¸­ä¿å­˜çš„æŒ‡ä»¤å³è°ƒç”¨teståçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>(gdb) ni
<span class="ln">2</span>0x0001046c 10 {
<span class="ln">3</span>(gdb) i r r11 sp
<span class="ln">4</span>r11            0x7efffaec 2130705132
<span class="ln">5</span>sp             0x7efffad8 0x7efffad8
</code></pre></div><p>è§‚å¯Ÿåˆ°å°†r11å’Œlrå…¥æ ˆåï¼Œspå‡å°‘äº†8å­—èŠ‚ï¼Œä¸éš¾çŒœæµ‹ï¼Œé«˜4å­—èŠ‚å­˜æ”¾äº†lrçš„å€¼ï¼ˆè¿”å›åœ°å€ï¼‰ï¼Œä½4å­—èŠ‚å­˜æ”¾äº†spçš„å€¼ï¼ˆä¸Šä¸€ä¸ªæ ˆçš„æ ˆå¸§æŒ‡é’ˆï¼‰ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>(gdb) x /xw 0x7efffad8
<span class="ln">2</span>0x7efffad8: 0x7efffaec
<span class="ln">3</span>(gdb) x /xw 0x7efffadc
<span class="ln">4</span>0x7efffadc: 0x000104c0
<span class="ln">5</span>(gdb) i r $lr $r11
<span class="ln">6</span>lr             0x104c0 66752
<span class="ln">7</span>r11            0x7efffaec 2130705132
</code></pre></div><p>ç»§ç»­æ‰§è¡Œï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>(gdb) ni
<span class="ln">2</span>0x00010470 10 {
<span class="ln">3</span>(gdb) i r $r11
<span class="ln">4</span>r11            0x7efffadc 2130705116
</code></pre></div><p>æ­¤æ—¶r11æŒ‡å‘çš„æ˜¯å‡½æ•°è¿”å›åœ°å€ï¼Œè€Œä¸æ˜¯åƒx86ä¸€æ ·æŒ‡å‘ä¸Šä¸€ä¸ªæ ˆå¸§æŒ‡é’ˆï¼Œå’Œå‰é¢æ‰€è¯´çš„ä¸€è‡´ã€‚</p>
<h2 id="åˆ†æå‡½æ•°è¿”å›å‡ºæ ˆè¿‡ç¨‹">åˆ†æå‡½æ•°è¿”å›ï¼ˆå‡ºæ ˆï¼‰è¿‡ç¨‹</h2>
<p>testå‡½æ•°çš„æ±‡ç¼–æŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>(gdb) disassemble /m test
<span class="ln"> 2</span>Dump of assembler code for function test:
<span class="ln"> 3</span>10 {
<span class="ln"> 4</span>   0x00010468 &lt;+0&gt;:	push	{r11, lr}
<span class="ln"> 5</span>   0x0001046c &lt;+4&gt;:	add	r11, sp, #4
<span class="ln"> 6</span>   0x00010470 &lt;+8&gt;:	sub	sp, sp, #16
<span class="ln"> 7</span>   0x00010474 &lt;+12&gt;:	mov	r3, r0
<span class="ln"> 8</span>   0x00010478 &lt;+16&gt;:	strb	r3, [r11, #-13]
<span class="ln"> 9</span>
<span class="ln">10</span>11		int i;
<span class="ln">11</span>12		printf(&#34;%c&#34;,c);
<span class="ln">12</span>   0x0001047c &lt;+20&gt;:	ldrb	r3, [r11, #-13]
<span class="ln">13</span>   0x00010480 &lt;+24&gt;:	mov	r0, r3
<span class="ln">14</span>   0x00010484 &lt;+28&gt;:	bl	0x10300 &lt;putchar@plt&gt;
<span class="ln">15</span>
<span class="ln">16</span>13		test2(i);
<span class="ln">17</span>   0x00010488 &lt;+32&gt;:	ldr	r0, [r11, #-8]
<span class="ln">18</span>   0x0001048c &lt;+36&gt;:	bl	0x10440 &lt;test2&gt;
<span class="ln">19</span>
<span class="ln">20</span>14		return c;
<span class="ln">21</span>   0x00010490 &lt;+40&gt;:	ldrb	r3, [r11, #-13]
<span class="ln">22</span>
<span class="ln">23</span>15	}
<span class="ln">24</span>   0x00010494 &lt;+44&gt;:	mov	r0, r3
<span class="ln">25</span>=&gt; 0x00010498 &lt;+48&gt;:	sub	sp, r11, #4
<span class="ln">26</span>   0x0001049c &lt;+52&gt;:	pop	{r11, pc}
<span class="ln">27</span>
<span class="ln">28</span>End of assembler dump.
</code></pre></div><p>å‡½æ•°è¿è¡Œå®Œæ¯•è¿›å…¥å‡ºæ ˆæµç¨‹çš„æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p>
<ul>
<li>é¦–å…ˆé€šè¿‡ <code>sub sp, r11, #4</code> å°†æ ˆé¡¶æŒ‡é’ˆæŒ‡å‘ä¸Šä¸€ä¸ªæ ˆå¸§æŒ‡é’ˆ</li>
<li>æ¥ç€é€šè¿‡ <code>pop {r11, pc}</code> å°†ä¸Šä¸€ä¸ªæ ˆå¸§æŒ‡é’ˆèµ‹å€¼ç»™r11ï¼Œå¹¶å°†è¿”å›åœ°å€èµ‹å€¼ç»™pc</li>
<li>ä¸¤æ¬¡popåï¼Œæ ˆé¡¶æŒ‡é’ˆè‡ªåŠ¨å¾€æ ˆåº•æ–¹å‘é€€ä¸¤æ¬¡</li>
</ul>
<p>æœ€ç»ˆï¼Œæ ˆé¡¶æŒ‡é’ˆï¼ˆspï¼‰ã€æ ˆå¸§æŒ‡é’ˆï¼ˆr11ï¼‰å’ŒæŒ‡ä»¤æŒ‡é’ˆï¼ˆpcï¼‰éƒ½è¿˜åŸæˆäº†mainå‡½æ•°è°ƒç”¨testå‰çš„æ ·å­ï¼Œç”¨GDBæŸ¥çœ‹å¯„å­˜å™¨å†…å®¹è¯å®äº†è¿™ä¸€ç‚¹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>(gdb) disassemble 
<span class="ln"> 2</span>Dump of assembler code for function main:
<span class="ln"> 3</span>   0x000104a0 &lt;+0&gt;:	push	{r11, lr}
<span class="ln"> 4</span>   0x000104a4 &lt;+4&gt;:	add	r11, sp, #4
<span class="ln"> 5</span>   0x000104a8 &lt;+8&gt;:	sub	sp, sp, #8
<span class="ln"> 6</span>   0x000104ac &lt;+12&gt;:	mov	r3, #97	; 0x61
<span class="ln"> 7</span>   0x000104b0 &lt;+16&gt;:	strb	r3, [r11, #-5]
<span class="ln"> 8</span>   0x000104b4 &lt;+20&gt;:	ldrb	r3, [r11, #-5]
<span class="ln"> 9</span>   0x000104b8 &lt;+24&gt;:	mov	r0, r3
<span class="ln">10</span>   0x000104bc &lt;+28&gt;:	bl	0x10468 &lt;test&gt;
<span class="ln">11</span>=&gt; 0x000104c0 &lt;+32&gt;:	mov	r3, r0
<span class="ln">12</span>   0x000104c4 &lt;+36&gt;:	strb	r3, [r11, #-6]
<span class="ln">13</span>   0x000104c8 &lt;+40&gt;:	mov	r3, #0
<span class="ln">14</span>   0x000104cc &lt;+44&gt;:	mov	r0, r3
<span class="ln">15</span>   0x000104d0 &lt;+48&gt;:	sub	sp, r11, #4
<span class="ln">16</span>   0x000104d4 &lt;+52&gt;:	pop	{r11, pc}
<span class="ln">17</span>End of assembler dump.
<span class="ln">18</span>(gdb) i r r11 sp pc
<span class="ln">19</span>r11            0x7efffaec	2130705132
<span class="ln">20</span>sp             0x7efffae0	0x7efffae0
<span class="ln">21</span>pc             0x104c0	0x104c0 &lt;main+32&gt;
</code></pre></div>]]></content>
		</item>
		
		<item>
			<title>å®‰å…¨çŸ¥è¯†æ€»ç»“</title>
			<link>https://cvvz.fun/post/about-computer-security/</link>
			<pubDate>Thu, 22 Aug 2019 12:38:04 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/about-computer-security/</guid>
			<description>åŠ è§£å¯†ç®—æ³• å¯¹ç§°åŠ å¯†ï¼š ç”¨åŒä¸€ä¸ªç§˜é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ï¼Œä»£è¡¨ç®—æ³•æœ‰AES/DES/RC2/RC5ç­‰ï¼› éå¯¹ç§°åŠ å¯†ï¼š ä¸€æ¬¡äº§ç”Ÿå…¬é’¥å’Œç§é’¥ä¸¤ä¸ªç§˜é’¥ï¼Œä»»æ„ä¸€ä¸ª</description>
			<content type="html"><![CDATA[<h2 id="åŠ è§£å¯†ç®—æ³•">åŠ è§£å¯†ç®—æ³•</h2>
<p><strong>å¯¹ç§°åŠ å¯†ï¼š</strong> ç”¨åŒä¸€ä¸ªç§˜é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ï¼Œä»£è¡¨ç®—æ³•æœ‰<code>AES/DES/RC2/RC5</code>ç­‰ï¼›</p>
<p><strong>éå¯¹ç§°åŠ å¯†ï¼š</strong> ä¸€æ¬¡äº§ç”Ÿå…¬é’¥å’Œç§é’¥ä¸¤ä¸ªç§˜é’¥ï¼Œä»»æ„ä¸€ä¸ªéƒ½èƒ½è¿›è¡ŒåŠ å¯†ï¼Œè§£å¯†åˆ™éœ€è¦ç”¨å¦å¤–ä¸€ä¸ªã€‚å…·ä½“çš„ç”¨æ³•æ˜¯ï¼šå…¬é’¥ç”¨æ¥â€œåŠ å¯†â€ï¼ˆç›¸åº”çš„ç§é’¥ç”¨æ¥è§£å¯†ï¼‰ï¼Œç§é’¥ç”¨æ¥â€œç­¾åâ€ï¼ˆç›¸åº”çš„å…¬é’¥ç”¨æ¥æ ¡éªŒï¼‰ã€‚ä»£è¡¨ç®—æ³•æœ‰<code>RSA/DSA/ECC/DH</code>ç­‰ã€‚</p>
<p><strong>æ‘˜è¦ï¼š</strong> æ‘˜è¦æ˜¯å¯¹æ•°æ®è®¡ç®—Hashå€¼ï¼ŒHashå€¼ä¸å¯é€†ï¼Œæ˜¯ä¸€ç§å•å‘åŠ å¯†ã€‚<code>shadow</code>æ–‡ä»¶ä¸­ä¿å­˜çš„ç”¨æˆ·å¯†ç å°±æ˜¯å¯†ç æ˜æ–‡çš„Hashå€¼ã€‚ä»£è¡¨ç®—æ³•æœ‰<code>MD5/SHA256</code>ç­‰ã€‚</p>
<h2 id="sslåè®®">SSLåè®®</h2>
<p>SSLåè®®å·¥ä½œåœ¨ä¼ è¾“å±‚å’Œåº”ç”¨å±‚ä¹‹é—´ã€‚åœ¨TCPåè®®çš„ä¸‰æ¬¡æ¡æ‰‹ä¹‹åï¼Œè¿›è¡ŒSSLåè®®çš„æ¡æ‰‹ã€‚</p>
<p>SSLæ¡æ‰‹è¿‡ç¨‹ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯å‘é€éšæœºæ•°xå’Œè‡ªå·±æ”¯æŒçš„åŠ å¯†ç®—æ³•</li>
<li>æœåŠ¡ç«¯å‘é€éšæœºæ•°yã€å…¬é’¥å’Œé€‰æ‹©çš„åŠ å¯†ç®—æ³•</li>
<li>å®¢æˆ·ç«¯å‘é€é€šè¿‡å…¬é’¥åŠ å¯†çš„éšæœºæ•°zçš„å¯†æ–‡</li>
<li>å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ç”¨xyzç®—å‡ºå¯¹ç§°åŠ å¯†çš„å¯†é’¥</li>
<li>åŒæ–¹è¿›è¡Œå¯¹ç§°åŠ å¯†é€šä¿¡ã€‚</li>
</ul>
<h2 id="sshåè®®">SSHåè®®</h2>
<h3 id="å¯†ç ç™»å½•">å¯†ç ç™»å½•</h3>
<ul>
<li>ä¸»æœºå°†è‡ªå·±çš„å…¬é’¥ï¼ˆä¸»æœºå¯†é’¥HostKeyï¼‰å‘åˆ°å®¢æˆ·ç«¯ï¼ˆHostKeyè·¯å¾„åœ¨sshdçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼‰</li>
<li>å®¢æˆ·ç«¯è®¡ç®—å…¬é’¥æŒ‡çº¹ï¼ˆæ‘˜è¦ï¼‰ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦ä¿¡ä»»è¯¥kostkeyï¼Œä¿¡ä»»åˆ™å°†keyå€¼è®°å½•åœ¨known_hostsä¸­ï¼Œä¸‹æ¬¡ç™»å½•ç›¸åŒæœåŠ¡å™¨æ—¶è‹¥hostkeyç›¸åŒä¸å¿…å†æ¬¡ç¡®è®¤ï¼›å¦åˆ™æç¤ºhostkeyä¸ä¸€è‡´</li>
<li>ç”¨æˆ·è¾“å…¥å¯†ç ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨å…¬é’¥åŠ å¯†å¯†ç æ˜æ–‡å¹¶å‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä½¿ç”¨ç§é’¥è§£å¯†å¹¶è¿›è¡Œå¯†ç æ ¡éªŒã€‚</li>
</ul>
<p>ç”±äºå­˜åœ¨å‘é€æœåŠ¡å™¨å…¬é’¥çš„è¿‡ç¨‹ï¼Œå› æ­¤å­˜åœ¨ä¸­é—´äººæ”»å‡»çš„å®‰å…¨éšæ‚£ã€‚</p>
<h3 id="å…¬é’¥ç™»å½•">å…¬é’¥ç™»å½•</h3>
<p>SSHå…¬é’¥ç™»å½•è§£å†³äº†SSHåè®®ä¸­çš„ä¸­é—´äººæ”»å‡»çš„é—®é¢˜ã€‚</p>
<ul>
<li>ç”¨æˆ·äº‹å…ˆç”Ÿæˆä¸€å¯¹å…¬/ç§é’¥ï¼Œå°†å…¬é’¥æå‰å¯¼å…¥åˆ°æœåŠ¡å™¨ï¼Œ</li>
<li>ç™»å½•æ—¶ï¼ŒæœåŠ¡å™¨é¦–å…ˆå‘é€ä¸€ä¸ªéšæœºæ•°åˆ°å®¢æˆ·ç«¯ï¼Œ</li>
<li>å®¢æˆ·ç«¯ä½¿ç”¨ç§é’¥åŠ å¯†éšæœºæ•°è¿”å›æœåŠ¡ç«¯ï¼Œ</li>
<li>æœåŠ¡ç«¯ä½¿ç”¨å…¬é’¥æ ¡éªŒé€šè¿‡åˆ™å…è®¸ç™»å½•ã€‚</li>
</ul>
<h2 id="ä¸­é—´äººæ”»å‡»">ä¸­é—´äººæ”»å‡»</h2>
<p>SSLåè®®ä»¥åŠSSHå¯†ç ç™»å½•æ–¹å¼ï¼Œéƒ½å­˜åœ¨ç€ä¸­é—´äººæ”»å‡»çš„å¨èƒï¼Œä¸»è¦å®‰å…¨éšæ‚£åœ¨äºæ¡æ‰‹è¿‡ç¨‹ä¸­æœåŠ¡ç«¯å‘é€çš„å…¬é’¥å¯èƒ½è¢«ä¸­é—´äººæˆªå–ï¼Œå®¢æˆ·ç«¯ä¸èƒ½ç¡®å®šæœåŠ¡ç«¯å‘é€çš„å…¬é’¥æ˜¯å¦å¯ä¿¡ã€‚</p>
<h2 id="è¯ä¹¦">è¯ä¹¦</h2>
<p>è¯ä¹¦è§£äº†æœåŠ¡ç«¯å…¬é’¥ä¸å¯ä¿¡çš„é—®é¢˜ã€‚</p>
<p>è¯ä¹¦ä¸­è®°å½•äº†æœåŠ¡å™¨çš„å…¬é’¥ä¿¡æ¯ï¼ŒæœåŠ¡å™¨ä¸ç›´æ¥å‘é€å…¬é’¥ï¼Œè€Œæ˜¯å‘é€ä»CAä¸­å¿ƒç”³è¯·åˆ°çš„è¯ä¹¦ã€‚CAä¸­å¿ƒæŠŠå…¬é’¥åŠå…¶ä»–è¯ä¹¦ä¿¡æ¯ä¸€èµ·è¿›è¡Œæ‘˜è¦è®¡ç®—ï¼Œå†å¯¹å…¶è¿›è¡Œç­¾åï¼Œæœ€ç»ˆçš„è¯ä¹¦ä¸­å­˜æ”¾çš„æ˜¯å…¬é’¥ã€è¯ä¹¦ä¿¡æ¯ã€æ•°å­—ç­¾åã€‚</p>
<p>å› ä¸ºæœ‰äº†CAä¸­å¿ƒçš„æ•°å­—ç­¾åï¼Œåªè¦ç”¨ç›¸åº”çš„CAä¸­å¿ƒçš„å…¬é’¥å¯¹ç­¾åè¿›è¡Œæ ¡éªŒï¼ˆå³æ¯”è¾ƒè§£å¯†åçš„æ‘˜è¦å€¼å’Œæœ¬åœ°è®¡ç®—çš„æ‘˜è¦å€¼æ˜¯å¦ç›¸åŒï¼‰é€šè¿‡ï¼Œå°±èƒ½å®‰å…¨ä½¿ç”¨å…¬é’¥è¿›è¡ŒåŠ å¯†ã€‚</p>
<p>CAä¸­å¿ƒçš„å…¬é’¥ä¸€èˆ¬é¢„ç½®åœ¨æ“ä½œç³»ç»Ÿä¸­çš„æ ¹CAè¯ä¹¦ä¸­ã€‚æ—¢ç„¶CAä¸­å¿ƒçš„å…¬é’¥æ˜¯ç”¨æ¥å¯¹ç­¾åè¿›è¡Œæ ¡éªŒçš„ï¼Œé‚£ä¹ˆç›¸åº”çš„ï¼Œè¿™ä¸ªæ ¹CAè¯ä¹¦å°±æ˜¯ç”¨æ¥å¯¹æœåŠ¡å™¨å‘æ¥çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒçš„ã€‚</p>
<h2 id="è¯ä¹¦é“¾">è¯ä¹¦é“¾</h2>
<p>ä¸€èˆ¬æˆ‘ä»¬ä¸ä¼šç›´æ¥æ‹¿æ ¹CAè¯ä¹¦å¯¹åº”çš„ç§é’¥å»åšè¯ä¹¦çš„ç­¾å‘ï¼Œå› ä¸ºé¢‘ç¹ä½¿ç”¨æ ¹è¯ä¹¦å¯¹åº”çš„ç§é’¥ä¼šå¢åŠ å…¶æ³„éœ²çš„å¯èƒ½æ€§ã€‚</p>
<p>å®‰å…¨çš„åšæ³•æ˜¯ï¼šCAä¸­å¿ƒç»™äºŒçº§CAä¸­å¿ƒç­¾å‘ä¸€ä¸ªè¯ä¹¦ï¼ˆå³äºŒçº§CAè¯ä¹¦ï¼ŒäºŒçº§CAä¸­å¿ƒä¸¥æ ¼ä¿å­˜å…¶å¯¹åº”çš„ç§é’¥ï¼‰ï¼ŒäºŒçº§CAä¸­å¿ƒå†ç»™ä¸‰çº§CAä¸­å¿ƒç­¾å‘è¯ä¹¦&hellip;ä¾æ¬¡ç±»æ¨ã€‚</p>
<p>å› æ­¤ï¼ŒæœåŠ¡æä¾›è€…å»Nçº§CAä¸­å¿ƒç­¾å‘è¯ä¹¦æ—¶ï¼Œç”Ÿæˆçš„ä¸å†æ˜¯è¯ä¹¦ï¼Œè€Œæ˜¯<code>è¯ä¹¦é“¾</code>ï¼Œè¯ä¹¦é“¾ä¸­ä¾æ¬¡è®°å½•ç€æœåŠ¡å™¨è¯ä¹¦ã€Nçº§CAè¯ä¹¦ã€N-1çº§CAè¯ä¹¦&hellip;äºŒçº§CAè¯ä¹¦ã€‚è¯ä¹¦æ ¡éªŒæ—¶ï¼Œç”¨æ ¹CAè¯ä¹¦æ ¡éªŒäºŒçº§CAè¯ä¹¦ã€äºŒçº§CAè¯ä¹¦æ ¡éªŒä¸‰çº§CAè¯ä¹¦&hellip;æœ€åNçº§æ ¡éªŒæœåŠ¡å™¨è¯ä¹¦ï¼Œåªæœ‰å…¨éƒ¨æ ¡éªŒé€šè¿‡ï¼ŒæœåŠ¡å™¨è¯ä¹¦æ‰ç®—è¢«å®¢æˆ·ç«¯æ ¡éªŒé€šè¿‡ã€‚</p>
<h2 id="æµè§ˆå™¨é€šè¿‡httpsåè®®è®¿é—®ç½‘ç«™çš„è¿‡ç¨‹">æµè§ˆå™¨é€šè¿‡HTTPSåè®®è®¿é—®ç½‘ç«™çš„è¿‡ç¨‹</h2>
<ol>
<li>é€šè¿‡æœ¬åœ°çš„DNSé…ç½®æ–‡ä»¶æ‰¾åˆ°DNSæœåŠ¡å™¨åœ°å€ã€‚</li>
<li>DNSæœåŠ¡å™¨å°†ç½‘å€è§£æä¸ºipåœ°å€è¿”å›ã€‚</li>
<li>æœ¬æœºé€šè¿‡é“¾è·¯å±‚çš„arpåè®®æ‰¾åˆ°å±€åŸŸç½‘çš„è·¯ç”±å™¨ã€‚ï¼ˆäºŒå±‚ï¼‰</li>
<li>è·¯ç”±å™¨é€šè¿‡ipåœ°å€è·¯ç”±å¯»å€æ‰¾åˆ°ipåœ°å€å¯¹åº”çš„ä¸»æœºã€‚ï¼ˆä¸‰å±‚ï¼‰</li>
<li>ä¸»æœºé€šè¿‡TCPåè®®æ‰¾åˆ°æœ¬æœºçš„ç«¯å£å·ï¼ˆè¿›ç¨‹listenï¼‰ã€‚ï¼ˆå››å±‚ï¼‰</li>
<li>TCPä¸‰æ¬¡æ¡æ‰‹ã€‚</li>
<li><strong>ä½¿ç”¨è¯ä¹¦</strong>è¿›è¡ŒSSLæ¡æ‰‹ï¼ˆä¸»æœºå°†è‡ªå·±çš„è¯ä¹¦é“¾å‘åˆ°æµè§ˆå™¨ï¼Œæµè§ˆå™¨ä½¿ç”¨æ“ä½œç³»ç»Ÿé¢„ç½®CAè¯ä¹¦è¿›è¡Œæ ¡éªŒï¼Œæ ¡éªŒä¸é€šè¿‡ä¼šæç¤ºé“¾æ¥ä¸å®‰å…¨çš„é£é™©ï¼‰ã€‚ï¼ˆSSLå±‚ï¼‰</li>
<li>æœåŠ¡å™¨è¿›ç¨‹å’Œæµè§ˆå™¨è¿›ç¨‹åœ¨åº”ç”¨å±‚ä½¿ç”¨HTTPåè®®äº¤æ¢æ•°æ®ã€‚ï¼ˆä¸ƒå±‚ï¼‰</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>æŠ“åŒ…è§£è¯»smtpå’Œtlsåè®®</title>
			<link>https://cvvz.fun/post/smtp-with-tls/</link>
			<pubDate>Sat, 22 Jun 2019 23:21:54 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/smtp-with-tls/</guid>
			<description>èƒŒæ™¯ï¼šæŸè¿›ç¨‹è°ƒç”¨ libcurl æä¾›çš„ curl_easy_perform æ¥å£ä¸é‚®ç®±æœåŠ¡å™¨è¿›è¡Œsmtpé€šä¿¡æ—¶ï¼ŒæœåŠ¡ç«¯è¿”å›56(CURLE_RECV_ERROR)é”™è¯¯ã€‚ç”±äºæœåŠ¡ç«¯æ—¥å¿—ä¿¡æ¯ä¸è¶³</description>
			<content type="html"><![CDATA[<blockquote>
<p>èƒŒæ™¯ï¼šæŸè¿›ç¨‹è°ƒç”¨ <code>libcurl</code> æä¾›çš„ <code>curl_easy_perform</code> æ¥å£ä¸é‚®ç®±æœåŠ¡å™¨è¿›è¡Œsmtpé€šä¿¡æ—¶ï¼ŒæœåŠ¡ç«¯è¿”å›56(<code>CURLE_RECV_ERROR</code>)é”™è¯¯ã€‚ç”±äºæœåŠ¡ç«¯æ—¥å¿—ä¿¡æ¯ä¸è¶³ï¼Œäºæ˜¯æƒ³åˆ°å¯ä»¥é€šè¿‡æŠ“åŒ…æŸ¥çœ‹å»ºç«‹smtpè¿æ¥æ—¶çš„é”™è¯¯ä¿¡æ¯ã€‚</p>
</blockquote>
<h3 id="ç¬¬ä¸€æ¬¡æŠ“åŒ…">ç¬¬ä¸€æ¬¡æŠ“åŒ…</h3>
<figure>
    <img src="/smtp-with-tls.png" width="1050px"/> 
</figure>

<p>ä»å›¾ä¸­å¯ä»¥æ¸…æ™°çœ‹å‡ºæ•´ä¸ªSMTPè¿æ¥ä»å»ºç«‹åˆ°æ–­å¼€çš„å…¨è¿‡ç¨‹ï¼š</p>
<ol>
<li>é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹TCPè¿æ¥</li>
<li>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ <code>STARTTLS</code>ï¼ŒæœåŠ¡ç«¯å›å¤ <code>220 Ready to start TLS</code>åï¼ŒSMTPåè®®å‡†å¤‡å»ºç«‹å®‰å…¨ä¿¡é“</li>
<li><a href="https://cvvz.github.io/post/about-computer-security/#ssl%E5%8D%8F%E8%AE%AE">TLSåè®®æ¡æ‰‹</a>å»ºç«‹è¿æ¥</li>
<li>TLSåè®®å»ºç«‹è¿æ¥åï¼Œ<strong>åº”ç”¨å±‚åè®®çš„å†…å®¹å°±è¢«åŠ å¯†äº†ï¼ŒæŠ“åŒ…åªèƒ½çœ‹åˆ°å›¾ä¸­çš„<code>Application Data</code>å­—æ ·</strong>ã€‚</li>
<li>é€šè¿‡TCPå››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥</li>
</ol>
<blockquote>
<p>ç”±äºsmtpåè®®å†…å®¹è¢«åŠ å¯†äº†ï¼Œå› æ­¤éœ€è¦å…ˆå»æ‰TLSè¿æ¥ï¼Œå†æŠ“åŒ…åˆ†æã€‚</p>
</blockquote>
<h3 id="ç¬¬äºŒæ¬¡æŠ“åŒ…">ç¬¬äºŒæ¬¡æŠ“åŒ…</h3>
<figure>
    <img src="/smtp-without-tls.png" width="1050px"/> 
</figure>

<p>ä»ç¬¬äºŒæ¬¡æŠ“åŒ…å¾—åˆ°çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹å‡ºè¿æ¥æ–­å¼€çš„æ ¹å› æ˜¯smtpæœåŠ¡å™¨è¿”å›äº†<code>502 VRFY disallowed</code>ã€‚</p>
<p>æ¥ä¸‹æ¥ç½‘ä¸Šæœç´¢<code>smtp VRFY disallowed</code>ç›¸å…³å†…å®¹å°±èƒ½æ‰¾åˆ°ç­”æ¡ˆäº†ï¼šåŸæ¥<code>libcurl</code>ä»7.34.0ç‰ˆæœ¬å¼€å§‹ï¼Œè¦æ±‚SMTPå®¢æˆ·ç«¯æ˜¾å¼çš„è®¾ç½® <code>CURLOPT_UPLOAD</code> é€‰é¡¹ï¼Œå¦åˆ™libcurlå°†å‘é€<code>VRFY</code>å‘½ä»¤ã€‚è€Œä¸€èˆ¬æœåŠ¡å™¨å‡ºäºå®‰å…¨æ€§çš„è€ƒè™‘ï¼Œä¼šç¦æ­¢æ‰§è¡ŒVRFYå‘½ä»¤ã€‚ï¼ˆå‚è€ƒ<a href="https://issues.dlang.org/show_bug.cgi?id=13042">https://issues.dlang.org/show_bug.cgi?id=13042</a> ï¼‰</p>
<blockquote>
<p>é€šè¿‡æŠ“åŒ…è¿˜è¯å®äº†ï¼Œä¸è¿›è¡ŒåŠ å¯†é€šä¿¡çš„åº”ç”¨å±‚æ•°æ®æ˜¯æ˜æ–‡ä¼ è¾“çš„ï¼Œsmtpåè®®ä¸­çš„ç”¨æˆ·åå¯†ç è¢«ä¸€è§ˆæ— ä½™ã€‚</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>ã€é—®é¢˜å®šä½ã€‘å¼‚æ­¥å›è°ƒå‡½æ•°é€ æˆè¸©å†…å­˜</title>
			<link>https://cvvz.fun/post/coredump/</link>
			<pubDate>Thu, 13 Jun 2019 03:54:36 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/coredump/</guid>
			<description>é—®é¢˜ç°è±¡ è¿›ç¨‹æ¦‚ç‡æ€§coredump åˆ†æè¿‡ç¨‹ åˆ†æcoreæ–‡ä»¶ï¼Œå †æ ˆæ ˆé¡¶å‡½æ•°ä¸ºstrncmpï¼Œcoredumpçš„åŸå› æ˜¯ç»™strncmpä¼ é€’çš„å­—ç¬¦</description>
			<content type="html"><![CDATA[<h2 id="é—®é¢˜ç°è±¡">é—®é¢˜ç°è±¡</h2>
<p>è¿›ç¨‹æ¦‚ç‡æ€§coredump</p>
<h2 id="åˆ†æè¿‡ç¨‹">åˆ†æè¿‡ç¨‹</h2>
<ol>
<li>åˆ†æcoreæ–‡ä»¶ï¼Œå †æ ˆæ ˆé¡¶å‡½æ•°ä¸º<code>strncmp</code>ï¼Œcoredumpçš„åŸå› æ˜¯ç»™strncmpä¼ é€’çš„å­—ç¬¦ä¸²æŒ‡é’ˆï¼ˆchar*ï¼‰ä¸º<code>0x01</code>ï¼Œè®¿é—®éæ³•å†…å­˜åœ°å€ã€‚</li>
<li>æ‰¾åˆ°è¯¥å­—ç¬¦ä¸²æŒ‡é’ˆåŸå§‹å®šä¹‰å¤„ï¼Œæ˜¯æŸå‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡ï¼Œå†…å­˜åœ°å€æ­£å¸¸ã€‚</li>
<li>è¯¥å­—ç¬¦ä¸²ç”Ÿå‘½å‘¨æœŸå†…æ²¡æœ‰è¢«æ”¹å†™è¿‡ï¼Œä½†æ˜¯åœ¨æŸä¸€æ—¶åˆ»çªå˜ä¸ºäº†<code>0x01</code>ã€‚</li>
<li>å› æ­¤æœ€å¤§å¯èƒ½æ€§æ˜¯å…¶æ‰€åœ¨çš„æ ˆç©ºé—´å†…å­˜è¢«å…¶ä»–çº¿ç¨‹è¸©åˆ°äº†ã€‚</li>
<li>é€šè¿‡ä¸¤ä¸ªæ‰‹æ®µæ¥æ’æŸ¥è¿™ä¸ªé—®é¢˜ï¼š
<ol>
<li>é‡ç‚¹å…³æ³¨è¢«è¸©çš„å†…å­˜ç©ºé—´ä¹‹å‰è¢«å“ªäº›å‡½æ•°ä½¿ç”¨è¿‡ã€‚</li>
<li>ä¸€ä¸€æ’æŸ¥coreæ–‡ä»¶ä¸­çš„æ‰€æœ‰æ‰§è¡Œçº¿ç¨‹ï¼Œé‡ç‚¹å…³æ³¨å¯èƒ½å¼•èµ·è¸©å†…å­˜çš„å‡½æ•°ã€‚</li>
</ol>
</li>
</ol>
<h2 id="åŸå› è§£æ">åŸå› è§£æ</h2>
<p>è¿™ä¸ªå­—ç¬¦ä¸²çš„å†…å­˜ç©ºé—´æ›¾ç»è¢«ç”¨ä½œæŸä¸ªå‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œè€Œè¿™ä¸ªå‡½æ•°ä¸­æœ‰ä¸€æ®µé€»è¾‘æ˜¯å¾ªç¯è°ƒç”¨ä¸€ä¸ªå¼‚æ­¥æŸ¥è¯¢æ¥å£ï¼Œå¹¶ç»™è¿™ä¸ªå¼‚æ­¥æŸ¥è¯¢æ¥å£æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè€Œè¿™ä¸ªå›è°ƒå‡½æ•°çš„ä½œç”¨å°±æ˜¯å»ä¿®æ”¹è¿™ä¸ªå±€éƒ¨å˜é‡ã€‚</p>
<p>é—®é¢˜å‘ç”Ÿçš„åŸå› æ˜¯è¿™ä¸ªå¼‚æ­¥å›è°ƒæ¥å£è¿”å›çš„å¤ªæ…¢ï¼Œè°ƒç”¨æ–¹å‡½æ•°å·²ç»è¿è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶æ ˆç©ºé—´å·²ç»è¢«æ“ä½œç³»ç»Ÿå›æ”¶å¹¶åˆ†é…ç»™å…¶ä»–å‡½æ•°ï¼Œè¿™æ—¶å†æ‰§è¡Œå›è°ƒå‡½æ•°ä¿®æ”¹åŸå…ˆçš„å±€éƒ¨å˜é‡ï¼Œå°±é€ æˆäº†è¸©å†…å­˜ã€‚</p>
<p>è¿™é‡ŒåŸå…ˆçš„å±€éƒ¨å˜é‡æ˜¯ä¸ª<code>int</code>ç±»å‹ï¼Œå›è°ƒå‡½æ•°æƒ³å°†å…¶ä¿®æ”¹ä¸º1ï¼Œç»“æœå°±æˆäº†å°†ä¸€ä¸ª<code>char*</code>ç±»å‹çš„å˜é‡å€¼ä¿®æ”¹ä¸ºäº†<code>0x01</code>ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>gdbä¸­çš„å¤šçº¿ç¨‹å’Œä¿¡å·å¤„ç†</title>
			<link>https://cvvz.fun/post/gdb-muti-process-and-signal-handle/</link>
			<pubDate>Mon, 10 Jun 2019 11:44:52 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/gdb-muti-process-and-signal-handle/</guid>
			<description>å¤šçº¿ç¨‹è°ƒè¯• ä½¿ç”¨GDBè°ƒè¯•å¤šçº¿ç¨‹æ—¶ï¼Œæ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæ¨¡å¼ä¸»è¦åˆ†ä¸¤ç§ï¼šall-stop æ¨¡å¼å’Œ non-stop æ¨¡å¼ã€‚ All-Stop ä»»ä½•ä¸€ä¸ªçº¿ç¨‹åœ¨æ–­ç‚¹å¤„hangä½æ—¶ï¼Œæ‰€æœ‰å…¶ä»–çº¿</description>
			<content type="html"><![CDATA[<h2 id="å¤šçº¿ç¨‹è°ƒè¯•">å¤šçº¿ç¨‹è°ƒè¯•</h2>
<p>ä½¿ç”¨GDBè°ƒè¯•å¤šçº¿ç¨‹æ—¶ï¼Œæ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæ¨¡å¼ä¸»è¦åˆ†ä¸¤ç§ï¼šall-stop æ¨¡å¼å’Œ non-stop æ¨¡å¼ã€‚</p>
<h3 id="all-stop">All-Stop</h3>
<blockquote>
<p>ä»»ä½•ä¸€ä¸ªçº¿ç¨‹åœ¨æ–­ç‚¹å¤„hangä½æ—¶ï¼Œæ‰€æœ‰å…¶ä»–çº¿ç¨‹ä¹Ÿä¼šhangä½ã€‚é»˜è®¤ä¸ºall-stopæ¨¡å¼ã€‚</p>
</blockquote>
<ol>
<li>
<p>åœ¨all-stopæ¨¡å¼ä¸­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ–­ç‚¹æˆ–äº§ç”Ÿä¿¡å·ï¼ŒGDBå°†è‡ªåŠ¨é€‰æ‹©è¯¥çº¿ç¨‹ä½œä¸ºå½“å‰çº¿ç¨‹å¹¶åœä½ï¼ˆæç¤º<code>Switching to Thread n</code>ï¼‰ï¼Œå¹¶ä¸”å…¶ä»–çº¿ç¨‹ä¹Ÿéƒ½ä¼šåœæ­¢è¿è¡Œï¼›</p>
</li>
<li>
<p>å½“æ‰§è¡Œ<code>continue</code>ã€<code>until</code>ã€<code>finish</code>ã€<code>next</code>ã€<code>step</code>ç­‰ä½¿çº¿ç¨‹ç»§ç»­è¿è¡Œï¼Œæ‰€æœ‰çº¿ç¨‹ä¼šåŒæ—¶ç»§ç»­è¿è¡Œï¼Œç›´åˆ°æŸä¸€ä¸ªçº¿ç¨‹å†æ¬¡è¢«stopï¼Œç„¶åè¯¥çº¿ç¨‹æˆä¸ºå½“å‰çº¿ç¨‹ã€‚</p>
</li>
<li>
<p>è¿™é‡Œè¿˜å­˜åœ¨è¿™æ ·ä¸€ç§æƒ…å†µï¼šå½“ä½ å•æ­¥è·Ÿè¸ªæŸä¸ªçº¿ç¨‹æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹ä¸€å®šæ˜¯æ‰§è¡Œäº†æŸæ¡å®Œæ•´è¯­å¥ååœ¨ä¸‹ä¸€æ¡è¯­å¥å‰åœä½ï¼Œ<strong>ä½†æ˜¯è¿™æ®µæ—¶é—´é‡Œå…¶ä»–çº¿ç¨‹å¯èƒ½æ‰§è¡Œäº†åŠæ¡ã€ä¸€æ¡æˆ–å¤šæ¡è¯­å¥</strong>ã€‚</p>
</li>
<li>
<p>åœ¨all-stopæ¨¡å¼ä¸‹ï¼Œå¯ä»¥é€šè¿‡è®¾å®š<code>scheduler-locking</code>ï¼ˆè°ƒåº¦å™¨é”å®šï¼‰æ¥æ§åˆ¶CPUè°ƒåº¦å™¨çš„è¡Œä¸ºä»è€Œæ§åˆ¶å¤šçº¿ç¨‹çš„å¹¶å‘è¿è¡Œè¡Œä¸ºã€‚</p>
<ul>
<li><code>set scheduler-locking off</code>ï¼šé»˜è®¤è°ƒåº¦å™¨é”å®šä¸ºå…³ï¼Œä¹Ÿå°±æ˜¯CPUä¹Ÿå¯ä»¥è¿›è¡Œè‡ªç”±è°ƒåº¦ï¼Œé‚£ä¹ˆæ‰€æœ‰çº¿ç¨‹æ˜¯â€œåŒè¿›åŒæ­¢â€çš„ï¼Œä¸€èµ·stopï¼Œä¸€èµ·ç»§ç»­è¿è¡Œï¼Œç«äº‰CPUèµ„æºï¼›</li>
<li><code>set scheduler-locking on</code>ï¼šå¼€å¯è°ƒåº¦å™¨é”å®šï¼Œä¸å…è®¸CPUè‡ªç”±è°ƒåº¦ï¼ŒCPUåªèƒ½æ‰§è¡Œå½“å‰çº¿ç¨‹ä¸­çš„æŒ‡ä»¤ï¼Œå…¶ä»–çº¿ç¨‹ä¸€ç›´å¤„äºstopçŠ¶æ€ï¼›</li>
</ul>
</li>
</ol>
<h3 id="non-stop">Non-Stop</h3>
<blockquote>
<p>ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è¢«stopç”šè‡³å•æ­¥è°ƒè¯•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è‡ªç”±è¿è¡Œã€‚</p>
</blockquote>
<ol>
<li>é€šè¿‡<code>set non-stop on</code>æ‰‹åŠ¨å¼€å¯non-stopæ¨¡å¼ã€‚ä¸€èˆ¬non-stopæ¨¡å¼æ­é…å¼‚æ­¥æ‰§è¡Œå‘½ä»¤ä½¿ç”¨ã€‚</li>
<li>GDBçš„å¯æ‰§è¡Œå‘½ä»¤åˆ†ä¸ºä¸¤ç§ï¼šåŒæ­¥æ‰§è¡Œå’Œå¼‚æ­¥æ‰§è¡Œã€‚
<ul>
<li>åŒæ­¥æ‰§è¡Œï¼šå³æ‰§è¡Œä¸€æ¡å‘½ä»¤åï¼Œè¦ç­‰å¾…æœ‰çº¿ç¨‹è¢«stopäº†æ‰ä¼šåœ¨å¼¹å‡ºå‘½ä»¤æç¤ºç¬¦ã€‚è¿™æ˜¯é»˜è®¤æ‰§è¡Œæ¨¡å¼ã€‚</li>
<li>å¼‚æ­¥æ‰§è¡Œï¼šç«‹åˆ»è¿”å›å¼¹å‡ºå‘½ä»¤æç¤ºç¬¦ã€‚æ‰“å¼€å‘½ä»¤å¼‚æ­¥æ‰§è¡Œæ¨¡å¼å¼€å…³çš„å‘½ä»¤æ˜¯<code>set target-async on</code>ã€‚</li>
</ul>
<blockquote>
<p>åœ¨å‘½ä»¤åè·Ÿ<code>&amp;</code>è¡¨ç¤ºè¯¥å‘½ä»¤ä»¥å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œï¼Œå¦‚<code>attach&amp;</code>ã€<code>continue&amp;</code>ç­‰ã€‚</p>
</blockquote>
</li>
<li>non-stopæ¨¡å¼ä¸‹å¯ä½¿ç”¨<code>interrupt</code>åœæ­¢å½“å‰è¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œ<code>interrupt -a</code>åœä¸‹æ‰€æœ‰çº¿ç¨‹ã€‚</li>
</ol>
<h2 id="ä¿¡å·å¤„ç†">ä¿¡å·å¤„ç†</h2>
<p>GDBèƒ½å¤Ÿæ£€æµ‹åˆ°ç¨‹åºä¸­äº§ç”Ÿçš„ä¿¡å·ï¼Œå¹¶è¿›è¡Œé’ˆå¯¹æ€§çš„å¤„ç†ã€‚é€šè¿‡<code>info handle</code>æŸ¥çœ‹å¯¹æ‰€æœ‰ä¿¡å·çš„å¤„ç†æ–¹å¼ï¼š</p>
<ul>
<li>Stopï¼šæ£€æµ‹åˆ°ä¿¡å·æ˜¯å¦åœä½ç¨‹åºçš„è¿è¡Œï¼›</li>
<li>Printï¼šæ˜¯å¦æ‰“å°æ”¶åˆ°è¯¥ä¿¡å·çš„ä¿¡æ¯ï¼›</li>
<li>Pass to programï¼šæ˜¯å¦æŠŠè¯¥ä¿¡å·ä¼ ç»™è¿›ç¨‹å¤„ç†ï¼ˆæˆ–è€…è¯´æ˜¯å¦å±è”½è¯¥ä¿¡å·ï¼Œæ— æ³•å±è”½<code>SIGKILL</code>å’Œ<code>SIGSTOP</code>ä¿¡å·ï¼‰</li>
</ul>
<p>é€šè¿‡<code>handle SIG</code>æ¥æŒ‡å®šæŸä¸ªä¿¡å·çš„å¤„ç†æ–¹å¼ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>è§£å‰–è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´</title>
			<link>https://cvvz.fun/post/anatomy-of-a-program-in-memory/</link>
			<pubDate>Fri, 07 Jun 2019 23:14:03 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/anatomy-of-a-program-in-memory/</guid>
			<description>å¯¹äº32ä½ x86 Linuxæ“ä½œç³»ç»Ÿï¼Œå…¸å‹çš„è¿›ç¨‹åœ°å€ç©ºé—´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ¯ä¸€ä¸ªè¿›ç¨‹è¿è¡Œåœ¨å„è‡ªç‹¬ç«‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­ï¼Œä»0x00000000åˆ°0xFFFF</description>
			<content type="html"><![CDATA[<p>å¯¹äº<strong>32ä½ x86 Linuxæ“ä½œç³»ç»Ÿ</strong>ï¼Œå…¸å‹çš„è¿›ç¨‹åœ°å€ç©ºé—´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure>
    <img src="/linuxFlexibleAddressSpaceLayout.png" width="750px"/> 
</figure>

<p>æ¯ä¸€ä¸ªè¿›ç¨‹è¿è¡Œåœ¨å„è‡ªç‹¬ç«‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­ï¼Œä»0x00000000åˆ°0xFFFFFFFFï¼Œå…±4GBã€‚</p>
<p>è¿›ç¨‹åœ°å€ç©ºé—´ä»ä½åˆ°é«˜ä¾æ¬¡æ˜¯ï¼š</p>
<ul>
<li><strong>Text Segmentï¼š</strong> æœºå™¨æŒ‡ä»¤ï¼Œåªè¯»ï¼Œä¸€ä¸ªç¨‹åºçš„å¤šä¸ªè¿›ç¨‹å…±äº«ä¸€ä¸ªæ­£æ–‡æ®µã€‚</li>
</ul>
<blockquote>
<p>å¦‚æœè¿›ç¨‹å¸¦æœ‰è°ƒè¯•ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡<code>addr2line</code> + æ­£æ–‡æ®µåœ°å€è·å¾—å¯¹åº”çš„æºä»£ç ä½ç½®ã€‚</p>
</blockquote>
<ul>
<li>
<p><strong>Data Segmentï¼š</strong> å…·æœ‰åˆå€¼çš„å…¨å±€/é™æ€å˜é‡ã€‚</p>
</li>
<li>
<p><strong>BSS Segmentï¼š</strong> æœªèµ‹åˆå€¼çš„å…¨å±€/é™æ€å˜é‡ã€‚</p>
</li>
<li>
<p><strong>Heapï¼š</strong> å †ã€‚å †ä»ä½åœ°å€å‘é«˜åœ°å€ç”Ÿé•¿ã€‚å †åŒºå†…å­˜åœ¨åˆ†é…è¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼š</p>
</li>
</ul>
<p><img src="/fragmentedHeap.png" alt="å†…å­˜ç¢ç‰‡" title="å†…å­˜ç¢ç‰‡"></p>
<blockquote>
<p>ç”³è¯·å †å†…å­˜çš„æ¥å£æ˜¯é˜»å¡æ¥å£ï¼Œå³å¯èƒ½å› ä¸ºæš‚æ—¶åˆ†é…ä¸åˆ°å¤Ÿå¤§çš„å †ç©ºé—´å¯¼è‡´è¿›ç¨‹è®©å‡ºCPUã€‚</p>
</blockquote>
<ul>
<li>
<p><strong>Memory Mapping Segmentï¼š</strong> å†…å­˜æ˜ å°„åŒºã€‚åŠ¨æ€åº“ã€mmapã€å…±äº«å†…å­˜ä½¿ç”¨çš„éƒ½æ˜¯å†…å­˜æ˜ å°„åŒºã€‚</p>
</li>
<li>
<p><strong>Stackï¼š</strong> æ ˆã€‚æ ˆä»é«˜åœ°å€å‘ä½åœ°å€ç”Ÿé•¿ã€‚è¿›ç¨‹æ ˆç©ºé—´çš„æ€»å¤§å°å¯é€šè¿‡
<code>ulimit -s</code>æŸ¥çœ‹ï¼Œé»˜è®¤ä¸º8MBã€‚æ ˆä¸­ä¸ä»…å­˜æ”¾ç€å±€éƒ¨å˜é‡ï¼Œ<strong>æ¯æ¬¡å‡½æ•°è°ƒç”¨æ—¶ï¼Œå‚æ•°ã€è¿”å›åœ°å€ã€å¯„å­˜å™¨å€¼ç­‰éƒ½ä¼šè¿›è¡Œå‹æ ˆã€‚</strong></p>
</li>
<li>
<p><strong>Kernel spaceï¼š</strong> è¿›ç¨‹åœ°å€ç©ºé—´çš„æœ€é«˜1GBæ˜¯å†…æ ¸ç©ºé—´ã€‚<strong>å†…æ ¸ç©ºé—´è¢«æ‰€æœ‰è¿›ç¨‹å…±äº«</strong>ï¼Œä½†æ˜¯ç”¨æˆ·æ€è¿›ç¨‹åªæœ‰é€šè¿‡ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸æ€æ‰èƒ½æ‰§è¡Œå†…æ ¸æ€ä»£ç ã€‚</p>
</li>
</ul>
<blockquote>
<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://manybutfinite.com/post/anatomy-of-a-program-in-memory/">https://manybutfinite.com/post/anatomy-of-a-program-in-memory/</a></p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>systemç³»ç»Ÿè°ƒç”¨æ¢ç§˜</title>
			<link>https://cvvz.fun/post/system-and-shell/</link>
			<pubDate>Thu, 30 May 2019 00:28:40 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/system-and-shell/</guid>
			<description>6æœˆ3æ—¥æ›´æ–° æ–°çš„å®éªŒåˆå‘ç°ä½¿ç”¨/bin/shå’Œä¹¦ä¸­è¡Œä¸ºä¸€è‡´ï¼Œä½†ä½¿ç”¨/bin/bashçš„è¡Œä¸ºå’Œæœ¬æ–‡ä¸­çš„å®éªŒä¸€è‡´ï¼Œçœ‹æ¥æ˜¯ä¸åŒshellçš„åº•å±‚çš„å®</description>
			<content type="html"><![CDATA[<blockquote>
<p><strong>6æœˆ3æ—¥æ›´æ–°</strong></p>
<p>æ–°çš„å®éªŒåˆå‘ç°ä½¿ç”¨<code>/bin/sh</code>å’Œä¹¦ä¸­è¡Œä¸ºä¸€è‡´ï¼Œä½†ä½¿ç”¨<code>/bin/bash</code>çš„è¡Œä¸ºå’Œæœ¬æ–‡ä¸­çš„å®éªŒä¸€è‡´ï¼Œçœ‹æ¥æ˜¯ä¸åŒshellçš„åº•å±‚çš„å®ç°æ–¹å¼æœ‰å·®å¼‚ã€‚<strong>è€Œä¹‹æ‰€ä»¥ä¹‹å‰ç”¨<code>/bin/sh</code>åšçš„å®éªŒå’Œä¹¦ä¸­è¡Œä¸ºä¸ä¸€è‡´ï¼Œæ˜¯å› ä¸ºåœ¨æˆ‘åšå®éªŒçš„æœºå™¨ä¸Šï¼Œ<code>/bin/sh</code>å…¶å®æ˜¯ä¸€ä¸ªæŒ‡å‘<code>/bin/bash</code>çš„è½¯é“¾æ¥</strong>ã€‚ã€‚ã€‚</p>
<p>ä¸è¿‡è‡³å°‘å¾—åˆ°ä¸€ä¸ªé‡è¦ç»“è®ºï¼Œé‚£å°±æ˜¯ï¼š<strong>å¯¹äºä¸åŒçš„åº•å±‚shellï¼Œsystemç³»ç»Ÿè°ƒç”¨çš„è¡¨ç°ä¼šä¸åŒ</strong>ã€‚è¿™ä¸€ç‚¹åœ¨ç¼–ç æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚</p>
</blockquote>
<h2 id="systemå®ç°åŸç†">systemå®ç°åŸç†</h2>
<p><code>system</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„æºç åœ¨ç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šäº†ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºäº†ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯çˆ¶è¿›ç¨‹<code>fork</code>åï¼Œåœ¨å­è¿›ç¨‹ä¸­é€šè¿‡æ‰§è¡Œ<code>execl(&quot;/bin/sh&quot;, &quot;sh&quot;, &quot;-c&quot;, cmdstring, (char *)0)</code>ï¼Œä½¿å¾—<code>/bin/sh</code>æˆä¸ºæ–°çš„å­è¿›ç¨‹ï¼Œç„¶ååœ¨<code>/bin/sh</code>ä¸­æ‰§è¡Œ<code>cmdstring</code>å‘½ä»¤ï¼›çˆ¶è¿›ç¨‹å¾ªç¯æ‰§è¡Œ<code>waitpid</code>ï¼Œç­‰å¾…å­è¿›ç¨‹é€€å‡ºçš„ä¿¡å·ã€‚</p>
<h2 id="åˆ°åº•æœ‰å‡ ä¸ªå­è¿›ç¨‹">åˆ°åº•æœ‰å‡ ä¸ªå­è¿›ç¨‹ï¼Ÿ</h2>
<h3 id="å®éªŒä¸€">å®éªŒä¸€</h3>
<p>åœ¨å­¦ä¹ ã€ŠUNIXç¯å¢ƒé«˜çº§ç¼–ç¨‹ï¼ˆç¬¬3ç‰ˆï¼‰ã€‹ä¿¡å·ä¸€ç« æ—¶ï¼Œæ ¹æ®å›¾10-27æ‰€ç¤ºï¼Œæ‰§è¡Œ <code>system(&quot;/bin/ed&quot;)</code> å‘½ä»¤åï¼Œä¼šåˆ†åˆ«è°ƒç”¨<code>fork</code>/<code>exec</code>ç³»ç»Ÿè°ƒç”¨ä¸¤æ¬¡ï¼š</p>
<ol>
<li>ç¬¬ä¸€æ¬¡å‘ç”Ÿåœ¨è°ƒç”¨<code>system</code>æ—¶ï¼Œçˆ¶è¿›ç¨‹<code>fork</code>ä¸€æ¬¡ï¼Œå­è¿›ç¨‹æ‰§è¡Œ<code>execl(&quot;/bin/sh&quot;,&quot;sh&quot;,&quot;-c&quot;,&quot;/bin/ed&quot;,(char *)0)</code>ä¸€æ¬¡ï¼Œå­è¿›ç¨‹è¢«æ›¿æ¢ä¸º<code>/bin/sh</code>ã€‚</li>
<li>ç¬¬äºŒæ¬¡å‘ç”Ÿåœ¨<code>/bin/sh</code>è¿™ä¸ªå­è¿›ç¨‹ä¸­ï¼Œ<code>/bin/sh</code>ä¼šå…ˆ<code>fork</code>ä¸€ä¸ªå­è¿›ç¨‹ï¼Œè¿™ä¸ªå­è¿›ç¨‹æ‰§è¡Œ<code>exec(&quot;/bin/ed&quot;)</code>ï¼Œç”¨<code>/bin/ed</code>æ›¿æ¢<code>/bin/sh</code>ã€‚</li>
</ol>
<p>ä½†æ˜¯æˆ‘åœ¨è‡ªå·±åšå®éªŒæ—¶ï¼Œç”¨<code>strace</code>å‘½ä»¤è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ï¼Œå‘ç°<code>system</code>ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ<strong>åª<code>fork</code>äº†ä¸€æ¬¡ï¼Œ<code>exec</code>äº†ä¸¤æ¬¡ï¼Œä¸»è¦çš„å·®å¼‚åœ¨äº<code>/bin/sh</code>å¹¶æ²¡æœ‰<code>fork</code>å­è¿›ç¨‹ï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡Œäº†<code>exec(&quot;/bin/ed&quot;)</code></strong>ã€‚</p>
<h3 id="å®éªŒäºŒ">å®éªŒäºŒ</h3>
<p>æˆ‘åœ¨shellä¸‹æ‰§è¡Œ<code>sh -c &quot;sleep 5&quot;&amp;</code>å‘½ä»¤ï¼Œæ ¹æ®ä¹¦ä¸­çš„ç¤ºä¾‹ï¼Œæ‰§è¡Œ<code>ps -f</code>ååº”è¯¥å¯ä»¥çœ‹åˆ°4ä¸ªè¿›ç¨‹ï¼š</p>
<ul>
<li><code>ps -f</code></li>
<li>å½“å‰shellè¿›ç¨‹</li>
<li>å½“å‰shellçš„å­è¿›ç¨‹<code>sh</code></li>
<li><code>sh</code>çš„å­è¿›ç¨‹<code>sleep 5</code>ï¼›</li>
</ul>
<p><strong>ä½†å®é™…æˆ‘åªçœ‹åˆ°ä¸‰ä¸ªè¿›ç¨‹ï¼Œç¼ºå°‘å­è¿›ç¨‹<code>sh</code>ï¼Œ<code>sleep 5</code>ç›´æ¥æˆä¸ºäº†å½“å‰shellçš„å­è¿›ç¨‹</strong>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>Storage:~ <span class="c1"># sh -c &#34;sleep 5&#34; &amp;</span>
<span class="ln">2</span><span class="o">[</span>1<span class="o">]</span> <span class="m">101978</span>
<span class="ln">3</span>Storage:~ <span class="c1"># ps -o pid,ppid,cmd</span>
<span class="ln">4</span>PID PPID CMD
<span class="ln">5</span><span class="m">48673</span> <span class="m">48658</span> -bash
<span class="ln">6</span><span class="m">101978</span> <span class="m">48673</span> sleep <span class="m">5</span>
<span class="ln">7</span><span class="m">103012</span> <span class="m">48673</span> ps -o pid,ppid,cmd
</code></pre></div><h2 id="systemçš„è¿”å›å€¼åˆ°åº•æ˜¯å¤šå°‘">systemçš„è¿”å›å€¼åˆ°åº•æ˜¯å¤šå°‘ï¼Ÿ</h2>
<p>ä½¿ç”¨å¦‚ä¸‹ç¨‹åºå¯¹systemçš„è¿”å›å€¼è¿›è¡Œå®éªŒï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="ln"> 1</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="ln"> 2</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="ln"> 3</span><span class="cp"></span><span class="kt">void</span> <span class="nf">main</span> <span class="p">()</span>
<span class="ln"> 4</span><span class="p">{</span>
<span class="ln"> 5</span>    <span class="kt">int</span> <span class="n">iStatus</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">iStatus</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="s">&#34;sleep 5&#34;</span><span class="p">);</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">iStatus</span><span class="p">))</span>
<span class="ln"> 8</span>    <span class="p">{</span>
<span class="ln"> 9</span>        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;normal exit code %d ,status %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">iStatus</span><span class="p">),</span><span class="n">iStatus</span><span class="p">);</span>
<span class="ln">10</span>    <span class="p">}</span>
<span class="ln">11</span>
<span class="ln">12</span>    <span class="k">if</span> <span class="p">(</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">iStatus</span><span class="p">))</span>
<span class="ln">13</span>    <span class="p">{</span>
<span class="ln">14</span>        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;signal code %d ,status %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">iStatus</span><span class="p">),</span><span class="n">iStatus</span><span class="p">);</span>
<span class="ln">15</span>    <span class="p">}</span>
<span class="ln">16</span><span class="p">}</span>
</code></pre></div><p>åœ¨è¿™ä¸ªå®éªŒç¨‹åºä¸­ï¼Œé€šè¿‡<code>system</code>ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œ<code>sleep 5</code>ï¼ŒsleepæœŸé—´é€šè¿‡<code>ctrl+C</code>å‘mainè¿›ç¨‹å‘é€<code>SIGINT</code>ä¿¡å·ï¼Œè§‚å¯Ÿä¼šæ‰“å°å‡ºä»€ä¹ˆã€‚</p>
<p>æŒ‰ç…§ä¹¦ä¸­çš„å®éªŒç»“æœï¼Œæ˜¯ä¼šæ‰“å°&quot;normal exit&hellip;&ldquo;çš„ï¼ŒåŸå› åˆ†æï¼š</p>
<ol>
<li>æ”¶åˆ°<code>SIGINT</code>ä¿¡å·çš„æ˜¯<code>sleep 5</code>è¿›ç¨‹ï¼Œ<code>sleep 5</code>è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶ï¼Œå®ƒçš„é€€å‡ºå€¼ä¸º2ï¼›</li>
<li>ä½†<code>sleep 5</code>çš„çˆ¶è¿›ç¨‹æ˜¯<code>/bin/sh</code>ï¼Œè€Œ<strong>shellä¼šå°†å­è¿›ç¨‹çš„é€€å‡ºç ï¼ˆæ­¤å¤„ä¸º2ï¼‰+128ä½œä¸ºé€€å‡ºå€¼æ­£å¸¸é€€å‡ºï¼ˆä½8ä½å…¨0ï¼‰</strong>ã€‚</li>
<li>æ‰€ä»¥çˆ¶è¿›ç¨‹<code>main</code>é€šè¿‡<code>waitpid</code>å¾—åˆ°<code>/bin/sh</code>çš„é€€å‡ºç ä¸º130ï¼Œè®¤ä¸ºæ˜¯æ­£å¸¸æ‰§è¡Œé€€å‡ºï¼ˆä½8ä½å…¨0ï¼‰ã€‚</li>
</ol>
<p>ç„¶è€Œæˆ‘çš„å®éªŒç»“æœå´æ˜¯æ‰“å°&quot;signal code 2&rdquo;ã€‚åŸå› å¦‚ä¸‹ï¼š</p>
<p>å®é™…ä¸Š<code>sleep 2</code>æ˜¯mainå‡½æ•°çš„å­è¿›ç¨‹ï¼Œæ‰€ä»¥ï¼Œå®ƒæ”¶åˆ°ä¿¡å·é€€å‡ºï¼Œmainå‡½æ•°é€šè¿‡<code>waitpid</code>å¾—åˆ°çš„å­è¿›ç¨‹é€€å‡ºçš„çŠ¶æ€ç å°±æ˜¯2äº†ã€‚</p>
<blockquote>
<p><strong>waitpidå¾—åˆ°çš„çŠ¶æ€ç </strong>ï¼š<strong>ä½7ä½ä»£è¡¨ä¿¡å·å€¼ï¼Œç¬¬8ä½ä»£è¡¨æ˜¯å¦coreï¼Œé«˜8ä½ä»£è¡¨exité€€å‡ºç ã€‚ç”±æ­¤å¯è§ä¿¡å·æœ€å¤š127ç§ï¼Œexitæœ€å¤§å€¼ä¸º255</strong>ã€‚</p>
<p>é€šè¿‡<code>WIFEXITED</code>å®åˆ¤æ–­ä½ä¸ƒä½çš„ä¿¡å·å€¼æ˜¯å¦ä¸º0ï¼Œ0ä¸ºæ­£å¸¸é€€å‡ºï¼›é€šè¿‡<code>WEXITSTATUS</code>å¾—åˆ°é«˜8ä½çš„exitå€¼ï¼›å¦åˆ™é€šè¿‡<code>WIFSIGNALED</code>å¾—åˆ°ä½ä¸ƒä½çš„ä¿¡å·å€¼ã€‚</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>ã€é—®é¢˜å®šä½ã€‘ä¸²å£ç™»å½•å¤±è´¥</title>
			<link>https://cvvz.fun/post/arm-login-failed/</link>
			<pubDate>Fri, 24 May 2019 02:45:41 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/arm-login-failed/</guid>
			<description>é—®é¢˜ç°è±¡ é€šè¿‡ä¸²å£æ— æ³•æ­£å¸¸ç™»å½•ARMè®¾å¤‡ï¼Œshellé—ªé€€ã€‚ é—®é¢˜åˆ†æ é¦–å…ˆæ¢³ç†ä¸€ä¸‹SSHç™»å½•å’Œä¸²å£ç™»å½•ä¸¤ç§æ–¹å¼çš„æµç¨‹ï¼š ä¸¤ç§ç™»å½•æ–¹å¼é¦–å…ˆéƒ½è¦ç»è¿‡PA</description>
			<content type="html"><![CDATA[<h2 id="é—®é¢˜ç°è±¡">é—®é¢˜ç°è±¡</h2>
<p>é€šè¿‡ä¸²å£æ— æ³•æ­£å¸¸ç™»å½•ARMè®¾å¤‡ï¼Œshellé—ªé€€ã€‚</p>
<h2 id="é—®é¢˜åˆ†æ">é—®é¢˜åˆ†æ</h2>
<p>é¦–å…ˆæ¢³ç†ä¸€ä¸‹SSHç™»å½•å’Œä¸²å£ç™»å½•ä¸¤ç§æ–¹å¼çš„æµç¨‹ï¼š</p>
<figure>
    <img src="/linux-login.drawio.svg" width="400px"/> 
</figure>

<ol>
<li>ä¸¤ç§ç™»å½•æ–¹å¼é¦–å…ˆéƒ½è¦ç»è¿‡PAMæ’ä»¶çš„å¤„ç†ï¼ŒSSHç™»å½•æ˜¯ç”±SSHDé€šè¿‡å­è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨shellï¼Œä¸²å£ç™»å½•åˆ™æ˜¯æ‹‰èµ·/bin/loginï¼Œç”±/bin/loginå¯åŠ¨shellæ›¿ä»£è‡ªå·±ã€‚</li>
<li>shellå¯åŠ¨åï¼Œä¼šå»æ‰§è¡Œ<code>/etc/profile</code>ä¸­çš„ä¸€ç³»åˆ—è„šæœ¬ï¼Œé…ç½®ç³»ç»Ÿç¯å¢ƒã€‚</li>
</ol>
<p>è¿™é‡Œé¢å¯èƒ½å‡ºé—®é¢˜çš„ç¯èŠ‚æœ‰ï¼šPAMæ’ä»¶ã€/bin/loginè¿›ç¨‹ã€/bin/bashå’Œ/etc/profileã€‚ä½†è¿™ä¸ªé—®é¢˜çš„ç°è±¡æ˜¯/bin/bashè¢«æ‹‰èµ·åï¼Œå¾ˆå¿«åˆé—ªé€€äº†ï¼Œå› æ­¤é—®é¢˜è‚¯å®šå‡ºåœ¨/etc/profileè„šæœ¬ä¸­ã€‚æœ€åæ’æŸ¥å‘ç°è„šæœ¬ä¸­é™åˆ¶äº†ä¸²å£ç™»å½•çš„ç»ˆç«¯è®¾å¤‡åä¸º<code>ttyS0</code>ï¼Œå¦åˆ™ç›´æ¥é€€å‡ºã€‚ä½†æ–°çš„ARMè®¾å¤‡çš„ä¸²è¡Œç»ˆç«¯åç§°æ˜¯<code>ttyAMA0</code>ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>ã€é—®é¢˜å®šä½ã€‘/bin/bashæ— æƒé™å¯¼è‡´SSHç™»å½•å¤±è´¥</title>
			<link>https://cvvz.fun/post/login-permission-denied/</link>
			<pubDate>Thu, 23 May 2019 02:21:56 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/login-permission-denied/</guid>
			<description>é—®é¢˜ç°è±¡ SSHç™»å½•ä¸»æœºå¤±è´¥ï¼Œæç¤ºé”™è¯¯ï¼š/bin/bash: Permission deniedã€‚ åˆ†æè¿‡ç¨‹ Linuxå¤„ç†SSHè¿œç¨‹ç™»å½•çš„æµç¨‹å¦‚ä¸‹ï¼š SSHDè¿›ç¨‹åå°ç›‘</description>
			<content type="html"><![CDATA[<h2 id="é—®é¢˜ç°è±¡">é—®é¢˜ç°è±¡</h2>
<p>SSHç™»å½•ä¸»æœºå¤±è´¥ï¼Œæç¤ºé”™è¯¯ï¼š<code>/bin/bash: Permission denied</code>ã€‚</p>
<h2 id="åˆ†æè¿‡ç¨‹">åˆ†æè¿‡ç¨‹</h2>
<p>Linuxå¤„ç†SSHè¿œç¨‹ç™»å½•çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>SSHDè¿›ç¨‹åå°ç›‘å¬SSHè¿æ¥</li>
<li>å½“æœ‰è¿æ¥åˆ°è¾¾æ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶æ‰“å¼€ä¸€ä¸ªä¼ªç»ˆç«¯è®¾å¤‡ï¼ˆptsï¼‰</li>
<li>ä»passwdä¸­è·å¾—ç”¨æˆ·idã€ç»„idã€shellè·¯å¾„ç­‰ä¿¡æ¯ï¼Œå¹¶ä¸ºæ‰“å¼€çš„å­è¿›ç¨‹è®¾ç½®è¿›ç¨‹uidã€gidç­‰</li>
<li>é€šè¿‡<code>exec</code>ç³»ç»Ÿè°ƒç”¨å°†å­è¿›ç¨‹æ›¿æ¢ä¸ºç™»å½•shellï¼ˆè¿™é‡Œæ˜¯<code>/bin/bash</code>ï¼‰ï¼Œshellçš„0ã€1ã€2æ–‡ä»¶æè¿°ç¬¦å’Œä¼ªç»ˆç«¯ç›¸è¿</li>
<li>ç”¨æˆ·é€šè¿‡ä¼ªç»ˆç«¯å’Œä¸»æœºé€šä¿¡</li>
</ol>
<p>å¾ˆæ˜æ˜¾è¿™é‡Œçš„é”™è¯¯åŸå› æ˜¯å› ä¸ºè®¾ç½®äº†ç™»é™†ç”¨æˆ·çš„uidã€gidçš„å­è¿›ç¨‹æ²¡æœ‰<code>/bin/bash</code>çš„æ‰§è¡Œæƒé™å¯¼è‡´çš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬4æ­¥å‡ºé”™ã€‚é€šè¿‡<code>strace</code>è·Ÿè¸ªsshdè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°è¯äº†è¿™ä¸€ç‚¹ï¼šå­è¿›ç¨‹ç¡®å®æ˜¯åœ¨æ‰§è¡Œ<code>execve(/bin/bash)</code>æ—¶æŠ¥<code>Permission denied</code>ã€‚</p>
<p>ç»§ç»­å®éªŒï¼Œå‘ç°åªæœ‰érootç»„å†…ç”¨æˆ·ç™»å½•æ‰ä¼šæŠ¥è¯¥é”™è¯¯ã€‚å› æ­¤å°†ä¸€ä¸ªå·²ç™»å½•çš„rootç»„å†…ç”¨æˆ·ä¿®æ”¹ä¸ºérootç»„å†…ç”¨æˆ·åï¼Œé€šè¿‡<code>strace</code>è·Ÿè¸ªå…¶æ‰§è¡Œ<code>/bin/bash</code>çš„è¿‡ç¨‹ï¼Œå‘ç°æ˜¯åœ¨<code>open</code>æŸä¸ªåŠ¨æ€åº“æƒé™ä¸è¶³ã€‚æŸ¥çœ‹è¯¥åº“æ–‡ä»¶åŠè·¯å¾„çš„æƒé™ï¼Œå‘ç°åŸæœ¬åº”è¯¥æ˜¯<code>755</code>æƒé™çš„<code>/usr</code>ç›®å½•å˜æˆäº†<code>750</code>ã€‚é€šè¿‡<code>stat</code>å‘½ä»¤æŸ¥çœ‹è¯¥æ–‡ä»¶å¤¹è¢«ä¿®æ”¹çš„æ—¶é—´ç‚¹ï¼Œå®šä½åˆ°æ˜¯è®¾å¤‡ä¸Šç”µè„šæœ¬ä¸­çš„ä¸€ä¸ªbugã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>è®°ä¸€æ¬¡ç¼–è¯‘é”™è¯¯çš„è§£å†³è¿‡ç¨‹</title>
			<link>https://cvvz.fun/post/compile-error/</link>
			<pubDate>Thu, 01 Nov 2018 20:31:15 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/compile-error/</guid>
			<description>æœ€è¿‘å¼€å‘æ–°çš„éœ€æ±‚éœ€è¦ä½¿ç”¨æŸä¸ªå¤–éƒ¨æ¨¡å—çš„åº“æ–‡ä»¶ï¼Œè¯¥æ¨¡å—åœ¨æ–‡æ¡£ä¸­æä¾›äº†ä¸€ä¸ªdemoï¼Œä½†makefileæ–‡ä»¶ç¼–è¯‘æŠ¥é”™ã€‚é€šè¿‡æ‘¸ç´¢å’Œå­¦ä¹ æœ€ç»ˆæŠŠdemo</description>
			<content type="html"><![CDATA[<p>æœ€è¿‘å¼€å‘æ–°çš„éœ€æ±‚éœ€è¦ä½¿ç”¨æŸä¸ªå¤–éƒ¨æ¨¡å—çš„åº“æ–‡ä»¶ï¼Œè¯¥æ¨¡å—åœ¨æ–‡æ¡£ä¸­æä¾›äº†ä¸€ä¸ªdemoï¼Œä½†makefileæ–‡ä»¶ç¼–è¯‘æŠ¥é”™ã€‚é€šè¿‡æ‘¸ç´¢å’Œå­¦ä¹ æœ€ç»ˆæŠŠdemoç¼–è¯‘æˆåŠŸå¹¶è¿è¡Œèµ·æ¥ï¼Œä¸‹é¢è®°å½•ä¸€ä¸‹è¿‡ç¨‹ä¸­ç¢°åˆ°çš„é—®é¢˜å¹¶è¿›è¡Œæ€»ç»“ã€‚</p>
<h2 id="so-not-found">so not found</h2>
<p>ä½¿ç”¨gccç¼–è¯‘c/c++ç¨‹åºæ—¶ï¼Œç¼–è¯‘æ—¶ç”¨<code>-I</code>æŒ‡å®šå¤´æ–‡ä»¶æŸ¥æ‰¾è·¯å¾„ï¼Œ<code>-L</code>æŒ‡å®šåº“æ–‡ä»¶æŸ¥æ‰¾è·¯å¾„ï¼Œ<code>-l</code>å…·ä½“æŒ‡å®šä¾èµ–çš„åº“ã€‚</p>
<p>å¦‚æœæŒ‡å®šäº†<code>-L</code>ï¼Œä¹Ÿä½¿ç”¨<code>-l</code>é“¾æ¥äº†è¯¥åº“ï¼Œä½†æ˜¯æŠ¥å¦‚ä¸‹å‘Šè­¦ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>warning: libxxx.so, needed by ./libyyy.so, not found <span class="o">(</span>try using -rpath or -rpath-link<span class="o">)</span>
</code></pre></div><p>è¯´æ˜è¯¥soä¾èµ–çš„å…¶ä»–soæ— æ³•æ‰¾åˆ°ã€‚ä½¿ç”¨<code>ldd</code>å‘½ä»¤æŸ¥çœ‹è¯¥soä¾èµ–çš„æ‰€æœ‰å…¶ä»–soï¼Œä¼šæœ‰ç±»ä¼¼äº</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>/usr/bin/ld: cannot find -lxxx
</code></pre></div><p>çš„æ‰“å°ï¼Œè¿™æ—¶å°±éœ€è¦æ‰¾åˆ°è¢«ä¾èµ–çš„soæ‰€åœ¨çš„ç»å¯¹è·¯å¾„ï¼Œæ·»åŠ åˆ°<code>/etc/ld.so.conf</code>æ–‡ä»¶ä¸­ï¼Œå¹¶æ‰§è¡Œ<code>ldconfig</code>ã€‚</p>
<p>å¦ä¸€ç§åŠæ³•æ˜¯å‘ç¯å¢ƒå˜é‡<code>LD_LIBRARY_PATH</code>ä¸­æ·»åŠ è·¯å¾„ï¼ŒæŒ‡å®šåŠ¨æ€åº“åŠ è½½è·¯å¾„ï¼›å¯¹åº”çš„é™æ€åº“åŠ è½½è·¯å¾„çš„ç¯å¢ƒå˜é‡å<code>LIBRARY_PATH</code>ã€‚</p>
<blockquote>
<p>æ³¨æ„: ä½¿ç”¨<code>env</code>å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿä¸­è‹¥æ— ç¯å¢ƒå˜é‡<code>LD_LIBRARY_PATH</code>å’Œ<code>LIBRARY_PATH</code>ï¼Œåˆ™éœ€è¦ä½¿ç”¨<code>export</code>å‘½ä»¤å°†å˜é‡å˜æˆç¯å¢ƒå˜é‡ï¼Œå³è¯¥å˜é‡åœ¨å­shellè¿›ç¨‹ä¸­ä¹Ÿå¯è§ã€‚ä½†é‡æ–°ç™»å½•æ—¶è¯¥ç¯å¢ƒå˜é‡ä¼šæ¶ˆå¤±ã€‚è¦æƒ³ç¯å¢ƒå˜é‡æ¯æ¬¡ç™»å½•éƒ½å­˜åœ¨ï¼Œå¯ä»¥å‘<code>/etc/profile</code>æ–‡ä»¶å°¾ç”¨exportæ·»åŠ ç¯å¢ƒå˜é‡ã€‚è¿™æ˜¯å› ä¸º<strong>æ¯æ¬¡ç™»å½•æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰§è¡Œ/etc/profileè„šæœ¬</strong>ã€‚</p>
</blockquote>
<h2 id="file-format-not-recognized">file format not recognized</h2>
<p>ç¼–è¯‘æ—¶æç¤ºé”™è¯¯å¦‚ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>/usr/bin/ld:./libxxx.so: file format not recognized<span class="p">;</span> treating as linker script
<span class="ln">2</span>/usr/bin/ld:./libxxx.so:2: syntax error
</code></pre></div><p>æ„æ€æ˜¯è¿™ä¸ªsoæ–‡ä»¶æ ¼å¼ä¸è¯†åˆ«ï¼Œldè¯•å›¾å°†å®ƒå½“ä½œé“¾æ¥æ–‡ä»¶æ¥çœ‹å¾…ï¼Œä½†ä»ç„¶å‡ºé”™ã€‚æŸ¥çœ‹å‘ç°è¯¥soæ–‡ä»¶å¤§å°åªæœ‰å‡ å­—èŠ‚ï¼Œä¸”é™„è¿‘æœ‰ä¸€ä¸ªå¸¦åç¼€.1çš„æ–‡ä»¶libxxx.so.1ã€‚<strong>åŸå› æ˜¯è¯¥soæ–‡ä»¶å®é™…æ˜¯ä¸€ä¸ªè½¯é“¾æ¥æ–‡ä»¶ï¼Œé“¾æ¥å¯¹è±¡å°±æ˜¯libxxx.so.1</strong>ï¼›ä½†ç”±äºè¯¥æ¨¡å—æä¾›çš„libå‹ç¼©åŒ…æ˜¯åœ¨windowsä¸‹è§£å‹åé€šè¿‡è¿œç¨‹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°linuxç³»ç»Ÿä¸Šçš„ï¼Œè½¯è¿æ¥æ–‡ä»¶è¢«å½“æˆæ™®é€šæ–‡ä»¶è§£å‹äº†ã€‚è§£å†³åŠæ³•æ˜¯é‡æ–°åˆ›å»ºè½¯è¿æ¥æˆ–ç›´æ¥åœ¨linuxä¸‹è§£å‹ã€‚</p>
<blockquote>
<p>soåé¢å¸¦çš„.1æ˜¯ç‰ˆæœ¬å·ä¸º1çš„æ„æ€ã€‚è¿™æ˜¯linuxä¸‹åŠ¨æ€åº“ç‰ˆæœ¬æ§åˆ¶çš„ä¸€ç§æ–¹æ³•ã€‚å…·ä½“å¯ä»¥çœ‹<a href="https://cvvz.github.io/post/version-control-of-shared-object">åŠ¨æ€é“¾æ¥åº“çš„ç‰ˆæœ¬æ§åˆ¶</a>ä¸€æ–‡ã€‚</p>
</blockquote>
<h2 id="undefined-reference-to">undefined reference to</h2>
<p><code>undefined reference to</code> å³æœªå®šä¹‰çš„å¼•ç”¨ï¼Œè¡¨ç¤ºæŸå‡½æ•°è¢«å£°æ˜äº†ä½†æ˜¯å´æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å®ç°ï¼Œè¿™ç§æƒ…å†µæ˜¯å¯ä»¥ç¼–è¯‘æˆåŠŸçš„ï¼Œä½†æ˜¯é“¾æ¥ä¼šå¤±è´¥ã€‚ç±»ä¼¼çš„è¿˜æœ‰<code>Undeclared references</code>ï¼Œå³æœªå£°æ˜çš„å¼•ç”¨ï¼Œè¡¨ç¤ºæ‰¾ä¸åˆ°å‡½æ•°å£°æ˜ã€‚</p>
<p>å‡ºç°è¿™ç§æƒ…å†µåªèƒ½è€ƒè™‘æ˜¯ç¼–è¯‘æ—¶è¿˜æœ‰å¿…è¦çš„åº“æ²¡æœ‰é“¾æ¥ï¼Œå¯¹åº“æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰çš„åº“æ‰§è¡Œ<code>nm</code>å‘½ä»¤ï¼Œè¿‡æ»¤è¯¥å‡½æ•°åï¼Œæ‰¾åˆ°è¯¥å‡½æ•°å®šä¹‰(<code>Tç±»</code>)æ‰€åœ¨çš„åº“æ–‡ä»¶ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°ç¼–è¯‘é“¾æ¥åº“ä¸­ã€‚</p>
<blockquote>
<p><code>nm</code>ç”¨äºæ‰“å°åº“æˆ–å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ç¬¦å·åï¼š</p>
<ul>
<li>Tç±»ï¼šæ˜¯åœ¨åº“ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œç”¨Tè¡¨ç¤ºï¼›</li>
<li>Uç±»ï¼šæ˜¯åœ¨åº“ä¸­è¢«è°ƒç”¨ï¼Œä½†å¹¶æ²¡æœ‰åœ¨åº“ä¸­å®šä¹‰(è¡¨æ˜éœ€è¦å…¶ä»–åº“æ”¯æŒ)ï¼Œç”¨Uè¡¨ç¤ºï¼›</li>
</ul>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>åŠ¨æ€é“¾æ¥åº“çš„ç‰ˆæœ¬æ§åˆ¶</title>
			<link>https://cvvz.fun/post/version-control-of-shared-object/</link>
			<pubDate>Sat, 20 Oct 2018 21:00:51 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/version-control-of-shared-object/</guid>
			<description>DLL Hell DLL Hellï¼šåŒä¸€å°æœºå™¨ä¸Šï¼Œè¿è¡Œç€Aå’ŒBä¸¤ä¸ªç¨‹åºï¼Œä»–ä»¬ä½¿ç”¨äº†åŒä¸€ä¸ªsoï¼›ç¨‹åºAåœ¨å‡çº§æ—¶ä½¿ç”¨æ–°çš„soç›´æ¥è¦†ç›–è€çš„soï¼Œæ­¤æ—¶å¯èƒ½ä¼šé€ æˆç¨‹åºBæ— </description>
			<content type="html"><![CDATA[<h2 id="dll-hell">DLL Hell</h2>
<p><strong><a href="https://en.wikipedia.org/wiki/DLL_Hell">DLL Hell</a></strong>ï¼šåŒä¸€å°æœºå™¨ä¸Šï¼Œè¿è¡Œç€Aå’ŒBä¸¤ä¸ªç¨‹åºï¼Œä»–ä»¬ä½¿ç”¨äº†åŒä¸€ä¸ªsoï¼›ç¨‹åºAåœ¨å‡çº§æ—¶ä½¿ç”¨æ–°çš„so<strong>ç›´æ¥è¦†ç›–</strong>è€çš„soï¼Œæ­¤æ—¶å¯èƒ½ä¼šé€ æˆç¨‹åºBæ— æ³•æ­£å¸¸è¿è¡Œã€‚</p>
<p>å› æ­¤éœ€è¦å¯¹åŠ¨æ€é“¾æ¥åº“è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚</p>
<h2 id="so-name">so name</h2>
<p>åœ¨ä»‹ç»ç‰ˆæœ¬æ§åˆ¶å‰ï¼Œéœ€è¦å…ˆäº†è§£åŠ¨æ€é“¾æ¥åº“çš„ä¸‰ç§nameï¼š<code>real name</code>ã€<code>soname</code>ã€<code>link name</code>ã€‚</p>
<ul>
<li><strong>link name</strong>ï¼š<code>libxxx.so</code>ç§°ä¸ºåŠ¨æ€é“¾æ¥åº“çš„<code>link name</code>ã€‚</li>
<li><strong>real name</strong>ï¼šå®é™…ç¼–è¯‘å‡ºæ¥çš„åŠ¨æ€é“¾æ¥åº“æ˜¯å…·æœ‰ç‰ˆæœ¬å·åç¼€çš„ï¼Œå¦‚<code>libxxx.so.x.y.z</code>ï¼Œç§°ä¸ºåŠ¨æ€é“¾æ¥åº“çš„<code>real name</code>ã€‚
<blockquote>
<p>å…¶ä¸­<code>x</code>ä»£è¡¨ä¸»ç‰ˆæœ¬å·ï¼Œ<code>y</code>ä»£è¡¨å°ç‰ˆæœ¬å·ï¼Œ<code>z</code>ä»£è¡¨duildå·ã€‚</p>
</blockquote>
</li>
<li><strong>soname</strong>ï¼š<code>link name</code>+<code>ä¸»ç‰ˆæœ¬å·</code>ï¼Œå³<code>libxxx.so.1</code>ã€‚</li>
</ul>
<h2 id="ç¼–è¯‘åŠ¨æ€åº“">ç¼–è¯‘åŠ¨æ€åº“</h2>
<p>ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“æ—¶è¦å¸¦ä¸Šç¼–è¯‘é€‰é¡¹<code>-soname</code>ä»¥æŒ‡å®šsonameã€‚ä¾‹å¦‚ç¼–è¯‘åŠ¨æ€åº“<code>libtest.so.1.0.0</code>æ—¶ï¼Œç¼–è¯‘æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>gcc -fPIC -o test.o -c test.c
<span class="ln">2</span>gcc -shared -Wl,-soname,libtest.so.1 -o libtest.so.1.0.0 test.o
</code></pre></div><p>é€šè¿‡<code>readelf -d</code>æŸ¥çœ‹åŠ¨æ€æ®µï¼Œå¯ä»¥å‘ç°<code>soname</code>ä¿¡æ¯è¢«è®°å½•åˆ°äº†<code>libtest.so.1.0.0</code>çš„æ–‡ä»¶å¤´ä¸­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>readelf -d libtest.so.1.0.0 <span class="p">|</span> grep soname
<span class="ln">2</span> 0x0000000e <span class="o">(</span>SONAME<span class="o">)</span> Library soname: <span class="o">[</span>libtest.so.1<span class="o">]</span>
</code></pre></div><p><strong>æ­¤æ—¶æ‰§è¡Œ<code>ldconfig</code>å‘½ä»¤å°†è‡ªåŠ¨ç”Ÿæˆ<code>libtest.so.1</code>æ–‡ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘<code>libtest.so.1.0.0</code>çš„è½¯è¿æ¥</strong>ã€‚</p>
<p>ä¸éš¾æƒ³åˆ°ï¼š</p>
<ul>
<li>å¦‚æœä¸»ç‰ˆæœ¬å‘ç”Ÿå˜åŒ–ï¼Œæ–°è€ç‰ˆæœ¬çš„sonameä¼šå‘ç”Ÿå˜åŒ–ã€‚</li>
<li>å¦‚æœå°ç‰ˆæœ¬å‘ç”Ÿå˜åŒ–ï¼Œæ–°è€ç‰ˆæœ¬çš„sonameåº”è¯¥ä¿æŒä¸å˜ã€‚</li>
</ul>
<h2 id="ç¼–è¯‘ç¨‹åº">ç¼–è¯‘ç¨‹åº</h2>
<p>ä»¥ä½¿ç”¨ä¸Šé¢ç¼–è¯‘å¥½çš„<code>libtest.so.1.0.0</code>åŠ¨æ€åº“çš„ç¨‹åºä¸ºä¾‹ï¼Œç¼–è¯‘çš„æ ‡å‡†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªæŒ‡å‘real nameæ–‡ä»¶çš„link nameæ–‡ä»¶ï¼Œå³ <code>ln -s libtest.so.1.0.0 libtest.so</code></li>
<li>ç¼–è¯‘ç¨‹åºï¼Œé€šè¿‡æŒ‡å®š<code>-ltest</code>ï¼Œç¼–è¯‘å™¨ä¼šå»æŸ¥æ‰¾<code>libtest.so</code>æ–‡ä»¶ï¼Œä½†å®é™…å‚ä¸ç¼–è¯‘çš„æ˜¯<code>libtest.so.1.0.0</code>æ–‡ä»¶</li>
<li>ç¼–è¯‘å™¨å‘ç°<code>libtest.so.1.0.0</code>ä¸­è®°å½•ç€soname <code>libtest.so.1</code>ï¼Œå‘Šè¯‰ç¨‹åºåœ¨è¿è¡Œæ—¶åº”è¯¥å¼•ç”¨<code>libtest.so.1</code></li>
<li>è€Œ<code>libtest.so.1</code>æ–‡ä»¶ï¼Œåˆ™æ˜¯é€šè¿‡æ‰§è¡Œ<code>ldconfig</code>å‘½ä»¤ç”Ÿæˆå‡ºæ¥çš„æŒ‡å‘<code>libtest.so.1.0.0</code>çš„è½¯é“¾æ¥ï¼Œæ‰€ä»¥ç¨‹åºå®é™…è¿è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ˜¯<code>libtest.so.1.0.0</code></li>
</ol>
<h2 id="å‡çº§åŠ¨æ€åº“">å‡çº§åŠ¨æ€åº“</h2>
<ol>
<li>å°ç‰ˆæœ¬å‡çº§ï¼Œæ¯”å¦‚ä»<code>libtest.so.1.0.0</code>å‡çº§ä¸º<code>libtest.so.1.1.1</code>ã€‚è¿™ä¸ªæ—¶å€™ï¼ŒæŒ‰ç…§çº¦å®šå®ƒçš„soname<code>libtest.so.1</code>æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥ä½¿ç”¨è€…å¯ä»¥ç›´æ¥æŠŠæ–°ç‰ˆæœ¬soä¸¢åˆ°æœºå™¨ä¸Šï¼Œæ‰§è¡Œ<code>ldconfig</code>ï¼Œæ–°ç”Ÿæˆçš„<code>libtest.so.1</code>å°±å˜æˆäº†æŒ‡å‘<code>libtest.so.1.1.1</code>çš„è½¯è¿æ¥ã€‚å°ç‰ˆæœ¬å‡çº§æ˜¯åå‘å…¼å®¹çš„ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿›è¡Œå‡çº§æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</li>
<li>ä¸»ç‰ˆæœ¬å‡çº§ï¼Œæ¯”å¦‚ä»<code>libtest.so.1.1.1</code>å‡çº§ä¸º<code>libtest.so.2.0.0</code>ã€‚è¿™ä¸ªæ—¶å€™ï¼ŒæŒ‰ç…§çº¦å®šå®ƒçš„sonameå˜æˆäº†<code>libtest.so.2</code>ï¼Œæ­¤æ—¶<code>ldconfig</code>ç”Ÿæˆçš„è½¯è¿æ¥ä¸º<code>libtest.so.2</code>ï¼ŒæŒ‡å‘<code>libtest.so.2.0.0</code>ã€‚ä¸€èˆ¬ä¸»ç‰ˆæœ¬å‡çº§ä¼šæœ‰åå‘å…¼å®¹æ€§é—®é¢˜ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨äº†æ–°çš„sonameï¼Œå› æ­¤å¯¹ä½¿ç”¨è€ç‰ˆæœ¬soçš„ç¨‹åºæ²¡æœ‰å½±å“ã€‚</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>å…³äºè¿›ç¨‹å’Œçº¿ç¨‹çš„ä¸€äº›æ€è€ƒ</title>
			<link>https://cvvz.fun/post/process-and-thread/</link>
			<pubDate>Sat, 23 Jun 2018 20:34:56 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/process-and-thread/</guid>
			<description>ä»â€œç¨‹åºâ€å¼€å§‹ å¯¹äºUNIXæ“ä½œç³»ç»Ÿï¼Œç¨‹åºæ˜¯å­˜æ”¾åœ¨ç£ç›˜ä¸Šçš„ELFæ–‡ä»¶ï¼ˆå¯ä»¥é€šè¿‡fileå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶ç±»å‹ï¼‰ å¯¹äºwindowsæ“ä½œç³»ç»Ÿï¼Œç¨‹åºæ˜¯å­˜æ”¾</description>
			<content type="html"><![CDATA[<h2 id="ä»ç¨‹åºå¼€å§‹">ä»â€œç¨‹åºâ€å¼€å§‹</h2>
<ul>
<li>å¯¹äºUNIXæ“ä½œç³»ç»Ÿï¼Œç¨‹åºæ˜¯å­˜æ”¾åœ¨ç£ç›˜ä¸Šçš„<strong>ELFæ–‡ä»¶</strong>ï¼ˆå¯ä»¥é€šè¿‡<code>file</code>å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶ç±»å‹ï¼‰</li>
<li>å¯¹äºwindowsæ“ä½œç³»ç»Ÿï¼Œç¨‹åºæ˜¯å­˜æ”¾åœ¨ç£ç›˜ä¸Šçš„<strong>PEæ–‡ä»¶</strong>ï¼Œå…¶ä¸­æœ€å¸¸è§çš„æ˜¯<code>.exe</code>æ–‡ä»¶ã€‚</li>
</ul>
<p>ç¼–è¯‘å™¨å°†é«˜çº§è¯­è¨€ç¼–å†™æˆçš„ç¨‹åºç¼–è¯‘æˆæœºå™¨ç ï¼Œæ“ä½œç³»ç»Ÿå°†ELFæ–‡ä»¶è¯»å…¥å†…å­˜åï¼ŒELFæ–‡ä»¶ä¸­çš„<strong>ä»£ç æ®µ</strong>ä¹Ÿå°±æ˜¯CPUå¯ä»¥æ‰§è¡Œçš„æœºå™¨ç ï¼ˆå¯ä»¥é€šè¿‡<code>readelf</code>å‘½ä»¤æŸ¥çœ‹ELFæ–‡ä»¶çš„ä»£ç æ®µå†…å®¹ï¼‰ï¼ŒCPUä»å†…å­˜ä¸­è¯»å–æœºå™¨ç å¹¶æ‰§è¡Œã€‚</p>
<h2 id="ä¸ºè¿›ç¨‹åˆ†é…èµ„æº">ä¸ºè¿›ç¨‹åˆ†é…èµ„æº</h2>
<p>è¿›ç¨‹äº§ç”Ÿçš„æ ‡å¿—æ˜¯ï¼šå†…æ ¸ä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½åˆ†é…äº†ä¸€ä¸ª<code>task_struct</code>ç»“æ„ä½“ï¼Œåœ¨<code>task_struct</code>ä¸­è®°å½•äº†è¿™ä¸ªè¿›ç¨‹æ‰€æ‹¥æœ‰çš„èµ„æºï¼Œå¦‚å…¨å±€å˜é‡ã€è™šæ‹Ÿå†…å­˜ç­‰ï¼Œæ‰€ä»¥è¯´<strong>è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½</strong>ã€‚</p>
<h2 id="è°ƒåº¦çº¿ç¨‹">è°ƒåº¦çº¿ç¨‹</h2>
<p><strong>çº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>å†…æ ¸è¿›è¡Œè°ƒåº¦çš„å¯¹è±¡å®é™…ä¸Šæ˜¯çº¿ç¨‹ï¼Œè€Œè¿›ç¨‹æ˜¯è´Ÿè´£ä¸ºçº¿ç¨‹æä¾›å…±äº«èµ„æºçš„</strong>ã€‚</p>
<p>ä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿™ä¸ªè¿›ç¨‹çš„èµ„æºï¼Œä½†æ˜¯<strong>å®ƒä»¬è™½ç„¶å…±äº«åŒä¸€ç‰‡è™šæ‹Ÿå†…å­˜ï¼Œè‡ªèº«å´æ‹¥æœ‰è¿™ç‰‡è™šæ‹Ÿå†…å­˜ä¸­çš„ä¸åŒçš„æ ˆç©ºé—´</strong>ï¼›</p>
<h2 id="é€šä¿¡æ–¹å¼">é€šä¿¡æ–¹å¼</h2>
<p>ç”±äºåŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹å…±äº«èµ„æºï¼Œæ‰€ä»¥é€šä¿¡éå¸¸æ–¹ä¾¿ï¼Œç›´æ¥è¯»å†™åŒä¸€å—ç”¨æˆ·æ€å†…å­˜å³å¯ï¼Œä½†æ˜¯è¿™å¿…ç„¶å°±æ¶‰åŠåˆ°äº’æ–¥å’ŒåŸå­æ€§é—®é¢˜ã€‚</p>
<p>è€Œè¿›ç¨‹è¦å®ç°é€šä¿¡åˆ™éœ€è¦å€ŸåŠ©å†…æ ¸å’Œæ–‡ä»¶ï¼Œæ‰€æœ‰çš„IPCï¼Œéƒ½æ˜¯æŠŠå†…æ ¸å’Œæ–‡ä»¶å……å½“äº¤æ¢ä¿¡æ¯çš„æ¡¥æ¢ã€‚</p>
<h2 id="ä¸Šä¸‹æ–‡åˆ‡æ¢">ä¸Šä¸‹æ–‡åˆ‡æ¢</h2>
<p>cpuè°ƒåº¦åŸºæœ¬çš„å•ä½æ˜¯çº¿ç¨‹ï¼Œæ‰€ä»¥åœ¨è¿è¡Œä¸åŒçš„çº¿ç¨‹æ—¶ï¼Œä¼šå¯¼è‡´<strong>cpuä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ï¼Œå³CPUå¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨çš„ä¿å­˜å’Œæ›´æ–°ã€‚è€Œæ ¹æ®è¢«è°ƒåº¦çš„çº¿ç¨‹æ˜¯åŒä¸€ä¸ªè¿›ç¨‹é‡Œçš„è¿˜æ˜¯ä¸åŒè¿›ç¨‹é‡Œçš„ï¼Œåˆåˆ†ä¸º<strong>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>å’Œ<strong>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ã€‚</p>
<p>CPUä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯éœ€è¦CPUè¿è¡Œå†…æ ¸ä»£ç çš„ï¼Œæ‰€ä»¥è¿‡å¤šçš„cpuä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šå¯¼è‡´cpuå°†å¤§é‡çš„æ—¶é—´éƒ½ç”¨æ¥è¿è¡Œå†…æ ¸ä»£ç ï¼Œå¯¼è‡´çœŸæ­£çš„ç»™ç”¨æˆ·æ€çº¿ç¨‹è¿è¡Œçš„æ—¶é—´å˜å°‘ã€‚æ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬ä¼šæ ¹æ®æœºå™¨çš„æ ¸æ•°æ¥å†³å®šè¿›ç¨‹çš„çº¿ç¨‹æ•°é‡æˆ–è€…å­è¿›ç¨‹æ•°é‡ï¼Œé¿å…è¿›è¡Œé¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>ç”±äºçº¿ç¨‹å…±äº«è¿›ç¨‹ä¸­çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼Œ<strong>ä¸éœ€è¦æ›´æ–°è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„å†…å­˜æ˜ å°„è¡¨</strong>ã€‚è€Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼Œç”±äºä¸åŒè¿›ç¨‹è™šæ‹Ÿå†…å­˜çš„æ”¹å˜ï¼Œåˆ™è¦æ›´æ–°è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„å†…å­˜æ˜ å°„è¡¨ã€‚å½“å†…æ ¸æ‰¾ä¸åˆ°è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»æ—¶ï¼Œä¾¿ä¼šäº§ç”Ÿ<code>ç¼ºé¡µä¸­æ–­</code>ã€‚æ‰€ä»¥<strong>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢åï¼Œç¨‹åºæ‰§è¡Œæ›´å®¹æ˜“äº§ç”Ÿç¼ºé¡µä¸­æ–­</strong>ï¼Œè¿™ä¹Ÿå°±æ˜¯è¿›ç¨‹åˆ‡æ¢æ¯”çº¿ç¨‹åˆ‡æ¢å¯¹æ€§èƒ½å½±å“æ›´å¤§çš„åŸå› ã€‚</p>
<h2 id="æ€ä¹ˆç†è§£linuxä¸­çš„çº¿ç¨‹æ˜¯ä»¥è¿›ç¨‹çš„æ–¹å¼å®ç°çš„">æ€ä¹ˆç†è§£Linuxä¸­çš„çº¿ç¨‹æ˜¯ä»¥è¿›ç¨‹çš„æ–¹å¼å®ç°çš„</h2>
<ul>
<li>å¯¹äºæ”¯æŒçº¿ç¨‹çš„æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹ä¸­æœ‰Nä¸ªçº¿ç¨‹ï¼Œåˆ™å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹æè¿°ç¬¦ï¼Œä¾æ¬¡è½®æµæŒ‡å‘Nä¸ªçº¿ç¨‹ã€‚è¿™ä¸ªè¿›ç¨‹æè¿°ç¬¦æŒ‡æ˜å…±äº«èµ„æºï¼ŒåŒ…æ‹¬å†…å­˜ç©ºé—´å’Œæ‰“å¼€çš„æ–‡ä»¶ã€‚è€Œæ¯ä¸€ä¸ªçº¿ç¨‹æè¿°å®ƒä»¬è‡ªå·±ç‹¬äº«çš„èµ„æºã€‚ä¹Ÿå°±æ˜¯è¯´<strong>å†…æ ¸ä¸­æè¿°çº¿ç¨‹çš„ç»“æ„ä½“å’Œæè¿°è¿›ç¨‹çš„ç»“æ„ä½“ä¸åŒ</strong>ã€‚</li>
<li>è€Œåœ¨Linuxä¸­ï¼Œåˆ™æœ‰Nä¸ª<code>task_struct</code>æ•°æ®ç»“æ„ï¼Œåªæ˜¯è¿™äº›æ•°æ®ç»“æ„çš„æŸäº›èµ„æºé¡¹æ˜¯å…±äº«çš„ï¼ˆæŒ‡å‘åŒä¸€ç‰‡å†…å­˜ï¼‰ï¼ŒæŸäº›æ˜¯ç‹¬å çš„ã€‚</li>
</ul>
<figure>
    <img src="/%e4%b8%8a%e4%b8%8b%e6%96%87%e5%88%87%e6%8d%a2.png" width="1000px"/> 
</figure>

]]></content>
		</item>
		
		<item>
			<title>Gitç¬”è®°</title>
			<link>https://cvvz.fun/post/usage-of-git/</link>
			<pubDate>Sat, 02 Jun 2018 23:41:24 +0800</pubDate>
			
			<guid>https://cvvz.fun/post/usage-of-git/</guid>
			<description>æ•´ç†ä¸€ä¸‹æœ€è¿‘å­¦ä¹ çš„gitçŸ¥è¯†ï¼Œä»¥åŠå¹³æ—¶å¸¸ç”¨çš„gitåŠŸèƒ½ã€‚ .git ä½¿ç”¨git initæˆ–cloneä¸€ä¸ªè¿œç«¯ä»“ï¼Œä¼šåœ¨æœ¬åœ°å»ºç«‹ä¸€ä¸ª.gitç›®å½•ã€‚è¿™ä¸ªç›®å½•æ˜¯</description>
			<content type="html"><![CDATA[<blockquote>
<p>æ•´ç†ä¸€ä¸‹æœ€è¿‘å­¦ä¹ çš„gitçŸ¥è¯†ï¼Œä»¥åŠå¹³æ—¶å¸¸ç”¨çš„gitåŠŸèƒ½ã€‚</p>
</blockquote>
<h2 id="git">.git</h2>
<p>ä½¿ç”¨git initæˆ–cloneä¸€ä¸ªè¿œç«¯ä»“ï¼Œä¼šåœ¨æœ¬åœ°å»ºç«‹ä¸€ä¸ª.gitç›®å½•ã€‚<strong>è¿™ä¸ªç›®å½•æ˜¯gitä»“çš„å…¨éƒ¨ï¼ŒæŠŠ.gitæ‹·è´åˆ°å…¶ä»–ç›®å½•ä¸‹ï¼Œå°±èƒ½åœ¨è¯¥ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„gitä»“</strong>ã€‚</p>
<h2 id="ç¼“å­˜åŒºstaged">ç¼“å­˜åŒºï¼ˆstagedï¼‰</h2>
<ul>
<li>å¯¹working derictoyä¸­çš„æ–‡ä»¶åšçš„æ”¹åŠ¨ï¼Œä»–ä»¬çš„çŠ¶æ€æ˜¯unstaged</li>
<li>ä½¿ç”¨ <code>git add</code>/<code>git rm</code>/<code>git mv</code> å°†å…¶é€å…¥ç¼“å­˜åŒºï¼ˆstagedï¼‰</li>
<li>ä½¿ç”¨ <code>git commit</code> æäº¤ç¼“å­˜åŒºä¸­è®°å½•çš„æ”¹åŠ¨ã€‚</li>
<li><code>git diff {filename}</code> å¯ä»¥æŸ¥çœ‹unstagedå’Œstagedä¸­æ–‡ä»¶çš„ä¸åŒ</li>
<li><code>git diff --staged {filename}</code> å¯ä»¥æŸ¥çœ‹stagedä¸­çš„æ–‡ä»¶å’ŒåŸæ–‡ä»¶çš„ä¸åŒ</li>
<li>æ³¨æ„stagedå’Œ<code>stash</code>çš„åŒºåˆ«</li>
</ul>
<h2 id="ä¸Šæ¸¸åˆ†æ”¯">ä¸Šæ¸¸åˆ†æ”¯</h2>
<p><code>git clone</code>å¯ä»¥é€šè¿‡å‚æ•° <code>-b</code> æ¥æŒ‡å®šcloneè¿œç«¯ä»“åº“åˆ°æœ¬åœ°åæ‹‰å–å“ªæ¡åˆ†æ”¯ï¼Œä¸æŒ‡å®šåˆ™é»˜è®¤æ‹‰å–<code>master</code>ï¼›è¿œç«¯ä»“åº“ä¸­å¿…é¡»å­˜åœ¨åŒååˆ†æ”¯ï¼Œä½œä¸ºæœ¬åœ°åˆ†æ”¯çš„ä¸Šæ¸¸åˆ†æ”¯ã€‚</p>
<p>é€šè¿‡<code>git branch -vv</code> æˆ– <code>git status</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯ç›¸æ¯”ä¸Šæ¸¸åˆ†æ”¯é¢†å…ˆ/è½åå¤šå°‘ä¸ªcommitã€‚</p>
<p><code>git checkout -b {local_branch} {remote_branch}</code>ç”¨æ¥åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯ï¼Œå¹¶æŒ‡å®šè¯¥åˆ†æ”¯çš„ä¸Šæ¸¸åˆ†æ”¯ã€‚</p>
<h2 id="revertå’Œreset">revertå’Œreset</h2>
<p><code>git reset</code>æŠŠHEADæŒ‡é’ˆæŒ‡å‘åˆ°æŸä¸€ä¸ªcommit idï¼Œè¿™æ¬¡commitä¹‹åçš„æ‰€æœ‰commitéƒ½ä¼šè¢«åˆ é™¤ã€‚</p>
<p><code>git revert</code>ç”¨æ¥æ’¤é”€æŸä¸€æ¬¡commitå¸¦æ¥çš„å˜åŒ–ï¼Œä¸ä¼šå½±å“å…¶ä»–commitã€‚revertæœ¬èº«ä¹Ÿéœ€è¦commitã€‚</p>
<p>éfast-forwardå½¢å¼åˆå¹¶ä¸¤æ¡åˆ†æ”¯æ—¶ï¼Œgitä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåˆå¹¶æäº¤ã€‚å¦‚æœæƒ³å›é€€æŸæ¡åˆ†æ”¯çš„mergeæ“ä½œï¼Œå¯ä»¥revertè¿™æ¬¡åˆå¹¶æäº¤çš„commitï¼Œgitä¼šè®©ä½ é€‰æ‹©ç•™ä¸‹è¿™æ¬¡åˆå¹¶æäº¤çš„å“ªä¸€ä¸ªçˆ¶åˆ†æ”¯ï¼Œå¦ä¸€ä¸ªçˆ¶åˆ†æ”¯æ‰€ä½œçš„æ”¹åŠ¨ä¼šè¢«å›é€€ã€‚</p>
<h2 id="å¦‚ä½•ä¿®æ”¹ä¸€æ¬¡å†å²commit">å¦‚ä½•ä¿®æ”¹ä¸€æ¬¡å†å²commit</h2>
<p>æ‰§è¡Œ<code>git rebase -i {commitid}^</code>ï¼ˆcommitidæ˜¯æƒ³è¦ä¿®æ”¹çš„é‚£æ¬¡æäº¤ï¼‰ï¼Œgitä¼šä»¥commitidçš„å‰ä¸€æ¬¡æäº¤ä½œä¸ºbaseï¼Œé‡‡ç”¨äº¤äº’å¼çš„æ–¹å¼ï¼Œé‡æ–°æäº¤åé¢çš„æ¯ä¸€æ¬¡commitï¼Œå°†æƒ³è¦ä¿®æ”¹çš„é‚£ä¸€æ¬¡çš„æäº¤å‘½ä»¤è®¾ç½®ä¸ºeditå³å¯ã€‚</p>
]]></content>
		</item>
		
	</channel>
</rss>
