<!DOCTYPE html>
<html lang="zh-hans">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="google-site-verification" content="Wp3QtEkIlF0ZvtKx90lPmoXyH39d-pmBhiTyTbba9L4" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta itemprop="name" content="为什么删除Pod时webhook收到三次delete请求">
<meta itemprop="description" content="最近在玩admission webhook时，发现一个奇怪的现象：我配置了validatingWebhookConfiguration使其监听">
<meta itemprop="datePublished" content="2020-12-13T19:26:15+08:00" />
<meta itemprop="dateModified" content="2021-12-22T11:39:56+08:00" />
<meta itemprop="wordCount" content="3955">



<meta itemprop="keywords" content="kubernetes," />
<meta property="og:title" content="为什么删除Pod时webhook收到三次delete请求" />
<meta property="og:description" content="最近在玩admission webhook时，发现一个奇怪的现象：我配置了validatingWebhookConfiguration使其监听" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cvvz.github.io/post/k8s-3-deletion-webhook/" />
<meta property="article:published_time" content="2020-12-13T19:26:15+08:00" />
<meta property="article:modified_time" content="2021-12-22T11:39:56+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="为什么删除Pod时webhook收到三次delete请求"/>
<meta name="twitter:description" content="最近在玩admission webhook时，发现一个奇怪的现象：我配置了validatingWebhookConfiguration使其监听"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>为什么删除Pod时webhook收到三次delete请求</title>
	<link rel="stylesheet" href="https://cvvz.github.io/css/style.min.7a1ec200e9f3394f73c6eda58011808507a3b24318de81e1e343f22a2470caef.css">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://cvvz.github.io">cvvz&#39;s Blog</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://cvvz.github.io/post/">技术</a>
					<a href="https://cvvz.github.io/read/">读书</a>
					<a href="https://cvvz.github.io/thinking/">想法</a>
					<a href="https://cvvz.github.io/running/">跑步</a>
					<a href="https://cvvz.github.io/aboutme/resume.pdf">关于</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="目录"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://github.com/cvvz" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="mailto:ftdchenwz@gmail.com" target="_blank" rel="noopener me" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a></span><button id="menu-btn" class="hdr-btn" title="菜单"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://cvvz.github.io/post/">技术</a></li>
			<li><a href="https://cvvz.github.io/read/">读书</a></li>
			<li><a href="https://cvvz.github.io/thinking/">想法</a></li>
			<li><a href="https://cvvz.github.io/running/">跑步</a></li>
			<li><a href="https://cvvz.github.io/aboutme/resume.pdf">关于</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<h1>为什么删除Pod时webhook收到三次delete请求</h1>
			</header>
			<div class="content">
				<p>最近在玩admission webhook时，发现一个奇怪的现象：我配置了validatingWebhookConfiguration使其监听pod的删除操作，结果发现每次删除Pod的时候，webhook会收到三次delete请求：</p>
<figure>
    <img src="/3-delete.png" width="1000px"/> 
</figure>

<p>从日志打印上可以分析出，第一次删除请求来自于kubectl客户端，后面两次来自于pod所在的node节点。为什么会收到三次delete请求呢？</p>
<h2 id="删除一个pod的过程">删除一个Pod的过程<a href="#删除一个pod的过程" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>通过阅读kube-apiserver和kubelet源码，我把一个pod的删除过程总结成如下这幅流程图，三个红色加粗的请求即为webhook收到的三次delete请求。
<figure>
    <img src="/delete-pod.drawio.svg" width="800px"/> 
</figure>
</p>
<h3 id="kube-apiserver处理第一次删除请求">kube-apiserver处理第一次删除请求<a href="#kube-apiserver处理第一次删除请求" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>首先，由kubectl发来的delete请求，会经过kube-apiserver的admission-controller进行准入校验。我们定义了admission webhook，所以kube-apiserver会将该请求相关的信息封装在<strong>AdmissionReview</strong>结构体中发送给webhook。这是第一次webhook收到delete请求。</p>
<p>kube-apiserver作为一个http服务器，它的handler在<code>staging/src/k8s.io/apiserver/pkg/endpoints/installer.go</code>文件中的<code>registerResourceHandlers</code>函数中定义。其中<code>DELETE</code>请求的handler是<code>restfulDeleteResource</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="k">case</span> <span class="s">&#34;DELETE&#34;</span><span class="p">:</span> <span class="c1">// Delete a resource.
</span><span class="ln">2</span><span class="c1"></span>    <span class="c1">// ...
</span><span class="ln">3</span><span class="c1"></span>
<span class="ln">4</span>    <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">metrics</span><span class="p">.</span><span class="nf">InstrumentRouteFunc</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">Verb</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">subresource</span><span class="p">,</span> <span class="nx">requestScope</span><span class="p">,</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">APIServerComponent</span><span class="p">,</span> <span class="nx">deprecated</span><span class="p">,</span> <span class="nx">removedRelease</span><span class="p">,</span> <span class="nf">restfulDeleteResource</span><span class="p">(</span><span class="nx">gracefulDeleter</span><span class="p">,</span> <span class="nx">isGracefulDeleter</span><span class="p">,</span> <span class="nx">reqScope</span><span class="p">,</span> <span class="nx">admit</span><span class="p">))</span>
<span class="ln">5</span>
<span class="ln">6</span>    <span class="o">...</span>
</code></pre></div><p><code>restfulDeleteResource</code>调用<code>DeleteResource</code>，后者则调用<code>staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go</code>文件中的<code>Delete</code>方法对对象进行删除</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="kd">func</span> <span class="nf">restfulDeleteResource</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">GracefulDeleter</span><span class="p">,</span> <span class="nx">allowsOptions</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">scope</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admit</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">restful</span><span class="p">.</span><span class="nx">RouteFunction</span> <span class="p">{</span>
<span class="ln">2</span>	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>		<span class="nx">handlers</span><span class="p">.</span><span class="nf">DeleteResource</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">allowsOptions</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">admit</span><span class="p">)(</span><span class="nx">res</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
<span class="ln">4</span>	<span class="p">}</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="nf">DeleteResource</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">GracefulDeleter</span><span class="p">,</span> <span class="nx">allowsOptions</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">scope</span> <span class="o">*</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admit</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="c1">//...
</span><span class="ln"> 3</span><span class="c1"></span>
<span class="ln"> 4</span>    <span class="nx">trace</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">&#34;About to delete object from database&#34;</span><span class="p">)</span>
<span class="ln"> 5</span>		<span class="nx">wasDeleted</span> <span class="o">:=</span> <span class="kc">true</span>
<span class="ln"> 6</span>		<span class="nx">userInfo</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">UserFrom</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="ln"> 7</span>		<span class="nx">staticAdmissionAttrs</span> <span class="o">:=</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">NewAttributesRecord</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Resource</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Subresource</span><span class="p">,</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Delete</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">dryrun</span><span class="p">.</span><span class="nf">IsDryRun</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">DryRun</span><span class="p">),</span> <span class="nx">userInfo</span><span class="p">)</span>
<span class="ln"> 8</span>		<span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">finishRequest</span><span class="p">(</span><span class="nx">timeout</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>			<span class="nx">obj</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">AdmissionToValidateObjectDeleteFunc</span><span class="p">(</span><span class="nx">admit</span><span class="p">,</span> <span class="nx">staticAdmissionAttrs</span><span class="p">,</span> <span class="nx">scope</span><span class="p">),</span> <span class="nx">options</span><span class="p">)</span>
<span class="ln">10</span>			<span class="nx">wasDeleted</span> <span class="p">=</span> <span class="nx">deleted</span>
<span class="ln">11</span>			<span class="k">return</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">12</span>		<span class="p">})</span>
<span class="ln">13</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">14</span>			<span class="nx">scope</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="ln">15</span>			<span class="k">return</span>
<span class="ln">16</span>		<span class="p">}</span>
<span class="ln">17</span>        <span class="nx">trace</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">&#34;Object deleted from database&#34;</span><span class="p">)</span>
<span class="ln">18</span>        
<span class="ln">19</span>        <span class="o">...</span>
<span class="ln">20</span><span class="p">}</span>
</code></pre></div><p><code>Delete</code>方法中，在<code>BeforeDelete</code>函数中判断是否需要优雅删除，判断的标准是<code>DeletionGracePeriodSeconds</code>值是否为0，不为零则认为是优雅删除，kube-apiserver不会立即将这个API对象从etcd中删除，否则直接删除。</p>
<p>对于Pod而言，默认<code>DeletionGracePeriodSeconds</code>为30秒，因此这里不会被kube-apiserver立刻删除掉。而是将<code>DeletionTimestamp</code>设置为当前时间，<code>DeletionGracePeriodSeconds</code>设置为默认值30秒。</p>
<h3 id="kubelet杀掉容器">kubelet杀掉容器<a href="#kubelet杀掉容器" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>kube-apiserver设置好<code>DeletionTimestamp</code>和<code>DeletionGracePeriodSeconds</code>这两个字段后，kubelet 会watch到Pod的更新。那kubelet list-watch机制又是怎么实现的呢？</p>
<p>Kubelet在<code>makePodSourceConfig</code>函数中，监听了三种类型的Pod：通过<a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/static-pod/#configuration-files">文件系统上的配置文件</a>配置的静态Pod，通过<a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/static-pod/#pods-created-via-http">web 网络上的配置文件</a>配置的静态Pod，以及kube-apiserver中的pod。我们主要关心第三种。</p>
<p>Kubelet通过reflactor watch到Pod资源发生变化后，是通过channel的方式将Pod及其变化传递给syncLoop主控制循环中进行处理的，<strong>并没有使用informer+workqueque的方式</strong>。</p>
<p>kubelet的主控制循环在<code>pkg/kubelet/kubelet.go</code>文件中的<code>syncLoopIteration</code>函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">syncLoopIteration</span><span class="p">(</span><span class="nx">configCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">PodUpdate</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">SyncHandler</span><span class="p">,</span>
<span class="ln"> 2</span>	<span class="nx">syncCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">housekeepingCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">plegCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">pleg</span><span class="p">.</span><span class="nx">PodLifecycleEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
<span class="ln"> 3</span>	<span class="k">select</span> <span class="p">{</span>
<span class="ln"> 4</span>	<span class="k">case</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">open</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">configCh</span><span class="p">:</span>
<span class="ln"> 5</span>		<span class="c1">// Update from a config source; dispatch it to the right handler
</span><span class="ln"> 6</span><span class="c1"></span>		<span class="c1">// callback.
</span><span class="ln"> 7</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">open</span> <span class="p">{</span>
<span class="ln"> 8</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Update channel is closed. Exiting the sync loop.&#34;</span><span class="p">)</span>
<span class="ln"> 9</span>			<span class="k">return</span> <span class="kc">false</span>
<span class="ln">10</span>		<span class="p">}</span>
<span class="ln">11</span>
<span class="ln">12</span>		<span class="k">switch</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Op</span> <span class="p">{</span>
<span class="ln">13</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">:</span>
<span class="ln">14</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (ADD, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">15</span>			<span class="c1">// After restarting, kubelet will get all existing pods through
</span><span class="ln">16</span><span class="c1"></span>			<span class="c1">// ADD as if they are new pods. These pods will then go through the
</span><span class="ln">17</span><span class="c1"></span>			<span class="c1">// admission process and *may* be rejected. This can be resolved
</span><span class="ln">18</span><span class="c1"></span>			<span class="c1">// once we have checkpointing.
</span><span class="ln">19</span><span class="c1"></span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodAdditions</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">20</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">UPDATE</span><span class="p">:</span>
<span class="ln">21</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (UPDATE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">PodsWithDeletionTimestamps</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">22</span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodUpdates</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">23</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">REMOVE</span><span class="p">:</span>
<span class="ln">24</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (REMOVE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">25</span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodRemoves</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">26</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">RECONCILE</span><span class="p">:</span>
<span class="ln">27</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (RECONCILE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">28</span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodReconcile</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">29</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">:</span>
<span class="ln">30</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (DELETE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">31</span>			<span class="c1">// DELETE is treated as a UPDATE because of graceful deletion.
</span><span class="ln">32</span><span class="c1"></span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodUpdates</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">33</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">RESTORE</span><span class="p">:</span>
<span class="ln">34</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (RESTORE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">35</span>			<span class="c1">// These are pods restored from the checkpoint. Treat them as new
</span><span class="ln">36</span><span class="c1"></span>			<span class="c1">// pods.
</span><span class="ln">37</span><span class="c1"></span>			<span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodAdditions</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">38</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">:</span>
<span class="ln">39</span>			<span class="c1">// TODO: Do we want to support this?
</span><span class="ln">40</span><span class="c1"></span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Kubelet does not support snapshot update&#34;</span><span class="p">)</span>
<span class="ln">41</span>        <span class="p">}</span>
<span class="ln">42</span>
<span class="ln">43</span>        <span class="o">...</span>
</code></pre></div><p>当Pod的<code>DeletionTimestamp</code>被设置时，Kubelet会走入<code>kubetypes.DELETE</code>这个分支，最终会调用到<code>pkg/kubelet/kubelet.go</code>中的<code>syncPod</code>函数，<strong><code>syncPod</code> 这个函数是 kubelet 核心处理函数</strong>。这个函数会调用到容器运行时的<code>KillPod</code>方法，该方法进而又会以goroutine的方式，使用<code>pkg/kubelet/kuberuntime/kuberuntime_container.go</code>中定义的<code>killContainer</code>方法<strong>并行的杀掉</strong>所有容器。<code>killContainer</code>的代码实现如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">killContainer</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">containerID</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span> <span class="nx">containerName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln"> 2</span>	<span class="o">...</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span>	<span class="c1">// From this point, pod and container must be non-nil.
</span><span class="ln"> 5</span><span class="c1"></span>	<span class="nx">gracePeriod</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">minimumGracePeriodInSeconds</span><span class="p">)</span>
<span class="ln"> 6</span>	<span class="k">switch</span> <span class="p">{</span>
<span class="ln"> 7</span>	<span class="k">case</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
<span class="ln"> 8</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span>
<span class="ln"> 9</span>	<span class="k">case</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
<span class="ln">10</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span>
<span class="ln">11</span>	<span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
<span class="ln">14</span>		<span class="nx">message</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Stopping container %s&#34;</span><span class="p">,</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="ln">15</span>	<span class="p">}</span>
<span class="ln">16</span>	<span class="nx">m</span><span class="p">.</span><span class="nf">recordContainerEvent</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">containerSpec</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeNormal</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">KillingContainer</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
<span class="ln">17</span>
<span class="ln">18</span>	<span class="c1">// Run internal pre-stop lifecycle hook
</span><span class="ln">19</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">internalLifecycle</span><span class="p">.</span><span class="nf">PreStopContainer</span><span class="p">(</span><span class="nx">containerID</span><span class="p">.</span><span class="nx">ID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">20</span>		<span class="k">return</span> <span class="nx">err</span>
<span class="ln">21</span>	<span class="p">}</span>
<span class="ln">22</span>
<span class="ln">23</span>	<span class="c1">// Run the pre-stop lifecycle hooks if applicable and if there is enough time to run it
</span><span class="ln">24</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">Lifecycle</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">Lifecycle</span><span class="p">.</span><span class="nx">PreStop</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">gracePeriod</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
<span class="ln">25</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="nx">gracePeriod</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nf">executePreStopHook</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">,</span> <span class="nx">containerSpec</span><span class="p">,</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">26</span>	<span class="p">}</span>
<span class="ln">27</span>	<span class="c1">// always give containers a minimal shutdown window to avoid unnecessary SIGKILLs
</span><span class="ln">28</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">gracePeriod</span> <span class="p">&lt;</span> <span class="nx">minimumGracePeriodInSeconds</span> <span class="p">{</span>
<span class="ln">29</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="nx">minimumGracePeriodInSeconds</span>
<span class="ln">30</span>	<span class="p">}</span>
<span class="ln">31</span>	<span class="k">if</span> <span class="nx">gracePeriodOverride</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">32</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">gracePeriodOverride</span>
<span class="ln">33</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Killing container %q, but using %d second grace period override&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">,</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">34</span>	<span class="p">}</span>
<span class="ln">35</span>
<span class="ln">36</span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Killing container %q with %d second grace period&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">37</span>
<span class="ln">38</span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">runtimeService</span><span class="p">.</span><span class="nf">StopContainer</span><span class="p">(</span><span class="nx">containerID</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">39</span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">40</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Container %q termination failed with gracePeriod %d: %v&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="nx">gracePeriod</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="ln">41</span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">42</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Container %q exited normally&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
<span class="ln">43</span>	<span class="p">}</span>
<span class="ln">44</span>
<span class="ln">45</span>	<span class="nx">m</span><span class="p">.</span><span class="nx">containerRefManager</span><span class="p">.</span><span class="nf">ClearRef</span><span class="p">(</span><span class="nx">containerID</span><span class="p">)</span>
<span class="ln">46</span>
<span class="ln">47</span>	<span class="k">return</span> <span class="nx">err</span>
<span class="ln">48</span><span class="p">}</span>  
</code></pre></div><p>这个方法就是先调用prestop hook，然后在通过<code>runtimeService.StopContainer</code>方法杀掉容器进程，整个过程总时长不能超过<code>DeletionGracePeriodSeconds</code>。注意，prestop hook是不会进行重试的，失败了kubelet也不管，容器还是照杀不误。</p>
<h3 id="statusmanager发送删除请求">statusManager发送删除请求<a href="#statusmanager发送删除请求" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>kubelet以goroutine的方式运行着一个<code>statusManager</code>，它的作用就是周期性的监听Pod的状态变化，然后执行<code>func (m *manager) syncPod(uid types.UID, status versionedPodStatus) {</code>。在<code>syncPod</code>中，注意到有如下的逻辑：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">manager</span><span class="p">)</span> <span class="nf">syncPod</span><span class="p">(</span><span class="nx">uid</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">status</span> <span class="nx">versionedPodStatus</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="o">...</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nf">canBeDeleted</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>		<span class="nx">deleteOptions</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">{</span>
<span class="ln"> 6</span>			<span class="nx">GracePeriodSeconds</span><span class="p">:</span> <span class="nb">new</span><span class="p">(</span><span class="kt">int64</span><span class="p">),</span>
<span class="ln"> 7</span>			<span class="c1">// Use the pod UID as the precondition for deletion to prevent deleting a
</span><span class="ln"> 8</span><span class="c1"></span>			<span class="c1">// newly created pod with the same name and namespace.
</span><span class="ln"> 9</span><span class="c1"></span>			<span class="nx">Preconditions</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">NewUIDPreconditions</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">UID</span><span class="p">)),</span>
<span class="ln">10</span>		<span class="p">}</span>
<span class="ln">11</span>		<span class="nx">err</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">deleteOptions</span><span class="p">)</span>
<span class="ln">12</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">13</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Failed to delete status for pod %q: %v&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pod</span><span class="p">(</span><span class="nx">pod</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
<span class="ln">14</span>			<span class="k">return</span>
<span class="ln">15</span>		<span class="p">}</span>
<span class="ln">16</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Pod %q fully terminated and removed from etcd&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pod</span><span class="p">(</span><span class="nx">pod</span><span class="p">))</span>
<span class="ln">17</span>		<span class="nx">m</span><span class="p">.</span><span class="nf">deletePodStatus</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span>
<span class="ln">18</span>	<span class="p">}</span>
<span class="ln">19</span><span class="p">}</span>
</code></pre></div><p>也就是说，<strong><code>statusManager</code>发现Pod可以被删除的时候，就会去调用clientset的delete接口将Pod资源从kube-apiserver中删掉</strong>。那什么时候Pod可以被删除呢？自然是在上一步中，kubelet将Pod的容器、卷、cgroup sandbox等资源统统删除掉，就可以被删除了。</p>
<p>这里，webhook就会收到第二次删除请求，而且这次请求中，将<code>GracePeriodSeconds</code>设置为了0，这就代表着kube-apiserver收到这个DELETE请求后，可以将Pod从etcd中删除了。</p>
<h3 id="第三次delete请求">第三次delete请求<a href="#第三次delete请求" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>webhook为什么会收到第三次delete请求，这个问题着实困扰了我很久。</p>
<p>从日志的serviceAccount的信息来看，很像是节点上的组件又发了一次DELETE请求。是kubelet吗？还是kube-proxy？但是查看相关日志和代码，没有发现任何可疑点。</p>
<p>其实，第三次DELETE请求是kube-apiserver自己发的。</p>
<p>在第一部分中，我提到kube-apiserver收到DELETE请求后最终会调用<code>staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go</code>文件中的<code>Delete</code>方法，然后由于走的是优雅删除，它更新完Pod的<code>DeletionTimestamp</code>和<code>DeletionGracePeriodSeconds</code>两个字段后，就返回了。</p>
<p>现在，第二次DELETE请求将<code>GracePeriodSeconds</code>设置为了0，于是现在可以开始执行实际的删除操作了。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deleteValidation</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">ValidateObjectFunc</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="o">...</span>
<span class="ln"> 3</span>    <span class="c1">// delete immediately, or no graceful deletion supported
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;going to delete %s from registry: &#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
<span class="ln"> 5</span>    <span class="nx">out</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">NewFunc</span><span class="p">()</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">preconditions</span><span class="p">,</span> <span class="nx">storage</span><span class="p">.</span><span class="nf">ValidateObjectFunc</span><span class="p">(</span><span class="nx">deleteValidation</span><span class="p">),</span> <span class="nx">dryrun</span><span class="p">.</span><span class="nf">IsDryRun</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">DryRun</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="c1">// Please refer to the place where we set ignoreNotFound for the reason
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="c1">// why we ignore the NotFound error .
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">storage</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ignoreNotFound</span> <span class="o">&amp;&amp;</span> <span class="nx">lastExisting</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">10</span>            <span class="c1">// The lastExisting object may not be the last state of the object
</span><span class="ln">11</span><span class="c1"></span>            <span class="c1">// before its deletion, but it&#39;s the best approximation.
</span><span class="ln">12</span><span class="c1"></span>            <span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">finalizeDelete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">lastExisting</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="ln">13</span>            <span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">14</span>        <span class="p">}</span>
<span class="ln">15</span>        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">storeerr</span><span class="p">.</span><span class="nf">InterpretDeleteError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">qualifiedResource</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
<span class="ln">16</span>    <span class="p">}</span>
<span class="ln">17</span>    <span class="o">...</span>
<span class="ln">18</span><span class="p">}</span>
</code></pre></div><p>在<code>e.Storage.Delete</code>方法中，定义了<code>storage.ValidateObjectFunc(deleteValidation)</code>参数，仔细阅读这个方法的实现细节，原来，kube-apiserver在进行删除前，还会再对这个删除操作执行一次准入控制校验，即Validating和Mutating。代码逻辑见<code>staging/src/k8s.io/apiserver/pkg/storage/etcd3/store.go</code>中的<code>conditionalDelete</code>函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">store</span><span class="p">)</span> <span class="nf">conditionalDelete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">out</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">preconditions</span> <span class="o">*</span><span class="nx">storage</span><span class="p">.</span><span class="nx">Preconditions</span><span class="p">,</span> <span class="nx">validateDeletion</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">ValidateObjectFunc</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="o">...</span>
<span class="ln"> 3</span>    <span class="k">for</span> <span class="p">{</span>
<span class="ln"> 4</span>		<span class="nx">origState</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">getState</span><span class="p">(</span><span class="nx">getResp</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="ln"> 5</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln"> 6</span>			<span class="k">return</span> <span class="nx">err</span>
<span class="ln"> 7</span>		<span class="p">}</span>
<span class="ln"> 8</span>		<span class="k">if</span> <span class="nx">preconditions</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln"> 9</span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">preconditions</span><span class="p">.</span><span class="nf">Check</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">origState</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">10</span>				<span class="k">return</span> <span class="nx">err</span>
<span class="ln">11</span>			<span class="p">}</span>
<span class="ln">12</span>		<span class="p">}</span>
<span class="ln">13</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">validateDeletion</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">origState</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">14</span>			<span class="k">return</span> <span class="nx">err</span>
<span class="ln">15</span>		<span class="p">}</span>
<span class="ln">16</span>		<span class="nx">startTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
<span class="ln">17</span>		<span class="nx">txnResp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">KV</span><span class="p">.</span><span class="nf">Txn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">If</span><span class="p">(</span>
<span class="ln">18</span>			<span class="nx">clientv3</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nf">ModRevision</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="s">&#34;=&#34;</span><span class="p">,</span> <span class="nx">origState</span><span class="p">.</span><span class="nx">rev</span><span class="p">),</span>
<span class="ln">19</span>		<span class="p">).</span><span class="nf">Then</span><span class="p">(</span>
<span class="ln">20</span>			<span class="nx">clientv3</span><span class="p">.</span><span class="nf">OpDelete</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span>
<span class="ln">21</span>		<span class="p">).</span><span class="nf">Else</span><span class="p">(</span>
<span class="ln">22</span>			<span class="nx">clientv3</span><span class="p">.</span><span class="nf">OpGet</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span>
<span class="ln">23</span>        <span class="p">).</span><span class="nf">Commit</span><span class="p">()</span>
<span class="ln">24</span>    <span class="o">...</span>
<span class="ln">25</span>
<span class="ln">26</span><span class="p">}</span>
</code></pre></div><p>validateDeletion 即为进行DELETE准入控制校验的地方，这个过程中必定会调用到Validating webhook，也就有了第三次delete请求。至于为什么要再做一次准入控制，我也不太明白。</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://cvvz.github.io/tags/kubernetes">kubernetes</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>3955 字</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="20" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"></circle><line x1="1.05" y1="12" x2="7" y2="12"></line><line x1="17.01" y1="12" x2="22.96" y2="12"></line></svg><a href="https://github.com/cvvz/blog/commit/e3763633dde2d52632cbdb90a743d2513368ea9d" target="_blank" rel="noopener">e376363</a> @ 2021-12-22</p>
			</footer>
		</article>
		<aside id="toc" class="show-toc">
			<div class="toc-title">目录</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#删除一个pod的过程">删除一个Pod的过程</a>
      <ul>
        <li><a href="#kube-apiserver处理第一次删除请求">kube-apiserver处理第一次删除请求</a></li>
        <li><a href="#kubelet杀掉容器">kubelet杀掉容器</a></li>
        <li><a href="#statusmanager发送删除请求">statusManager发送删除请求</a></li>
        <li><a href="#第三次delete请求">第三次delete请求</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://cvvz.github.io/post/container/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;新</span><br><span>容器</span>
			</a>
			<a class="prev-post" href="https://cvvz.github.io/post/k8s-volume/">
				<span class="post-nav-label">旧&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Kubernetes存储之Volume实现原理</span>
			</a>
		</div>
		<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
        <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
		<div id="gitalk-container" class="thin"></div>     
		<script type="text/javascript">
			var gitalk = new Gitalk({
				clientID: '0f8bdcbe6b4973f9b206',
				clientSecret: '4939e64d59c93fc5eb7eaf74469a746e4535700d',
				repo: 'cvvz.github.io',
				owner: 'cvvz',
				admin: ['cvvz'],
				id: location.pathname,      
				distractionFreeMode: true 
			});
  			gitalk.render('gitalk-container');
		</script>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2023 <a href="https://cvvz.github.io">陈维志</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://cvvz.github.io/post/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://cvvz.github.io/js/main.min.784417f5847151f848c339cf0acb13a06cbb648b1483435a28ed4556c4ead69b.js"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-M8Q3DKDEVL', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
